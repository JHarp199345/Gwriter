import { fnv1a32 } from '../ContentHash';
const STOPWORDS = new Set([
    'the',
    'a',
    'an',
    'and',
    'or',
    'but',
    'to',
    'of',
    'in',
    'on',
    'for',
    'with',
    'at',
    'from',
    'by',
    'as',
    'is',
    'are',
    'was',
    'were',
    'be',
    'been',
    'it',
    'that',
    'this',
    'these',
    'those'
]);
function tokenize(value) {
    return value
        .toLowerCase()
        .split(/[^a-z0-9]+/g)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3 && !STOPWORDS.has(t));
}
function findSnippet(content, term, maxLen) {
    const lower = content.toLowerCase();
    const idx = lower.indexOf(term.toLowerCase());
    if (idx < 0)
        return content.slice(0, maxLen);
    const start = Math.max(0, idx - Math.floor(maxLen / 3));
    const end = Math.min(content.length, start + maxLen);
    const prefix = start > 0 ? '…' : '';
    const suffix = end < content.length ? '…' : '';
    return `${prefix}${content.slice(start, end)}${suffix}`.trim();
}
export class HeuristicProvider {
    constructor(vault, vaultService) {
        this.id = 'heuristic';
        this.cache = new Map();
        this.cacheTtlMs = 30000;
        this.vault = vault;
        this.vaultService = vaultService;
    }
    async search(query, opts) {
        const q = (query.text ?? '').trim();
        if (!q)
            return [];
        const cacheKey = fnv1a32([
            'q:' + q,
            'active:' + (query.activeFilePath ?? ''),
            'mode:' + (query.mode ?? ''),
            'k:' + String(opts.limit)
        ].join('\n'));
        const cached = this.cache.get(cacheKey);
        if (cached && Date.now() - cached.at <= this.cacheTtlMs) {
            return cached.results.slice(0, opts.limit);
        }
        const terms = tokenize(q).slice(0, 24);
        if (terms.length === 0)
            return [];
        const files = this.vaultService.getIncludedMarkdownFiles();
        if (files.length === 0)
            return [];
        // Fast candidate scoring without reading file content.
        const now = Date.now();
        const scored = files
            .map((f) => {
            const base = `${f.basename} ${f.path}`.toLowerCase();
            let score = 0;
            let titleHits = 0;
            for (const t of terms) {
                if (base.includes(t)) {
                    score += 1.0;
                    titleHits++;
                }
            }
            // Recency boost (soft): newer files float up for relevance.
            const ageMs = Math.max(0, now - (f.stat?.mtime ?? now));
            const recency = 1 / (1 + ageMs / (1000 * 60 * 60 * 24 * 30)); // ~30 day scale
            score += recency * 0.5;
            // Working-file proximity boost
            if (query.activeFilePath && f.path === query.activeFilePath)
                score += 0.75;
            if (query.activeFilePath && f.path.startsWith(query.activeFilePath.split('/').slice(0, -1).join('/')))
                score += 0.15;
            return { file: f, score, titleHits };
        })
            .sort((a, b) => b.score - a.score)
            .slice(0, 200);
        const results = [];
        const maxRead = Math.min(scored.length, 120);
        for (let i = 0; i < maxRead; i++) {
            const { file, score: baseScore, titleHits } = scored[i];
            let content = '';
            try {
                content = await this.vault.read(file);
            }
            catch {
                continue;
            }
            const lower = content.toLowerCase();
            let tf = 0;
            let firstTerm = null;
            for (const t of terms) {
                const hits = lower.split(t).length - 1;
                if (hits > 0 && !firstTerm)
                    firstTerm = t;
                tf += hits;
            }
            if (tf === 0 && titleHits === 0)
                continue;
            const normalizedTf = Math.min(1, tf / 24);
            const score = Math.min(1, baseScore / 6 + normalizedTf * 0.7);
            const reasonTags = [];
            if (titleHits > 0)
                reasonTags.push('titleMatch');
            if (tf > 0)
                reasonTags.push('textMatch');
            const excerpt = firstTerm ? findSnippet(content, firstTerm, 2500) : content.slice(0, 2500);
            results.push({
                key: `file:${file.path}`,
                path: file.path,
                title: file.basename,
                excerpt,
                score,
                source: this.id,
                reasonTags
            });
        }
        const finalResults = results.sort((a, b) => b.score - a.score).slice(0, opts.limit);
        this.cache.set(cacheKey, { at: Date.now(), results: finalResults });
        return finalResults;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSGV1cmlzdGljUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJIZXVyaXN0aWNQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekMsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQVM7SUFDakMsS0FBSztJQUNMLEdBQUc7SUFDSCxJQUFJO0lBQ0osS0FBSztJQUNMLElBQUk7SUFDSixLQUFLO0lBQ0wsSUFBSTtJQUNKLElBQUk7SUFDSixJQUFJO0lBQ0osSUFBSTtJQUNKLEtBQUs7SUFDTCxNQUFNO0lBQ04sSUFBSTtJQUNKLE1BQU07SUFDTixJQUFJO0lBQ0osSUFBSTtJQUNKLElBQUk7SUFDSixLQUFLO0lBQ0wsS0FBSztJQUNMLE1BQU07SUFDTixJQUFJO0lBQ0osTUFBTTtJQUNOLElBQUk7SUFDSixNQUFNO0lBQ04sTUFBTTtJQUNOLE9BQU87SUFDUCxPQUFPO0NBQ1AsQ0FBQyxDQUFDO0FBRUgsU0FBUyxRQUFRLENBQUMsS0FBYTtJQUM5QixPQUFPLEtBQUs7U0FDVixXQUFXLEVBQUU7U0FDYixLQUFLLENBQUMsYUFBYSxDQUFDO1NBQ3BCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3BCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckQsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLE9BQWUsRUFBRSxJQUFZLEVBQUUsTUFBYztJQUNqRSxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDcEMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FB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LEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BGLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7UUFDcEUsT0FBTyxZQUFZLENBQUM7SUFDckIsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBWYXVsdCB9IGZyb20gJ29ic2lkaWFuJztcclxuaW1wb3J0IHR5cGUgeyBDb250ZXh0SXRlbSwgUmV0cmlldmFsT3B0aW9ucywgUmV0cmlldmFsUHJvdmlkZXIsIFJldHJpZXZhbFF1ZXJ5IH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB0eXBlIHsgVmF1bHRTZXJ2aWNlIH0gZnJvbSAnLi4vVmF1bHRTZXJ2aWNlJztcclxuaW1wb3J0IHsgZm52MWEzMiB9IGZyb20gJy4uL0NvbnRlbnRIYXNoJztcclxuXHJcbmNvbnN0IFNUT1BXT1JEUyA9IG5ldyBTZXQ8c3RyaW5nPihbXHJcblx0J3RoZScsXHJcblx0J2EnLFxyXG5cdCdhbicsXHJcblx0J2FuZCcsXHJcblx0J29yJyxcclxuXHQnYnV0JyxcclxuXHQndG8nLFxyXG5cdCdvZicsXHJcblx0J2luJyxcclxuXHQnb24nLFxyXG5cdCdmb3InLFxyXG5cdCd3aXRoJyxcclxuXHQnYXQnLFxyXG5cdCdmcm9tJyxcclxuXHQnYnknLFxyXG5cdCdhcycsXHJcblx0J2lzJyxcclxuXHQnYXJlJyxcclxuXHQnd2FzJyxcclxuXHQnd2VyZScsXHJcblx0J2JlJyxcclxuXHQnYmVlbicsXHJcblx0J2l0JyxcclxuXHQndGhhdCcsXHJcblx0J3RoaXMnLFxyXG5cdCd0aGVzZScsXHJcblx0J3Rob3NlJ1xyXG5dKTtcclxuXHJcbmZ1bmN0aW9uIHRva2VuaXplKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcblx0cmV0dXJuIHZhbHVlXHJcblx0XHQudG9Mb3dlckNhc2UoKVxyXG5cdFx0LnNwbGl0KC9bXmEtejAtOV0rL2cpXHJcblx0XHQubWFwKCh0KSA9PiB0LnRyaW0oKSlcclxuXHRcdC5maWx0ZXIoKHQpID0+IHQubGVuZ3RoID49IDMgJiYgIVNUT1BXT1JEUy5oYXModCkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmaW5kU25pcHBldChjb250ZW50OiBzdHJpbmcsIHRlcm06IHN0cmluZywgbWF4TGVuOiBudW1iZXIpOiBzdHJpbmcge1xyXG5cdGNvbnN0IGxvd2VyID0gY29udGVudC50b0xvd2VyQ2FzZSgpO1xyXG5cdGNvbnN0IGlkeCA9IGxvd2VyLmluZGV4T2YodGVybS50b0xvd2VyQ2FzZSgpKTtcclxuXHRpZiAoaWR4IDwgMCkgcmV0dXJuIGNvbnRlbnQuc2xpY2UoMCwgbWF4TGVuKTtcclxuXHRjb25zdCBzdGFydCA9IE1hdGgubWF4KDAsIGlkeCAtIE1hdGguZmxvb3IobWF4TGVuIC8gMykpO1xyXG5cdGNvbnN0IGVuZCA9IE1hdGgubWluKGNvbnRlbnQubGVuZ3RoLCBzdGFydCArIG1heExlbik7XHJcblx0Y29uc3QgcHJlZml4ID0gc3RhcnQgPiAwID8gJ+KApicgOiAnJztcclxuXHRjb25zdCBzdWZmaXggPSBlbmQgPCBjb250ZW50Lmxlbmd0aCA/ICfigKYnIDogJyc7XHJcblx0cmV0dXJuIGAke3ByZWZpeH0ke2NvbnRlbnQuc2xpY2Uoc3RhcnQsIGVuZCl9JHtzdWZmaXh9YC50cmltKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBIZXVyaXN0aWNQcm92aWRlciBpbXBsZW1lbnRzIFJldHJpZXZhbFByb3ZpZGVyIHtcclxuXHRyZWFkb25seSBpZCA9ICdoZXVyaXN0aWMnO1xyXG5cclxuXHRwcml2YXRlIHJlYWRvbmx5IHZhdWx0OiBWYXVsdDtcclxuXHRwcml2YXRlIHJlYWRvbmx5IHZhdWx0U2VydmljZTogVmF1bHRTZXJ2aWNlO1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgY2FjaGUgPSBuZXcgTWFwPHN0cmluZywgeyBhdDogbnVtYmVyOyByZXN1bHRzOiBDb250ZXh0SXRlbVtdIH0+KCk7XHJcblx0cHJpdmF0ZSByZWFkb25seSBjYWNoZVR0bE1zID0gMzBfMDAwO1xyXG5cclxuXHRjb25zdHJ1Y3Rvcih2YXVsdDogVmF1bHQsIHZhdWx0U2VydmljZTogVmF1bHRTZXJ2aWNlKSB7XHJcblx0XHR0aGlzLnZhdWx0ID0gdmF1bHQ7XHJcblx0XHR0aGlzLnZhdWx0U2VydmljZSA9IHZhdWx0U2VydmljZTtcclxuXHR9XHJcblxyXG5cdGFzeW5jIHNlYXJjaChxdWVyeTogUmV0cmlldmFsUXVlcnksIG9wdHM6IFJldHJpZXZhbE9wdGlvbnMpOiBQcm9taXNlPENvbnRleHRJdGVtW10+IHtcclxuXHRcdGNvbnN0IHEgPSAocXVlcnkudGV4dCA/PyAnJykudHJpbSgpO1xyXG5cdFx0aWYgKCFxKSByZXR1cm4gW107XHJcblxyXG5cdFx0Y29uc3QgY2FjaGVLZXkgPSBmbnYxYTMyKFxyXG5cdFx0XHRbXHJcblx0XHRcdFx0J3E6JyArIHEsXHJcblx0XHRcdFx0J2FjdGl2ZTonICsgKHF1ZXJ5LmFjdGl2ZUZpbGVQYXRoID8/ICcnKSxcclxuXHRcdFx0XHQnbW9kZTonICsgKHF1ZXJ5Lm1vZGUgPz8gJycpLFxyXG5cdFx0XHRcdCdrOicgKyBTdHJpbmcob3B0cy5saW1pdClcclxuXHRcdFx0XS5qb2luKCdcXG4nKVxyXG5cdFx0KTtcclxuXHRcdGNvbnN0IGNhY2hlZCA9IHRoaXMuY2FjaGUuZ2V0KGNhY2hlS2V5KTtcclxuXHRcdGlmIChjYWNoZWQgJiYgRGF0ZS5ub3coKSAtIGNhY2hlZC5hdCA8PSB0aGlzLmNhY2hlVHRsTXMpIHtcclxuXHRcdFx0cmV0dXJuIGNhY2hlZC5yZXN1bHRzLnNsaWNlKDAsIG9wdHMubGltaXQpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGNvbnN0IHRlcm1zID0gdG9rZW5pemUocSkuc2xpY2UoMCwgMjQpO1xyXG5cdFx0aWYgKHRlcm1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdO1xyXG5cclxuXHRcdGNvbnN0IGZpbGVzID0gdGhpcy52YXVsdFNlcnZpY2UuZ2V0SW5jbHVkZWRNYXJrZG93bkZpbGVzKCk7XHJcblx0XHRpZiAoZmlsZXMubGVuZ3RoID09PSAwKSByZXR1cm4gW107XHJcblxyXG5cdFx0Ly8gRmFzdCBjYW5kaWRhdGUgc2NvcmluZyB3aXRob3V0IHJlYWRpbmcgZmlsZSBjb250ZW50LlxyXG5cdFx0Y29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuXHRcdGNvbnN0IHNjb3JlZCA9IGZpbGVzXHJcblx0XHRcdC5tYXAoKGYpID0+IHtcclxuXHRcdFx0XHRjb25zdCBiYXNlID0gYCR7Zi5iYXNlbmFtZX0gJHtmLnBhdGh9YC50b0xvd2VyQ2FzZSgpO1xyXG5cdFx0XHRcdGxldCBzY29yZSA9IDA7XHJcblx0XHRcdFx0bGV0IHRpdGxlSGl0cyA9IDA7XHJcblx0XHRcdFx0Zm9yIChjb25zdCB0IG9mIHRlcm1zKSB7XHJcblx0XHRcdFx0XHRpZiAoYmFzZS5pbmNsdWRlcyh0KSkge1xyXG5cdFx0XHRcdFx0XHRzY29yZSArPSAxLjA7XHJcblx0XHRcdFx0XHRcdHRpdGxlSGl0cysrO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHQvLyBSZWNlbmN5IGJvb3N0IChzb2Z0KTogbmV3ZXIgZmlsZXMgZmxvYXQgdXAgZm9yIHJlbGV2YW5jZS5cclxuXHRcdFx0XHRjb25zdCBhZ2VNcyA9IE1hdGgubWF4KDAsIG5vdyAtIChmLnN0YXQ/Lm10aW1lID8/IG5vdykpO1xyXG5cdFx0XHRcdGNvbnN0IHJlY2VuY3kgPSAxIC8gKDEgKyBhZ2VNcyAvICgxMDAwICogNjAgKiA2MCAqIDI0ICogMzApKTsgLy8gfjMwIGRheSBzY2FsZVxyXG5cdFx0XHRcdHNjb3JlICs9IHJlY2VuY3kgKiAwLjU7XHJcblxyXG5cdFx0XHRcdC8vIFdvcmtpbmctZmlsZSBwcm94aW1pdHkgYm9vc3RcclxuXHRcdFx0XHRpZiAocXVlcnkuYWN0aXZlRmlsZVBhdGggJiYgZi5wYXRoID09PSBxdWVyeS5hY3RpdmVGaWxlUGF0aCkgc2NvcmUgKz0gMC43NTtcclxuXHRcdFx0XHRpZiAocXVlcnkuYWN0aXZlRmlsZVBhdGggJiYgZi5wYXRoLnN0YXJ0c1dpdGgocXVlcnkuYWN0aXZlRmlsZVBhdGguc3BsaXQoJy8nKS5zbGljZSgwLCAtMSkuam9pbignLycpKSkgc2NvcmUgKz0gMC4xNTtcclxuXHJcblx0XHRcdFx0cmV0dXJuIHsgZmlsZTogZiwgc2NvcmUsIHRpdGxlSGl0cyB9O1xyXG5cdFx0XHR9KVxyXG5cdFx0XHQuc29ydCgoYSwgYikgPT4gYi5zY29yZSAtIGEuc2NvcmUpXHJcblx0XHRcdC5zbGljZSgwLCAyMDApO1xyXG5cclxuXHRcdGNvbnN0IHJlc3VsdHM6IENvbnRleHRJdGVtW10gPSBbXTtcclxuXHRcdGNvbnN0IG1heFJlYWQgPSBNYXRoLm1pbihzY29yZWQubGVuZ3RoLCAxMjApO1xyXG5cclxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbWF4UmVhZDsgaSsrKSB7XHJcblx0XHRcdGNvbnN0IHsgZmlsZSwgc2NvcmU6IGJhc2VTY29yZSwgdGl0bGVIaXRzIH0gPSBzY29yZWRbaV07XHJcblx0XHRcdGxldCBjb250ZW50ID0gJyc7XHJcblx0XHRcdHRyeSB7XHJcblx0XHRcdFx0Y29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQucmVhZChmaWxlKTtcclxuXHRcdFx0fSBjYXRjaCB7XHJcblx0XHRcdFx0Y29udGludWU7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGNvbnN0IGxvd2VyID0gY29udGVudC50b0xvd2VyQ2FzZSgpO1xyXG5cdFx0XHRsZXQgdGYgPSAwO1xyXG5cdFx0XHRsZXQgZmlyc3RUZXJtOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcclxuXHRcdFx0Zm9yIChjb25zdCB0IG9mIHRlcm1zKSB7XHJcblx0XHRcdFx0Y29uc3QgaGl0cyA9IGxvd2VyLnNwbGl0KHQpLmxlbmd0aCAtIDE7XHJcblx0XHRcdFx0aWYgKGhpdHMgPiAwICYmICFmaXJzdFRlcm0pIGZpcnN0VGVybSA9IHQ7XHJcblx0XHRcdFx0dGYgKz0gaGl0cztcclxuXHRcdFx0fVxyXG5cdFx0XHRpZiAodGYgPT09IDAgJiYgdGl0bGVIaXRzID09PSAwKSBjb250aW51ZTtcclxuXHJcblx0XHRcdGNvbnN0IG5vcm1hbGl6ZWRUZiA9IE1hdGgubWluKDEsIHRmIC8gMjQpO1xyXG5cdFx0XHRjb25zdCBzY29yZSA9IE1hdGgubWluKDEsIGJhc2VTY29yZSAvIDYgKyBub3JtYWxpemVkVGYgKiAwLjcpO1xyXG5cclxuXHRcdFx0Y29uc3QgcmVhc29uVGFnczogc3RyaW5nW10gPSBbXTtcclxuXHRcdFx0aWYgKHRpdGxlSGl0cyA+IDApIHJlYXNvblRhZ3MucHVzaCgndGl0bGVNYXRjaCcpO1xyXG5cdFx0XHRpZiAodGYgPiAwKSByZWFzb25UYWdzLnB1c2goJ3RleHRNYXRjaCcpO1xyXG5cclxuXHRcdFx0Y29uc3QgZXhjZXJwdCA9IGZpcnN0VGVybSA/IGZpbmRTbmlwcGV0KGNvbnRlbnQsIGZpcnN0VGVybSwgMjUwMCkgOiBjb250ZW50LnNsaWNlKDAsIDI1MDApO1xyXG5cclxuXHRcdFx0cmVzdWx0cy5wdXNoKHtcclxuXHRcdFx0XHRrZXk6IGBmaWxlOiR7ZmlsZS5wYXRofWAsXHJcblx0XHRcdFx0cGF0aDogZmlsZS5wYXRoLFxyXG5cdFx0XHRcdHRpdGxlOiBmaWxlLmJhc2VuYW1lLFxyXG5cdFx0XHRcdGV4Y2VycHQsXHJcblx0XHRcdFx0c2NvcmUsXHJcblx0XHRcdFx0c291cmNlOiB0aGlzLmlkLFxyXG5cdFx0XHRcdHJlYXNvblRhZ3NcclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblxyXG5cdFx0Y29uc3QgZmluYWxSZXN1bHRzID0gcmVzdWx0cy5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSkuc2xpY2UoMCwgb3B0cy5saW1pdCk7XHJcblx0XHR0aGlzLmNhY2hlLnNldChjYWNoZUtleSwgeyBhdDogRGF0ZS5ub3coKSwgcmVzdWx0czogZmluYWxSZXN1bHRzIH0pO1xyXG5cdFx0cmV0dXJuIGZpbmFsUmVzdWx0cztcclxuXHR9XHJcbn1cclxuXHJcblxyXG4iXX0=