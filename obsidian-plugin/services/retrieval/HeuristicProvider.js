import { fnv1a32 } from '../ContentHash';
const STOPWORDS = new Set([
    'the',
    'a',
    'an',
    'and',
    'or',
    'but',
    'to',
    'of',
    'in',
    'on',
    'for',
    'with',
    'at',
    'from',
    'by',
    'as',
    'is',
    'are',
    'was',
    'were',
    'be',
    'been',
    'it',
    'that',
    'this',
    'these',
    'those'
]);
function tokenize(value) {
    return value
        .toLowerCase()
        .split(/[^a-z0-9]+/g)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3 && !STOPWORDS.has(t));
}
function findSnippet(content, term, maxLen) {
    const lower = content.toLowerCase();
    const idx = lower.indexOf(term.toLowerCase());
    if (idx < 0)
        return content.slice(0, maxLen);
    const start = Math.max(0, idx - Math.floor(maxLen / 3));
    const end = Math.min(content.length, start + maxLen);
    const prefix = start > 0 ? '…' : '';
    const suffix = end < content.length ? '…' : '';
    return `${prefix}${content.slice(start, end)}${suffix}`.trim();
}
export class HeuristicProvider {
    constructor(vault, vaultService) {
        this.id = 'heuristic';
        this.cache = new Map();
        this.cacheTtlMs = 30000;
        this.vault = vault;
        this.vaultService = vaultService;
    }
    async search(query, opts) {
        const q = (query.text ?? '').trim();
        if (!q)
            return [];
        const cacheKey = fnv1a32([
            'q:' + q,
            'active:' + (query.activeFilePath ?? ''),
            'mode:' + (query.mode ?? ''),
            'k:' + String(opts.limit)
        ].join('\n'));
        const cached = this.cache.get(cacheKey);
        if (cached && Date.now() - cached.at <= this.cacheTtlMs) {
            return cached.results.slice(0, opts.limit);
        }
        const terms = tokenize(q).slice(0, 24);
        if (terms.length === 0)
            return [];
        const files = this.vaultService.getIncludedMarkdownFiles();
        if (files.length === 0)
            return [];
        // Fast candidate scoring without reading file content.
        const now = Date.now();
        const scored = files
            .map((f) => {
            const base = `${f.basename} ${f.path}`.toLowerCase();
            let score = 0;
            let titleHits = 0;
            for (const t of terms) {
                if (base.includes(t)) {
                    score += 1.0;
                    titleHits++;
                }
            }
            // Recency boost (soft): newer files float up for relevance.
            const ageMs = Math.max(0, now - (f.stat?.mtime ?? now));
            const recency = 1 / (1 + ageMs / (1000 * 60 * 60 * 24 * 30)); // ~30 day scale
            score += recency * 0.5;
            // Working-file proximity boost
            if (query.activeFilePath && f.path === query.activeFilePath)
                score += 0.75;
            if (query.activeFilePath && f.path.startsWith(query.activeFilePath.split('/').slice(0, -1).join('/')))
                score += 0.15;
            return { file: f, score, titleHits };
        })
            .sort((a, b) => b.score - a.score)
            .slice(0, 200);
        const results = [];
        const maxRead = Math.min(scored.length, 120);
        for (let i = 0; i < maxRead; i++) {
            const { file, score: baseScore, titleHits } = scored[i];
            let content = '';
            try {
                content = await this.vault.read(file);
            }
            catch {
                continue;
            }
            const lower = content.toLowerCase();
            let tf = 0;
            let firstTerm = null;
            for (const t of terms) {
                const hits = lower.split(t).length - 1;
                if (hits > 0 && !firstTerm)
                    firstTerm = t;
                tf += hits;
            }
            if (tf === 0 && titleHits === 0)
                continue;
            const normalizedTf = Math.min(1, tf / 24);
            const score = Math.min(1, baseScore / 6 + normalizedTf * 0.7);
            const reasonTags = [];
            if (titleHits > 0)
                reasonTags.push('titleMatch');
            if (tf > 0)
                reasonTags.push('textMatch');
            const excerpt = firstTerm ? findSnippet(content, firstTerm, 2500) : content.slice(0, 2500);
            results.push({
                key: `file:${file.path}`,
                path: file.path,
                title: file.basename,
                excerpt,
                score,
                source: this.id,
                reasonTags
            });
        }
        const finalResults = results.sort((a, b) => b.score - a.score).slice(0, opts.limit);
        this.cache.set(cacheKey, { at: Date.now(), results: finalResults });
        return finalResults;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSGV1cmlzdGljUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJIZXVyaXN0aWNQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekMsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQVM7SUFDakMsS0FBSztJQUNMLEdBQUc7SUFDSCxJQUFJO0lBQ0osS0FBSztJQUNMLElBQUk7SUFDSixLQUFLO0lBQ0wsSUFBSTtJQUNKLElBQUk7SUFDSixJQUFJO0lBQ0osSUFBSTtJQUNKLEtBQUs7SUFDTCxNQUFNO0lBQ04sSUFBSTtJQUNKLE1BQU07SUFDTixJQUFJO0lBQ0osSUFBSTtJQUNKLElBQUk7SUFDSixLQUFLO0lBQ0wsS0FBSztJQUNMLE1BQU07SUFDTixJQUFJO0lBQ0osTUFBTTtJQUNOLElBQUk7SUFDSixNQUFNO0lBQ04sTUFBTTtJQUNOLE9BQU87SUFDUCxPQUFPO0NBQ1AsQ0FBQyxDQUFDO0FBRUgsU0FBUyxRQUFRLENBQUMsS0FBYTtJQUM5QixPQUFPLEtBQUs7U0FDVixXQUFXLEVBQUU7U0FDYixLQUFLLENBQUMsYUFBYSxDQUFDO1NBQ3BCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3BCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckQsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLE9BQWUsRUFBRSxJQUFZLEVBQUUsTUFBYztJQUNqRSxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDcEMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FB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LEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BGLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7UUFDcEUsT0FBTyxZQUFZLENBQUM7SUFDckIsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBWYXVsdCB9IGZyb20gJ29ic2lkaWFuJztcbmltcG9ydCB0eXBlIHsgQ29udGV4dEl0ZW0sIFJldHJpZXZhbE9wdGlvbnMsIFJldHJpZXZhbFByb3ZpZGVyLCBSZXRyaWV2YWxRdWVyeSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHR5cGUgeyBWYXVsdFNlcnZpY2UgfSBmcm9tICcuLi9WYXVsdFNlcnZpY2UnO1xuaW1wb3J0IHsgZm52MWEzMiB9IGZyb20gJy4uL0NvbnRlbnRIYXNoJztcblxuY29uc3QgU1RPUFdPUkRTID0gbmV3IFNldDxzdHJpbmc+KFtcblx0J3RoZScsXG5cdCdhJyxcblx0J2FuJyxcblx0J2FuZCcsXG5cdCdvcicsXG5cdCdidXQnLFxuXHQndG8nLFxuXHQnb2YnLFxuXHQnaW4nLFxuXHQnb24nLFxuXHQnZm9yJyxcblx0J3dpdGgnLFxuXHQnYXQnLFxuXHQnZnJvbScsXG5cdCdieScsXG5cdCdhcycsXG5cdCdpcycsXG5cdCdhcmUnLFxuXHQnd2FzJyxcblx0J3dlcmUnLFxuXHQnYmUnLFxuXHQnYmVlbicsXG5cdCdpdCcsXG5cdCd0aGF0Jyxcblx0J3RoaXMnLFxuXHQndGhlc2UnLFxuXHQndGhvc2UnXG5dKTtcblxuZnVuY3Rpb24gdG9rZW5pemUodmFsdWU6IHN0cmluZyk6IHN0cmluZ1tdIHtcblx0cmV0dXJuIHZhbHVlXG5cdFx0LnRvTG93ZXJDYXNlKClcblx0XHQuc3BsaXQoL1teYS16MC05XSsvZylcblx0XHQubWFwKCh0KSA9PiB0LnRyaW0oKSlcblx0XHQuZmlsdGVyKCh0KSA9PiB0Lmxlbmd0aCA+PSAzICYmICFTVE9QV09SRFMuaGFzKHQpKTtcbn1cblxuZnVuY3Rpb24gZmluZFNuaXBwZXQoY29udGVudDogc3RyaW5nLCB0ZXJtOiBzdHJpbmcsIG1heExlbjogbnVtYmVyKTogc3RyaW5nIHtcblx0Y29uc3QgbG93ZXIgPSBjb250ZW50LnRvTG93ZXJDYXNlKCk7XG5cdGNvbnN0IGlkeCA9IGxvd2VyLmluZGV4T2YodGVybS50b0xvd2VyQ2FzZSgpKTtcblx0aWYgKGlkeCA8IDApIHJldHVybiBjb250ZW50LnNsaWNlKDAsIG1heExlbik7XG5cdGNvbnN0IHN0YXJ0ID0gTWF0aC5tYXgoMCwgaWR4IC0gTWF0aC5mbG9vcihtYXhMZW4gLyAzKSk7XG5cdGNvbnN0IGVuZCA9IE1hdGgubWluKGNvbnRlbnQubGVuZ3RoLCBzdGFydCArIG1heExlbik7XG5cdGNvbnN0IHByZWZpeCA9IHN0YXJ0ID4gMCA/ICfigKYnIDogJyc7XG5cdGNvbnN0IHN1ZmZpeCA9IGVuZCA8IGNvbnRlbnQubGVuZ3RoID8gJ+KApicgOiAnJztcblx0cmV0dXJuIGAke3ByZWZpeH0ke2NvbnRlbnQuc2xpY2Uoc3RhcnQsIGVuZCl9JHtzdWZmaXh9YC50cmltKCk7XG59XG5cbmV4cG9ydCBjbGFzcyBIZXVyaXN0aWNQcm92aWRlciBpbXBsZW1lbnRzIFJldHJpZXZhbFByb3ZpZGVyIHtcblx0cmVhZG9ubHkgaWQgPSAnaGV1cmlzdGljJztcblxuXHRwcml2YXRlIHJlYWRvbmx5IHZhdWx0OiBWYXVsdDtcblx0cHJpdmF0ZSByZWFkb25seSB2YXVsdFNlcnZpY2U6IFZhdWx0U2VydmljZTtcblx0cHJpdmF0ZSByZWFkb25seSBjYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCB7IGF0OiBudW1iZXI7IHJlc3VsdHM6IENvbnRleHRJdGVtW10gfT4oKTtcblx0cHJpdmF0ZSByZWFkb25seSBjYWNoZVR0bE1zID0gMzBfMDAwO1xuXG5cdGNvbnN0cnVjdG9yKHZhdWx0OiBWYXVsdCwgdmF1bHRTZXJ2aWNlOiBWYXVsdFNlcnZpY2UpIHtcblx0XHR0aGlzLnZhdWx0ID0gdmF1bHQ7XG5cdFx0dGhpcy52YXVsdFNlcnZpY2UgPSB2YXVsdFNlcnZpY2U7XG5cdH1cblxuXHRhc3luYyBzZWFyY2gocXVlcnk6IFJldHJpZXZhbFF1ZXJ5LCBvcHRzOiBSZXRyaWV2YWxPcHRpb25zKTogUHJvbWlzZTxDb250ZXh0SXRlbVtdPiB7XG5cdFx0Y29uc3QgcSA9IChxdWVyeS50ZXh0ID8/ICcnKS50cmltKCk7XG5cdFx0aWYgKCFxKSByZXR1cm4gW107XG5cblx0XHRjb25zdCBjYWNoZUtleSA9IGZudjFhMzIoXG5cdFx0XHRbXG5cdFx0XHRcdCdxOicgKyBxLFxuXHRcdFx0XHQnYWN0aXZlOicgKyAocXVlcnkuYWN0aXZlRmlsZVBhdGggPz8gJycpLFxuXHRcdFx0XHQnbW9kZTonICsgKHF1ZXJ5Lm1vZGUgPz8gJycpLFxuXHRcdFx0XHQnazonICsgU3RyaW5nKG9wdHMubGltaXQpXG5cdFx0XHRdLmpvaW4oJ1xcbicpXG5cdFx0KTtcblx0XHRjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldChjYWNoZUtleSk7XG5cdFx0aWYgKGNhY2hlZCAmJiBEYXRlLm5vdygpIC0gY2FjaGVkLmF0IDw9IHRoaXMuY2FjaGVUdGxNcykge1xuXHRcdFx0cmV0dXJuIGNhY2hlZC5yZXN1bHRzLnNsaWNlKDAsIG9wdHMubGltaXQpO1xuXHRcdH1cblxuXHRcdGNvbnN0IHRlcm1zID0gdG9rZW5pemUocSkuc2xpY2UoMCwgMjQpO1xuXHRcdGlmICh0ZXJtcy5sZW5ndGggPT09IDApIHJldHVybiBbXTtcblxuXHRcdGNvbnN0IGZpbGVzID0gdGhpcy52YXVsdFNlcnZpY2UuZ2V0SW5jbHVkZWRNYXJrZG93bkZpbGVzKCk7XG5cdFx0aWYgKGZpbGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdO1xuXG5cdFx0Ly8gRmFzdCBjYW5kaWRhdGUgc2NvcmluZyB3aXRob3V0IHJlYWRpbmcgZmlsZSBjb250ZW50LlxuXHRcdGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG5cdFx0Y29uc3Qgc2NvcmVkID0gZmlsZXNcblx0XHRcdC5tYXAoKGYpID0+IHtcblx0XHRcdFx0Y29uc3QgYmFzZSA9IGAke2YuYmFzZW5hbWV9ICR7Zi5wYXRofWAudG9Mb3dlckNhc2UoKTtcblx0XHRcdFx0bGV0IHNjb3JlID0gMDtcblx0XHRcdFx0bGV0IHRpdGxlSGl0cyA9IDA7XG5cdFx0XHRcdGZvciAoY29uc3QgdCBvZiB0ZXJtcykge1xuXHRcdFx0XHRcdGlmIChiYXNlLmluY2x1ZGVzKHQpKSB7XG5cdFx0XHRcdFx0XHRzY29yZSArPSAxLjA7XG5cdFx0XHRcdFx0XHR0aXRsZUhpdHMrKztcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdFx0Ly8gUmVjZW5jeSBib29zdCAoc29mdCk6IG5ld2VyIGZpbGVzIGZsb2F0IHVwIGZvciByZWxldmFuY2UuXG5cdFx0XHRcdGNvbnN0IGFnZU1zID0gTWF0aC5tYXgoMCwgbm93IC0gKGYuc3RhdD8ubXRpbWUgPz8gbm93KSk7XG5cdFx0XHRcdGNvbnN0IHJlY2VuY3kgPSAxIC8gKDEgKyBhZ2VNcyAvICgxMDAwICogNjAgKiA2MCAqIDI0ICogMzApKTsgLy8gfjMwIGRheSBzY2FsZVxuXHRcdFx0XHRzY29yZSArPSByZWNlbmN5ICogMC41O1xuXG5cdFx0XHRcdC8vIFdvcmtpbmctZmlsZSBwcm94aW1pdHkgYm9vc3Rcblx0XHRcdFx0aWYgKHF1ZXJ5LmFjdGl2ZUZpbGVQYXRoICYmIGYucGF0aCA9PT0gcXVlcnkuYWN0aXZlRmlsZVBhdGgpIHNjb3JlICs9IDAuNzU7XG5cdFx0XHRcdGlmIChxdWVyeS5hY3RpdmVGaWxlUGF0aCAmJiBmLnBhdGguc3RhcnRzV2l0aChxdWVyeS5hY3RpdmVGaWxlUGF0aC5zcGxpdCgnLycpLnNsaWNlKDAsIC0xKS5qb2luKCcvJykpKSBzY29yZSArPSAwLjE1O1xuXG5cdFx0XHRcdHJldHVybiB7IGZpbGU6IGYsIHNjb3JlLCB0aXRsZUhpdHMgfTtcblx0XHRcdH0pXG5cdFx0XHQuc29ydCgoYSwgYikgPT4gYi5zY29yZSAtIGEuc2NvcmUpXG5cdFx0XHQuc2xpY2UoMCwgMjAwKTtcblxuXHRcdGNvbnN0IHJlc3VsdHM6IENvbnRleHRJdGVtW10gPSBbXTtcblx0XHRjb25zdCBtYXhSZWFkID0gTWF0aC5taW4oc2NvcmVkLmxlbmd0aCwgMTIwKTtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbWF4UmVhZDsgaSsrKSB7XG5cdFx0XHRjb25zdCB7IGZpbGUsIHNjb3JlOiBiYXNlU2NvcmUsIHRpdGxlSGl0cyB9ID0gc2NvcmVkW2ldO1xuXHRcdFx0bGV0IGNvbnRlbnQgPSAnJztcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGNvbnRlbnQgPSBhd2FpdCB0aGlzLnZhdWx0LnJlYWQoZmlsZSk7XG5cdFx0XHR9IGNhdGNoIHtcblx0XHRcdFx0Y29udGludWU7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGxvd2VyID0gY29udGVudC50b0xvd2VyQ2FzZSgpO1xuXHRcdFx0bGV0IHRmID0gMDtcblx0XHRcdGxldCBmaXJzdFRlcm06IHN0cmluZyB8IG51bGwgPSBudWxsO1xuXHRcdFx0Zm9yIChjb25zdCB0IG9mIHRlcm1zKSB7XG5cdFx0XHRcdGNvbnN0IGhpdHMgPSBsb3dlci5zcGxpdCh0KS5sZW5ndGggLSAxO1xuXHRcdFx0XHRpZiAoaGl0cyA+IDAgJiYgIWZpcnN0VGVybSkgZmlyc3RUZXJtID0gdDtcblx0XHRcdFx0dGYgKz0gaGl0cztcblx0XHRcdH1cblx0XHRcdGlmICh0ZiA9PT0gMCAmJiB0aXRsZUhpdHMgPT09IDApIGNvbnRpbnVlO1xuXG5cdFx0XHRjb25zdCBub3JtYWxpemVkVGYgPSBNYXRoLm1pbigxLCB0ZiAvIDI0KTtcblx0XHRcdGNvbnN0IHNjb3JlID0gTWF0aC5taW4oMSwgYmFzZVNjb3JlIC8gNiArIG5vcm1hbGl6ZWRUZiAqIDAuNyk7XG5cblx0XHRcdGNvbnN0IHJlYXNvblRhZ3M6IHN0cmluZ1tdID0gW107XG5cdFx0XHRpZiAodGl0bGVIaXRzID4gMCkgcmVhc29uVGFncy5wdXNoKCd0aXRsZU1hdGNoJyk7XG5cdFx0XHRpZiAodGYgPiAwKSByZWFzb25UYWdzLnB1c2goJ3RleHRNYXRjaCcpO1xuXG5cdFx0XHRjb25zdCBleGNlcnB0ID0gZmlyc3RUZXJtID8gZmluZFNuaXBwZXQoY29udGVudCwgZmlyc3RUZXJtLCAyNTAwKSA6IGNvbnRlbnQuc2xpY2UoMCwgMjUwMCk7XG5cblx0XHRcdHJlc3VsdHMucHVzaCh7XG5cdFx0XHRcdGtleTogYGZpbGU6JHtmaWxlLnBhdGh9YCxcblx0XHRcdFx0cGF0aDogZmlsZS5wYXRoLFxuXHRcdFx0XHR0aXRsZTogZmlsZS5iYXNlbmFtZSxcblx0XHRcdFx0ZXhjZXJwdCxcblx0XHRcdFx0c2NvcmUsXG5cdFx0XHRcdHNvdXJjZTogdGhpcy5pZCxcblx0XHRcdFx0cmVhc29uVGFnc1xuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgZmluYWxSZXN1bHRzID0gcmVzdWx0cy5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSkuc2xpY2UoMCwgb3B0cy5saW1pdCk7XG5cdFx0dGhpcy5jYWNoZS5zZXQoY2FjaGVLZXksIHsgYXQ6IERhdGUubm93KCksIHJlc3VsdHM6IGZpbmFsUmVzdWx0cyB9KTtcblx0XHRyZXR1cm4gZmluYWxSZXN1bHRzO1xuXHR9XG59XG5cblxuIl19