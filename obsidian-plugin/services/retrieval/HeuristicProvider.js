import { __awaiter } from "tslib";
import { fnv1a32 } from '../ContentHash';
const STOPWORDS = new Set([
    'the',
    'a',
    'an',
    'and',
    'or',
    'but',
    'to',
    'of',
    'in',
    'on',
    'for',
    'with',
    'at',
    'from',
    'by',
    'as',
    'is',
    'are',
    'was',
    'were',
    'be',
    'been',
    'it',
    'that',
    'this',
    'these',
    'those'
]);
function tokenize(value) {
    return value
        .toLowerCase()
        .split(/[^a-z0-9]+/g)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3 && !STOPWORDS.has(t));
}
function findSnippet(content, term, maxLen) {
    const lower = content.toLowerCase();
    const idx = lower.indexOf(term.toLowerCase());
    if (idx < 0)
        return content.slice(0, maxLen);
    const start = Math.max(0, idx - Math.floor(maxLen / 3));
    const end = Math.min(content.length, start + maxLen);
    const prefix = start > 0 ? '…' : '';
    const suffix = end < content.length ? '…' : '';
    return `${prefix}${content.slice(start, end)}${suffix}`.trim();
}
export class HeuristicProvider {
    constructor(vault, vaultService) {
        this.id = 'heuristic';
        this.cache = new Map();
        this.cacheTtlMs = 30000;
        this.vault = vault;
        this.vaultService = vaultService;
    }
    search(query, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a, _b, _c;
            const q = ((_a = query.text) !== null && _a !== void 0 ? _a : '').trim();
            if (!q)
                return [];
            const cacheKey = fnv1a32([
                'q:' + q,
                'active:' + ((_b = query.activeFilePath) !== null && _b !== void 0 ? _b : ''),
                'mode:' + ((_c = query.mode) !== null && _c !== void 0 ? _c : ''),
                'k:' + String(opts.limit)
            ].join('\n'));
            const cached = this.cache.get(cacheKey);
            if (cached && Date.now() - cached.at <= this.cacheTtlMs) {
                return cached.results.slice(0, opts.limit);
            }
            const terms = tokenize(q).slice(0, 24);
            if (terms.length === 0)
                return [];
            const files = this.vaultService.getIncludedMarkdownFiles();
            if (files.length === 0)
                return [];
            // Fast candidate scoring without reading file content.
            const now = Date.now();
            const scored = files
                .map((f) => {
                var _a, _b;
                const base = `${f.basename} ${f.path}`.toLowerCase();
                let score = 0;
                let titleHits = 0;
                for (const t of terms) {
                    if (base.includes(t)) {
                        score += 1.0;
                        titleHits++;
                    }
                }
                // Recency boost (soft): newer files float up for relevance.
                const ageMs = Math.max(0, now - ((_b = (_a = f.stat) === null || _a === void 0 ? void 0 : _a.mtime) !== null && _b !== void 0 ? _b : now));
                const recency = 1 / (1 + ageMs / (1000 * 60 * 60 * 24 * 30)); // ~30 day scale
                score += recency * 0.5;
                // Working-file proximity boost
                if (query.activeFilePath && f.path === query.activeFilePath)
                    score += 0.75;
                if (query.activeFilePath && f.path.startsWith(query.activeFilePath.split('/').slice(0, -1).join('/')))
                    score += 0.15;
                return { file: f, score, titleHits };
            })
                .sort((a, b) => b.score - a.score)
                .slice(0, 200);
            const results = [];
            const maxRead = Math.min(scored.length, 120);
            for (let i = 0; i < maxRead; i++) {
                const { file, score: baseScore, titleHits } = scored[i];
                let content = '';
                try {
                    content = yield this.vault.read(file);
                }
                catch (_d) {
                    continue;
                }
                const lower = content.toLowerCase();
                let tf = 0;
                let firstTerm = null;
                for (const t of terms) {
                    const hits = lower.split(t).length - 1;
                    if (hits > 0 && !firstTerm)
                        firstTerm = t;
                    tf += hits;
                }
                if (tf === 0 && titleHits === 0)
                    continue;
                const normalizedTf = Math.min(1, tf / 24);
                const score = Math.min(1, baseScore / 6 + normalizedTf * 0.7);
                const reasonTags = [];
                if (titleHits > 0)
                    reasonTags.push('titleMatch');
                if (tf > 0)
                    reasonTags.push('textMatch');
                const excerpt = firstTerm ? findSnippet(content, firstTerm, 600) : content.slice(0, 600);
                results.push({
                    key: `file:${file.path}`,
                    path: file.path,
                    title: file.basename,
                    excerpt,
                    score,
                    source: this.id,
                    reasonTags
                });
            }
            const finalResults = results.sort((a, b) => b.score - a.score).slice(0, opts.limit);
            this.cache.set(cacheKey, { at: Date.now(), results: finalResults });
            return finalResults;
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSGV1cmlzdGljUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJIZXVyaXN0aWNQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXpDLE1BQU0sU0FBUyxHQUFHLElBQUksR0FBRyxDQUFTO0lBQ2pDLEtBQUs7SUFDTCxHQUFHO0lBQ0gsSUFBSTtJQUNKLEtBQUs7SUFDTCxJQUFJO0lBQ0osS0FBSztJQUNMLElBQUk7SUFDSixJQUFJO0lBQ0osSUFBSTtJQUNKLElBQUk7SUFDSixLQUFLO0lBQ0wsTUFBTTtJQUNOLElBQUk7SUFDSixNQUFNO0lBQ04sSUFBSTtJQUNKLElBQUk7SUFDSixJQUFJO0lBQ0osS0FBSztJQUNMLEtBQUs7SUFDTCxNQUFNO0lBQ04sSUFBSTtJQUNKLE1BQU07SUFDTixJQUFJO0lBQ0osTUFBTTtJQUNOLE1BQU07SUFDTixPQUFPO0lBQ1AsT0FBTztDQUNQLENBQUMsQ0FBQztBQUVILFNBQVMsUUFBUSxDQUFDLEtBQWE7SUFDOUIsT0FBTyxLQUFLO1NBQ1YsV0FBVyxFQUFFO1NBQ2IsS0FBSyxDQUFDLGFBQWEsQ0FBQztTQUNwQixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNwQixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3JELENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxPQUFlLEVBQUUsSUFBWSxFQUFFLE1BQWM7SUFDakUsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3BDLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdB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QUNKLENBQUM7WUFFRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDcEYsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztZQUNwRSxPQUFPLFlBQVksQ0FBQztRQUNyQixDQUFDO0tBQUE7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgVmF1bHQgfSBmcm9tICdvYnNpZGlhbic7XHJcbmltcG9ydCB0eXBlIHsgQ29udGV4dEl0ZW0sIFJldHJpZXZhbE9wdGlvbnMsIFJldHJpZXZhbFByb3ZpZGVyLCBSZXRyaWV2YWxRdWVyeSB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgdHlwZSB7IFZhdWx0U2VydmljZSB9IGZyb20gJy4uL1ZhdWx0U2VydmljZSc7XHJcbmltcG9ydCB7IGZudjFhMzIgfSBmcm9tICcuLi9Db250ZW50SGFzaCc7XHJcblxyXG5jb25zdCBTVE9QV09SRFMgPSBuZXcgU2V0PHN0cmluZz4oW1xyXG5cdCd0aGUnLFxyXG5cdCdhJyxcclxuXHQnYW4nLFxyXG5cdCdhbmQnLFxyXG5cdCdvcicsXHJcblx0J2J1dCcsXHJcblx0J3RvJyxcclxuXHQnb2YnLFxyXG5cdCdpbicsXHJcblx0J29uJyxcclxuXHQnZm9yJyxcclxuXHQnd2l0aCcsXHJcblx0J2F0JyxcclxuXHQnZnJvbScsXHJcblx0J2J5JyxcclxuXHQnYXMnLFxyXG5cdCdpcycsXHJcblx0J2FyZScsXHJcblx0J3dhcycsXHJcblx0J3dlcmUnLFxyXG5cdCdiZScsXHJcblx0J2JlZW4nLFxyXG5cdCdpdCcsXHJcblx0J3RoYXQnLFxyXG5cdCd0aGlzJyxcclxuXHQndGhlc2UnLFxyXG5cdCd0aG9zZSdcclxuXSk7XHJcblxyXG5mdW5jdGlvbiB0b2tlbml6ZSh2YWx1ZTogc3RyaW5nKTogc3RyaW5nW10ge1xyXG5cdHJldHVybiB2YWx1ZVxyXG5cdFx0LnRvTG93ZXJDYXNlKClcclxuXHRcdC5zcGxpdCgvW15hLXowLTldKy9nKVxyXG5cdFx0Lm1hcCgodCkgPT4gdC50cmltKCkpXHJcblx0XHQuZmlsdGVyKCh0KSA9PiB0Lmxlbmd0aCA+PSAzICYmICFTVE9QV09SRFMuaGFzKHQpKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZmluZFNuaXBwZXQoY29udGVudDogc3RyaW5nLCB0ZXJtOiBzdHJpbmcsIG1heExlbjogbnVtYmVyKTogc3RyaW5nIHtcclxuXHRjb25zdCBsb3dlciA9IGNvbnRlbnQudG9Mb3dlckNhc2UoKTtcclxuXHRjb25zdCBpZHggPSBsb3dlci5pbmRleE9mKHRlcm0udG9Mb3dlckNhc2UoKSk7XHJcblx0aWYgKGlkeCA8IDApIHJldHVybiBjb250ZW50LnNsaWNlKDAsIG1heExlbik7XHJcblx0Y29uc3Qgc3RhcnQgPSBNYXRoLm1heCgwLCBpZHggLSBNYXRoLmZsb29yKG1heExlbiAvIDMpKTtcclxuXHRjb25zdCBlbmQgPSBNYXRoLm1pbihjb250ZW50Lmxlbmd0aCwgc3RhcnQgKyBtYXhMZW4pO1xyXG5cdGNvbnN0IHByZWZpeCA9IHN0YXJ0ID4gMCA/ICfigKYnIDogJyc7XHJcblx0Y29uc3Qgc3VmZml4ID0gZW5kIDwgY29udGVudC5sZW5ndGggPyAn4oCmJyA6ICcnO1xyXG5cdHJldHVybiBgJHtwcmVmaXh9JHtjb250ZW50LnNsaWNlKHN0YXJ0LCBlbmQpfSR7c3VmZml4fWAudHJpbSgpO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgSGV1cmlzdGljUHJvdmlkZXIgaW1wbGVtZW50cyBSZXRyaWV2YWxQcm92aWRlciB7XHJcblx0cmVhZG9ubHkgaWQgPSAnaGV1cmlzdGljJztcclxuXHJcblx0cHJpdmF0ZSByZWFkb25seSB2YXVsdDogVmF1bHQ7XHJcblx0cHJpdmF0ZSByZWFkb25seSB2YXVsdFNlcnZpY2U6IFZhdWx0U2VydmljZTtcclxuXHRwcml2YXRlIHJlYWRvbmx5IGNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIHsgYXQ6IG51bWJlcjsgcmVzdWx0czogQ29udGV4dEl0ZW1bXSB9PigpO1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgY2FjaGVUdGxNcyA9IDMwXzAwMDtcclxuXHJcblx0Y29uc3RydWN0b3IodmF1bHQ6IFZhdWx0LCB2YXVsdFNlcnZpY2U6IFZhdWx0U2VydmljZSkge1xyXG5cdFx0dGhpcy52YXVsdCA9IHZhdWx0O1xyXG5cdFx0dGhpcy52YXVsdFNlcnZpY2UgPSB2YXVsdFNlcnZpY2U7XHJcblx0fVxyXG5cclxuXHRhc3luYyBzZWFyY2gocXVlcnk6IFJldHJpZXZhbFF1ZXJ5LCBvcHRzOiBSZXRyaWV2YWxPcHRpb25zKTogUHJvbWlzZTxDb250ZXh0SXRlbVtdPiB7XHJcblx0XHRjb25zdCBxID0gKHF1ZXJ5LnRleHQgPz8gJycpLnRyaW0oKTtcclxuXHRcdGlmICghcSkgcmV0dXJuIFtdO1xyXG5cclxuXHRcdGNvbnN0IGNhY2hlS2V5ID0gZm52MWEzMihcclxuXHRcdFx0W1xyXG5cdFx0XHRcdCdxOicgKyBxLFxyXG5cdFx0XHRcdCdhY3RpdmU6JyArIChxdWVyeS5hY3RpdmVGaWxlUGF0aCA/PyAnJyksXHJcblx0XHRcdFx0J21vZGU6JyArIChxdWVyeS5tb2RlID8/ICcnKSxcclxuXHRcdFx0XHQnazonICsgU3RyaW5nKG9wdHMubGltaXQpXHJcblx0XHRcdF0uam9pbignXFxuJylcclxuXHRcdCk7XHJcblx0XHRjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldChjYWNoZUtleSk7XHJcblx0XHRpZiAoY2FjaGVkICYmIERhdGUubm93KCkgLSBjYWNoZWQuYXQgPD0gdGhpcy5jYWNoZVR0bE1zKSB7XHJcblx0XHRcdHJldHVybiBjYWNoZWQucmVzdWx0cy5zbGljZSgwLCBvcHRzLmxpbWl0KTtcclxuXHRcdH1cclxuXHJcblx0XHRjb25zdCB0ZXJtcyA9IHRva2VuaXplKHEpLnNsaWNlKDAsIDI0KTtcclxuXHRcdGlmICh0ZXJtcy5sZW5ndGggPT09IDApIHJldHVybiBbXTtcclxuXHJcblx0XHRjb25zdCBmaWxlcyA9IHRoaXMudmF1bHRTZXJ2aWNlLmdldEluY2x1ZGVkTWFya2Rvd25GaWxlcygpO1xyXG5cdFx0aWYgKGZpbGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdO1xyXG5cclxuXHRcdC8vIEZhc3QgY2FuZGlkYXRlIHNjb3Jpbmcgd2l0aG91dCByZWFkaW5nIGZpbGUgY29udGVudC5cclxuXHRcdGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcblx0XHRjb25zdCBzY29yZWQgPSBmaWxlc1xyXG5cdFx0XHQubWFwKChmKSA9PiB7XHJcblx0XHRcdFx0Y29uc3QgYmFzZSA9IGAke2YuYmFzZW5hbWV9ICR7Zi5wYXRofWAudG9Mb3dlckNhc2UoKTtcclxuXHRcdFx0XHRsZXQgc2NvcmUgPSAwO1xyXG5cdFx0XHRcdGxldCB0aXRsZUhpdHMgPSAwO1xyXG5cdFx0XHRcdGZvciAoY29uc3QgdCBvZiB0ZXJtcykge1xyXG5cdFx0XHRcdFx0aWYgKGJhc2UuaW5jbHVkZXModCkpIHtcclxuXHRcdFx0XHRcdFx0c2NvcmUgKz0gMS4wO1xyXG5cdFx0XHRcdFx0XHR0aXRsZUhpdHMrKztcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0Ly8gUmVjZW5jeSBib29zdCAoc29mdCk6IG5ld2VyIGZpbGVzIGZsb2F0IHVwIGZvciByZWxldmFuY2UuXHJcblx0XHRcdFx0Y29uc3QgYWdlTXMgPSBNYXRoLm1heCgwLCBub3cgLSAoZi5zdGF0Py5tdGltZSA/PyBub3cpKTtcclxuXHRcdFx0XHRjb25zdCByZWNlbmN5ID0gMSAvICgxICsgYWdlTXMgLyAoMTAwMCAqIDYwICogNjAgKiAyNCAqIDMwKSk7IC8vIH4zMCBkYXkgc2NhbGVcclxuXHRcdFx0XHRzY29yZSArPSByZWNlbmN5ICogMC41O1xyXG5cclxuXHRcdFx0XHQvLyBXb3JraW5nLWZpbGUgcHJveGltaXR5IGJvb3N0XHJcblx0XHRcdFx0aWYgKHF1ZXJ5LmFjdGl2ZUZpbGVQYXRoICYmIGYucGF0aCA9PT0gcXVlcnkuYWN0aXZlRmlsZVBhdGgpIHNjb3JlICs9IDAuNzU7XHJcblx0XHRcdFx0aWYgKHF1ZXJ5LmFjdGl2ZUZpbGVQYXRoICYmIGYucGF0aC5zdGFydHNXaXRoKHF1ZXJ5LmFjdGl2ZUZpbGVQYXRoLnNwbGl0KCcvJykuc2xpY2UoMCwgLTEpLmpvaW4oJy8nKSkpIHNjb3JlICs9IDAuMTU7XHJcblxyXG5cdFx0XHRcdHJldHVybiB7IGZpbGU6IGYsIHNjb3JlLCB0aXRsZUhpdHMgfTtcclxuXHRcdFx0fSlcclxuXHRcdFx0LnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKVxyXG5cdFx0XHQuc2xpY2UoMCwgMjAwKTtcclxuXHJcblx0XHRjb25zdCByZXN1bHRzOiBDb250ZXh0SXRlbVtdID0gW107XHJcblx0XHRjb25zdCBtYXhSZWFkID0gTWF0aC5taW4oc2NvcmVkLmxlbmd0aCwgMTIwKTtcclxuXHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IG1heFJlYWQ7IGkrKykge1xyXG5cdFx0XHRjb25zdCB7IGZpbGUsIHNjb3JlOiBiYXNlU2NvcmUsIHRpdGxlSGl0cyB9ID0gc2NvcmVkW2ldO1xyXG5cdFx0XHRsZXQgY29udGVudCA9ICcnO1xyXG5cdFx0XHR0cnkge1xyXG5cdFx0XHRcdGNvbnRlbnQgPSBhd2FpdCB0aGlzLnZhdWx0LnJlYWQoZmlsZSk7XHJcblx0XHRcdH0gY2F0Y2gge1xyXG5cdFx0XHRcdGNvbnRpbnVlO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRjb25zdCBsb3dlciA9IGNvbnRlbnQudG9Mb3dlckNhc2UoKTtcclxuXHRcdFx0bGV0IHRmID0gMDtcclxuXHRcdFx0bGV0IGZpcnN0VGVybTogc3RyaW5nIHwgbnVsbCA9IG51bGw7XHJcblx0XHRcdGZvciAoY29uc3QgdCBvZiB0ZXJtcykge1xyXG5cdFx0XHRcdGNvbnN0IGhpdHMgPSBsb3dlci5zcGxpdCh0KS5sZW5ndGggLSAxO1xyXG5cdFx0XHRcdGlmIChoaXRzID4gMCAmJiAhZmlyc3RUZXJtKSBmaXJzdFRlcm0gPSB0O1xyXG5cdFx0XHRcdHRmICs9IGhpdHM7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKHRmID09PSAwICYmIHRpdGxlSGl0cyA9PT0gMCkgY29udGludWU7XHJcblxyXG5cdFx0XHRjb25zdCBub3JtYWxpemVkVGYgPSBNYXRoLm1pbigxLCB0ZiAvIDI0KTtcclxuXHRcdFx0Y29uc3Qgc2NvcmUgPSBNYXRoLm1pbigxLCBiYXNlU2NvcmUgLyA2ICsgbm9ybWFsaXplZFRmICogMC43KTtcclxuXHJcblx0XHRcdGNvbnN0IHJlYXNvblRhZ3M6IHN0cmluZ1tdID0gW107XHJcblx0XHRcdGlmICh0aXRsZUhpdHMgPiAwKSByZWFzb25UYWdzLnB1c2goJ3RpdGxlTWF0Y2gnKTtcclxuXHRcdFx0aWYgKHRmID4gMCkgcmVhc29uVGFncy5wdXNoKCd0ZXh0TWF0Y2gnKTtcclxuXHJcblx0XHRcdGNvbnN0IGV4Y2VycHQgPSBmaXJzdFRlcm0gPyBmaW5kU25pcHBldChjb250ZW50LCBmaXJzdFRlcm0sIDYwMCkgOiBjb250ZW50LnNsaWNlKDAsIDYwMCk7XHJcblxyXG5cdFx0XHRyZXN1bHRzLnB1c2goe1xyXG5cdFx0XHRcdGtleTogYGZpbGU6JHtmaWxlLnBhdGh9YCxcclxuXHRcdFx0XHRwYXRoOiBmaWxlLnBhdGgsXHJcblx0XHRcdFx0dGl0bGU6IGZpbGUuYmFzZW5hbWUsXHJcblx0XHRcdFx0ZXhjZXJwdCxcclxuXHRcdFx0XHRzY29yZSxcclxuXHRcdFx0XHRzb3VyY2U6IHRoaXMuaWQsXHJcblx0XHRcdFx0cmVhc29uVGFnc1xyXG5cdFx0XHR9KTtcclxuXHRcdH1cclxuXHJcblx0XHRjb25zdCBmaW5hbFJlc3VsdHMgPSByZXN1bHRzLnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKS5zbGljZSgwLCBvcHRzLmxpbWl0KTtcclxuXHRcdHRoaXMuY2FjaGUuc2V0KGNhY2hlS2V5LCB7IGF0OiBEYXRlLm5vdygpLCByZXN1bHRzOiBmaW5hbFJlc3VsdHMgfSk7XHJcblx0XHRyZXR1cm4gZmluYWxSZXN1bHRzO1xyXG5cdH1cclxufVxyXG5cclxuXHJcbiJdfQ==