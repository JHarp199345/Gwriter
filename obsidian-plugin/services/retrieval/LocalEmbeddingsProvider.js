import { __awaiter } from "tslib";
function dot(a, b) {
    const n = Math.min(a.length, b.length);
    let s = 0;
    for (let i = 0; i < n; i++)
        s += a[i] * b[i];
    return s;
}
export class LocalEmbeddingsProvider {
    constructor(index, isEnabled, isAllowedPath) {
        this.id = 'semantic';
        this.index = index;
        this.isEnabled = isEnabled;
        this.isAllowedPath = isAllowedPath;
    }
    search(query, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            if (!this.isEnabled())
                return [];
            const q = ((_a = query.text) !== null && _a !== void 0 ? _a : '').trim();
            if (!q)
                return [];
            yield this.index.ensureLoaded();
            const qVec = this.index.buildQueryVector(q);
            const chunks = this.index.getAllChunks().filter((c) => this.isAllowedPath(c.path));
            if (chunks.length === 0)
                return [];
            // Score all chunks. For large vaults this is still typically fast at 256 dims.
            const scored = chunks
                .map((c) => ({ chunk: c, score: dot(qVec, c.vector) }))
                .sort((a, b) => b.score - a.score)
                .slice(0, Math.max(1, Math.min(200, opts.limit * 6)));
            const results = [];
            for (const { chunk, score } of scored) {
                results.push({
                    key: chunk.key,
                    path: chunk.path,
                    title: chunk.path.split('/').pop(),
                    excerpt: chunk.excerpt,
                    score: Math.max(0, Math.min(1, (score + 1) / 2)),
                    source: this.id,
                    reasonTags: ['semantic']
                });
            }
            return results.slice(0, opts.limit);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9jYWxFbWJlZGRpbmdzUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJMb2NhbEVtYmVkZGluZ3NQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsU0FBUyxHQUFHLENBQUMsQ0FBVyxFQUFFLENBQVc7SUFDcEMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN2QyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDVixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRTtRQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdDLE9BQU8sQ0FBQyxDQUFDO0FBQ1YsQ0FBQztBQUVELE1BQU0sT0FBTyx1QkFBdUI7SUFPbkMsWUFBWSxLQUFzQixFQUFFLFNBQXdCLEVBQUUsYUFBd0M7UUFON0YsT0FBRSxHQUFHLFVBQVUsQ0FBQztRQU94QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUMzQixJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztJQUNwQyxDQUFDO0lBRUssTUFBTSxDQUFDLEtBQXFCLEVBQUUsSUFBc0I7OztZQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFBRSxPQUFPLEVBQUUsQ0FBQztZQUNqQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQUEsS0FBSyxDQUFDLElBQUksbUNBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDcEMsSUFBSSxDQUFDLENBQUM7Z0JBQUUsT0FBTyxFQUFFLENBQUM7WUFFbEIsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1lBRWhDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbkYsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUM7Z0JBQUUsT0FBTyxFQUFFLENBQUM7WUFFbkMsK0VBQStFO1lBQy9FLE1BQU0sTUFBTSxHQUFHLE1BQU07aUJBQ25CLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDdEQsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2lCQUNqQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXZELE1BQU0sT0FBTyxHQUFrQixFQUFFLENBQUM7WUFDbEMsS0FBSyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLE1BQU0sRUFBRSxDQUFDO2dCQUN2QyxPQUFPLENBQUMsSUFBSSxDQUFDO29CQUNaLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztvQkFDZCxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7b0JBQ2hCLEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUU7b0JBQ2xDLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztvQkFDdEIsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUNoRCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7b0JBQ2YsVUFBVSxFQUFFLENBQUMsVUFBVSxDQUFDO2lCQUN4QixDQUFDLENBQUM7WUFDSixDQUFDO1lBRUQsT0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckMsQ0FBQztLQUFBO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IENvbnRleHRJdGVtLCBSZXRyaWV2YWxPcHRpb25zLCBSZXRyaWV2YWxQcm92aWRlciwgUmV0cmlldmFsUXVlcnkgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHR5cGUgeyBFbWJlZGRpbmdzSW5kZXggfSBmcm9tICcuL0VtYmVkZGluZ3NJbmRleCc7XHJcblxyXG5mdW5jdGlvbiBkb3QoYTogbnVtYmVyW10sIGI6IG51bWJlcltdKTogbnVtYmVyIHtcclxuXHRjb25zdCBuID0gTWF0aC5taW4oYS5sZW5ndGgsIGIubGVuZ3RoKTtcclxuXHRsZXQgcyA9IDA7XHJcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHMgKz0gYVtpXSAqIGJbaV07XHJcblx0cmV0dXJuIHM7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBMb2NhbEVtYmVkZGluZ3NQcm92aWRlciBpbXBsZW1lbnRzIFJldHJpZXZhbFByb3ZpZGVyIHtcclxuXHRyZWFkb25seSBpZCA9ICdzZW1hbnRpYyc7XHJcblxyXG5cdHByaXZhdGUgcmVhZG9ubHkgaW5kZXg6IEVtYmVkZGluZ3NJbmRleDtcclxuXHRwcml2YXRlIHJlYWRvbmx5IGlzRW5hYmxlZDogKCkgPT4gYm9vbGVhbjtcclxuXHRwcml2YXRlIHJlYWRvbmx5IGlzQWxsb3dlZFBhdGg6IChwYXRoOiBzdHJpbmcpID0+IGJvb2xlYW47XHJcblxyXG5cdGNvbnN0cnVjdG9yKGluZGV4OiBFbWJlZGRpbmdzSW5kZXgsIGlzRW5hYmxlZDogKCkgPT4gYm9vbGVhbiwgaXNBbGxvd2VkUGF0aDogKHBhdGg6IHN0cmluZykgPT4gYm9vbGVhbikge1xyXG5cdFx0dGhpcy5pbmRleCA9IGluZGV4O1xyXG5cdFx0dGhpcy5pc0VuYWJsZWQgPSBpc0VuYWJsZWQ7XHJcblx0XHR0aGlzLmlzQWxsb3dlZFBhdGggPSBpc0FsbG93ZWRQYXRoO1xyXG5cdH1cclxuXHJcblx0YXN5bmMgc2VhcmNoKHF1ZXJ5OiBSZXRyaWV2YWxRdWVyeSwgb3B0czogUmV0cmlldmFsT3B0aW9ucyk6IFByb21pc2U8Q29udGV4dEl0ZW1bXT4ge1xyXG5cdFx0aWYgKCF0aGlzLmlzRW5hYmxlZCgpKSByZXR1cm4gW107XHJcblx0XHRjb25zdCBxID0gKHF1ZXJ5LnRleHQgPz8gJycpLnRyaW0oKTtcclxuXHRcdGlmICghcSkgcmV0dXJuIFtdO1xyXG5cclxuXHRcdGF3YWl0IHRoaXMuaW5kZXguZW5zdXJlTG9hZGVkKCk7XHJcblxyXG5cdFx0Y29uc3QgcVZlYyA9IHRoaXMuaW5kZXguYnVpbGRRdWVyeVZlY3RvcihxKTtcclxuXHRcdGNvbnN0IGNodW5rcyA9IHRoaXMuaW5kZXguZ2V0QWxsQ2h1bmtzKCkuZmlsdGVyKChjKSA9PiB0aGlzLmlzQWxsb3dlZFBhdGgoYy5wYXRoKSk7XHJcblx0XHRpZiAoY2h1bmtzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdO1xyXG5cclxuXHRcdC8vIFNjb3JlIGFsbCBjaHVua3MuIEZvciBsYXJnZSB2YXVsdHMgdGhpcyBpcyBzdGlsbCB0eXBpY2FsbHkgZmFzdCBhdCAyNTYgZGltcy5cclxuXHRcdGNvbnN0IHNjb3JlZCA9IGNodW5rc1xyXG5cdFx0XHQubWFwKChjKSA9PiAoeyBjaHVuazogYywgc2NvcmU6IGRvdChxVmVjLCBjLnZlY3RvcikgfSkpXHJcblx0XHRcdC5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSlcclxuXHRcdFx0LnNsaWNlKDAsIE1hdGgubWF4KDEsIE1hdGgubWluKDIwMCwgb3B0cy5saW1pdCAqIDYpKSk7XHJcblxyXG5cdFx0Y29uc3QgcmVzdWx0czogQ29udGV4dEl0ZW1bXSA9IFtdO1xyXG5cdFx0Zm9yIChjb25zdCB7IGNodW5rLCBzY29yZSB9IG9mIHNjb3JlZCkge1xyXG5cdFx0XHRyZXN1bHRzLnB1c2goe1xyXG5cdFx0XHRcdGtleTogY2h1bmsua2V5LFxyXG5cdFx0XHRcdHBhdGg6IGNodW5rLnBhdGgsXHJcblx0XHRcdFx0dGl0bGU6IGNodW5rLnBhdGguc3BsaXQoJy8nKS5wb3AoKSxcclxuXHRcdFx0XHRleGNlcnB0OiBjaHVuay5leGNlcnB0LFxyXG5cdFx0XHRcdHNjb3JlOiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCAoc2NvcmUgKyAxKSAvIDIpKSxcclxuXHRcdFx0XHRzb3VyY2U6IHRoaXMuaWQsXHJcblx0XHRcdFx0cmVhc29uVGFnczogWydzZW1hbnRpYyddXHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiByZXN1bHRzLnNsaWNlKDAsIG9wdHMubGltaXQpO1xyXG5cdH1cclxufVxyXG5cclxuXHJcbiJdfQ==