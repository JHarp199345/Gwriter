function dot(a, b) {
    const n = Math.min(a.length, b.length);
    let s = 0;
    for (let i = 0; i < n; i++)
        s += a[i] * b[i];
    return s;
}
export class LocalEmbeddingsProvider {
    constructor(index, isEnabled, isAllowedPath) {
        this.id = 'semantic';
        this.index = index;
        this.isEnabled = isEnabled;
        this.isAllowedPath = isAllowedPath;
    }
    async search(query, opts) {
        if (!this.isEnabled())
            return [];
        const q = (query.text ?? '').trim();
        if (!q)
            return [];
        await this.index.ensureLoaded();
        let qVec;
        try {
            qVec = await this.index.embedQueryVector(q);
        }
        catch {
            // If true embeddings fail to load, treat as empty semantic results.
            return [];
        }
        const chunks = this.index.getAllChunks().filter((c) => this.isAllowedPath(c.path));
        if (chunks.length === 0)
            return [];
        // Score all chunks. For large vaults this is still typically fast at 256 dims.
        const scored = chunks
            .map((c) => ({ chunk: c, score: dot(qVec, c.vector) }))
            .sort((a, b) => b.score - a.score)
            .slice(0, Math.max(1, Math.min(200, opts.limit * 6)));
        const results = [];
        for (const { chunk, score } of scored) {
            results.push({
                key: chunk.key,
                path: chunk.path,
                title: chunk.path.split('/').pop(),
                excerpt: chunk.excerpt,
                score: Math.max(0, Math.min(1, (score + 1) / 2)),
                source: this.id,
                reasonTags: ['semantic']
            });
        }
        return results.slice(0, opts.limit);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9jYWxFbWJlZGRpbmdzUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJMb2NhbEVtYmVkZGluZ3NQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxTQUFTLEdBQUcsQ0FBQyxDQUFXLEVBQUUsQ0FBVztJQUNwQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNWLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0MsT0FBTyxDQUFDLENBQUM7QUFDVixDQUFDO0FBRUQsTUFBTSxPQUFPLHVCQUF1QjtJQU9uQyxZQUFZLEtBQXNCLEVBQUUsU0FBd0IsRUFBRSxhQUF3QztRQU43RixPQUFFLEdBQUcsVUFBVSxDQUFDO1FBT3hCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO0lBQ3BDLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQXFCLEVBQUUsSUFBc0I7UUFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUNqQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDcEMsSUFBSSxDQUFDLENBQUM7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUVsQixNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFaEMsSUFBSSxJQUFjLENBQUM7UUFDbkIsSUFBSSxDQUFDO1lBQ0osSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3QyxDQUFDO1FBQUMsTUFBTSxDQUFDO1lBQ1Isb0VBQW9FO1lBQ3BFLE9BQU8sRUFBRSxDQUFDO1FBQ1gsQ0FBQztRQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ25GLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFFbkMsK0VBQStFO1FBQy9FLE1BQU0sTUFBTSxHQUFHLE1BQU07YUFDbkIsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ3RELElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUNqQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXZELE1BQU0sT0FBTyxHQUFrQixFQUFFLENBQUM7UUFDbEMsS0FBSyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ3ZDLE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ1osR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHO2dCQUNkLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSTtnQkFDaEIsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRTtnQkFDbEMsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hELE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDZixVQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUM7YUFDeEIsQ0FBQyxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29udGV4dEl0ZW0sIFJldHJpZXZhbE9wdGlvbnMsIFJldHJpZXZhbFByb3ZpZGVyLCBSZXRyaWV2YWxRdWVyeSB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgdHlwZSB7IEVtYmVkZGluZ3NJbmRleCB9IGZyb20gJy4vRW1iZWRkaW5nc0luZGV4JztcclxuXHJcbmZ1bmN0aW9uIGRvdChhOiBudW1iZXJbXSwgYjogbnVtYmVyW10pOiBudW1iZXIge1xyXG5cdGNvbnN0IG4gPSBNYXRoLm1pbihhLmxlbmd0aCwgYi5sZW5ndGgpO1xyXG5cdGxldCBzID0gMDtcclxuXHRmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgcyArPSBhW2ldICogYltpXTtcclxuXHRyZXR1cm4gcztcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIExvY2FsRW1iZWRkaW5nc1Byb3ZpZGVyIGltcGxlbWVudHMgUmV0cmlldmFsUHJvdmlkZXIge1xyXG5cdHJlYWRvbmx5IGlkID0gJ3NlbWFudGljJztcclxuXHJcblx0cHJpdmF0ZSByZWFkb25seSBpbmRleDogRW1iZWRkaW5nc0luZGV4O1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgaXNFbmFibGVkOiAoKSA9PiBib29sZWFuO1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgaXNBbGxvd2VkUGF0aDogKHBhdGg6IHN0cmluZykgPT4gYm9vbGVhbjtcclxuXHJcblx0Y29uc3RydWN0b3IoaW5kZXg6IEVtYmVkZGluZ3NJbmRleCwgaXNFbmFibGVkOiAoKSA9PiBib29sZWFuLCBpc0FsbG93ZWRQYXRoOiAocGF0aDogc3RyaW5nKSA9PiBib29sZWFuKSB7XHJcblx0XHR0aGlzLmluZGV4ID0gaW5kZXg7XHJcblx0XHR0aGlzLmlzRW5hYmxlZCA9IGlzRW5hYmxlZDtcclxuXHRcdHRoaXMuaXNBbGxvd2VkUGF0aCA9IGlzQWxsb3dlZFBhdGg7XHJcblx0fVxyXG5cclxuXHRhc3luYyBzZWFyY2gocXVlcnk6IFJldHJpZXZhbFF1ZXJ5LCBvcHRzOiBSZXRyaWV2YWxPcHRpb25zKTogUHJvbWlzZTxDb250ZXh0SXRlbVtdPiB7XHJcblx0XHRpZiAoIXRoaXMuaXNFbmFibGVkKCkpIHJldHVybiBbXTtcclxuXHRcdGNvbnN0IHEgPSAocXVlcnkudGV4dCA/PyAnJykudHJpbSgpO1xyXG5cdFx0aWYgKCFxKSByZXR1cm4gW107XHJcblxyXG5cdFx0YXdhaXQgdGhpcy5pbmRleC5lbnN1cmVMb2FkZWQoKTtcclxuXHJcblx0XHRsZXQgcVZlYzogbnVtYmVyW107XHJcblx0XHR0cnkge1xyXG5cdFx0XHRxVmVjID0gYXdhaXQgdGhpcy5pbmRleC5lbWJlZFF1ZXJ5VmVjdG9yKHEpO1xyXG5cdFx0fSBjYXRjaCB7XHJcblx0XHRcdC8vIElmIHRydWUgZW1iZWRkaW5ncyBmYWlsIHRvIGxvYWQsIHRyZWF0IGFzIGVtcHR5IHNlbWFudGljIHJlc3VsdHMuXHJcblx0XHRcdHJldHVybiBbXTtcclxuXHRcdH1cclxuXHRcdGNvbnN0IGNodW5rcyA9IHRoaXMuaW5kZXguZ2V0QWxsQ2h1bmtzKCkuZmlsdGVyKChjKSA9PiB0aGlzLmlzQWxsb3dlZFBhdGgoYy5wYXRoKSk7XHJcblx0XHRpZiAoY2h1bmtzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdO1xyXG5cclxuXHRcdC8vIFNjb3JlIGFsbCBjaHVua3MuIEZvciBsYXJnZSB2YXVsdHMgdGhpcyBpcyBzdGlsbCB0eXBpY2FsbHkgZmFzdCBhdCAyNTYgZGltcy5cclxuXHRcdGNvbnN0IHNjb3JlZCA9IGNodW5rc1xyXG5cdFx0XHQubWFwKChjKSA9PiAoeyBjaHVuazogYywgc2NvcmU6IGRvdChxVmVjLCBjLnZlY3RvcikgfSkpXHJcblx0XHRcdC5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSlcclxuXHRcdFx0LnNsaWNlKDAsIE1hdGgubWF4KDEsIE1hdGgubWluKDIwMCwgb3B0cy5saW1pdCAqIDYpKSk7XHJcblxyXG5cdFx0Y29uc3QgcmVzdWx0czogQ29udGV4dEl0ZW1bXSA9IFtdO1xyXG5cdFx0Zm9yIChjb25zdCB7IGNodW5rLCBzY29yZSB9IG9mIHNjb3JlZCkge1xyXG5cdFx0XHRyZXN1bHRzLnB1c2goe1xyXG5cdFx0XHRcdGtleTogY2h1bmsua2V5LFxyXG5cdFx0XHRcdHBhdGg6IGNodW5rLnBhdGgsXHJcblx0XHRcdFx0dGl0bGU6IGNodW5rLnBhdGguc3BsaXQoJy8nKS5wb3AoKSxcclxuXHRcdFx0XHRleGNlcnB0OiBjaHVuay5leGNlcnB0LFxyXG5cdFx0XHRcdHNjb3JlOiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCAoc2NvcmUgKyAxKSAvIDIpKSxcclxuXHRcdFx0XHRzb3VyY2U6IHRoaXMuaWQsXHJcblx0XHRcdFx0cmVhc29uVGFnczogWydzZW1hbnRpYyddXHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiByZXN1bHRzLnNsaWNlKDAsIG9wdHMubGltaXQpO1xyXG5cdH1cclxufVxyXG5cclxuXHJcbiJdfQ==