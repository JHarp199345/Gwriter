function dot(a, b) {
    const n = Math.min(a.length, b.length);
    let s = 0;
    for (let i = 0; i < n; i++)
        s += a[i] * b[i];
    return s;
}
export class LocalEmbeddingsProvider {
    constructor(index, isEnabled, isAllowedPath) {
        this.id = 'semantic';
        this.index = index;
        this.isEnabled = isEnabled;
        this.isAllowedPath = isAllowedPath;
    }
    async search(query, opts) {
        if (!this.isEnabled())
            return [];
        const q = (query.text ?? '').trim();
        if (!q)
            return [];
        await this.index.ensureLoaded();
        let qVec;
        try {
            qVec = await this.index.embedQueryVector(q);
        }
        catch {
            // If true embeddings fail to load, treat as empty semantic results.
            return [];
        }
        const chunks = this.index.getAllChunks().filter((c) => this.isAllowedPath(c.path));
        if (chunks.length === 0)
            return [];
        // Score all chunks. For large vaults this is still typically fast at 256 dims.
        const scored = chunks
            .map((c) => ({ chunk: c, score: dot(qVec, c.vector) }))
            .sort((a, b) => b.score - a.score)
            .slice(0, Math.max(1, Math.min(200, opts.limit * 6)));
        const results = [];
        for (const { chunk, score } of scored) {
            results.push({
                key: chunk.key,
                path: chunk.path,
                title: chunk.path.split('/').pop(),
                excerpt: chunk.excerpt,
                score: Math.max(0, Math.min(1, (score + 1) / 2)),
                source: this.id,
                reasonTags: ['semantic']
            });
        }
        return results.slice(0, opts.limit);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9jYWxFbWJlZGRpbmdzUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJMb2NhbEVtYmVkZGluZ3NQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxTQUFTLEdBQUcsQ0FBQyxDQUFXLEVBQUUsQ0FBVztJQUNwQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNWLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0MsT0FBTyxDQUFDLENBQUM7QUFDVixDQUFDO0FBRUQsTUFBTSxPQUFPLHVCQUF1QjtJQU9uQyxZQUFZLEtBQXNCLEVBQUUsU0FBd0IsRUFBRSxhQUF3QztRQU43RixPQUFFLEdBQUcsVUFBVSxDQUFDO1FBT3hCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO0lBQ3BDLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQXFCLEVBQUUsSUFBc0I7UUFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUNqQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDcEMsSUFBSSxDQUFDLENBQUM7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUVsQixNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFaEMsSUFBSSxJQUFjLENBQUM7UUFDbkIsSUFBSSxDQUFDO1lBQ0osSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3QyxDQUFDO1FBQUMsTUFBTSxDQUFDO1lBQ1Isb0VBQW9FO1lBQ3BFLE9BQU8sRUFBRSxDQUFDO1FBQ1gsQ0FBQztRQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ25GLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFFbkMsK0VBQStFO1FBQy9FLE1BQU0sTUFBTSxHQUFHLE1BQU07YUFDbkIsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ3RELElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUNqQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXZELE1BQU0sT0FBTyxHQUFrQixFQUFFLENBQUM7UUFDbEMsS0FBSyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ3ZDLE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ1osR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHO2dCQUNkLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSTtnQkFDaEIsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRTtnQkFDbEMsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hELE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDZixVQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUM7YUFDeEIsQ0FBQyxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29udGV4dEl0ZW0sIFJldHJpZXZhbE9wdGlvbnMsIFJldHJpZXZhbFByb3ZpZGVyLCBSZXRyaWV2YWxRdWVyeSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHR5cGUgeyBFbWJlZGRpbmdzSW5kZXggfSBmcm9tICcuL0VtYmVkZGluZ3NJbmRleCc7XG5cbmZ1bmN0aW9uIGRvdChhOiBudW1iZXJbXSwgYjogbnVtYmVyW10pOiBudW1iZXIge1xuXHRjb25zdCBuID0gTWF0aC5taW4oYS5sZW5ndGgsIGIubGVuZ3RoKTtcblx0bGV0IHMgPSAwO1xuXHRmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgcyArPSBhW2ldICogYltpXTtcblx0cmV0dXJuIHM7XG59XG5cbmV4cG9ydCBjbGFzcyBMb2NhbEVtYmVkZGluZ3NQcm92aWRlciBpbXBsZW1lbnRzIFJldHJpZXZhbFByb3ZpZGVyIHtcblx0cmVhZG9ubHkgaWQgPSAnc2VtYW50aWMnO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgaW5kZXg6IEVtYmVkZGluZ3NJbmRleDtcblx0cHJpdmF0ZSByZWFkb25seSBpc0VuYWJsZWQ6ICgpID0+IGJvb2xlYW47XG5cdHByaXZhdGUgcmVhZG9ubHkgaXNBbGxvd2VkUGF0aDogKHBhdGg6IHN0cmluZykgPT4gYm9vbGVhbjtcblxuXHRjb25zdHJ1Y3RvcihpbmRleDogRW1iZWRkaW5nc0luZGV4LCBpc0VuYWJsZWQ6ICgpID0+IGJvb2xlYW4sIGlzQWxsb3dlZFBhdGg6IChwYXRoOiBzdHJpbmcpID0+IGJvb2xlYW4pIHtcblx0XHR0aGlzLmluZGV4ID0gaW5kZXg7XG5cdFx0dGhpcy5pc0VuYWJsZWQgPSBpc0VuYWJsZWQ7XG5cdFx0dGhpcy5pc0FsbG93ZWRQYXRoID0gaXNBbGxvd2VkUGF0aDtcblx0fVxuXG5cdGFzeW5jIHNlYXJjaChxdWVyeTogUmV0cmlldmFsUXVlcnksIG9wdHM6IFJldHJpZXZhbE9wdGlvbnMpOiBQcm9taXNlPENvbnRleHRJdGVtW10+IHtcblx0XHRpZiAoIXRoaXMuaXNFbmFibGVkKCkpIHJldHVybiBbXTtcblx0XHRjb25zdCBxID0gKHF1ZXJ5LnRleHQgPz8gJycpLnRyaW0oKTtcblx0XHRpZiAoIXEpIHJldHVybiBbXTtcblxuXHRcdGF3YWl0IHRoaXMuaW5kZXguZW5zdXJlTG9hZGVkKCk7XG5cblx0XHRsZXQgcVZlYzogbnVtYmVyW107XG5cdFx0dHJ5IHtcblx0XHRcdHFWZWMgPSBhd2FpdCB0aGlzLmluZGV4LmVtYmVkUXVlcnlWZWN0b3IocSk7XG5cdFx0fSBjYXRjaCB7XG5cdFx0XHQvLyBJZiB0cnVlIGVtYmVkZGluZ3MgZmFpbCB0byBsb2FkLCB0cmVhdCBhcyBlbXB0eSBzZW1hbnRpYyByZXN1bHRzLlxuXHRcdFx0cmV0dXJuIFtdO1xuXHRcdH1cblx0XHRjb25zdCBjaHVua3MgPSB0aGlzLmluZGV4LmdldEFsbENodW5rcygpLmZpbHRlcigoYykgPT4gdGhpcy5pc0FsbG93ZWRQYXRoKGMucGF0aCkpO1xuXHRcdGlmIChjaHVua3MubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG5cblx0XHQvLyBTY29yZSBhbGwgY2h1bmtzLiBGb3IgbGFyZ2UgdmF1bHRzIHRoaXMgaXMgc3RpbGwgdHlwaWNhbGx5IGZhc3QgYXQgMjU2IGRpbXMuXG5cdFx0Y29uc3Qgc2NvcmVkID0gY2h1bmtzXG5cdFx0XHQubWFwKChjKSA9PiAoeyBjaHVuazogYywgc2NvcmU6IGRvdChxVmVjLCBjLnZlY3RvcikgfSkpXG5cdFx0XHQuc29ydCgoYSwgYikgPT4gYi5zY29yZSAtIGEuc2NvcmUpXG5cdFx0XHQuc2xpY2UoMCwgTWF0aC5tYXgoMSwgTWF0aC5taW4oMjAwLCBvcHRzLmxpbWl0ICogNikpKTtcblxuXHRcdGNvbnN0IHJlc3VsdHM6IENvbnRleHRJdGVtW10gPSBbXTtcblx0XHRmb3IgKGNvbnN0IHsgY2h1bmssIHNjb3JlIH0gb2Ygc2NvcmVkKSB7XG5cdFx0XHRyZXN1bHRzLnB1c2goe1xuXHRcdFx0XHRrZXk6IGNodW5rLmtleSxcblx0XHRcdFx0cGF0aDogY2h1bmsucGF0aCxcblx0XHRcdFx0dGl0bGU6IGNodW5rLnBhdGguc3BsaXQoJy8nKS5wb3AoKSxcblx0XHRcdFx0ZXhjZXJwdDogY2h1bmsuZXhjZXJwdCxcblx0XHRcdFx0c2NvcmU6IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIChzY29yZSArIDEpIC8gMikpLFxuXHRcdFx0XHRzb3VyY2U6IHRoaXMuaWQsXG5cdFx0XHRcdHJlYXNvblRhZ3M6IFsnc2VtYW50aWMnXVxuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlc3VsdHMuc2xpY2UoMCwgb3B0cy5saW1pdCk7XG5cdH1cbn1cblxuXG4iXX0=