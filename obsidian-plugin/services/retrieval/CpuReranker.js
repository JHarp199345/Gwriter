import { fnv1a32 } from '../ContentHash';
function clamp01(x) {
    if (!Number.isFinite(x))
        return 0;
    return Math.max(0, Math.min(1, x));
}
function normalizeText(s) {
    return (s || '').replace(/\s+/g, ' ').trim();
}
/**
 * CPU reranker using @xenova/transformers (WASM). Loaded lazily.
 * If the model fails to load/run, callers should fall back to the pre-rerank order.
 */
class TransformersCrossEncoder {
    constructor() {
        this.id = 'cross-encoder-msmarco-minilm';
        this.pipeline = null;
        this.loading = null;
    }
    async ensureLoaded() {
        if (this.pipeline)
            return;
        if (this.loading !== null)
            return this.loading;
        this.loading = (async () => {
            const transformersUnknown = await import('@xenova/transformers');
            const transformers = transformersUnknown;
            if (!transformers.pipeline)
                throw new Error('Transformers pipeline is unavailable');
            // Cross-encoder reranker model (small-ish). Best-effort: may fail on some environments.
            const pipeUnknown = await transformers.pipeline('text-classification', 'Xenova/cross-encoder-ms-marco-MiniLM-L-6-v2', { quantized: true });
            const pipe = pipeUnknown;
            this.pipeline = async (input) => await pipe(input);
        })().finally(() => {
            this.loading = null;
        });
        return this.loading;
    }
    async rerankPair(query, document) {
        const q = normalizeText(query);
        const d = normalizeText(document);
        if (!q || !d)
            return { score: 0 };
        await this.ensureLoaded();
        if (!this.pipeline)
            throw new Error('Reranker pipeline unavailable');
        // Prefer pair input if supported by the pipeline implementation; fall back to concatenation.
        let out;
        try {
            out = await this.pipeline([{ text: q, text_pair: d }]);
        }
        catch {
            out = await this.pipeline(`${q}\n\n${d}`);
        }
        // Common output formats:
        // - [{ label: 'LABEL_1', score: 0.93 }, ...]
        // - { label, score }
        const first = Array.isArray(out) ? out[0] : out;
        const obj = first;
        const score = typeof obj?.score === 'number' ? obj.score : 0;
        return { score: clamp01(score) };
    }
}
export class CpuReranker {
    constructor(model) {
        // queryHash -> itemKey -> score
        this.cache = new Map();
        this.model = model ?? new TransformersCrossEncoder();
    }
    hashQuery(q) {
        return fnv1a32(normalizeText(q));
    }
    warm(query, items, opts) {
        const shortlist = Math.max(1, Math.min(120, Math.floor(opts?.shortlist ?? 40)));
        const qh = this.hashQuery(query);
        const map = this.cache.get(qh) ?? new Map();
        this.cache.set(qh, map);
        const toScore = items.slice(0, shortlist).filter((it) => !map.has(it.key));
        if (toScore.length === 0)
            return;
        // Fire-and-forget warmup; never block UI.
        void (async () => {
            for (const it of toScore) {
                try {
                    const doc = `${it.path}\n${it.excerpt}`;
                    const res = await this.model.rerankPair(query, doc);
                    map.set(it.key, res.score);
                }
                catch {
                    // stop warming if model fails
                    break;
                }
            }
        })().catch(() => {
            // ignore
        });
    }
    async rerank(query, items, opts) {
        const limit = Math.max(1, Math.min(200, Math.floor(opts.limit)));
        const shortlist = Math.max(limit, Math.min(120, Math.floor(opts.shortlist ?? 60)));
        const qh = this.hashQuery(query);
        const map = this.cache.get(qh) ?? new Map();
        this.cache.set(qh, map);
        const scored = [];
        const slice = items.slice(0, shortlist);
        for (const it of slice) {
            const cached = map.get(it.key);
            if (typeof cached === 'number') {
                scored.push({ item: it, score: cached });
                continue;
            }
            const doc = `${it.path}\n${it.excerpt}`;
            const res = await this.model.rerankPair(query, doc);
            map.set(it.key, res.score);
            scored.push({ item: it, score: res.score });
        }
        // Merge rerank score into final ordering; keep original score as secondary signal.
        const out = scored
            .sort((a, b) => b.score - a.score || b.item.score - a.item.score)
            .slice(0, limit)
            .map((s) => ({
            ...s.item,
            // Keep the score field as the rerank score so formatting reflects true order.
            score: s.score,
            source: 'rerank',
            reasonTags: Array.from(new Set([...(s.item.reasonTags ?? []), 'rerank']))
        }));
        return out;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3B1UmVyYW5rZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDcHVSZXJhbmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekMsU0FBUyxPQUFPLENBQUMsQ0FBUztJQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFBRSxPQUFPLENBQUMsQ0FBQztJQUNsQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFDLENBQVM7SUFDL0IsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQzlDLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxNQUFNLHdCQUF3QjtJQUE5QjtRQUNVLE9BQUUsR0FBRyw4QkFBOEIsQ0FBQztRQUVyQyxhQUFRLEdBRXdFLElBQUksQ0FBQztRQUNyRixZQUFPLEdBQXlCLElBQUksQ0FBQztJQW1EOUMsQ0FBQztJQWpEUSxLQUFLLENBQUMsWUFBWTtRQUN6QixJQUFJLElBQUksQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUMxQixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSTtZQUFFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUUvQyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDMUIsTUFBTSxtQkFBbUIsR0FBWSxNQUFNLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQzFFLE1BQU0sWUFBWSxHQUFHLG1CQUVwQixDQUFDO1lBQ0YsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRO2dCQUFFLE1BQU0sSUFBSSxL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QUssRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3hDLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3BELEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzdDLENBQUM7UUFFRCxtRkFBbUY7UUFDbkYsTUFBTSxHQUFHLEdBQUcsTUFBTTthQUNoQixJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDaEUsS0FBSyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUM7YUFDZixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDWixHQUFHLENBQUMsQ0FBQyxJQUFJO1lBQ1QsOEVBQThFO1lBQzlFLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSztZQUNkLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLFVBQVUsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7U0FDekUsQ0FBQyxDQUFDLENBQUM7UUFFTCxPQUFPLEdBQUcsQ0FBQztJQUNaLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29udGV4dEl0ZW0gfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB0eXBlIHsgQ3B1UmVyYW5rZXJNb2RlbCB9IGZyb20gJy4vUmVyYW5rZXJNb2RlbCc7XG5pbXBvcnQgeyBmbnYxYTMyIH0gZnJvbSAnLi4vQ29udGVudEhhc2gnO1xuXG5mdW5jdGlvbiBjbGFtcDAxKHg6IG51bWJlcik6IG51bWJlciB7XG5cdGlmICghTnVtYmVyLmlzRmluaXRlKHgpKSByZXR1cm4gMDtcblx0cmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHgpKTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplVGV4dChzOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRyZXR1cm4gKHMgfHwgJycpLnJlcGxhY2UoL1xccysvZywgJyAnKS50cmltKCk7XG59XG5cbi8qKlxuICogQ1BVIHJlcmFua2VyIHVzaW5nIEB4ZW5vdmEvdHJhbnNmb3JtZXJzIChXQVNNKS4gTG9hZGVkIGxhemlseS5cbiAqIElmIHRoZSBtb2RlbCBmYWlscyB0byBsb2FkL3J1biwgY2FsbGVycyBzaG91bGQgZmFsbCBiYWNrIHRvIHRoZSBwcmUtcmVyYW5rIG9yZGVyLlxuICovXG5jbGFzcyBUcmFuc2Zvcm1lcnNDcm9zc0VuY29kZXIgaW1wbGVtZW50cyBDcHVSZXJhbmtlck1vZGVsIHtcblx0cmVhZG9ubHkgaWQgPSAnY3Jvc3MtZW5jb2Rlci1tc21hcmNvLW1pbmlsbSc7XG5cblx0cHJpdmF0ZSBwaXBlbGluZTpcblx0XHR8IG51bGxcblx0XHR8ICgoaW5wdXQ6IHN0cmluZyB8IEFycmF5PHsgdGV4dDogc3RyaW5nOyB0ZXh0X3BhaXI6IHN0cmluZyB9PikgPT4gUHJvbWlzZTx1bmtub3duPikgPSBudWxsO1xuXHRwcml2YXRlIGxvYWRpbmc6IFByb21pc2U8dm9pZD4gfCBudWxsID0gbnVsbDtcblxuXHRwcml2YXRlIGFzeW5jIGVuc3VyZUxvYWRlZCgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRpZiAodGhpcy5waXBlbGluZSkgcmV0dXJuO1xuXHRcdGlmICh0aGlzLmxvYWRpbmcgIT09IG51bGwpIHJldHVybiB0aGlzLmxvYWRpbmc7XG5cblx0XHR0aGlzLmxvYWRpbmcgPSAoYXN5bmMgKCkgPT4ge1xuXHRcdFx0Y29uc3QgdHJhbnNmb3JtZXJzVW5rbm93bjogdW5rbm93biA9IGF3YWl0IGltcG9ydCgnQHhlbm92YS90cmFuc2Zvcm1lcnMnKTtcblx0XHRcdGNvbnN0IHRyYW5zZm9ybWVycyA9IHRyYW5zZm9ybWVyc1Vua25vd24gYXMge1xuXHRcdFx0XHRwaXBlbGluZT86ICh0YXNrOiBzdHJpbmcsIG1vZGVsOiBzdHJpbmcsIG9wdHM/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4gUHJvbWlzZTx1bmtub3duPjtcblx0XHRcdH07XG5cdFx0XHRpZiAoIXRyYW5zZm9ybWVycy5waXBlbGluZSkgdGhyb3cgbmV3IEVycm9yKCdUcmFuc2Zvcm1lcnMgcGlwZWxpbmUgaXMgdW5hdmFpbGFibGUnKTtcblxuXHRcdFx0Ly8gQ3Jvc3MtZW5jb2RlciByZXJhbmtlciBtb2RlbCAoc21hbGwtaXNoKS4gQmVzdC1lZmZvcnQ6IG1heSBmYWlsIG9uIHNvbWUgZW52aXJvbm1lbnRzLlxuXHRcdFx0Y29uc3QgcGlwZVVua25vd24gPSBhd2FpdCB0cmFuc2Zvcm1lcnMucGlwZWxpbmUoXG5cdFx0XHRcdCd0ZXh0LWNsYXNzaWZpY2F0aW9uJyxcblx0XHRcdFx0J1hlbm92YS9jcm9zcy1lbmNvZGVyLW1zLW1hcmNvLU1pbmlMTS1MLTYtdjInLFxuXHRcdFx0XHR7IHF1YW50aXplZDogdHJ1ZSB9XG5cdFx0XHQpO1xuXHRcdFx0Y29uc3QgcGlwZSA9IHBpcGVVbmtub3duIGFzIChpbnB1dDogdW5rbm93bikgPT4gUHJvbWlzZTx1bmtub3duPjtcblx0XHRcdHRoaXMucGlwZWxpbmUgPSBhc3luYyAoaW5wdXQpID0+IGF3YWl0IHBpcGUoaW5wdXQpO1xuXHRcdH0pKCkuZmluYWxseSgoKSA9PiB7XG5cdFx0XHR0aGlzLmxvYWRpbmcgPSBudWxsO1xuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIHRoaXMubG9hZGluZztcblx0fVxuXG5cdGFzeW5jIHJlcmFua1BhaXIocXVlcnk6IHN0cmluZywgZG9jdW1lbnQ6IHN0cmluZyk6IFByb21pc2U8eyBzY29yZTogbnVtYmVyIH0+IHtcblx0XHRjb25zdCBxID0gbm9ybWFsaXplVGV4dChxdWVyeSk7XG5cdFx0Y29uc3QgZCA9IG5vcm1hbGl6ZVRleHQoZG9jdW1lbnQpO1xuXHRcdGlmICghcSB8fCAhZCkgcmV0dXJuIHsgc2NvcmU6IDAgfTtcblx0XHRhd2FpdCB0aGlzLmVuc3VyZUxvYWRlZCgpO1xuXHRcdGlmICghdGhpcy5waXBlbGluZSkgdGhyb3cgbmV3IEVycm9yKCdSZXJhbmtlciBwaXBlbGluZSB1bmF2YWlsYWJsZScpO1xuXG5cdFx0Ly8gUHJlZmVyIHBhaXIgaW5wdXQgaWYgc3VwcG9ydGVkIGJ5IHRoZSBwaXBlbGluZSBpbXBsZW1lbnRhdGlvbjsgZmFsbCBiYWNrIHRvIGNvbmNhdGVuYXRpb24uXG5cdFx0bGV0IG91dDogdW5rbm93bjtcblx0XHR0cnkge1xuXHRcdFx0b3V0ID0gYXdhaXQgdGhpcy5waXBlbGluZShbeyB0ZXh0OiBxLCB0ZXh0X3BhaXI6IGQgfV0pO1xuXHRcdH0gY2F0Y2gge1xuXHRcdFx0b3V0ID0gYXdhaXQgdGhpcy5waXBlbGluZShgJHtxfVxcblxcbiR7ZH1gKTtcblx0XHR9XG5cblx0XHQvLyBDb21tb24gb3V0cHV0IGZvcm1hdHM6XG5cdFx0Ly8gLSBbeyBsYWJlbDogJ0xBQkVMXzEnLCBzY29yZTogMC45MyB9LCAuLi5dXG5cdFx0Ly8gLSB7IGxhYmVsLCBzY29yZSB9XG5cdFx0Y29uc3QgZmlyc3QgPSBBcnJheS5pc0FycmF5KG91dCkgPyBvdXRbMF0gOiBvdXQ7XG5cdFx0Y29uc3Qgb2JqID0gZmlyc3QgYXMgeyBzY29yZT86IHVua25vd247IGxhYmVsPzogdW5rbm93biB9O1xuXHRcdGNvbnN0IHNjb3JlID0gdHlwZW9mIG9iaj8uc2NvcmUgPT09ICdudW1iZXInID8gb2JqLnNjb3JlIDogMDtcblx0XHRyZXR1cm4geyBzY29yZTogY2xhbXAwMShzY29yZSkgfTtcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIENwdVJlcmFua09wdGlvbnMge1xuXHRsaW1pdDogbnVtYmVyOyAvLyBob3cgbWFueSBpdGVtcyB0byByZXR1cm5cblx0c2hvcnRsaXN0PzogbnVtYmVyOyAvLyBob3cgbWFueSB0byBzY29yZVxufVxuXG5leHBvcnQgY2xhc3MgQ3B1UmVyYW5rZXIge1xuXHRwcml2YXRlIHJlYWRvbmx5IG1vZGVsOiBDcHVSZXJhbmtlck1vZGVsO1xuXHQvLyBxdWVyeUhhc2ggLT4gaXRlbUtleSAtPiBzY29yZVxuXHRwcml2YXRlIHJlYWRvbmx5IGNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIG51bWJlcj4+KCk7XG5cblx0Y29uc3RydWN0b3IobW9kZWw/OiBDcHVSZXJhbmtlck1vZGVsKSB7XG5cdFx0dGhpcy5tb2RlbCA9IG1vZGVsID8/IG5ldyBUcmFuc2Zvcm1lcnNDcm9zc0VuY29kZXIoKTtcblx0fVxuXG5cdHByaXZhdGUgaGFzaFF1ZXJ5KHE6IHN0cmluZyk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIGZudjFhMzIobm9ybWFsaXplVGV4dChxKSk7XG5cdH1cblxuXHR3YXJtKHF1ZXJ5OiBzdHJpbmcsIGl0ZW1zOiBDb250ZXh0SXRlbVtdLCBvcHRzPzogeyBzaG9ydGxpc3Q/OiBudW1iZXIgfSk6IHZvaWQge1xuXHRcdGNvbnN0IHNob3J0bGlzdCA9IE1hdGgubWF4KDEsIE1hdGgubWluKDEyMCwgTWF0aC5mbG9vcihvcHRzPy5zaG9ydGxpc3QgPz8gNDApKSk7XG5cdFx0Y29uc3QgcWggPSB0aGlzLmhhc2hRdWVyeShxdWVyeSk7XG5cdFx0Y29uc3QgbWFwID0gdGhpcy5jYWNoZS5nZXQocWgpID8/IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cdFx0dGhpcy5jYWNoZS5zZXQocWgsIG1hcCk7XG5cblx0XHRjb25zdCB0b1Njb3JlID0gaXRlbXMuc2xpY2UoMCwgc2hvcnRsaXN0KS5maWx0ZXIoKGl0KSA9PiAhbWFwLmhhcyhpdC5rZXkpKTtcblx0XHRpZiAodG9TY29yZS5sZW5ndGggPT09IDApIHJldHVybjtcblxuXHRcdC8vIEZpcmUtYW5kLWZvcmdldCB3YXJtdXA7IG5ldmVyIGJsb2NrIFVJLlxuXHRcdHZvaWQgKGFzeW5jICgpID0+IHtcblx0XHRcdGZvciAoY29uc3QgaXQgb2YgdG9TY29yZSkge1xuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdGNvbnN0IGRvYyA9IGAke2l0LnBhdGh9XFxuJHtpdC5leGNlcnB0fWA7XG5cdFx0XHRcdFx0Y29uc3QgcmVzID0gYXdhaXQgdGhpcy5tb2RlbC5yZXJhbmtQYWlyKHF1ZXJ5LCBkb2MpO1xuXHRcdFx0XHRcdG1hcC5zZXQoaXQua2V5LCByZXMuc2NvcmUpO1xuXHRcdFx0XHR9IGNhdGNoIHtcblx0XHRcdFx0XHQvLyBzdG9wIHdhcm1pbmcgaWYgbW9kZWwgZmFpbHNcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pKCkuY2F0Y2goKCkgPT4ge1xuXHRcdFx0Ly8gaWdub3JlXG5cdFx0fSk7XG5cdH1cblxuXHRhc3luYyByZXJhbmsocXVlcnk6IHN0cmluZywgaXRlbXM6IENvbnRleHRJdGVtW10sIG9wdHM6IENwdVJlcmFua09wdGlvbnMpOiBQcm9taXNlPENvbnRleHRJdGVtW10+IHtcblx0XHRjb25zdCBsaW1pdCA9IE1hdGgubWF4KDEsIE1hdGgubWluKDIwMCwgTWF0aC5mbG9vcihvcHRzLmxpbWl0KSkpO1xuXHRcdGNvbnN0IHNob3J0bGlzdCA9IE1hdGgubWF4KGxpbWl0LCBNYXRoLm1pbigxMjAsIE1hdGguZmxvb3Iob3B0cy5zaG9ydGxpc3QgPz8gNjApKSk7XG5cdFx0Y29uc3QgcWggPSB0aGlzLmhhc2hRdWVyeShxdWVyeSk7XG5cdFx0Y29uc3QgbWFwID0gdGhpcy5jYWNoZS5nZXQocWgpID8/IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cdFx0dGhpcy5jYWNoZS5zZXQocWgsIG1hcCk7XG5cblx0XHRjb25zdCBzY29yZWQ6IEFycmF5PHsgaXRlbTogQ29udGV4dEl0ZW07IHNjb3JlOiBudW1iZXIgfT4gPSBbXTtcblx0XHRjb25zdCBzbGljZSA9IGl0ZW1zLnNsaWNlKDAsIHNob3J0bGlzdCk7XG5cdFx0Zm9yIChjb25zdCBpdCBvZiBzbGljZSkge1xuXHRcdFx0Y29uc3QgY2FjaGVkID0gbWFwLmdldChpdC5rZXkpO1xuXHRcdFx0aWYgKHR5cGVvZiBjYWNoZWQgPT09ICdudW1iZXInKSB7XG5cdFx0XHRcdHNjb3JlZC5wdXNoKHsgaXRlbTogaXQsIHNjb3JlOiBjYWNoZWQgfSk7XG5cdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0fVxuXHRcdFx0Y29uc3QgZG9jID0gYCR7aXQucGF0aH1cXG4ke2l0LmV4Y2VycHR9YDtcblx0XHRcdGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMubW9kZWwucmVyYW5rUGFpcihxdWVyeSwgZG9jKTtcblx0XHRcdG1hcC5zZXQoaXQua2V5LCByZXMuc2NvcmUpO1xuXHRcdFx0c2NvcmVkLnB1c2goeyBpdGVtOiBpdCwgc2NvcmU6IHJlcy5zY29yZSB9KTtcblx0XHR9XG5cblx0XHQvLyBNZXJnZSByZXJhbmsgc2NvcmUgaW50byBmaW5hbCBvcmRlcmluZzsga2VlcCBvcmlnaW5hbCBzY29yZSBhcyBzZWNvbmRhcnkgc2lnbmFsLlxuXHRcdGNvbnN0IG91dCA9IHNjb3JlZFxuXHRcdFx0LnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlIHx8IGIuaXRlbS5zY29yZSAtIGEuaXRlbS5zY29yZSlcblx0XHRcdC5zbGljZSgwLCBsaW1pdClcblx0XHRcdC5tYXAoKHMpID0+ICh7XG5cdFx0XHRcdC4uLnMuaXRlbSxcblx0XHRcdFx0Ly8gS2VlcCB0aGUgc2NvcmUgZmllbGQgYXMgdGhlIHJlcmFuayBzY29yZSBzbyBmb3JtYXR0aW5nIHJlZmxlY3RzIHRydWUgb3JkZXIuXG5cdFx0XHRcdHNjb3JlOiBzLnNjb3JlLFxuXHRcdFx0XHRzb3VyY2U6ICdyZXJhbmsnLFxuXHRcdFx0XHRyZWFzb25UYWdzOiBBcnJheS5mcm9tKG5ldyBTZXQoWy4uLihzLml0ZW0ucmVhc29uVGFncyA/PyBbXSksICdyZXJhbmsnXSkpXG5cdFx0XHR9KSk7XG5cblx0XHRyZXR1cm4gb3V0O1xuXHR9XG59XG5cblxuIl19