import { fnv1a32 } from '../ContentHash';
function clamp01(x) {
    if (!Number.isFinite(x))
        return 0;
    return Math.max(0, Math.min(1, x));
}
function normalizeText(s) {
    return (s || '').replace(/\s+/g, ' ').trim();
}
/**
 * CPU reranker using @xenova/transformers (WASM). Loaded lazily.
 * If the model fails to load/run, callers should fall back to the pre-rerank order.
 */
class TransformersCrossEncoder {
    constructor() {
        this.id = 'cross-encoder-msmarco-minilm';
        this.pipeline = null;
        this.loading = null;
    }
    async ensureLoaded() {
        if (this.pipeline)
            return;
        if (this.loading !== null)
            return this.loading;
        this.loading = (async () => {
            const transformersModule = await import('@xenova/transformers');
            // @xenova/transformers exports pipeline as a named export
            // It might be on the default export or as a named export
            const pipeline = transformersModule.pipeline || transformersModule.default?.pipeline;
            if (!pipeline || typeof pipeline !== 'function') {
                throw new Error('Transformers pipeline is unavailable');
            }
            // Cross-encoder reranker model (small-ish). Best-effort: may fail on some environments.
            const pipeUnknown = await pipeline('text-classification', 'Xenova/cross-encoder-ms-marco-MiniLM-L-6-v2', { quantized: true });
            const pipe = pipeUnknown;
            this.pipeline = async (input) => await pipe(input);
        })().finally(() => {
            this.loading = null;
        });
        return this.loading;
    }
    async rerankPair(query, document) {
        const q = normalizeText(query);
        const d = normalizeText(document);
        if (!q || !d)
            return { score: 0 };
        await this.ensureLoaded();
        if (!this.pipeline)
            throw new Error('Reranker pipeline unavailable');
        // Prefer pair input if supported by the pipeline implementation; fall back to concatenation.
        let out;
        try {
            out = await this.pipeline([{ text: q, text_pair: d }]);
        }
        catch {
            out = await this.pipeline(`${q}\n\n${d}`);
        }
        // Common output formats:
        // - [{ label: 'LABEL_1', score: 0.93 }, ...]
        // - { label, score }
        const first = Array.isArray(out) ? out[0] : out;
        const obj = first;
        const score = typeof obj?.score === 'number' ? obj.score : 0;
        return { score: clamp01(score) };
    }
}
export class CpuReranker {
    constructor(model) {
        // queryHash -> itemKey -> score
        this.cache = new Map();
        this.model = model ?? new TransformersCrossEncoder();
    }
    hashQuery(q) {
        return fnv1a32(normalizeText(q));
    }
    warm(query, items, opts) {
        const shortlist = Math.max(1, Math.min(120, Math.floor(opts?.shortlist ?? 40)));
        const qh = this.hashQuery(query);
        const map = this.cache.get(qh) ?? new Map();
        this.cache.set(qh, map);
        const toScore = items.slice(0, shortlist).filter((it) => !map.has(it.key));
        if (toScore.length === 0)
            return;
        // Fire-and-forget warmup; never block UI.
        void (async () => {
            for (const it of toScore) {
                try {
                    const doc = `${it.path}\n${it.excerpt}`;
                    const res = await this.model.rerankPair(query, doc);
                    map.set(it.key, res.score);
                }
                catch {
                    // stop warming if model fails
                    break;
                }
            }
        })().catch(() => {
            // ignore
        });
    }
    async rerank(query, items, opts) {
        const limit = Math.max(1, Math.min(200, Math.floor(opts.limit)));
        const shortlist = Math.max(limit, Math.min(120, Math.floor(opts.shortlist ?? 60)));
        const qh = this.hashQuery(query);
        const map = this.cache.get(qh) ?? new Map();
        this.cache.set(qh, map);
        const scored = [];
        const slice = items.slice(0, shortlist);
        for (const it of slice) {
            const cached = map.get(it.key);
            if (typeof cached === 'number') {
                scored.push({ item: it, score: cached });
                continue;
            }
            const doc = `${it.path}\n${it.excerpt}`;
            const res = await this.model.rerankPair(query, doc);
            map.set(it.key, res.score);
            scored.push({ item: it, score: res.score });
        }
        // Merge rerank score into final ordering; keep original score as secondary signal.
        const out = scored
            .sort((a, b) => b.score - a.score || b.item.score - a.item.score)
            .slice(0, limit)
            .map((s) => ({
            ...s.item,
            // Keep the score field as the rerank score so formatting reflects true order.
            score: s.score,
            source: 'rerank',
            reasonTags: Array.from(new Set([...(s.item.reasonTags ?? []), 'rerank']))
        }));
        return out;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3B1UmVyYW5rZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDcHVSZXJhbmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekMsU0FBUyxPQUFPLENBQUMsQ0FBUztJQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFBRSxPQUFPLENBQUMsQ0FBQztJQUNsQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFDLENBQVM7SUFDL0IsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQzlDLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxNQUFNLHdCQUF3QjtJQUE5QjtRQUNVLE9BQUUsR0FBRyw4QkFBOEIsQ0FBQztRQUVyQyxhQUFRLEdBRXdFLElBQUksQ0FBQztRQUNyRixZQUFPLEdBQXlCLElBQUksQ0FBQztJQXFEOUMsQ0FBQztJQW5EUSxLQUFLLENBQUMsWUFBWTtRQUN6QixJQUFJLElBQUksQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUMxQixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSTtZQUFFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUUvQyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDMUIsTUFBTSxrQkFBa0IsR0FBUSxNQUFNLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQ3JFLDBEQUEwRDtZQUMxRCx5REFBeUQ7WUFDekQsTUFBTSxRQUFRLEdBQUcsa0JBQWtCLENBQUMsUUFBUSxJQUFJLGtCQUFrQixDQUFD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RyxDQUFDO0lBQ1osQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDb250ZXh0SXRlbSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHR5cGUgeyBDcHVSZXJhbmtlck1vZGVsIH0gZnJvbSAnLi9SZXJhbmtlck1vZGVsJztcbmltcG9ydCB7IGZudjFhMzIgfSBmcm9tICcuLi9Db250ZW50SGFzaCc7XG5cbmZ1bmN0aW9uIGNsYW1wMDEoeDogbnVtYmVyKTogbnVtYmVyIHtcblx0aWYgKCFOdW1iZXIuaXNGaW5pdGUoeCkpIHJldHVybiAwO1xuXHRyZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgeCkpO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVUZXh0KHM6IHN0cmluZyk6IHN0cmluZyB7XG5cdHJldHVybiAocyB8fCAnJykucmVwbGFjZSgvXFxzKy9nLCAnICcpLnRyaW0oKTtcbn1cblxuLyoqXG4gKiBDUFUgcmVyYW5rZXIgdXNpbmcgQHhlbm92YS90cmFuc2Zvcm1lcnMgKFdBU00pLiBMb2FkZWQgbGF6aWx5LlxuICogSWYgdGhlIG1vZGVsIGZhaWxzIHRvIGxvYWQvcnVuLCBjYWxsZXJzIHNob3VsZCBmYWxsIGJhY2sgdG8gdGhlIHByZS1yZXJhbmsgb3JkZXIuXG4gKi9cbmNsYXNzIFRyYW5zZm9ybWVyc0Nyb3NzRW5jb2RlciBpbXBsZW1lbnRzIENwdVJlcmFua2VyTW9kZWwge1xuXHRyZWFkb25seSBpZCA9ICdjcm9zcy1lbmNvZGVyLW1zbWFyY28tbWluaWxtJztcblxuXHRwcml2YXRlIHBpcGVsaW5lOlxuXHRcdHwgbnVsbFxuXHRcdHwgKChpbnB1dDogc3RyaW5nIHwgQXJyYXk8eyB0ZXh0OiBzdHJpbmc7IHRleHRfcGFpcjogc3RyaW5nIH0+KSA9PiBQcm9taXNlPHVua25vd24+KSA9IG51bGw7XG5cdHByaXZhdGUgbG9hZGluZzogUHJvbWlzZTx2b2lkPiB8IG51bGwgPSBudWxsO1xuXG5cdHByaXZhdGUgYXN5bmMgZW5zdXJlTG9hZGVkKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGlmICh0aGlzLnBpcGVsaW5lKSByZXR1cm47XG5cdFx0aWYgKHRoaXMubG9hZGluZyAhPT0gbnVsbCkgcmV0dXJuIHRoaXMubG9hZGluZztcblxuXHRcdHRoaXMubG9hZGluZyA9IChhc3luYyAoKSA9PiB7XG5cdFx0XHRjb25zdCB0cmFuc2Zvcm1lcnNNb2R1bGU6IGFueSA9IGF3YWl0IGltcG9ydCgnQHhlbm92YS90cmFuc2Zvcm1lcnMnKTtcblx0XHRcdC8vIEB4ZW5vdmEvdHJhbnNmb3JtZXJzIGV4cG9ydHMgcGlwZWxpbmUgYXMgYSBuYW1lZCBleHBvcnRcblx0XHRcdC8vIEl0IG1pZ2h0IGJlIG9uIHRoZSBkZWZhdWx0IGV4cG9ydCBvciBhcyBhIG5hbWVkIGV4cG9ydFxuXHRcdFx0Y29uc3QgcGlwZWxpbmUgPSB0cmFuc2Zvcm1lcnNNb2R1bGUucGlwZWxpbmUgfHwgdHJhbnNmb3JtZXJzTW9kdWxlLmRlZmF1bHQ/LnBpcGVsaW5lO1xuXHRcdFx0aWYgKCFwaXBlbGluZSB8fCB0eXBlb2YgcGlwZWxpbmUgIT09ICdmdW5jdGlvbicpIHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdUcmFuc2Zvcm1lcnMgcGlwZWxpbmUgaXMgdW5hdmFpbGFibGUnKTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gQ3Jvc3MtZW5jb2RlciByZXJhbmtlciBtb2RlbCAoc21hbGwtaXNoKS4gQmVzdC1lZmZvcnQ6IG1heSBmYWlsIG9uIHNvbWUgZW52aXJvbm1lbnRzLlxuXHRcdFx0Y29uc3QgcGlwZVVua25vd24gPSBhd2FpdCBwaXBlbGluZShcblx0XHRcdFx0J3RleHQtY2xhc3NpZmljYXRpb24nLFxuXHRcdFx0XHQnWGVub3ZhL2Nyb3NzLWVuY29kZXItbXMtbWFyY28tTWluaUxNLUwtNi12MicsXG5cdFx0XHRcdHsgcXVhbnRpemVkOiB0cnVlIH1cblx0XHRcdCk7XG5cdFx0XHRjb25zdCBwaXBlID0gcGlwZVVua25vd24gYXMgKGlucHV0OiB1bmtub3duKSA9PiBQcm9taXNlPHVua25vd24+O1xuXHRcdFx0dGhpcy5waXBlbGluZSA9IGFzeW5jIChpbnB1dCkgPT4gYXdhaXQgcGlwZShpbnB1dCk7XG5cdFx0fSkoKS5maW5hbGx5KCgpID0+IHtcblx0XHRcdHRoaXMubG9hZGluZyA9IG51bGw7XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gdGhpcy5sb2FkaW5nO1xuXHR9XG5cblx0YXN5bmMgcmVyYW5rUGFpcihxdWVyeTogc3RyaW5nLCBkb2N1bWVudDogc3RyaW5nKTogUHJvbWlzZTx7IHNjb3JlOiBudW1iZXIgfT4ge1xuXHRcdGNvbnN0IHEgPSBub3JtYWxpemVUZXh0KHF1ZXJ5KTtcblx0XHRjb25zdCBkID0gbm9ybWFsaXplVGV4dChkb2N1bWVudCk7XG5cdFx0aWYgKCFxIHx8ICFkKSByZXR1cm4geyBzY29yZTogMCB9O1xuXHRcdGF3YWl0IHRoaXMuZW5zdXJlTG9hZGVkKCk7XG5cdFx0aWYgKCF0aGlzLnBpcGVsaW5lKSB0aHJvdyBuZXcgRXJyb3IoJ1JlcmFua2VyIHBpcGVsaW5lIHVuYXZhaWxhYmxlJyk7XG5cblx0XHQvLyBQcmVmZXIgcGFpciBpbnB1dCBpZiBzdXBwb3J0ZWQgYnkgdGhlIHBpcGVsaW5lIGltcGxlbWVudGF0aW9uOyBmYWxsIGJhY2sgdG8gY29uY2F0ZW5hdGlvbi5cblx0XHRsZXQgb3V0OiB1bmtub3duO1xuXHRcdHRyeSB7XG5cdFx0XHRvdXQgPSBhd2FpdCB0aGlzLnBpcGVsaW5lKFt7IHRleHQ6IHEsIHRleHRfcGFpcjogZCB9XSk7XG5cdFx0fSBjYXRjaCB7XG5cdFx0XHRvdXQgPSBhd2FpdCB0aGlzLnBpcGVsaW5lKGAke3F9XFxuXFxuJHtkfWApO1xuXHRcdH1cblxuXHRcdC8vIENvbW1vbiBvdXRwdXQgZm9ybWF0czpcblx0XHQvLyAtIFt7IGxhYmVsOiAnTEFCRUxfMScsIHNjb3JlOiAwLjkzIH0sIC4uLl1cblx0XHQvLyAtIHsgbGFiZWwsIHNjb3JlIH1cblx0XHRjb25zdCBmaXJzdCA9IEFycmF5LmlzQXJyYXkob3V0KSA/IG91dFswXSA6IG91dDtcblx0XHRjb25zdCBvYmogPSBmaXJzdCBhcyB7IHNjb3JlPzogdW5rbm93bjsgbGFiZWw/OiB1bmtub3duIH07XG5cdFx0Y29uc3Qgc2NvcmUgPSB0eXBlb2Ygb2JqPy5zY29yZSA9PT0gJ251bWJlcicgPyBvYmouc2NvcmUgOiAwO1xuXHRcdHJldHVybiB7IHNjb3JlOiBjbGFtcDAxKHNjb3JlKSB9O1xuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3B1UmVyYW5rT3B0aW9ucyB7XG5cdGxpbWl0OiBudW1iZXI7IC8vIGhvdyBtYW55IGl0ZW1zIHRvIHJldHVyblxuXHRzaG9ydGxpc3Q/OiBudW1iZXI7IC8vIGhvdyBtYW55IHRvIHNjb3JlXG59XG5cbmV4cG9ydCBjbGFzcyBDcHVSZXJhbmtlciB7XG5cdHByaXZhdGUgcmVhZG9ubHkgbW9kZWw6IENwdVJlcmFua2VyTW9kZWw7XG5cdC8vIHF1ZXJ5SGFzaCAtPiBpdGVtS2V5IC0+IHNjb3JlXG5cdHByaXZhdGUgcmVhZG9ubHkgY2FjaGUgPSBuZXcgTWFwPHN0cmluZywgTWFwPHN0cmluZywgbnVtYmVyPj4oKTtcblxuXHRjb25zdHJ1Y3Rvcihtb2RlbD86IENwdVJlcmFua2VyTW9kZWwpIHtcblx0XHR0aGlzLm1vZGVsID0gbW9kZWwgPz8gbmV3IFRyYW5zZm9ybWVyc0Nyb3NzRW5jb2RlcigpO1xuXHR9XG5cblx0cHJpdmF0ZSBoYXNoUXVlcnkocTogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gZm52MWEzMihub3JtYWxpemVUZXh0KHEpKTtcblx0fVxuXG5cdHdhcm0ocXVlcnk6IHN0cmluZywgaXRlbXM6IENvbnRleHRJdGVtW10sIG9wdHM/OiB7IHNob3J0bGlzdD86IG51bWJlciB9KTogdm9pZCB7XG5cdFx0Y29uc3Qgc2hvcnRsaXN0ID0gTWF0aC5tYXgoMSwgTWF0aC5taW4oMTIwLCBNYXRoLmZsb29yKG9wdHM/LnNob3J0bGlzdCA/PyA0MCkpKTtcblx0XHRjb25zdCBxaCA9IHRoaXMuaGFzaFF1ZXJ5KHF1ZXJ5KTtcblx0XHRjb25zdCBtYXAgPSB0aGlzLmNhY2hlLmdldChxaCkgPz8gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcblx0XHR0aGlzLmNhY2hlLnNldChxaCwgbWFwKTtcblxuXHRcdGNvbnN0IHRvU2NvcmUgPSBpdGVtcy5zbGljZSgwLCBzaG9ydGxpc3QpLmZpbHRlcigoaXQpID0+ICFtYXAuaGFzKGl0LmtleSkpO1xuXHRcdGlmICh0b1Njb3JlLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuXG5cdFx0Ly8gRmlyZS1hbmQtZm9yZ2V0IHdhcm11cDsgbmV2ZXIgYmxvY2sgVUkuXG5cdFx0dm9pZCAoYXN5bmMgKCkgPT4ge1xuXHRcdFx0Zm9yIChjb25zdCBpdCBvZiB0b1Njb3JlKSB7XG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0Y29uc3QgZG9jID0gYCR7aXQucGF0aH1cXG4ke2l0LmV4Y2VycHR9YDtcblx0XHRcdFx0XHRjb25zdCByZXMgPSBhd2FpdCB0aGlzLm1vZGVsLnJlcmFua1BhaXIocXVlcnksIGRvYyk7XG5cdFx0XHRcdFx0bWFwLnNldChpdC5rZXksIHJlcy5zY29yZSk7XG5cdFx0XHRcdH0gY2F0Y2gge1xuXHRcdFx0XHRcdC8vIHN0b3Agd2FybWluZyBpZiBtb2RlbCBmYWlsc1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSkoKS5jYXRjaCgoKSA9PiB7XG5cdFx0XHQvLyBpZ25vcmVcblx0XHR9KTtcblx0fVxuXG5cdGFzeW5jIHJlcmFuayhxdWVyeTogc3RyaW5nLCBpdGVtczogQ29udGV4dEl0ZW1bXSwgb3B0czogQ3B1UmVyYW5rT3B0aW9ucyk6IFByb21pc2U8Q29udGV4dEl0ZW1bXT4ge1xuXHRcdGNvbnN0IGxpbWl0ID0gTWF0aC5tYXgoMSwgTWF0aC5taW4oMjAwLCBNYXRoLmZsb29yKG9wdHMubGltaXQpKSk7XG5cdFx0Y29uc3Qgc2hvcnRsaXN0ID0gTWF0aC5tYXgobGltaXQsIE1hdGgubWluKDEyMCwgTWF0aC5mbG9vcihvcHRzLnNob3J0bGlzdCA/PyA2MCkpKTtcblx0XHRjb25zdCBxaCA9IHRoaXMuaGFzaFF1ZXJ5KHF1ZXJ5KTtcblx0XHRjb25zdCBtYXAgPSB0aGlzLmNhY2hlLmdldChxaCkgPz8gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcblx0XHR0aGlzLmNhY2hlLnNldChxaCwgbWFwKTtcblxuXHRcdGNvbnN0IHNjb3JlZDogQXJyYXk8eyBpdGVtOiBDb250ZXh0SXRlbTsgc2NvcmU6IG51bWJlciB9PiA9IFtdO1xuXHRcdGNvbnN0IHNsaWNlID0gaXRlbXMuc2xpY2UoMCwgc2hvcnRsaXN0KTtcblx0XHRmb3IgKGNvbnN0IGl0IG9mIHNsaWNlKSB7XG5cdFx0XHRjb25zdCBjYWNoZWQgPSBtYXAuZ2V0KGl0LmtleSk7XG5cdFx0XHRpZiAodHlwZW9mIGNhY2hlZCA9PT0gJ251bWJlcicpIHtcblx0XHRcdFx0c2NvcmVkLnB1c2goeyBpdGVtOiBpdCwgc2NvcmU6IGNhY2hlZCB9KTtcblx0XHRcdFx0Y29udGludWU7XG5cdFx0XHR9XG5cdFx0XHRjb25zdCBkb2MgPSBgJHtpdC5wYXRofVxcbiR7aXQuZXhjZXJwdH1gO1xuXHRcdFx0Y29uc3QgcmVzID0gYXdhaXQgdGhpcy5tb2RlbC5yZXJhbmtQYWlyKHF1ZXJ5LCBkb2MpO1xuXHRcdFx0bWFwLnNldChpdC5rZXksIHJlcy5zY29yZSk7XG5cdFx0XHRzY29yZWQucHVzaCh7IGl0ZW06IGl0LCBzY29yZTogcmVzLnNjb3JlIH0pO1xuXHRcdH1cblxuXHRcdC8vIE1lcmdlIHJlcmFuayBzY29yZSBpbnRvIGZpbmFsIG9yZGVyaW5nOyBrZWVwIG9yaWdpbmFsIHNjb3JlIGFzIHNlY29uZGFyeSBzaWduYWwuXG5cdFx0Y29uc3Qgb3V0ID0gc2NvcmVkXG5cdFx0XHQuc29ydCgoYSwgYikgPT4gYi5zY29yZSAtIGEuc2NvcmUgfHwgYi5pdGVtLnNjb3JlIC0gYS5pdGVtLnNjb3JlKVxuXHRcdFx0LnNsaWNlKDAsIGxpbWl0KVxuXHRcdFx0Lm1hcCgocykgPT4gKHtcblx0XHRcdFx0Li4ucy5pdGVtLFxuXHRcdFx0XHQvLyBLZWVwIHRoZSBzY29yZSBmaWVsZCBhcyB0aGUgcmVyYW5rIHNjb3JlIHNvIGZvcm1hdHRpbmcgcmVmbGVjdHMgdHJ1ZSBvcmRlci5cblx0XHRcdFx0c2NvcmU6IHMuc2NvcmUsXG5cdFx0XHRcdHNvdXJjZTogJ3JlcmFuaycsXG5cdFx0XHRcdHJlYXNvblRhZ3M6IEFycmF5LmZyb20obmV3IFNldChbLi4uKHMuaXRlbS5yZWFzb25UYWdzID8/IFtdKSwgJ3JlcmFuayddKSlcblx0XHRcdH0pKTtcblxuXHRcdHJldHVybiBvdXQ7XG5cdH1cbn1cblxuXG4iXX0=