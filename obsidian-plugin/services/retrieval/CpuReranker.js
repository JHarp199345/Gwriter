import { fnv1a32 } from '../ContentHash';
function clamp01(x) {
    if (!Number.isFinite(x))
        return 0;
    return Math.max(0, Math.min(1, x));
}
function normalizeText(s) {
    return (s || '').replace(/\s+/g, ' ').trim();
}
/**
 * CPU reranker using @xenova/transformers (WASM). Loaded lazily.
 * If the model fails to load/run, callers should fall back to the pre-rerank order.
 */
class TransformersCrossEncoder {
    constructor() {
        this.id = 'cross-encoder-msmarco-minilm';
        this.pipeline = null;
        this.loading = null;
    }
    async ensureLoaded() {
        if (this.pipeline)
            return;
        if (this.loading !== null)
            return this.loading;
        this.loading = (async () => {
            // Import the vendored transformers library
            const transformersModule = await import('../../lib/transformers.js');
            // Configure WASM paths - use object mapping for individual files
            if (transformersModule.env && transformersModule.env.backends && transformersModule.env.backends.onnx) {
                const onnxEnv = transformersModule.env.backends.onnx;
                if (!onnxEnv.wasm)
                    onnxEnv.wasm = {};
                const wasmFiles = [
                    'ort-wasm.wasm',
                    'ort-wasm-simd.wasm',
                    'ort-wasm-threaded.wasm',
                    'ort-wasm-simd-threaded.wasm'
                ];
                const wasmPaths = {};
                for (const wasmFile of wasmFiles) {
                    wasmPaths[wasmFile] = `./lib/${wasmFile}`;
                }
                onnxEnv.wasm.wasmPaths = wasmPaths;
                console.log(`[CpuReranker] Configured WASM paths:`, wasmPaths);
            }
            // @xenova/transformers exports pipeline as a named export
            // It might be on the default export or as a named export
            const pipeline = transformersModule.pipeline || transformersModule.default?.pipeline;
            if (!pipeline || typeof pipeline !== 'function') {
                throw new Error('Transformers pipeline is unavailable');
            }
            // Cross-encoder reranker model (small-ish). Best-effort: may fail on some environments.
            const pipeUnknown = await pipeline('text-classification', 'Xenova/cross-encoder-ms-marco-MiniLM-L-6-v2', { quantized: true });
            const pipe = pipeUnknown;
            this.pipeline = async (input) => await pipe(input);
        })().finally(() => {
            this.loading = null;
        });
        return this.loading;
    }
    async rerankPair(query, document) {
        const q = normalizeText(query);
        const d = normalizeText(document);
        if (!q || !d)
            return { score: 0 };
        await this.ensureLoaded();
        if (!this.pipeline)
            throw new Error('Reranker pipeline unavailable');
        // Prefer pair input if supported by the pipeline implementation; fall back to concatenation.
        let out;
        try {
            out = await this.pipeline([{ text: q, text_pair: d }]);
        }
        catch {
            out = await this.pipeline(`${q}\n\n${d}`);
        }
        // Common output formats:
        // - [{ label: 'LABEL_1', score: 0.93 }, ...]
        // - { label, score }
        const first = Array.isArray(out) ? out[0] : out;
        const obj = first;
        const score = typeof obj?.score === 'number' ? obj.score : 0;
        return { score: clamp01(score) };
    }
}
export class CpuReranker {
    constructor(model) {
        // queryHash -> itemKey -> score
        this.cache = new Map();
        this.model = model ?? new TransformersCrossEncoder();
    }
    hashQuery(q) {
        return fnv1a32(normalizeText(q));
    }
    warm(query, items, opts) {
        const shortlist = Math.max(1, Math.min(120, Math.floor(opts?.shortlist ?? 40)));
        const qh = this.hashQuery(query);
        const map = this.cache.get(qh) ?? new Map();
        this.cache.set(qh, map);
        const toScore = items.slice(0, shortlist).filter((it) => !map.has(it.key));
        if (toScore.length === 0)
            return;
        // Fire-and-forget warmup; never block UI.
        void (async () => {
            for (const it of toScore) {
                try {
                    const doc = `${it.path}\n${it.excerpt}`;
                    const res = await this.model.rerankPair(query, doc);
                    map.set(it.key, res.score);
                }
                catch {
                    // stop warming if model fails
                    break;
                }
            }
        })().catch(() => {
            // ignore
        });
    }
    async rerank(query, items, opts) {
        const limit = Math.max(1, Math.min(200, Math.floor(opts.limit)));
        const shortlist = Math.max(limit, Math.min(120, Math.floor(opts.shortlist ?? 60)));
        const qh = this.hashQuery(query);
        const map = this.cache.get(qh) ?? new Map();
        this.cache.set(qh, map);
        const scored = [];
        const slice = items.slice(0, shortlist);
        for (const it of slice) {
            const cached = map.get(it.key);
            if (typeof cached === 'number') {
                scored.push({ item: it, score: cached });
                continue;
            }
            const doc = `${it.path}\n${it.excerpt}`;
            const res = await this.model.rerankPair(query, doc);
            map.set(it.key, res.score);
            scored.push({ item: it, score: res.score });
        }
        // Merge rerank score into final ordering; keep original score as secondary signal.
        const out = scored
            .sort((a, b) => b.score - a.score || b.item.score - a.item.score)
            .slice(0, limit)
            .map((s) => ({
            ...s.item,
            // Keep the score field as the rerank score so formatting reflects true order.
            score: s.score,
            source: 'rerank',
            reasonTags: Array.from(new Set([...(s.item.reasonTags ?? []), 'rerank']))
        }));
        return out;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3B1UmVyYW5rZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDcHVSZXJhbmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekMsU0FBUyxPQUFPLENBQUMsQ0FBUztJQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFBRSxPQUFPLENBQUMsQ0FBQztJQUNsQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFDLENBQVM7SUFDL0IsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQzlDLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxNQUFNLHdCQUF3QjtJQUE5QjtRQUNVLE9BQUUsR0FBRyw4QkFBOEIsQ0FBQztRQUVyQyxhQUFRLEdBRXdFLElBQUksQ0FBQztRQUNyRixZQUFPLEdBQXlCLElBQUksQ0FBQztJQTRFOUMsQ0FBQztJQTFFUSxLQUFLLENBQUMsWUFBWTtRQUN6QixJQUFJLElBQUksQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUMxQixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSTtZQUFFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUUvQyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDMUIsMkNBQTJDO1lBQzNDLE1BQU0sa0JBQWtCLEdBQVEsTUFBTSxNQUFNLENBQUMsMkJBQTJCLENBQUMsQ0FBQztZQUUxRSxpRUFBaUU7WUFDakUsSUFBSSxrQkFBa0IsQ0FBQyxHQUFHLElBQUksa0JBQWtCLENBQUMsR0FBRyxDQUFD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LENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUM3QyxDQUFDO1FBRUQsbUZBQW1GO1FBQ25GLE1BQU0sR0FBRyxHQUFHLE1BQU07YUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO2FBQ2hFLEtBQUssQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDO2FBQ2YsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ1osR0FBRyxDQUFDLENBQUMsSUFBSTtZQUNULDhFQUE4RTtZQUM5RSxLQUFLLEVBQUUsQ0FBQyxDQUFDLEtBQUs7WUFDZCxNQUFNLEVBQUUsUUFBUTtZQUNoQixVQUFVLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQ3pFLENBQUMsQ0FBQyxDQUFDO1FBRUwsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IENvbnRleHRJdGVtIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgdHlwZSB7IENwdVJlcmFua2VyTW9kZWwgfSBmcm9tICcuL1JlcmFua2VyTW9kZWwnO1xuaW1wb3J0IHsgZm52MWEzMiB9IGZyb20gJy4uL0NvbnRlbnRIYXNoJztcblxuZnVuY3Rpb24gY2xhbXAwMSh4OiBudW1iZXIpOiBudW1iZXIge1xuXHRpZiAoIU51bWJlci5pc0Zpbml0ZSh4KSkgcmV0dXJuIDA7XG5cdHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB4KSk7XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZVRleHQoczogc3RyaW5nKTogc3RyaW5nIHtcblx0cmV0dXJuIChzIHx8ICcnKS5yZXBsYWNlKC9cXHMrL2csICcgJykudHJpbSgpO1xufVxuXG4vKipcbiAqIENQVSByZXJhbmtlciB1c2luZyBAeGVub3ZhL3RyYW5zZm9ybWVycyAoV0FTTSkuIExvYWRlZCBsYXppbHkuXG4gKiBJZiB0aGUgbW9kZWwgZmFpbHMgdG8gbG9hZC9ydW4sIGNhbGxlcnMgc2hvdWxkIGZhbGwgYmFjayB0byB0aGUgcHJlLXJlcmFuayBvcmRlci5cbiAqL1xuY2xhc3MgVHJhbnNmb3JtZXJzQ3Jvc3NFbmNvZGVyIGltcGxlbWVudHMgQ3B1UmVyYW5rZXJNb2RlbCB7XG5cdHJlYWRvbmx5IGlkID0gJ2Nyb3NzLWVuY29kZXItbXNtYXJjby1taW5pbG0nO1xuXG5cdHByaXZhdGUgcGlwZWxpbmU6XG5cdFx0fCBudWxsXG5cdFx0fCAoKGlucHV0OiBzdHJpbmcgfCBBcnJheTx7IHRleHQ6IHN0cmluZzsgdGV4dF9wYWlyOiBzdHJpbmcgfT4pID0+IFByb21pc2U8dW5rbm93bj4pID0gbnVsbDtcblx0cHJpdmF0ZSBsb2FkaW5nOiBQcm9taXNlPHZvaWQ+IHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBhc3luYyBlbnN1cmVMb2FkZWQoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0aWYgKHRoaXMucGlwZWxpbmUpIHJldHVybjtcblx0XHRpZiAodGhpcy5sb2FkaW5nICE9PSBudWxsKSByZXR1cm4gdGhpcy5sb2FkaW5nO1xuXG5cdFx0dGhpcy5sb2FkaW5nID0gKGFzeW5jICgpID0+IHtcblx0XHRcdC8vIEltcG9ydCB0aGUgdmVuZG9yZWQgdHJhbnNmb3JtZXJzIGxpYnJhcnlcblx0XHRcdGNvbnN0IHRyYW5zZm9ybWVyc01vZHVsZTogYW55ID0gYXdhaXQgaW1wb3J0KCcuLi8uLi9saWIvdHJhbnNmb3JtZXJzLmpzJyk7XG5cdFx0XHRcblx0XHRcdC8vIENvbmZpZ3VyZSBXQVNNIHBhdGhzIC0gdXNlIG9iamVjdCBtYXBwaW5nIGZvciBpbmRpdmlkdWFsIGZpbGVzXG5cdFx0XHRpZiAodHJhbnNmb3JtZXJzTW9kdWxlLmVudiAmJiB0cmFuc2Zvcm1lcnNNb2R1bGUuZW52LmJhY2tlbmRzICYmIHRyYW5zZm9ybWVyc01vZHVsZS5lbnYuYmFja2VuZHMub25ueCkge1xuXHRcdFx0XHRjb25zdCBvbm54RW52ID0gdHJhbnNmb3JtZXJzTW9kdWxlLmVudi5iYWNrZW5kcy5vbm54O1xuXHRcdFx0XHRpZiAoIW9ubnhFbnYud2FzbSkgb25ueEVudi53YXNtID0ge307XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zdCB3YXNtRmlsZXMgPSBbXG5cdFx0XHRcdFx0J29ydC13YXNtLndhc20nLFxuXHRcdFx0XHRcdCdvcnQtd2FzbS1zaW1kLndhc20nLFxuXHRcdFx0XHRcdCdvcnQtd2FzbS10aHJlYWRlZC53YXNtJyxcblx0XHRcdFx0XHQnb3J0LXdhc20tc2ltZC10aHJlYWRlZC53YXNtJ1xuXHRcdFx0XHRdO1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc3Qgd2FzbVBhdGhzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG5cdFx0XHRcdGZvciAoY29uc3Qgd2FzbUZpbGUgb2Ygd2FzbUZpbGVzKSB7XG5cdFx0XHRcdFx0d2FzbVBhdGhzW3dhc21GaWxlXSA9IGAuL2xpYi8ke3dhc21GaWxlfWA7XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHRcdG9ubnhFbnYud2FzbS53YXNtUGF0aHMgPSB3YXNtUGF0aHM7XG5cdFx0XHRcdGNvbnNvbGUubG9nKGBbQ3B1UmVyYW5rZXJdIENvbmZpZ3VyZWQgV0FTTSBwYXRoczpgLCB3YXNtUGF0aHMpO1xuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHQvLyBAeGVub3ZhL3RyYW5zZm9ybWVycyBleHBvcnRzIHBpcGVsaW5lIGFzIGEgbmFtZWQgZXhwb3J0XG5cdFx0XHQvLyBJdCBtaWdodCBiZSBvbiB0aGUgZGVmYXVsdCBleHBvcnQgb3IgYXMgYSBuYW1lZCBleHBvcnRcblx0XHRcdGNvbnN0IHBpcGVsaW5lID0gdHJhbnNmb3JtZXJzTW9kdWxlLnBpcGVsaW5lIHx8IHRyYW5zZm9ybWVyc01vZHVsZS5kZWZhdWx0Py5waXBlbGluZTtcblx0XHRcdGlmICghcGlwZWxpbmUgfHwgdHlwZW9mIHBpcGVsaW5lICE9PSAnZnVuY3Rpb24nKSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcignVHJhbnNmb3JtZXJzIHBpcGVsaW5lIGlzIHVuYXZhaWxhYmxlJyk7XG5cdFx0XHR9XG5cblx0XHRcdC8vIENyb3NzLWVuY29kZXIgcmVyYW5rZXIgbW9kZWwgKHNtYWxsLWlzaCkuIEJlc3QtZWZmb3J0OiBtYXkgZmFpbCBvbiBzb21lIGVudmlyb25tZW50cy5cblx0XHRcdGNvbnN0IHBpcGVVbmtub3duID0gYXdhaXQgcGlwZWxpbmUoXG5cdFx0XHRcdCd0ZXh0LWNsYXNzaWZpY2F0aW9uJyxcblx0XHRcdFx0J1hlbm92YS9jcm9zcy1lbmNvZGVyLW1zLW1hcmNvLU1pbmlMTS1MLTYtdjInLFxuXHRcdFx0XHR7IHF1YW50aXplZDogdHJ1ZSB9XG5cdFx0XHQpO1xuXHRcdFx0Y29uc3QgcGlwZSA9IHBpcGVVbmtub3duIGFzIChpbnB1dDogdW5rbm93bikgPT4gUHJvbWlzZTx1bmtub3duPjtcblx0XHRcdHRoaXMucGlwZWxpbmUgPSBhc3luYyAoaW5wdXQpID0+IGF3YWl0IHBpcGUoaW5wdXQpO1xuXHRcdH0pKCkuZmluYWxseSgoKSA9PiB7XG5cdFx0XHR0aGlzLmxvYWRpbmcgPSBudWxsO1xuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIHRoaXMubG9hZGluZztcblx0fVxuXG5cdGFzeW5jIHJlcmFua1BhaXIocXVlcnk6IHN0cmluZywgZG9jdW1lbnQ6IHN0cmluZyk6IFByb21pc2U8eyBzY29yZTogbnVtYmVyIH0+IHtcblx0XHRjb25zdCBxID0gbm9ybWFsaXplVGV4dChxdWVyeSk7XG5cdFx0Y29uc3QgZCA9IG5vcm1hbGl6ZVRleHQoZG9jdW1lbnQpO1xuXHRcdGlmICghcSB8fCAhZCkgcmV0dXJuIHsgc2NvcmU6IDAgfTtcblx0XHRhd2FpdCB0aGlzLmVuc3VyZUxvYWRlZCgpO1xuXHRcdGlmICghdGhpcy5waXBlbGluZSkgdGhyb3cgbmV3IEVycm9yKCdSZXJhbmtlciBwaXBlbGluZSB1bmF2YWlsYWJsZScpO1xuXG5cdFx0Ly8gUHJlZmVyIHBhaXIgaW5wdXQgaWYgc3VwcG9ydGVkIGJ5IHRoZSBwaXBlbGluZSBpbXBsZW1lbnRhdGlvbjsgZmFsbCBiYWNrIHRvIGNvbmNhdGVuYXRpb24uXG5cdFx0bGV0IG91dDogdW5rbm93bjtcblx0XHR0cnkge1xuXHRcdFx0b3V0ID0gYXdhaXQgdGhpcy5waXBlbGluZShbeyB0ZXh0OiBxLCB0ZXh0X3BhaXI6IGQgfV0pO1xuXHRcdH0gY2F0Y2gge1xuXHRcdFx0b3V0ID0gYXdhaXQgdGhpcy5waXBlbGluZShgJHtxfVxcblxcbiR7ZH1gKTtcblx0XHR9XG5cblx0XHQvLyBDb21tb24gb3V0cHV0IGZvcm1hdHM6XG5cdFx0Ly8gLSBbeyBsYWJlbDogJ0xBQkVMXzEnLCBzY29yZTogMC45MyB9LCAuLi5dXG5cdFx0Ly8gLSB7IGxhYmVsLCBzY29yZSB9XG5cdFx0Y29uc3QgZmlyc3QgPSBBcnJheS5pc0FycmF5KG91dCkgPyBvdXRbMF0gOiBvdXQ7XG5cdFx0Y29uc3Qgb2JqID0gZmlyc3QgYXMgeyBzY29yZT86IHVua25vd247IGxhYmVsPzogdW5rbm93biB9O1xuXHRcdGNvbnN0IHNjb3JlID0gdHlwZW9mIG9iaj8uc2NvcmUgPT09ICdudW1iZXInID8gb2JqLnNjb3JlIDogMDtcblx0XHRyZXR1cm4geyBzY29yZTogY2xhbXAwMShzY29yZSkgfTtcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIENwdVJlcmFua09wdGlvbnMge1xuXHRsaW1pdDogbnVtYmVyOyAvLyBob3cgbWFueSBpdGVtcyB0byByZXR1cm5cblx0c2hvcnRsaXN0PzogbnVtYmVyOyAvLyBob3cgbWFueSB0byBzY29yZVxufVxuXG5leHBvcnQgY2xhc3MgQ3B1UmVyYW5rZXIge1xuXHRwcml2YXRlIHJlYWRvbmx5IG1vZGVsOiBDcHVSZXJhbmtlck1vZGVsO1xuXHQvLyBxdWVyeUhhc2ggLT4gaXRlbUtleSAtPiBzY29yZVxuXHRwcml2YXRlIHJlYWRvbmx5IGNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIG51bWJlcj4+KCk7XG5cblx0Y29uc3RydWN0b3IobW9kZWw/OiBDcHVSZXJhbmtlck1vZGVsKSB7XG5cdFx0dGhpcy5tb2RlbCA9IG1vZGVsID8/IG5ldyBUcmFuc2Zvcm1lcnNDcm9zc0VuY29kZXIoKTtcblx0fVxuXG5cdHByaXZhdGUgaGFzaFF1ZXJ5KHE6IHN0cmluZyk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIGZudjFhMzIobm9ybWFsaXplVGV4dChxKSk7XG5cdH1cblxuXHR3YXJtKHF1ZXJ5OiBzdHJpbmcsIGl0ZW1zOiBDb250ZXh0SXRlbVtdLCBvcHRzPzogeyBzaG9ydGxpc3Q/OiBudW1iZXIgfSk6IHZvaWQge1xuXHRcdGNvbnN0IHNob3J0bGlzdCA9IE1hdGgubWF4KDEsIE1hdGgubWluKDEyMCwgTWF0aC5mbG9vcihvcHRzPy5zaG9ydGxpc3QgPz8gNDApKSk7XG5cdFx0Y29uc3QgcWggPSB0aGlzLmhhc2hRdWVyeShxdWVyeSk7XG5cdFx0Y29uc3QgbWFwID0gdGhpcy5jYWNoZS5nZXQocWgpID8/IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cdFx0dGhpcy5jYWNoZS5zZXQocWgsIG1hcCk7XG5cblx0XHRjb25zdCB0b1Njb3JlID0gaXRlbXMuc2xpY2UoMCwgc2hvcnRsaXN0KS5maWx0ZXIoKGl0KSA9PiAhbWFwLmhhcyhpdC5rZXkpKTtcblx0XHRpZiAodG9TY29yZS5sZW5ndGggPT09IDApIHJldHVybjtcblxuXHRcdC8vIEZpcmUtYW5kLWZvcmdldCB3YXJtdXA7IG5ldmVyIGJsb2NrIFVJLlxuXHRcdHZvaWQgKGFzeW5jICgpID0+IHtcblx0XHRcdGZvciAoY29uc3QgaXQgb2YgdG9TY29yZSkge1xuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdGNvbnN0IGRvYyA9IGAke2l0LnBhdGh9XFxuJHtpdC5leGNlcnB0fWA7XG5cdFx0XHRcdFx0Y29uc3QgcmVzID0gYXdhaXQgdGhpcy5tb2RlbC5yZXJhbmtQYWlyKHF1ZXJ5LCBkb2MpO1xuXHRcdFx0XHRcdG1hcC5zZXQoaXQua2V5LCByZXMuc2NvcmUpO1xuXHRcdFx0XHR9IGNhdGNoIHtcblx0XHRcdFx0XHQvLyBzdG9wIHdhcm1pbmcgaWYgbW9kZWwgZmFpbHNcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pKCkuY2F0Y2goKCkgPT4ge1xuXHRcdFx0Ly8gaWdub3JlXG5cdFx0fSk7XG5cdH1cblxuXHRhc3luYyByZXJhbmsocXVlcnk6IHN0cmluZywgaXRlbXM6IENvbnRleHRJdGVtW10sIG9wdHM6IENwdVJlcmFua09wdGlvbnMpOiBQcm9taXNlPENvbnRleHRJdGVtW10+IHtcblx0XHRjb25zdCBsaW1pdCA9IE1hdGgubWF4KDEsIE1hdGgubWluKDIwMCwgTWF0aC5mbG9vcihvcHRzLmxpbWl0KSkpO1xuXHRcdGNvbnN0IHNob3J0bGlzdCA9IE1hdGgubWF4KGxpbWl0LCBNYXRoLm1pbigxMjAsIE1hdGguZmxvb3Iob3B0cy5zaG9ydGxpc3QgPz8gNjApKSk7XG5cdFx0Y29uc3QgcWggPSB0aGlzLmhhc2hRdWVyeShxdWVyeSk7XG5cdFx0Y29uc3QgbWFwID0gdGhpcy5jYWNoZS5nZXQocWgpID8/IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cdFx0dGhpcy5jYWNoZS5zZXQocWgsIG1hcCk7XG5cblx0XHRjb25zdCBzY29yZWQ6IEFycmF5PHsgaXRlbTogQ29udGV4dEl0ZW07IHNjb3JlOiBudW1iZXIgfT4gPSBbXTtcblx0XHRjb25zdCBzbGljZSA9IGl0ZW1zLnNsaWNlKDAsIHNob3J0bGlzdCk7XG5cdFx0Zm9yIChjb25zdCBpdCBvZiBzbGljZSkge1xuXHRcdFx0Y29uc3QgY2FjaGVkID0gbWFwLmdldChpdC5rZXkpO1xuXHRcdFx0aWYgKHR5cGVvZiBjYWNoZWQgPT09ICdudW1iZXInKSB7XG5cdFx0XHRcdHNjb3JlZC5wdXNoKHsgaXRlbTogaXQsIHNjb3JlOiBjYWNoZWQgfSk7XG5cdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0fVxuXHRcdFx0Y29uc3QgZG9jID0gYCR7aXQucGF0aH1cXG4ke2l0LmV4Y2VycHR9YDtcblx0XHRcdGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMubW9kZWwucmVyYW5rUGFpcihxdWVyeSwgZG9jKTtcblx0XHRcdG1hcC5zZXQoaXQua2V5LCByZXMuc2NvcmUpO1xuXHRcdFx0c2NvcmVkLnB1c2goeyBpdGVtOiBpdCwgc2NvcmU6IHJlcy5zY29yZSB9KTtcblx0XHR9XG5cblx0XHQvLyBNZXJnZSByZXJhbmsgc2NvcmUgaW50byBmaW5hbCBvcmRlcmluZzsga2VlcCBvcmlnaW5hbCBzY29yZSBhcyBzZWNvbmRhcnkgc2lnbmFsLlxuXHRcdGNvbnN0IG91dCA9IHNjb3JlZFxuXHRcdFx0LnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlIHx8IGIuaXRlbS5zY29yZSAtIGEuaXRlbS5zY29yZSlcblx0XHRcdC5zbGljZSgwLCBsaW1pdClcblx0XHRcdC5tYXAoKHMpID0+ICh7XG5cdFx0XHRcdC4uLnMuaXRlbSxcblx0XHRcdFx0Ly8gS2VlcCB0aGUgc2NvcmUgZmllbGQgYXMgdGhlIHJlcmFuayBzY29yZSBzbyBmb3JtYXR0aW5nIHJlZmxlY3RzIHRydWUgb3JkZXIuXG5cdFx0XHRcdHNjb3JlOiBzLnNjb3JlLFxuXHRcdFx0XHRzb3VyY2U6ICdyZXJhbmsnLFxuXHRcdFx0XHRyZWFzb25UYWdzOiBBcnJheS5mcm9tKG5ldyBTZXQoWy4uLihzLml0ZW0ucmVhc29uVGFncyA/PyBbXSksICdyZXJhbmsnXSkpXG5cdFx0XHR9KSk7XG5cblx0XHRyZXR1cm4gb3V0O1xuXHR9XG59XG5cblxuIl19