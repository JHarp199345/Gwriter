import { fnv1a32 } from '../ContentHash';
function clamp01(x) {
    if (!Number.isFinite(x))
        return 0;
    return Math.max(0, Math.min(1, x));
}
function normalizeText(s) {
    return (s || '').replace(/\s+/g, ' ').trim();
}
/**
 * CPU reranker using @xenova/transformers (WASM). Loaded lazily.
 * If the model fails to load/run, callers should fall back to the pre-rerank order.
 */
class TransformersCrossEncoder {
    constructor() {
        this.id = 'cross-encoder-msmarco-minilm';
        this.pipeline = null;
        this.loading = null;
    }
    async ensureLoaded() {
        if (this.pipeline)
            return;
        if (this.loading !== null)
            return this.loading;
        this.loading = (async () => {
            // Import the vendored transformers library
            const transformersModule = await import('../../lib/transformers.js');
            // Configure WASM paths - use a relative path from the plugin directory
            // The library will resolve this relative to where it's loaded
            if (transformersModule.env && transformersModule.env.backends && transformersModule.env.backends.onnx && transformersModule.env.backends.onnx.wasm) {
                // Use relative path - the library should resolve it from the plugin directory
                transformersModule.env.backends.onnx.wasm.wasmPaths = './lib/';
            }
            // @xenova/transformers exports pipeline as a named export
            // It might be on the default export or as a named export
            const pipeline = transformersModule.pipeline || transformersModule.default?.pipeline;
            if (!pipeline || typeof pipeline !== 'function') {
                throw new Error('Transformers pipeline is unavailable');
            }
            // Cross-encoder reranker model (small-ish). Best-effort: may fail on some environments.
            const pipeUnknown = await pipeline('text-classification', 'Xenova/cross-encoder-ms-marco-MiniLM-L-6-v2', { quantized: true });
            const pipe = pipeUnknown;
            this.pipeline = async (input) => await pipe(input);
        })().finally(() => {
            this.loading = null;
        });
        return this.loading;
    }
    async rerankPair(query, document) {
        const q = normalizeText(query);
        const d = normalizeText(document);
        if (!q || !d)
            return { score: 0 };
        await this.ensureLoaded();
        if (!this.pipeline)
            throw new Error('Reranker pipeline unavailable');
        // Prefer pair input if supported by the pipeline implementation; fall back to concatenation.
        let out;
        try {
            out = await this.pipeline([{ text: q, text_pair: d }]);
        }
        catch {
            out = await this.pipeline(`${q}\n\n${d}`);
        }
        // Common output formats:
        // - [{ label: 'LABEL_1', score: 0.93 }, ...]
        // - { label, score }
        const first = Array.isArray(out) ? out[0] : out;
        const obj = first;
        const score = typeof obj?.score === 'number' ? obj.score : 0;
        return { score: clamp01(score) };
    }
}
export class CpuReranker {
    constructor(model) {
        // queryHash -> itemKey -> score
        this.cache = new Map();
        this.model = model ?? new TransformersCrossEncoder();
    }
    hashQuery(q) {
        return fnv1a32(normalizeText(q));
    }
    warm(query, items, opts) {
        const shortlist = Math.max(1, Math.min(120, Math.floor(opts?.shortlist ?? 40)));
        const qh = this.hashQuery(query);
        const map = this.cache.get(qh) ?? new Map();
        this.cache.set(qh, map);
        const toScore = items.slice(0, shortlist).filter((it) => !map.has(it.key));
        if (toScore.length === 0)
            return;
        // Fire-and-forget warmup; never block UI.
        void (async () => {
            for (const it of toScore) {
                try {
                    const doc = `${it.path}\n${it.excerpt}`;
                    const res = await this.model.rerankPair(query, doc);
                    map.set(it.key, res.score);
                }
                catch {
                    // stop warming if model fails
                    break;
                }
            }
        })().catch(() => {
            // ignore
        });
    }
    async rerank(query, items, opts) {
        const limit = Math.max(1, Math.min(200, Math.floor(opts.limit)));
        const shortlist = Math.max(limit, Math.min(120, Math.floor(opts.shortlist ?? 60)));
        const qh = this.hashQuery(query);
        const map = this.cache.get(qh) ?? new Map();
        this.cache.set(qh, map);
        const scored = [];
        const slice = items.slice(0, shortlist);
        for (const it of slice) {
            const cached = map.get(it.key);
            if (typeof cached === 'number') {
                scored.push({ item: it, score: cached });
                continue;
            }
            const doc = `${it.path}\n${it.excerpt}`;
            const res = await this.model.rerankPair(query, doc);
            map.set(it.key, res.score);
            scored.push({ item: it, score: res.score });
        }
        // Merge rerank score into final ordering; keep original score as secondary signal.
        const out = scored
            .sort((a, b) => b.score - a.score || b.item.score - a.item.score)
            .slice(0, limit)
            .map((s) => ({
            ...s.item,
            // Keep the score field as the rerank score so formatting reflects true order.
            score: s.score,
            source: 'rerank',
            reasonTags: Array.from(new Set([...(s.item.reasonTags ?? []), 'rerank']))
        }));
        return out;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3B1UmVyYW5rZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDcHVSZXJhbmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekMsU0FBUyxPQUFPLENBQUMsQ0FBUztJQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFBRSxPQUFPLENBQUMsQ0FBQztJQUNsQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFDLENBQVM7SUFDL0IsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQzlDLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxNQUFNLHdCQUF3QjtJQUE5QjtRQUNVLE9BQUUsR0FBRyw4QkFBOEIsQ0FBQztRQUVyQyxhQUFRLEdBRXdFLElBQUksQ0FBQztRQUNyRixZQUFPLEdBQXlCLElBQUksQ0FBQztJQThEOUMsQ0FBQztJQTVEUSxLQUFLLENBQUMsWUFBWTtRQUN6QixJQUFJLElBQUksQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUMxQixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSTtZQUFFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUUvQyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDMUIsMkNBQTJDO1lBQzNDLE1BQU0sa0JBQWtCLEdBQVEsTUFBTSxNQUFNLENBQUMsMkJBQTJCLENBQUMsQ0FBQztZQUUxRSx1RUFBdUU7WUFDdkUsOERBQThEO1lBQzlELElBQUksa0JBQWtCLENBQUMsR0FBRyxJQUFJLGtCQUFrQixD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QUssQ0FBQzthQUNmLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNaLEdBQUcsQ0FBQyxDQUFDLElBQUk7WUFDVCw4RUFBOEU7WUFDOUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxLQUFLO1lBQ2QsTUFBTSxFQUFFLFFBQVE7WUFDaEIsVUFBVSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztTQUN6RSxDQUFDLENBQUMsQ0FBQztRQUVMLE9BQU8sR0FBRyxDQUFDO0lBQ1osQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDb250ZXh0SXRlbSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHR5cGUgeyBDcHVSZXJhbmtlck1vZGVsIH0gZnJvbSAnLi9SZXJhbmtlck1vZGVsJztcbmltcG9ydCB7IGZudjFhMzIgfSBmcm9tICcuLi9Db250ZW50SGFzaCc7XG5cbmZ1bmN0aW9uIGNsYW1wMDEoeDogbnVtYmVyKTogbnVtYmVyIHtcblx0aWYgKCFOdW1iZXIuaXNGaW5pdGUoeCkpIHJldHVybiAwO1xuXHRyZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgeCkpO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVUZXh0KHM6IHN0cmluZyk6IHN0cmluZyB7XG5cdHJldHVybiAocyB8fCAnJykucmVwbGFjZSgvXFxzKy9nLCAnICcpLnRyaW0oKTtcbn1cblxuLyoqXG4gKiBDUFUgcmVyYW5rZXIgdXNpbmcgQHhlbm92YS90cmFuc2Zvcm1lcnMgKFdBU00pLiBMb2FkZWQgbGF6aWx5LlxuICogSWYgdGhlIG1vZGVsIGZhaWxzIHRvIGxvYWQvcnVuLCBjYWxsZXJzIHNob3VsZCBmYWxsIGJhY2sgdG8gdGhlIHByZS1yZXJhbmsgb3JkZXIuXG4gKi9cbmNsYXNzIFRyYW5zZm9ybWVyc0Nyb3NzRW5jb2RlciBpbXBsZW1lbnRzIENwdVJlcmFua2VyTW9kZWwge1xuXHRyZWFkb25seSBpZCA9ICdjcm9zcy1lbmNvZGVyLW1zbWFyY28tbWluaWxtJztcblxuXHRwcml2YXRlIHBpcGVsaW5lOlxuXHRcdHwgbnVsbFxuXHRcdHwgKChpbnB1dDogc3RyaW5nIHwgQXJyYXk8eyB0ZXh0OiBzdHJpbmc7IHRleHRfcGFpcjogc3RyaW5nIH0+KSA9PiBQcm9taXNlPHVua25vd24+KSA9IG51bGw7XG5cdHByaXZhdGUgbG9hZGluZzogUHJvbWlzZTx2b2lkPiB8IG51bGwgPSBudWxsO1xuXG5cdHByaXZhdGUgYXN5bmMgZW5zdXJlTG9hZGVkKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGlmICh0aGlzLnBpcGVsaW5lKSByZXR1cm47XG5cdFx0aWYgKHRoaXMubG9hZGluZyAhPT0gbnVsbCkgcmV0dXJuIHRoaXMubG9hZGluZztcblxuXHRcdHRoaXMubG9hZGluZyA9IChhc3luYyAoKSA9PiB7XG5cdFx0XHQvLyBJbXBvcnQgdGhlIHZlbmRvcmVkIHRyYW5zZm9ybWVycyBsaWJyYXJ5XG5cdFx0XHRjb25zdCB0cmFuc2Zvcm1lcnNNb2R1bGU6IGFueSA9IGF3YWl0IGltcG9ydCgnLi4vLi4vbGliL3RyYW5zZm9ybWVycy5qcycpO1xuXHRcdFx0XG5cdFx0XHQvLyBDb25maWd1cmUgV0FTTSBwYXRocyAtIHVzZSBhIHJlbGF0aXZlIHBhdGggZnJvbSB0aGUgcGx1Z2luIGRpcmVjdG9yeVxuXHRcdFx0Ly8gVGhlIGxpYnJhcnkgd2lsbCByZXNvbHZlIHRoaXMgcmVsYXRpdmUgdG8gd2hlcmUgaXQncyBsb2FkZWRcblx0XHRcdGlmICh0cmFuc2Zvcm1lcnNNb2R1bGUuZW52ICYmIHRyYW5zZm9ybWVyc01vZHVsZS5lbnYuYmFja2VuZHMgJiYgdHJhbnNmb3JtZXJzTW9kdWxlLmVudi5iYWNrZW5kcy5vbm54ICYmIHRyYW5zZm9ybWVyc01vZHVsZS5lbnYuYmFja2VuZHMub25ueC53YXNtKSB7XG5cdFx0XHRcdC8vIFVzZSByZWxhdGl2ZSBwYXRoIC0gdGhlIGxpYnJhcnkgc2hvdWxkIHJlc29sdmUgaXQgZnJvbSB0aGUgcGx1Z2luIGRpcmVjdG9yeVxuXHRcdFx0XHR0cmFuc2Zvcm1lcnNNb2R1bGUuZW52LmJhY2tlbmRzLm9ubngud2FzbS53YXNtUGF0aHMgPSAnLi9saWIvJztcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0Ly8gQHhlbm92YS90cmFuc2Zvcm1lcnMgZXhwb3J0cyBwaXBlbGluZSBhcyBhIG5hbWVkIGV4cG9ydFxuXHRcdFx0Ly8gSXQgbWlnaHQgYmUgb24gdGhlIGRlZmF1bHQgZXhwb3J0IG9yIGFzIGEgbmFtZWQgZXhwb3J0XG5cdFx0XHRjb25zdCBwaXBlbGluZSA9IHRyYW5zZm9ybWVyc01vZHVsZS5waXBlbGluZSB8fCB0cmFuc2Zvcm1lcnNNb2R1bGUuZGVmYXVsdD8ucGlwZWxpbmU7XG5cdFx0XHRpZiAoIXBpcGVsaW5lIHx8IHR5cGVvZiBwaXBlbGluZSAhPT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1RyYW5zZm9ybWVycyBwaXBlbGluZSBpcyB1bmF2YWlsYWJsZScpO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyBDcm9zcy1lbmNvZGVyIHJlcmFua2VyIG1vZGVsIChzbWFsbC1pc2gpLiBCZXN0LWVmZm9ydDogbWF5IGZhaWwgb24gc29tZSBlbnZpcm9ubWVudHMuXG5cdFx0XHRjb25zdCBwaXBlVW5rbm93biA9IGF3YWl0IHBpcGVsaW5lKFxuXHRcdFx0XHQndGV4dC1jbGFzc2lmaWNhdGlvbicsXG5cdFx0XHRcdCdYZW5vdmEvY3Jvc3MtZW5jb2Rlci1tcy1tYXJjby1NaW5pTE0tTC02LXYyJyxcblx0XHRcdFx0eyBxdWFudGl6ZWQ6IHRydWUgfVxuXHRcdFx0KTtcblx0XHRcdGNvbnN0IHBpcGUgPSBwaXBlVW5rbm93biBhcyAoaW5wdXQ6IHVua25vd24pID0+IFByb21pc2U8dW5rbm93bj47XG5cdFx0XHR0aGlzLnBpcGVsaW5lID0gYXN5bmMgKGlucHV0KSA9PiBhd2FpdCBwaXBlKGlucHV0KTtcblx0XHR9KSgpLmZpbmFsbHkoKCkgPT4ge1xuXHRcdFx0dGhpcy5sb2FkaW5nID0gbnVsbDtcblx0XHR9KTtcblxuXHRcdHJldHVybiB0aGlzLmxvYWRpbmc7XG5cdH1cblxuXHRhc3luYyByZXJhbmtQYWlyKHF1ZXJ5OiBzdHJpbmcsIGRvY3VtZW50OiBzdHJpbmcpOiBQcm9taXNlPHsgc2NvcmU6IG51bWJlciB9PiB7XG5cdFx0Y29uc3QgcSA9IG5vcm1hbGl6ZVRleHQocXVlcnkpO1xuXHRcdGNvbnN0IGQgPSBub3JtYWxpemVUZXh0KGRvY3VtZW50KTtcblx0XHRpZiAoIXEgfHwgIWQpIHJldHVybiB7IHNjb3JlOiAwIH07XG5cdFx0YXdhaXQgdGhpcy5lbnN1cmVMb2FkZWQoKTtcblx0XHRpZiAoIXRoaXMucGlwZWxpbmUpIHRocm93IG5ldyBFcnJvcignUmVyYW5rZXIgcGlwZWxpbmUgdW5hdmFpbGFibGUnKTtcblxuXHRcdC8vIFByZWZlciBwYWlyIGlucHV0IGlmIHN1cHBvcnRlZCBieSB0aGUgcGlwZWxpbmUgaW1wbGVtZW50YXRpb247IGZhbGwgYmFjayB0byBjb25jYXRlbmF0aW9uLlxuXHRcdGxldCBvdXQ6IHVua25vd247XG5cdFx0dHJ5IHtcblx0XHRcdG91dCA9IGF3YWl0IHRoaXMucGlwZWxpbmUoW3sgdGV4dDogcSwgdGV4dF9wYWlyOiBkIH1dKTtcblx0XHR9IGNhdGNoIHtcblx0XHRcdG91dCA9IGF3YWl0IHRoaXMucGlwZWxpbmUoYCR7cX1cXG5cXG4ke2R9YCk7XG5cdFx0fVxuXG5cdFx0Ly8gQ29tbW9uIG91dHB1dCBmb3JtYXRzOlxuXHRcdC8vIC0gW3sgbGFiZWw6ICdMQUJFTF8xJywgc2NvcmU6IDAuOTMgfSwgLi4uXVxuXHRcdC8vIC0geyBsYWJlbCwgc2NvcmUgfVxuXHRcdGNvbnN0IGZpcnN0ID0gQXJyYXkuaXNBcnJheShvdXQpID8gb3V0WzBdIDogb3V0O1xuXHRcdGNvbnN0IG9iaiA9IGZpcnN0IGFzIHsgc2NvcmU/OiB1bmtub3duOyBsYWJlbD86IHVua25vd24gfTtcblx0XHRjb25zdCBzY29yZSA9IHR5cGVvZiBvYmo/LnNjb3JlID09PSAnbnVtYmVyJyA/IG9iai5zY29yZSA6IDA7XG5cdFx0cmV0dXJuIHsgc2NvcmU6IGNsYW1wMDEoc2NvcmUpIH07XG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBDcHVSZXJhbmtPcHRpb25zIHtcblx0bGltaXQ6IG51bWJlcjsgLy8gaG93IG1hbnkgaXRlbXMgdG8gcmV0dXJuXG5cdHNob3J0bGlzdD86IG51bWJlcjsgLy8gaG93IG1hbnkgdG8gc2NvcmVcbn1cblxuZXhwb3J0IGNsYXNzIENwdVJlcmFua2VyIHtcblx0cHJpdmF0ZSByZWFkb25seSBtb2RlbDogQ3B1UmVyYW5rZXJNb2RlbDtcblx0Ly8gcXVlcnlIYXNoIC0+IGl0ZW1LZXkgLT4gc2NvcmVcblx0cHJpdmF0ZSByZWFkb25seSBjYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBudW1iZXI+PigpO1xuXG5cdGNvbnN0cnVjdG9yKG1vZGVsPzogQ3B1UmVyYW5rZXJNb2RlbCkge1xuXHRcdHRoaXMubW9kZWwgPSBtb2RlbCA/PyBuZXcgVHJhbnNmb3JtZXJzQ3Jvc3NFbmNvZGVyKCk7XG5cdH1cblxuXHRwcml2YXRlIGhhc2hRdWVyeShxOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRcdHJldHVybiBmbnYxYTMyKG5vcm1hbGl6ZVRleHQocSkpO1xuXHR9XG5cblx0d2FybShxdWVyeTogc3RyaW5nLCBpdGVtczogQ29udGV4dEl0ZW1bXSwgb3B0cz86IHsgc2hvcnRsaXN0PzogbnVtYmVyIH0pOiB2b2lkIHtcblx0XHRjb25zdCBzaG9ydGxpc3QgPSBNYXRoLm1heCgxLCBNYXRoLm1pbigxMjAsIE1hdGguZmxvb3Iob3B0cz8uc2hvcnRsaXN0ID8/IDQwKSkpO1xuXHRcdGNvbnN0IHFoID0gdGhpcy5oYXNoUXVlcnkocXVlcnkpO1xuXHRcdGNvbnN0IG1hcCA9IHRoaXMuY2FjaGUuZ2V0KHFoKSA/PyBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xuXHRcdHRoaXMuY2FjaGUuc2V0KHFoLCBtYXApO1xuXG5cdFx0Y29uc3QgdG9TY29yZSA9IGl0ZW1zLnNsaWNlKDAsIHNob3J0bGlzdCkuZmlsdGVyKChpdCkgPT4gIW1hcC5oYXMoaXQua2V5KSk7XG5cdFx0aWYgKHRvU2NvcmUubGVuZ3RoID09PSAwKSByZXR1cm47XG5cblx0XHQvLyBGaXJlLWFuZC1mb3JnZXQgd2FybXVwOyBuZXZlciBibG9jayBVSS5cblx0XHR2b2lkIChhc3luYyAoKSA9PiB7XG5cdFx0XHRmb3IgKGNvbnN0IGl0IG9mIHRvU2NvcmUpIHtcblx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRjb25zdCBkb2MgPSBgJHtpdC5wYXRofVxcbiR7aXQuZXhjZXJwdH1gO1xuXHRcdFx0XHRcdGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMubW9kZWwucmVyYW5rUGFpcihxdWVyeSwgZG9jKTtcblx0XHRcdFx0XHRtYXAuc2V0KGl0LmtleSwgcmVzLnNjb3JlKTtcblx0XHRcdFx0fSBjYXRjaCB7XG5cdFx0XHRcdFx0Ly8gc3RvcCB3YXJtaW5nIGlmIG1vZGVsIGZhaWxzXG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KSgpLmNhdGNoKCgpID0+IHtcblx0XHRcdC8vIGlnbm9yZVxuXHRcdH0pO1xuXHR9XG5cblx0YXN5bmMgcmVyYW5rKHF1ZXJ5OiBzdHJpbmcsIGl0ZW1zOiBDb250ZXh0SXRlbVtdLCBvcHRzOiBDcHVSZXJhbmtPcHRpb25zKTogUHJvbWlzZTxDb250ZXh0SXRlbVtdPiB7XG5cdFx0Y29uc3QgbGltaXQgPSBNYXRoLm1heCgxLCBNYXRoLm1pbigyMDAsIE1hdGguZmxvb3Iob3B0cy5saW1pdCkpKTtcblx0XHRjb25zdCBzaG9ydGxpc3QgPSBNYXRoLm1heChsaW1pdCwgTWF0aC5taW4oMTIwLCBNYXRoLmZsb29yKG9wdHMuc2hvcnRsaXN0ID8/IDYwKSkpO1xuXHRcdGNvbnN0IHFoID0gdGhpcy5oYXNoUXVlcnkocXVlcnkpO1xuXHRcdGNvbnN0IG1hcCA9IHRoaXMuY2FjaGUuZ2V0KHFoKSA/PyBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xuXHRcdHRoaXMuY2FjaGUuc2V0KHFoLCBtYXApO1xuXG5cdFx0Y29uc3Qgc2NvcmVkOiBBcnJheTx7IGl0ZW06IENvbnRleHRJdGVtOyBzY29yZTogbnVtYmVyIH0+ID0gW107XG5cdFx0Y29uc3Qgc2xpY2UgPSBpdGVtcy5zbGljZSgwLCBzaG9ydGxpc3QpO1xuXHRcdGZvciAoY29uc3QgaXQgb2Ygc2xpY2UpIHtcblx0XHRcdGNvbnN0IGNhY2hlZCA9IG1hcC5nZXQoaXQua2V5KTtcblx0XHRcdGlmICh0eXBlb2YgY2FjaGVkID09PSAnbnVtYmVyJykge1xuXHRcdFx0XHRzY29yZWQucHVzaCh7IGl0ZW06IGl0LCBzY29yZTogY2FjaGVkIH0pO1xuXHRcdFx0XHRjb250aW51ZTtcblx0XHRcdH1cblx0XHRcdGNvbnN0IGRvYyA9IGAke2l0LnBhdGh9XFxuJHtpdC5leGNlcnB0fWA7XG5cdFx0XHRjb25zdCByZXMgPSBhd2FpdCB0aGlzLm1vZGVsLnJlcmFua1BhaXIocXVlcnksIGRvYyk7XG5cdFx0XHRtYXAuc2V0KGl0LmtleSwgcmVzLnNjb3JlKTtcblx0XHRcdHNjb3JlZC5wdXNoKHsgaXRlbTogaXQsIHNjb3JlOiByZXMuc2NvcmUgfSk7XG5cdFx0fVxuXG5cdFx0Ly8gTWVyZ2UgcmVyYW5rIHNjb3JlIGludG8gZmluYWwgb3JkZXJpbmc7IGtlZXAgb3JpZ2luYWwgc2NvcmUgYXMgc2Vjb25kYXJ5IHNpZ25hbC5cblx0XHRjb25zdCBvdXQgPSBzY29yZWRcblx0XHRcdC5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSB8fCBiLml0ZW0uc2NvcmUgLSBhLml0ZW0uc2NvcmUpXG5cdFx0XHQuc2xpY2UoMCwgbGltaXQpXG5cdFx0XHQubWFwKChzKSA9PiAoe1xuXHRcdFx0XHQuLi5zLml0ZW0sXG5cdFx0XHRcdC8vIEtlZXAgdGhlIHNjb3JlIGZpZWxkIGFzIHRoZSByZXJhbmsgc2NvcmUgc28gZm9ybWF0dGluZyByZWZsZWN0cyB0cnVlIG9yZGVyLlxuXHRcdFx0XHRzY29yZTogcy5zY29yZSxcblx0XHRcdFx0c291cmNlOiAncmVyYW5rJyxcblx0XHRcdFx0cmVhc29uVGFnczogQXJyYXkuZnJvbShuZXcgU2V0KFsuLi4ocy5pdGVtLnJlYXNvblRhZ3MgPz8gW10pLCAncmVyYW5rJ10pKVxuXHRcdFx0fSkpO1xuXG5cdFx0cmV0dXJuIG91dDtcblx0fVxufVxuXG5cbiJdfQ==