export class Bm25Provider {
    constructor(index, isEnabled, isAllowedPath) {
        this.id = 'bm25';
        this.index = index;
        this.isEnabled = isEnabled;
        this.isAllowedPath = isAllowedPath;
    }
    async search(query, opts) {
        if (!this.isEnabled())
            return [];
        const q = (query.text ?? '').trim();
        if (!q)
            return [];
        await this.index.ensureLoaded();
        const ranked = this.index.search(q, Math.max(1, Math.min(400, opts.limit * 8)));
        if (ranked.length === 0)
            return [];
        let max = 0;
        for (const r of ranked)
            if (r.rawScore > max)
                max = r.rawScore;
        const denom = max || 1;
        const results = [];
        for (const r of ranked) {
            if (!this.isAllowedPath(r.chunk.path))
                continue;
            results.push({
                key: r.chunk.key,
                path: r.chunk.path,
                title: r.chunk.path.split('/').pop(),
                excerpt: r.chunk.excerpt,
                score: Math.max(0, Math.min(1, r.rawScore / denom)),
                source: this.id,
                reasonTags: ['bm25']
            });
            if (results.length >= opts.limit)
                break;
        }
        return results;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm0yNVByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQm0yNVByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE1BQU0sT0FBTyxZQUFZO0lBT3hCLFlBQVksS0FBZ0IsRUFBRSxTQUF3QixFQUFFLGFBQXdDO1FBTnZGLE9BQUUsR0FBRyxNQUFNLENBQUM7UUFPcEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7SUFDcEMsQ0FBQztJQUVELEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBcUIsRUFBRSxJQUFzQjtRQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsQ0FBQztZQUFFLE9BQU8sRUFBRSxDQUFDO1FBRWxCLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNoQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEYsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUVuQyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDWixLQUFLLE1BQU0sQ0FBQyxJQUFJLE1BQU07WUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLEdBQUcsR0FBRztnQkFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUMvRCxNQUFNLEtBQUssR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRXZCLE1BQU0sT0FBTyxHQUFrQixFQUFFLENBQUM7UUFDbEMsS0FBSyxNQUFNLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztnQkFBRSxTQUFTO1lBQ2hELE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ1osR0FBRyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRztnQkFDaEIsSUFBSSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSTtnQkFDbEIsS0FBSyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3BDLE9BQU8sRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU87Z0JBQ3hCLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDO2dCQUNuRCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7Z0JBQ2YsVUFBVSxFQUFFLENBQUMsTUFBTSxDQUFDO2FBQ3BCLENBQUMsQ0FBQztZQUNILElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsS0FBSztnQkFBRSxNQUFNO1FBQ3pDLENBQUM7UUFFRCxPQUFPLE9BQU8sQ0FBQztJQUNoQixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IENvbnRleHRJdGVtLCBSZXRyaWV2YWxPcHRpb25zLCBSZXRyaWV2YWxQcm92aWRlciwgUmV0cmlldmFsUXVlcnkgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHR5cGUgeyBCbTI1SW5kZXggfSBmcm9tICcuL0JtMjVJbmRleCc7XHJcblxyXG5leHBvcnQgY2xhc3MgQm0yNVByb3ZpZGVyIGltcGxlbWVudHMgUmV0cmlldmFsUHJvdmlkZXIge1xyXG5cdHJlYWRvbmx5IGlkID0gJ2JtMjUnO1xyXG5cclxuXHRwcml2YXRlIHJlYWRvbmx5IGluZGV4OiBCbTI1SW5kZXg7XHJcblx0cHJpdmF0ZSByZWFkb25seSBpc0VuYWJsZWQ6ICgpID0+IGJvb2xlYW47XHJcblx0cHJpdmF0ZSByZWFkb25seSBpc0FsbG93ZWRQYXRoOiAocGF0aDogc3RyaW5nKSA9PiBib29sZWFuO1xyXG5cclxuXHRjb25zdHJ1Y3RvcihpbmRleDogQm0yNUluZGV4LCBpc0VuYWJsZWQ6ICgpID0+IGJvb2xlYW4sIGlzQWxsb3dlZFBhdGg6IChwYXRoOiBzdHJpbmcpID0+IGJvb2xlYW4pIHtcclxuXHRcdHRoaXMuaW5kZXggPSBpbmRleDtcclxuXHRcdHRoaXMuaXNFbmFibGVkID0gaXNFbmFibGVkO1xyXG5cdFx0dGhpcy5pc0FsbG93ZWRQYXRoID0gaXNBbGxvd2VkUGF0aDtcclxuXHR9XHJcblxyXG5cdGFzeW5jIHNlYXJjaChxdWVyeTogUmV0cmlldmFsUXVlcnksIG9wdHM6IFJldHJpZXZhbE9wdGlvbnMpOiBQcm9taXNlPENvbnRleHRJdGVtW10+IHtcclxuXHRcdGlmICghdGhpcy5pc0VuYWJsZWQoKSkgcmV0dXJuIFtdO1xyXG5cdFx0Y29uc3QgcSA9IChxdWVyeS50ZXh0ID8/ICcnKS50cmltKCk7XHJcblx0XHRpZiAoIXEpIHJldHVybiBbXTtcclxuXHJcblx0XHRhd2FpdCB0aGlzLmluZGV4LmVuc3VyZUxvYWRlZCgpO1xyXG5cdFx0Y29uc3QgcmFua2VkID0gdGhpcy5pbmRleC5zZWFyY2gocSwgTWF0aC5tYXgoMSwgTWF0aC5taW4oNDAwLCBvcHRzLmxpbWl0ICogOCkpKTtcclxuXHRcdGlmIChyYW5rZWQubGVuZ3RoID09PSAwKSByZXR1cm4gW107XHJcblxyXG5cdFx0bGV0IG1heCA9IDA7XHJcblx0XHRmb3IgKGNvbnN0IHIgb2YgcmFua2VkKSBpZiAoci5yYXdTY29yZSA+IG1heCkgbWF4ID0gci5yYXdTY29yZTtcclxuXHRcdGNvbnN0IGRlbm9tID0gbWF4IHx8IDE7XHJcblxyXG5cdFx0Y29uc3QgcmVzdWx0czogQ29udGV4dEl0ZW1bXSA9IFtdO1xyXG5cdFx0Zm9yIChjb25zdCByIG9mIHJhbmtlZCkge1xyXG5cdFx0XHRpZiAoIXRoaXMuaXNBbGxvd2VkUGF0aChyLmNodW5rLnBhdGgpKSBjb250aW51ZTtcclxuXHRcdFx0cmVzdWx0cy5wdXNoKHtcclxuXHRcdFx0XHRrZXk6IHIuY2h1bmsua2V5LFxyXG5cdFx0XHRcdHBhdGg6IHIuY2h1bmsucGF0aCxcclxuXHRcdFx0XHR0aXRsZTogci5jaHVuay5wYXRoLnNwbGl0KCcvJykucG9wKCksXHJcblx0XHRcdFx0ZXhjZXJwdDogci5jaHVuay5leGNlcnB0LFxyXG5cdFx0XHRcdHNjb3JlOiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCByLnJhd1Njb3JlIC8gZGVub20pKSxcclxuXHRcdFx0XHRzb3VyY2U6IHRoaXMuaWQsXHJcblx0XHRcdFx0cmVhc29uVGFnczogWydibTI1J11cclxuXHRcdFx0fSk7XHJcblx0XHRcdGlmIChyZXN1bHRzLmxlbmd0aCA+PSBvcHRzLmxpbWl0KSBicmVhaztcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gcmVzdWx0cztcclxuXHR9XHJcbn1cclxuXHJcblxyXG4iXX0=