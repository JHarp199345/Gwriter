export class Bm25Provider {
    constructor(index, isEnabled, isAllowedPath) {
        this.id = 'bm25';
        this.index = index;
        this.isEnabled = isEnabled;
        this.isAllowedPath = isAllowedPath;
    }
    async search(query, opts) {
        if (!this.isEnabled())
            return [];
        const q = (query.text ?? '').trim();
        if (!q)
            return [];
        await this.index.ensureLoaded();
        const ranked = this.index.search(q, Math.max(1, Math.min(400, opts.limit * 8)));
        if (ranked.length === 0)
            return [];
        let max = 0;
        for (const r of ranked)
            if (r.rawScore > max)
                max = r.rawScore;
        const denom = max || 1;
        const results = [];
        for (const r of ranked) {
            if (!this.isAllowedPath(r.chunk.path))
                continue;
            results.push({
                key: r.chunk.key,
                path: r.chunk.path,
                title: r.chunk.path.split('/').pop(),
                excerpt: r.chunk.excerpt,
                score: Math.max(0, Math.min(1, r.rawScore / denom)),
                source: this.id,
                reasonTags: ['bm25']
            });
            if (results.length >= opts.limit)
                break;
        }
        return results;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm0yNVByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQm0yNVByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE1BQU0sT0FBTyxZQUFZO0lBT3hCLFlBQVksS0FBZ0IsRUFBRSxTQUF3QixFQUFFLGFBQXdDO1FBTnZGLE9BQUUsR0FBRyxNQUFNLENBQUM7UUFPcEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7SUFDcEMsQ0FBQztJQUVELEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBcUIsRUFBRSxJQUFzQjtRQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsQ0FBQztZQUFFLE9BQU8sRUFBRSxDQUFDO1FBRWxCLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNoQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEYsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUVuQyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDWixLQUFLLE1BQU0sQ0FBQyxJQUFJLE1BQU07WUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLEdBQUcsR0FBRztnQkFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUMvRCxNQUFNLEtBQUssR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRXZCLE1BQU0sT0FBTyxHQUFrQixFQUFFLENBQUM7UUFDbEMsS0FBSyxNQUFNLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztnQkFBRSxTQUFTO1lBQ2hELE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ1osR0FBRyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRztnQkFDaEIsSUFBSSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSTtnQkFDbEIsS0FBSyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3BDLE9BQU8sRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU87Z0JBQ3hCLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDO2dCQUNuRCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7Z0JBQ2YsVUFBVSxFQUFFLENBQUMsTUFBTSxDQUFDO2FBQ3BCLENBQUMsQ0FBQztZQUNILElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsS0FBSztnQkFBRSxNQUFNO1FBQ3pDLENBQUM7UUFFRCxPQUFPLE9BQU8sQ0FBQztJQUNoQixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IENvbnRleHRJdGVtLCBSZXRyaWV2YWxPcHRpb25zLCBSZXRyaWV2YWxQcm92aWRlciwgUmV0cmlldmFsUXVlcnkgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB0eXBlIHsgQm0yNUluZGV4IH0gZnJvbSAnLi9CbTI1SW5kZXgnO1xuXG5leHBvcnQgY2xhc3MgQm0yNVByb3ZpZGVyIGltcGxlbWVudHMgUmV0cmlldmFsUHJvdmlkZXIge1xuXHRyZWFkb25seSBpZCA9ICdibTI1JztcblxuXHRwcml2YXRlIHJlYWRvbmx5IGluZGV4OiBCbTI1SW5kZXg7XG5cdHByaXZhdGUgcmVhZG9ubHkgaXNFbmFibGVkOiAoKSA9PiBib29sZWFuO1xuXHRwcml2YXRlIHJlYWRvbmx5IGlzQWxsb3dlZFBhdGg6IChwYXRoOiBzdHJpbmcpID0+IGJvb2xlYW47XG5cblx0Y29uc3RydWN0b3IoaW5kZXg6IEJtMjVJbmRleCwgaXNFbmFibGVkOiAoKSA9PiBib29sZWFuLCBpc0FsbG93ZWRQYXRoOiAocGF0aDogc3RyaW5nKSA9PiBib29sZWFuKSB7XG5cdFx0dGhpcy5pbmRleCA9IGluZGV4O1xuXHRcdHRoaXMuaXNFbmFibGVkID0gaXNFbmFibGVkO1xuXHRcdHRoaXMuaXNBbGxvd2VkUGF0aCA9IGlzQWxsb3dlZFBhdGg7XG5cdH1cblxuXHRhc3luYyBzZWFyY2gocXVlcnk6IFJldHJpZXZhbFF1ZXJ5LCBvcHRzOiBSZXRyaWV2YWxPcHRpb25zKTogUHJvbWlzZTxDb250ZXh0SXRlbVtdPiB7XG5cdFx0aWYgKCF0aGlzLmlzRW5hYmxlZCgpKSByZXR1cm4gW107XG5cdFx0Y29uc3QgcSA9IChxdWVyeS50ZXh0ID8/ICcnKS50cmltKCk7XG5cdFx0aWYgKCFxKSByZXR1cm4gW107XG5cblx0XHRhd2FpdCB0aGlzLmluZGV4LmVuc3VyZUxvYWRlZCgpO1xuXHRcdGNvbnN0IHJhbmtlZCA9IHRoaXMuaW5kZXguc2VhcmNoKHEsIE1hdGgubWF4KDEsIE1hdGgubWluKDQwMCwgb3B0cy5saW1pdCAqIDgpKSk7XG5cdFx0aWYgKHJhbmtlZC5sZW5ndGggPT09IDApIHJldHVybiBbXTtcblxuXHRcdGxldCBtYXggPSAwO1xuXHRcdGZvciAoY29uc3QgciBvZiByYW5rZWQpIGlmIChyLnJhd1Njb3JlID4gbWF4KSBtYXggPSByLnJhd1Njb3JlO1xuXHRcdGNvbnN0IGRlbm9tID0gbWF4IHx8IDE7XG5cblx0XHRjb25zdCByZXN1bHRzOiBDb250ZXh0SXRlbVtdID0gW107XG5cdFx0Zm9yIChjb25zdCByIG9mIHJhbmtlZCkge1xuXHRcdFx0aWYgKCF0aGlzLmlzQWxsb3dlZFBhdGgoci5jaHVuay5wYXRoKSkgY29udGludWU7XG5cdFx0XHRyZXN1bHRzLnB1c2goe1xuXHRcdFx0XHRrZXk6IHIuY2h1bmsua2V5LFxuXHRcdFx0XHRwYXRoOiByLmNodW5rLnBhdGgsXG5cdFx0XHRcdHRpdGxlOiByLmNodW5rLnBhdGguc3BsaXQoJy8nKS5wb3AoKSxcblx0XHRcdFx0ZXhjZXJwdDogci5jaHVuay5leGNlcnB0LFxuXHRcdFx0XHRzY29yZTogTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgci5yYXdTY29yZSAvIGRlbm9tKSksXG5cdFx0XHRcdHNvdXJjZTogdGhpcy5pZCxcblx0XHRcdFx0cmVhc29uVGFnczogWydibTI1J11cblx0XHRcdH0pO1xuXHRcdFx0aWYgKHJlc3VsdHMubGVuZ3RoID49IG9wdHMubGltaXQpIGJyZWFrO1xuXHRcdH1cblxuXHRcdHJldHVybiByZXN1bHRzO1xuXHR9XG59XG5cblxuIl19