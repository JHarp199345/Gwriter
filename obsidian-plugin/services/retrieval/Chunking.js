function clampInt(value, min, max) {
    if (!Number.isFinite(value))
        return min;
    return Math.max(min, Math.min(max, Math.floor(value)));
}
function splitWords(text) {
    return (text || '').split(/\s+/g).filter(Boolean);
}
function isHeadingLine(line, level) {
    const t = (line || '').trimStart();
    if (level === 'h1')
        return /^#(?!#)\s+/.test(t);
    if (level === 'h2')
        return /^##(?!#)\s+/.test(t);
    if (level === 'h3')
        return /^###(?!#)\s+/.test(t);
    return false;
}
function splitByHeadingLevel(text, level) {
    if (level === 'none')
        return [];
    const normalized = (text || '').replace(/\r\n/g, '\n');
    const lines = normalized.split('\n');
    const sections = [];
    let current = [];
    let seenHeading = false;
    const flush = () => {
        const body = current.join('\n').trim();
        if (body)
            sections.push(body);
    };
    for (const line of lines) {
        if (isHeadingLine(line, level)) {
            if (seenHeading)
                flush();
            seenHeading = true;
            current = [line.trimEnd()];
            continue;
        }
        current.push(line);
    }
    if (seenHeading) {
        flush();
        return sections;
    }
    return [];
}
function chunkWordsWindow(text, globalStartWord, targetWords, overlapWords) {
    const words = splitWords(text);
    if (words.length === 0)
        return [];
    const size = clampInt(targetWords, 200, 2000);
    const overlap = clampInt(overlapWords, 0, Math.max(0, size - 1));
    const step = Math.max(1, size - overlap);
    const out = [];
    for (let start = 0; start < words.length; start += step) {
        const end = Math.min(words.length, start + size);
        out.push({
            startWord: globalStartWord + start,
            endWord: globalStartWord + end,
            text: words.slice(start, end).join(' ')
        });
        if (end >= words.length)
            break;
    }
    return out;
}
function mergeSmallSections(sections, minWords) {
    const min = Math.max(1, Math.floor(minWords));
    const out = [];
    let buf = [];
    let bufWords = 0;
    const flush = () => {
        const merged = buf.join('\n\n').trim();
        if (merged)
            out.push(merged);
        buf = [];
        bufWords = 0;
    };
    for (const s of sections) {
        const words = splitWords(s).length;
        if (bufWords === 0) {
            buf = [s];
            bufWords = words;
        }
        else if (bufWords < min) {
            buf.push(s);
            bufWords += words;
        }
        else {
            flush();
            buf = [s];
            bufWords = words;
        }
    }
    if (bufWords > 0)
        flush();
    return out;
}
export function buildIndexChunks(params) {
    const level = params.headingLevel;
    const target = clampInt(params.targetWords, 200, 2000);
    const overlap = clampInt(params.overlapWords, 0, 500);
    // Preferred heading-based segmentation.
    const sections = splitByHeadingLevel(params.text, level);
    if (sections.length > 0) {
        const minWords = Math.max(200, Math.floor(target * 0.5));
        const merged = mergeSmallSections(sections, minWords);
        const out = [];
        let cursor = 0;
        for (const sec of merged) {
            const words = splitWords(sec).length;
            if (words <= target) {
                out.push({ startWord: cursor, endWord: cursor + words, text: sec });
                cursor += words;
                continue;
            }
            const sub = chunkWordsWindow(sec, cursor, target, overlap);
            out.push(...sub);
            cursor += words;
        }
        return out;
    }
    // Fallback: word-window chunking over the whole text.
    return chunkWordsWindow(params.text, 0, target, overlap);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2h1bmtpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDaHVua2luZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFRQSxTQUFTLFFBQVEsQ0FBQyxLQUFhLEVBQUUsR0FBVyxFQUFFLEdBQVc7SUFDeEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO1FBQUUsT0FBTyxHQUFHLENBQUM7SUFDeEMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN4RCxDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsSUFBWTtJQUMvQixPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDbkQsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFDLElBQVksRUFBRSxLQUFtQjtJQUN2RCxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQyxJQUFJLEtBQUssS0FBSyxJQUFJO1FBQUUsT0FBTyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hELElBQUksS0FBSyxLQUFLLElBQUk7UUFBRSxPQUFPLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakQsSUFBSSxLQUFLLEtBQUssSUFBSTtRQUFFLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRCxPQUFPLEtBQUssQ0FBQztBQUNkLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLElBQVksRUFBRSxLQUFtQjtJQUM3RCxJQUFJLEtBQUssS0FBSyxNQUFNO1FBQUUsT0FBTyxFQUFFLENBQUM7SUFDaEMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN2RCxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXJDLE1BQU0sUUFBUSxHQUFhLEVBQUUsQ0FBQztJQUM5QixJQUFJLE9BQU8sR0FBYSxFQUFFLENBQUM7SUFDM0IsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDO0lBRXhCLE1BQU0sS0FBSyxHQUFHLEdBQUcsRUFBRTtRQUNsQixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3ZDLElBQUksSUFBSTtZQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0IsQ0FBQyxDQUFDO0lBRUYsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUMxQixJQUFJLGFBQWEsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNoQyxJQUFJLFdBQVc7Z0JBQUUsS0FBSyxFQUFFLENBQUM7WUFDekIsV0FBVyxHQUFHLElBQUksQ0FBQztZQUNuQixPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUMzQixTQUFTO1FBQ1YsQ0FBQztRQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQUksV0FBVyxFQUFFLENBQUM7UUFDakIsS0FBSyxFQUFFLENBQUM7UUFDUixPQUFPLFFBQVEsQ0FBQztJQUNqQixDQUFDO0lBQ0QsT0FBTyxFQUFFLENBQUM7QUFDWCxDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FDeEIsSUFBWSxFQUNaLGVBQXVCLEVBQ3ZCLFdBQW1CLEVBQ25CLFlBQW9CO0lBRXBCLE1BQU0sS0FBSyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQztRQUFFLE9BQU8sRUFBRSxDQUFDO0lBRWxDLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzlDLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksR0FBRyxPQUFPLENBQUMsQ0FBQztJQUV6QyxNQUFNLEdBQUcsR0FBaUIsRUFBRSxDQUFDO0lBQzdCLEtBQUssSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLEtBQUssSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN6RCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ2pELEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDUixTQUFTLEVBQUUsZUFBZSxHQUFHLEtBQUs7WUFDbEMsT0FBTyxFQUFFLGVBQWUsR0FBRyxHQUFHO1lBQzlCLElBQUksRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1NBQ3ZDLENBQUMsQ0FBQztRQUNILElBQUksR0FBRyxJQUFJLEtBQUssQ0FBQyxNQUFNO1lBQUUsTUFBTTtJQUNoQyxDQUFDO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDWixDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxRQUFrQixFQUFFLFFBQWdCO0lBQy9ELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUM5QyxNQUFNLEdBQUcsR0FBYSxFQUFFLENBQUM7SUFFekIsSUFBSSxHQUFHLEdBQWEsRUFBRSxDQUFDO0lBQ3ZCLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQztJQUVqQixNQUFNLEtBQUssR0FBRyxHQUFHLEVBQUU7UUFDbEIsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QyxJQUFJLE1BQU07WUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdCLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDVCxRQUFRLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsQ0FBQyxDQUFDO0lBRUYsS0FBSyxNQUFNLENBQUMsSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUMxQixNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ25DLElBQUksUUFBUSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3BCLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1YsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUNsQixDQUFDO2FBQU0sSUFBSSxRQUFRLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDM0IsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNaLFFBQVEsSUFBSSxLQUFLLENBQUM7UUFDbkIsQ0FBQzthQUFNLENBQUM7WUFDUCxLQUFLLEVBQUUsQ0FBQztZQUNSLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1YsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUNsQixDQUFDO0lBQ0YsQ0FBQztJQUNELElBQUksUUFBUSxHQUFHLENBQUM7UUFBRSxLQUFLLEVBQUUsQ0FBQztJQUMxQixPQUFPLEdBQUcsQ0FBQztBQUNaLENBQUM7QUFFRCxNQUFNLFVBQVUsZ0JBQWdCLENBQUMsTUFLaEM7SUFDQSxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO0lBQ2xDLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN2RCxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFFdEQsd0NBQXdDO0lBQ3hDLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekQsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3pCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDekQsTUFBTSxNQUFNLEdBQUcsa0JBQWtCLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRXRELE1BQU0sR0FBRyxHQUFpQixFQUFFLENBQUM7UUFDN0IsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUMxQixNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQ3JDLElBQUksS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO2dCQUNyQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxHQUFHLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDcEUsTUFBTSxJQUFJLEtBQUssQ0FBQztnQkFDaEIsU0FBUztZQUNWLENBQUM7WUFDRCxNQUFNLEdBQUcsR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMzRCxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQztRQUNqQixDQUFDO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDO0lBRUQsc0RBQXNEO0lBQ3RELE9BQU8sZ0JBQWdCLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQzFELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgdHlwZSBIZWFkaW5nTGV2ZWwgPSAnaDEnIHwgJ2gyJyB8ICdoMycgfCAnbm9uZSc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEluZGV4Q2h1bmsge1xyXG5cdHN0YXJ0V29yZDogbnVtYmVyO1xyXG5cdGVuZFdvcmQ6IG51bWJlcjtcclxuXHR0ZXh0OiBzdHJpbmc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNsYW1wSW50KHZhbHVlOiBudW1iZXIsIG1pbjogbnVtYmVyLCBtYXg6IG51bWJlcik6IG51bWJlciB7XHJcblx0aWYgKCFOdW1iZXIuaXNGaW5pdGUodmFsdWUpKSByZXR1cm4gbWluO1xyXG5cdHJldHVybiBNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgTWF0aC5mbG9vcih2YWx1ZSkpKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc3BsaXRXb3Jkcyh0ZXh0OiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcblx0cmV0dXJuICh0ZXh0IHx8ICcnKS5zcGxpdCgvXFxzKy9nKS5maWx0ZXIoQm9vbGVhbik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzSGVhZGluZ0xpbmUobGluZTogc3RyaW5nLCBsZXZlbDogSGVhZGluZ0xldmVsKTogYm9vbGVhbiB7XHJcblx0Y29uc3QgdCA9IChsaW5lIHx8ICcnKS50cmltU3RhcnQoKTtcclxuXHRpZiAobGV2ZWwgPT09ICdoMScpIHJldHVybiAvXiMoPyEjKVxccysvLnRlc3QodCk7XHJcblx0aWYgKGxldmVsID09PSAnaDInKSByZXR1cm4gL14jIyg/ISMpXFxzKy8udGVzdCh0KTtcclxuXHRpZiAobGV2ZWwgPT09ICdoMycpIHJldHVybiAvXiMjIyg/ISMpXFxzKy8udGVzdCh0KTtcclxuXHRyZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNwbGl0QnlIZWFkaW5nTGV2ZWwodGV4dDogc3RyaW5nLCBsZXZlbDogSGVhZGluZ0xldmVsKTogc3RyaW5nW10ge1xyXG5cdGlmIChsZXZlbCA9PT0gJ25vbmUnKSByZXR1cm4gW107XHJcblx0Y29uc3Qgbm9ybWFsaXplZCA9ICh0ZXh0IHx8ICcnKS5yZXBsYWNlKC9cXHJcXG4vZywgJ1xcbicpO1xyXG5cdGNvbnN0IGxpbmVzID0gbm9ybWFsaXplZC5zcGxpdCgnXFxuJyk7XHJcblxyXG5cdGNvbnN0IHNlY3Rpb25zOiBzdHJpbmdbXSA9IFtdO1xyXG5cdGxldCBjdXJyZW50OiBzdHJpbmdbXSA9IFtdO1xyXG5cdGxldCBzZWVuSGVhZGluZyA9IGZhbHNlO1xyXG5cclxuXHRjb25zdCBmbHVzaCA9ICgpID0+IHtcclxuXHRcdGNvbnN0IGJvZHkgPSBjdXJyZW50LmpvaW4oJ1xcbicpLnRyaW0oKTtcclxuXHRcdGlmIChib2R5KSBzZWN0aW9ucy5wdXNoKGJvZHkpO1xyXG5cdH07XHJcblxyXG5cdGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xyXG5cdFx0aWYgKGlzSGVhZGluZ0xpbmUobGluZSwgbGV2ZWwpKSB7XHJcblx0XHRcdGlmIChzZWVuSGVhZGluZykgZmx1c2goKTtcclxuXHRcdFx0c2VlbkhlYWRpbmcgPSB0cnVlO1xyXG5cdFx0XHRjdXJyZW50ID0gW2xpbmUudHJpbUVuZCgpXTtcclxuXHRcdFx0Y29udGludWU7XHJcblx0XHR9XHJcblx0XHRjdXJyZW50LnB1c2gobGluZSk7XHJcblx0fVxyXG5cclxuXHRpZiAoc2VlbkhlYWRpbmcpIHtcclxuXHRcdGZsdXNoKCk7XHJcblx0XHRyZXR1cm4gc2VjdGlvbnM7XHJcblx0fVxyXG5cdHJldHVybiBbXTtcclxufVxyXG5cclxuZnVuY3Rpb24gY2h1bmtXb3Jkc1dpbmRvdyhcclxuXHR0ZXh0OiBzdHJpbmcsXHJcblx0Z2xvYmFsU3RhcnRXb3JkOiBudW1iZXIsXHJcblx0dGFyZ2V0V29yZHM6IG51bWJlcixcclxuXHRvdmVybGFwV29yZHM6IG51bWJlclxyXG4pOiBJbmRleENodW5rW10ge1xyXG5cdGNvbnN0IHdvcmRzID0gc3BsaXRXb3Jkcyh0ZXh0KTtcclxuXHRpZiAod29yZHMubGVuZ3RoID09PSAwKSByZXR1cm4gW107XHJcblxyXG5cdGNvbnN0IHNpemUgPSBjbGFtcEludCh0YXJnZXRXb3JkcywgMjAwLCAyMDAwKTtcclxuXHRjb25zdCBvdmVybGFwID0gY2xhbXBJbnQob3ZlcmxhcFdvcmRzLCAwLCBNYXRoLm1heCgwLCBzaXplIC0gMSkpO1xyXG5cdGNvbnN0IHN0ZXAgPSBNYXRoLm1heCgxLCBzaXplIC0gb3ZlcmxhcCk7XHJcblxyXG5cdGNvbnN0IG91dDogSW5kZXhDaHVua1tdID0gW107XHJcblx0Zm9yIChsZXQgc3RhcnQgPSAwOyBzdGFydCA8IHdvcmRzLmxlbmd0aDsgc3RhcnQgKz0gc3RlcCkge1xyXG5cdFx0Y29uc3QgZW5kID0gTWF0aC5taW4od29yZHMubGVuZ3RoLCBzdGFydCArIHNpemUpO1xyXG5cdFx0b3V0LnB1c2goe1xyXG5cdFx0XHRzdGFydFdvcmQ6IGdsb2JhbFN0YXJ0V29yZCArIHN0YXJ0LFxyXG5cdFx0XHRlbmRXb3JkOiBnbG9iYWxTdGFydFdvcmQgKyBlbmQsXHJcblx0XHRcdHRleHQ6IHdvcmRzLnNsaWNlKHN0YXJ0LCBlbmQpLmpvaW4oJyAnKVxyXG5cdFx0fSk7XHJcblx0XHRpZiAoZW5kID49IHdvcmRzLmxlbmd0aCkgYnJlYWs7XHJcblx0fVxyXG5cdHJldHVybiBvdXQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1lcmdlU21hbGxTZWN0aW9ucyhzZWN0aW9uczogc3RyaW5nW10sIG1pbldvcmRzOiBudW1iZXIpOiBzdHJpbmdbXSB7XHJcblx0Y29uc3QgbWluID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihtaW5Xb3JkcykpO1xyXG5cdGNvbnN0IG91dDogc3RyaW5nW10gPSBbXTtcclxuXHJcblx0bGV0IGJ1Zjogc3RyaW5nW10gPSBbXTtcclxuXHRsZXQgYnVmV29yZHMgPSAwO1xyXG5cclxuXHRjb25zdCBmbHVzaCA9ICgpID0+IHtcclxuXHRcdGNvbnN0IG1lcmdlZCA9IGJ1Zi5qb2luKCdcXG5cXG4nKS50cmltKCk7XHJcblx0XHRpZiAobWVyZ2VkKSBvdXQucHVzaChtZXJnZWQpO1xyXG5cdFx0YnVmID0gW107XHJcblx0XHRidWZXb3JkcyA9IDA7XHJcblx0fTtcclxuXHJcblx0Zm9yIChjb25zdCBzIG9mIHNlY3Rpb25zKSB7XHJcblx0XHRjb25zdCB3b3JkcyA9IHNwbGl0V29yZHMocykubGVuZ3RoO1xyXG5cdFx0aWYgKGJ1ZldvcmRzID09PSAwKSB7XHJcblx0XHRcdGJ1ZiA9IFtzXTtcclxuXHRcdFx0YnVmV29yZHMgPSB3b3JkcztcclxuXHRcdH0gZWxzZSBpZiAoYnVmV29yZHMgPCBtaW4pIHtcclxuXHRcdFx0YnVmLnB1c2gocyk7XHJcblx0XHRcdGJ1ZldvcmRzICs9IHdvcmRzO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0Zmx1c2goKTtcclxuXHRcdFx0YnVmID0gW3NdO1xyXG5cdFx0XHRidWZXb3JkcyA9IHdvcmRzO1xyXG5cdFx0fVxyXG5cdH1cclxuXHRpZiAoYnVmV29yZHMgPiAwKSBmbHVzaCgpO1xyXG5cdHJldHVybiBvdXQ7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBidWlsZEluZGV4Q2h1bmtzKHBhcmFtczoge1xyXG5cdHRleHQ6IHN0cmluZztcclxuXHRoZWFkaW5nTGV2ZWw6IEhlYWRpbmdMZXZlbDtcclxuXHR0YXJnZXRXb3JkczogbnVtYmVyO1xyXG5cdG92ZXJsYXBXb3JkczogbnVtYmVyO1xyXG59KTogSW5kZXhDaHVua1tdIHtcclxuXHRjb25zdCBsZXZlbCA9IHBhcmFtcy5oZWFkaW5nTGV2ZWw7XHJcblx0Y29uc3QgdGFyZ2V0ID0gY2xhbXBJbnQocGFyYW1zLnRhcmdldFdvcmRzLCAyMDAsIDIwMDApO1xyXG5cdGNvbnN0IG92ZXJsYXAgPSBjbGFtcEludChwYXJhbXMub3ZlcmxhcFdvcmRzLCAwLCA1MDApO1xyXG5cclxuXHQvLyBQcmVmZXJyZWQgaGVhZGluZy1iYXNlZCBzZWdtZW50YXRpb24uXHJcblx0Y29uc3Qgc2VjdGlvbnMgPSBzcGxpdEJ5SGVhZGluZ0xldmVsKHBhcmFtcy50ZXh0LCBsZXZlbCk7XHJcblx0aWYgKHNlY3Rpb25zLmxlbmd0aCA+IDApIHtcclxuXHRcdGNvbnN0IG1pbldvcmRzID0gTWF0aC5tYXgoMjAwLCBNYXRoLmZsb29yKHRhcmdldCAqIDAuNSkpO1xyXG5cdFx0Y29uc3QgbWVyZ2VkID0gbWVyZ2VTbWFsbFNlY3Rpb25zKHNlY3Rpb25zLCBtaW5Xb3Jkcyk7XHJcblxyXG5cdFx0Y29uc3Qgb3V0OiBJbmRleENodW5rW10gPSBbXTtcclxuXHRcdGxldCBjdXJzb3IgPSAwO1xyXG5cdFx0Zm9yIChjb25zdCBzZWMgb2YgbWVyZ2VkKSB7XHJcblx0XHRcdGNvbnN0IHdvcmRzID0gc3BsaXRXb3JkcyhzZWMpLmxlbmd0aDtcclxuXHRcdFx0aWYgKHdvcmRzIDw9IHRhcmdldCkge1xyXG5cdFx0XHRcdG91dC5wdXNoKHsgc3RhcnRXb3JkOiBjdXJzb3IsIGVuZFdvcmQ6IGN1cnNvciArIHdvcmRzLCB0ZXh0OiBzZWMgfSk7XHJcblx0XHRcdFx0Y3Vyc29yICs9IHdvcmRzO1xyXG5cdFx0XHRcdGNvbnRpbnVlO1xyXG5cdFx0XHR9XHJcblx0XHRcdGNvbnN0IHN1YiA9IGNodW5rV29yZHNXaW5kb3coc2VjLCBjdXJzb3IsIHRhcmdldCwgb3ZlcmxhcCk7XHJcblx0XHRcdG91dC5wdXNoKC4uLnN1Yik7XHJcblx0XHRcdGN1cnNvciArPSB3b3JkcztcclxuXHRcdH1cclxuXHRcdHJldHVybiBvdXQ7XHJcblx0fVxyXG5cclxuXHQvLyBGYWxsYmFjazogd29yZC13aW5kb3cgY2h1bmtpbmcgb3ZlciB0aGUgd2hvbGUgdGV4dC5cclxuXHRyZXR1cm4gY2h1bmtXb3Jkc1dpbmRvdyhwYXJhbXMudGV4dCwgMCwgdGFyZ2V0LCBvdmVybGFwKTtcclxufVxyXG5cclxuXHJcbiJdfQ==