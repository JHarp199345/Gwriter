function clampInt(value, min, max) {
    if (!Number.isFinite(value))
        return min;
    return Math.max(min, Math.min(max, Math.floor(value)));
}
function splitWords(text) {
    return (text || '').split(/\s+/g).filter(Boolean);
}
function isHeadingLine(line, level) {
    const t = (line || '').trimStart();
    if (level === 'h1')
        return /^#(?!#)\s+/.test(t);
    if (level === 'h2')
        return /^##(?!#)\s+/.test(t);
    if (level === 'h3')
        return /^###(?!#)\s+/.test(t);
    return false;
}
function splitByHeadingLevel(text, level) {
    if (level === 'none')
        return [];
    const normalized = (text || '').replace(/\r\n/g, '\n');
    const lines = normalized.split('\n');
    const sections = [];
    let current = [];
    let seenHeading = false;
    const flush = () => {
        const body = current.join('\n').trim();
        if (body)
            sections.push(body);
    };
    for (const line of lines) {
        if (isHeadingLine(line, level)) {
            if (seenHeading)
                flush();
            seenHeading = true;
            current = [line.trimEnd()];
            continue;
        }
        current.push(line);
    }
    if (seenHeading) {
        flush();
        return sections;
    }
    return [];
}
function chunkWordsWindow(text, globalStartWord, targetWords, overlapWords) {
    const words = splitWords(text);
    if (words.length === 0)
        return [];
    const size = clampInt(targetWords, 200, 2000);
    const overlap = clampInt(overlapWords, 0, Math.max(0, size - 1));
    const step = Math.max(1, size - overlap);
    const out = [];
    for (let start = 0; start < words.length; start += step) {
        const end = Math.min(words.length, start + size);
        out.push({
            startWord: globalStartWord + start,
            endWord: globalStartWord + end,
            text: words.slice(start, end).join(' ')
        });
        if (end >= words.length)
            break;
    }
    return out;
}
function mergeSmallSections(sections, minWords) {
    const min = Math.max(1, Math.floor(minWords));
    const out = [];
    let buf = [];
    let bufWords = 0;
    const flush = () => {
        const merged = buf.join('\n\n').trim();
        if (merged)
            out.push(merged);
        buf = [];
        bufWords = 0;
    };
    for (const s of sections) {
        const words = splitWords(s).length;
        if (bufWords === 0) {
            buf = [s];
            bufWords = words;
        }
        else if (bufWords < min) {
            buf.push(s);
            bufWords += words;
        }
        else {
            flush();
            buf = [s];
            bufWords = words;
        }
    }
    if (bufWords > 0)
        flush();
    return out;
}
export function buildIndexChunks(params) {
    const level = params.headingLevel;
    const target = clampInt(params.targetWords, 200, 2000);
    const overlap = clampInt(params.overlapWords, 0, 500);
    // Preferred heading-based segmentation.
    const sections = splitByHeadingLevel(params.text, level);
    if (sections.length > 0) {
        const minWords = Math.max(200, Math.floor(target * 0.5));
        const merged = mergeSmallSections(sections, minWords);
        const out = [];
        let cursor = 0;
        for (const sec of merged) {
            const words = splitWords(sec).length;
            if (words <= target) {
                out.push({ startWord: cursor, endWord: cursor + words, text: sec });
                cursor += words;
                continue;
            }
            const sub = chunkWordsWindow(sec, cursor, target, overlap);
            out.push(...sub);
            cursor += words;
        }
        return out;
    }
    // Fallback: word-window chunking over the whole text.
    return chunkWordsWindow(params.text, 0, target, overlap);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2h1bmtpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDaHVua2luZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFRQSxTQUFTLFFBQVEsQ0FBQyxLQUFhLEVBQUUsR0FBVyxFQUFFLEdBQVc7SUFDeEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO1FBQUUsT0FBTyxHQUFHLENBQUM7SUFDeEMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN4RCxDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsSUFBWTtJQUMvQixPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDbkQsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFDLElBQVksRUFBRSxLQUFtQjtJQUN2RCxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQyxJQUFJLEtBQUssS0FBSyxJQUFJO1FBQUUsT0FBTyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hELElBQUksS0FBSyxLQUFLLElBQUk7UUFBRSxPQUFPLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakQsSUFBSSxLQUFLLEtBQUssSUFBSTtRQUFFLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRCxPQUFPLEtBQUssQ0FBQztBQUNkLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLElBQVksRUFBRSxLQUFtQjtJQUM3RCxJQUFJLEtBQUssS0FBSyxNQUFNO1FBQUUsT0FBTyxFQUFFLENBQUM7SUFDaEMs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QUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQztRQUNqQixDQUFDO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDO0lBRUQsc0RBQXNEO0lBQ3RELE9BQU8sZ0JBQWdCLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQzFELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgdHlwZSBIZWFkaW5nTGV2ZWwgPSAnaDEnIHwgJ2gyJyB8ICdoMycgfCAnbm9uZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSW5kZXhDaHVuayB7XG5cdHN0YXJ0V29yZDogbnVtYmVyO1xuXHRlbmRXb3JkOiBudW1iZXI7XG5cdHRleHQ6IHN0cmluZztcbn1cblxuZnVuY3Rpb24gY2xhbXBJbnQodmFsdWU6IG51bWJlciwgbWluOiBudW1iZXIsIG1heDogbnVtYmVyKTogbnVtYmVyIHtcblx0aWYgKCFOdW1iZXIuaXNGaW5pdGUodmFsdWUpKSByZXR1cm4gbWluO1xuXHRyZXR1cm4gTWF0aC5tYXgobWluLCBNYXRoLm1pbihtYXgsIE1hdGguZmxvb3IodmFsdWUpKSk7XG59XG5cbmZ1bmN0aW9uIHNwbGl0V29yZHModGV4dDogc3RyaW5nKTogc3RyaW5nW10ge1xuXHRyZXR1cm4gKHRleHQgfHwgJycpLnNwbGl0KC9cXHMrL2cpLmZpbHRlcihCb29sZWFuKTtcbn1cblxuZnVuY3Rpb24gaXNIZWFkaW5nTGluZShsaW5lOiBzdHJpbmcsIGxldmVsOiBIZWFkaW5nTGV2ZWwpOiBib29sZWFuIHtcblx0Y29uc3QgdCA9IChsaW5lIHx8ICcnKS50cmltU3RhcnQoKTtcblx0aWYgKGxldmVsID09PSAnaDEnKSByZXR1cm4gL14jKD8hIylcXHMrLy50ZXN0KHQpO1xuXHRpZiAobGV2ZWwgPT09ICdoMicpIHJldHVybiAvXiMjKD8hIylcXHMrLy50ZXN0KHQpO1xuXHRpZiAobGV2ZWwgPT09ICdoMycpIHJldHVybiAvXiMjIyg/ISMpXFxzKy8udGVzdCh0KTtcblx0cmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBzcGxpdEJ5SGVhZGluZ0xldmVsKHRleHQ6IHN0cmluZywgbGV2ZWw6IEhlYWRpbmdMZXZlbCk6IHN0cmluZ1tdIHtcblx0aWYgKGxldmVsID09PSAnbm9uZScpIHJldHVybiBbXTtcblx0Y29uc3Qgbm9ybWFsaXplZCA9ICh0ZXh0IHx8ICcnKS5yZXBsYWNlKC9cXHJcXG4vZywgJ1xcbicpO1xuXHRjb25zdCBsaW5lcyA9IG5vcm1hbGl6ZWQuc3BsaXQoJ1xcbicpO1xuXG5cdGNvbnN0IHNlY3Rpb25zOiBzdHJpbmdbXSA9IFtdO1xuXHRsZXQgY3VycmVudDogc3RyaW5nW10gPSBbXTtcblx0bGV0IHNlZW5IZWFkaW5nID0gZmFsc2U7XG5cblx0Y29uc3QgZmx1c2ggPSAoKSA9PiB7XG5cdFx0Y29uc3QgYm9keSA9IGN1cnJlbnQuam9pbignXFxuJykudHJpbSgpO1xuXHRcdGlmIChib2R5KSBzZWN0aW9ucy5wdXNoKGJvZHkpO1xuXHR9O1xuXG5cdGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuXHRcdGlmIChpc0hlYWRpbmdMaW5lKGxpbmUsIGxldmVsKSkge1xuXHRcdFx0aWYgKHNlZW5IZWFkaW5nKSBmbHVzaCgpO1xuXHRcdFx0c2VlbkhlYWRpbmcgPSB0cnVlO1xuXHRcdFx0Y3VycmVudCA9IFtsaW5lLnRyaW1FbmQoKV07XG5cdFx0XHRjb250aW51ZTtcblx0XHR9XG5cdFx0Y3VycmVudC5wdXNoKGxpbmUpO1xuXHR9XG5cblx0aWYgKHNlZW5IZWFkaW5nKSB7XG5cdFx0Zmx1c2goKTtcblx0XHRyZXR1cm4gc2VjdGlvbnM7XG5cdH1cblx0cmV0dXJuIFtdO1xufVxuXG5mdW5jdGlvbiBjaHVua1dvcmRzV2luZG93KFxuXHR0ZXh0OiBzdHJpbmcsXG5cdGdsb2JhbFN0YXJ0V29yZDogbnVtYmVyLFxuXHR0YXJnZXRXb3JkczogbnVtYmVyLFxuXHRvdmVybGFwV29yZHM6IG51bWJlclxuKTogSW5kZXhDaHVua1tdIHtcblx0Y29uc3Qgd29yZHMgPSBzcGxpdFdvcmRzKHRleHQpO1xuXHRpZiAod29yZHMubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG5cblx0Y29uc3Qgc2l6ZSA9IGNsYW1wSW50KHRhcmdldFdvcmRzLCAyMDAsIDIwMDApO1xuXHRjb25zdCBvdmVybGFwID0gY2xhbXBJbnQob3ZlcmxhcFdvcmRzLCAwLCBNYXRoLm1heCgwLCBzaXplIC0gMSkpO1xuXHRjb25zdCBzdGVwID0gTWF0aC5tYXgoMSwgc2l6ZSAtIG92ZXJsYXApO1xuXG5cdGNvbnN0IG91dDogSW5kZXhDaHVua1tdID0gW107XG5cdGZvciAobGV0IHN0YXJ0ID0gMDsgc3RhcnQgPCB3b3Jkcy5sZW5ndGg7IHN0YXJ0ICs9IHN0ZXApIHtcblx0XHRjb25zdCBlbmQgPSBNYXRoLm1pbih3b3Jkcy5sZW5ndGgsIHN0YXJ0ICsgc2l6ZSk7XG5cdFx0b3V0LnB1c2goe1xuXHRcdFx0c3RhcnRXb3JkOiBnbG9iYWxTdGFydFdvcmQgKyBzdGFydCxcblx0XHRcdGVuZFdvcmQ6IGdsb2JhbFN0YXJ0V29yZCArIGVuZCxcblx0XHRcdHRleHQ6IHdvcmRzLnNsaWNlKHN0YXJ0LCBlbmQpLmpvaW4oJyAnKVxuXHRcdH0pO1xuXHRcdGlmIChlbmQgPj0gd29yZHMubGVuZ3RoKSBicmVhaztcblx0fVxuXHRyZXR1cm4gb3V0O1xufVxuXG5mdW5jdGlvbiBtZXJnZVNtYWxsU2VjdGlvbnMoc2VjdGlvbnM6IHN0cmluZ1tdLCBtaW5Xb3JkczogbnVtYmVyKTogc3RyaW5nW10ge1xuXHRjb25zdCBtaW4gPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKG1pbldvcmRzKSk7XG5cdGNvbnN0IG91dDogc3RyaW5nW10gPSBbXTtcblxuXHRsZXQgYnVmOiBzdHJpbmdbXSA9IFtdO1xuXHRsZXQgYnVmV29yZHMgPSAwO1xuXG5cdGNvbnN0IGZsdXNoID0gKCkgPT4ge1xuXHRcdGNvbnN0IG1lcmdlZCA9IGJ1Zi5qb2luKCdcXG5cXG4nKS50cmltKCk7XG5cdFx0aWYgKG1lcmdlZCkgb3V0LnB1c2gobWVyZ2VkKTtcblx0XHRidWYgPSBbXTtcblx0XHRidWZXb3JkcyA9IDA7XG5cdH07XG5cblx0Zm9yIChjb25zdCBzIG9mIHNlY3Rpb25zKSB7XG5cdFx0Y29uc3Qgd29yZHMgPSBzcGxpdFdvcmRzKHMpLmxlbmd0aDtcblx0XHRpZiAoYnVmV29yZHMgPT09IDApIHtcblx0XHRcdGJ1ZiA9IFtzXTtcblx0XHRcdGJ1ZldvcmRzID0gd29yZHM7XG5cdFx0fSBlbHNlIGlmIChidWZXb3JkcyA8IG1pbikge1xuXHRcdFx0YnVmLnB1c2gocyk7XG5cdFx0XHRidWZXb3JkcyArPSB3b3Jkcztcblx0XHR9IGVsc2Uge1xuXHRcdFx0Zmx1c2goKTtcblx0XHRcdGJ1ZiA9IFtzXTtcblx0XHRcdGJ1ZldvcmRzID0gd29yZHM7XG5cdFx0fVxuXHR9XG5cdGlmIChidWZXb3JkcyA+IDApIGZsdXNoKCk7XG5cdHJldHVybiBvdXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZEluZGV4Q2h1bmtzKHBhcmFtczoge1xuXHR0ZXh0OiBzdHJpbmc7XG5cdGhlYWRpbmdMZXZlbDogSGVhZGluZ0xldmVsO1xuXHR0YXJnZXRXb3JkczogbnVtYmVyO1xuXHRvdmVybGFwV29yZHM6IG51bWJlcjtcbn0pOiBJbmRleENodW5rW10ge1xuXHRjb25zdCBsZXZlbCA9IHBhcmFtcy5oZWFkaW5nTGV2ZWw7XG5cdGNvbnN0IHRhcmdldCA9IGNsYW1wSW50KHBhcmFtcy50YXJnZXRXb3JkcywgMjAwLCAyMDAwKTtcblx0Y29uc3Qgb3ZlcmxhcCA9IGNsYW1wSW50KHBhcmFtcy5vdmVybGFwV29yZHMsIDAsIDUwMCk7XG5cblx0Ly8gUHJlZmVycmVkIGhlYWRpbmctYmFzZWQgc2VnbWVudGF0aW9uLlxuXHRjb25zdCBzZWN0aW9ucyA9IHNwbGl0QnlIZWFkaW5nTGV2ZWwocGFyYW1zLnRleHQsIGxldmVsKTtcblx0aWYgKHNlY3Rpb25zLmxlbmd0aCA+IDApIHtcblx0XHRjb25zdCBtaW5Xb3JkcyA9IE1hdGgubWF4KDIwMCwgTWF0aC5mbG9vcih0YXJnZXQgKiAwLjUpKTtcblx0XHRjb25zdCBtZXJnZWQgPSBtZXJnZVNtYWxsU2VjdGlvbnMoc2VjdGlvbnMsIG1pbldvcmRzKTtcblxuXHRcdGNvbnN0IG91dDogSW5kZXhDaHVua1tdID0gW107XG5cdFx0bGV0IGN1cnNvciA9IDA7XG5cdFx0Zm9yIChjb25zdCBzZWMgb2YgbWVyZ2VkKSB7XG5cdFx0XHRjb25zdCB3b3JkcyA9IHNwbGl0V29yZHMoc2VjKS5sZW5ndGg7XG5cdFx0XHRpZiAod29yZHMgPD0gdGFyZ2V0KSB7XG5cdFx0XHRcdG91dC5wdXNoKHsgc3RhcnRXb3JkOiBjdXJzb3IsIGVuZFdvcmQ6IGN1cnNvciArIHdvcmRzLCB0ZXh0OiBzZWMgfSk7XG5cdFx0XHRcdGN1cnNvciArPSB3b3Jkcztcblx0XHRcdFx0Y29udGludWU7XG5cdFx0XHR9XG5cdFx0XHRjb25zdCBzdWIgPSBjaHVua1dvcmRzV2luZG93KHNlYywgY3Vyc29yLCB0YXJnZXQsIG92ZXJsYXApO1xuXHRcdFx0b3V0LnB1c2goLi4uc3ViKTtcblx0XHRcdGN1cnNvciArPSB3b3Jkcztcblx0XHR9XG5cdFx0cmV0dXJuIG91dDtcblx0fVxuXG5cdC8vIEZhbGxiYWNrOiB3b3JkLXdpbmRvdyBjaHVua2luZyBvdmVyIHRoZSB3aG9sZSB0ZXh0LlxuXHRyZXR1cm4gY2h1bmtXb3Jkc1dpbmRvdyhwYXJhbXMudGV4dCwgMCwgdGFyZ2V0LCBvdmVybGFwKTtcbn1cblxuXG4iXX0=