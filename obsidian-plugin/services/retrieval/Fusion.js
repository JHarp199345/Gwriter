function mergeReasonTags(a, b) {
    if (!a?.length && !b?.length)
        return undefined;
    const set = new Set();
    a?.forEach((t) => set.add(t));
    b?.forEach((t) => set.add(t));
    return Array.from(set);
}
/**
 * Reciprocal Rank Fusion (RRF) across provider-ranked lists.
 * Produces a stable ranking even when providers disagree on score scales.
 */
export function fuseRrf(batches, opts) {
    const k = opts?.k ?? 60;
    const limit = opts?.limit ?? 200;
    const acc = new Map();
    for (const batch of batches) {
        const sorted = (batch.items || []).slice().sort((a, b) => b.score - a.score);
        for (let i = 0; i < sorted.length; i++) {
            const it = sorted[i];
            const key = it.key || `${it.path}${it.anchor ? `#${it.anchor}` : ''}`;
            const add = 1 / (k + (i + 1));
            const existing = acc.get(key);
            if (!existing) {
                acc.set(key, { item: { ...it, key }, score: add });
            }
            else {
                acc.set(key, {
                    item: {
                        ...existing.item,
                        // keep highest base score among providers but include tags from both
                        score: Math.max(existing.item.score, it.score),
                        reasonTags: mergeReasonTags(existing.item.reasonTags, it.reasonTags)
                    },
                    score: existing.score + add
                });
            }
        }
    }
    const fused = Array.from(acc.values())
        .sort((a, b) => b.score - a.score)
        .slice(0, Math.max(1, Math.min(1000, limit)));
    // Normalize fused scores to 0..1 for downstream consumers.
    let max = 0;
    for (const f of fused)
        if (f.score > max)
            max = f.score;
    const denom = max || 1;
    return fused.map((f) => ({
        ...f.item,
        score: Math.max(0, Math.min(1, f.score / denom)),
        source: 'fused',
        reasonTags: mergeReasonTags(f.item.reasonTags, ['fused'])
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRnVzaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRnVzaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLFNBQVMsZUFBZSxDQUFDLENBQXVCLEVBQUUsQ0FBdUI7SUFDeEUsSUFBSSxDQUFDLENBQUMsRUFBRSxNQUFNLElBQUksQ0FBQyxDQUFDLEVBQUUsTUFBTTtRQUFFLE9BQU8sU0FBUyxDQUFDO0lBQy9DLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7SUFDOUIsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlCLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM5QixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDeEIsQ0FBQztBQUVEOzs7R0FHRztBQUNILE1BQU0sVUFBVSxPQUFPLENBQUMsT0FBd0IsRUFBRSxJQUFxQztJQUN0RixNQUFNLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN4QixNQUFNLEtBQUssR0FBRyxJQUFJLEVBQUUsS0FBSyxJQUFJLEdBQUcsQ0FBQztJQUVqQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBZ0QsQ0FBQztJQUVwRSxLQUFLLE1BQU0sS0FBSyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzdCLE1BQU0sTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3RSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQixNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDdEUsTUFBTSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM5QixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ2YsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNwRCxDQUFDO2lCQUFNLENBQUM7Z0JBQ1AsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7b0JBQ1osSUFBSSxFQUFFO3dCQUNMLEdBQUcsUUFBUSxDQUFDLElBQUk7d0JBQ2hCLHFFQUFxRTt3QkFDckUsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQzt3QkFDOUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDO3FCQUNwRTtvQkFDRCxLQUFLLEVBQUUsUUFBUSxDQUFDLEtBQUssR0FBRyxHQUFHO2lCQUMzQixDQUFDLENBQUM7WUFDSixDQUFDO1FBQ0YsQ0FBQztJQUNGLENBQUM7SUFFRCxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUNwQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7U0FDakMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFL0MsMkRBQTJEO0lBQzNELElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztJQUNaLEtBQUssTUFBTSxDQUFDLElBQUksS0FBSztRQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssR0FBRyxHQUFHO1lBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7SUFDeEQsTUFBTSxLQUFLLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUV2QixPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDeEIsR0FBRyxDQUFDLENBQUMsSUFBSTtRQUNULEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDO1FBQ2hELE1BQU0sRUFBRSxPQUFPO1FBQ2YsVUFBVSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3pELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29udGV4dEl0ZW0gfSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBQcm92aWRlckJhdGNoIHtcblx0cHJvdmlkZXJJZDogc3RyaW5nO1xuXHRpdGVtczogQ29udGV4dEl0ZW1bXTtcbn1cblxuZnVuY3Rpb24gbWVyZ2VSZWFzb25UYWdzKGE6IHN0cmluZ1tdIHwgdW5kZWZpbmVkLCBiOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCk6IHN0cmluZ1tdIHwgdW5kZWZpbmVkIHtcblx0aWYgKCFhPy5sZW5ndGggJiYgIWI/Lmxlbmd0aCkgcmV0dXJuIHVuZGVmaW5lZDtcblx0Y29uc3Qgc2V0ID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cdGE/LmZvckVhY2goKHQpID0+IHNldC5hZGQodCkpO1xuXHRiPy5mb3JFYWNoKCh0KSA9PiBzZXQuYWRkKHQpKTtcblx0cmV0dXJuIEFycmF5LmZyb20oc2V0KTtcbn1cblxuLyoqXG4gKiBSZWNpcHJvY2FsIFJhbmsgRnVzaW9uIChSUkYpIGFjcm9zcyBwcm92aWRlci1yYW5rZWQgbGlzdHMuXG4gKiBQcm9kdWNlcyBhIHN0YWJsZSByYW5raW5nIGV2ZW4gd2hlbiBwcm92aWRlcnMgZGlzYWdyZWUgb24gc2NvcmUgc2NhbGVzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZnVzZVJyZihiYXRjaGVzOiBQcm92aWRlckJhdGNoW10sIG9wdHM/OiB7IGs/OiBudW1iZXI7IGxpbWl0PzogbnVtYmVyIH0pOiBDb250ZXh0SXRlbVtdIHtcblx0Y29uc3QgayA9IG9wdHM/LmsgPz8gNjA7XG5cdGNvbnN0IGxpbWl0ID0gb3B0cz8ubGltaXQgPz8gMjAwO1xuXG5cdGNvbnN0IGFjYyA9IG5ldyBNYXA8c3RyaW5nLCB7IGl0ZW06IENvbnRleHRJdGVtOyBzY29yZTogbnVtYmVyIH0+KCk7XG5cblx0Zm9yIChjb25zdCBiYXRjaCBvZiBiYXRjaGVzKSB7XG5cdFx0Y29uc3Qgc29ydGVkID0gKGJhdGNoLml0ZW1zIHx8IFtdKS5zbGljZSgpLnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKTtcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHNvcnRlZC5sZW5ndGg7IGkrKykge1xuXHRcdFx0Y29uc3QgaXQgPSBzb3J0ZWRbaV07XG5cdFx0XHRjb25zdCBrZXkgPSBpdC5rZXkgfHwgYCR7aXQucGF0aH0ke2l0LmFuY2hvciA/IGAjJHtpdC5hbmNob3J9YCA6ICcnfWA7XG5cdFx0XHRjb25zdCBhZGQgPSAxIC8gKGsgKyAoaSArIDEpKTtcblx0XHRcdGNvbnN0IGV4aXN0aW5nID0gYWNjLmdldChrZXkpO1xuXHRcdFx0aWYgKCFleGlzdGluZykge1xuXHRcdFx0XHRhY2Muc2V0KGtleSwgeyBpdGVtOiB7IC4uLml0LCBrZXkgfSwgc2NvcmU6IGFkZCB9KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGFjYy5zZXQoa2V5LCB7XG5cdFx0XHRcdFx0aXRlbToge1xuXHRcdFx0XHRcdFx0Li4uZXhpc3RpbmcuaXRlbSxcblx0XHRcdFx0XHRcdC8vIGtlZXAgaGlnaGVzdCBiYXNlIHNjb3JlIGFtb25nIHByb3ZpZGVycyBidXQgaW5jbHVkZSB0YWdzIGZyb20gYm90aFxuXHRcdFx0XHRcdFx0c2NvcmU6IE1hdGgubWF4KGV4aXN0aW5nLml0ZW0uc2NvcmUsIGl0LnNjb3JlKSxcblx0XHRcdFx0XHRcdHJlYXNvblRhZ3M6IG1lcmdlUmVhc29uVGFncyhleGlzdGluZy5pdGVtLnJlYXNvblRhZ3MsIGl0LnJlYXNvblRhZ3MpXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRzY29yZTogZXhpc3Rpbmcuc2NvcmUgKyBhZGRcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0Y29uc3QgZnVzZWQgPSBBcnJheS5mcm9tKGFjYy52YWx1ZXMoKSlcblx0XHQuc29ydCgoYSwgYikgPT4gYi5zY29yZSAtIGEuc2NvcmUpXG5cdFx0LnNsaWNlKDAsIE1hdGgubWF4KDEsIE1hdGgubWluKDEwMDAsIGxpbWl0KSkpO1xuXG5cdC8vIE5vcm1hbGl6ZSBmdXNlZCBzY29yZXMgdG8gMC4uMSBmb3IgZG93bnN0cmVhbSBjb25zdW1lcnMuXG5cdGxldCBtYXggPSAwO1xuXHRmb3IgKGNvbnN0IGYgb2YgZnVzZWQpIGlmIChmLnNjb3JlID4gbWF4KSBtYXggPSBmLnNjb3JlO1xuXHRjb25zdCBkZW5vbSA9IG1heCB8fCAxO1xuXG5cdHJldHVybiBmdXNlZC5tYXAoKGYpID0+ICh7XG5cdFx0Li4uZi5pdGVtLFxuXHRcdHNjb3JlOiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBmLnNjb3JlIC8gZGVub20pKSxcblx0XHRzb3VyY2U6ICdmdXNlZCcsXG5cdFx0cmVhc29uVGFnczogbWVyZ2VSZWFzb25UYWdzKGYuaXRlbS5yZWFzb25UYWdzLCBbJ2Z1c2VkJ10pXG5cdH0pKTtcbn1cblxuXG4iXX0=