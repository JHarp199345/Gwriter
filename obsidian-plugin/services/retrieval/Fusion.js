function mergeReasonTags(a, b) {
    if (!a?.length && !b?.length)
        return undefined;
    const set = new Set();
    a?.forEach((t) => set.add(t));
    b?.forEach((t) => set.add(t));
    return Array.from(set);
}
/**
 * Reciprocal Rank Fusion (RRF) across provider-ranked lists.
 * Produces a stable ranking even when providers disagree on score scales.
 */
export function fuseRrf(batches, opts) {
    const k = opts?.k ?? 60;
    const limit = opts?.limit ?? 200;
    const acc = new Map();
    for (const batch of batches) {
        const sorted = (batch.items || []).slice().sort((a, b) => b.score - a.score);
        for (let i = 0; i < sorted.length; i++) {
            const it = sorted[i];
            const key = it.key || `${it.path}${it.anchor ? `#${it.anchor}` : ''}`;
            const add = 1 / (k + (i + 1));
            const existing = acc.get(key);
            if (!existing) {
                acc.set(key, { item: { ...it, key }, score: add });
            }
            else {
                acc.set(key, {
                    item: {
                        ...existing.item,
                        // keep highest base score among providers but include tags from both
                        score: Math.max(existing.item.score, it.score),
                        reasonTags: mergeReasonTags(existing.item.reasonTags, it.reasonTags)
                    },
                    score: existing.score + add
                });
            }
        }
    }
    const fused = Array.from(acc.values())
        .sort((a, b) => b.score - a.score)
        .slice(0, Math.max(1, Math.min(1000, limit)));
    // Normalize fused scores to 0..1 for downstream consumers.
    let max = 0;
    for (const f of fused)
        if (f.score > max)
            max = f.score;
    const denom = max || 1;
    return fused.map((f) => ({
        ...f.item,
        score: Math.max(0, Math.min(1, f.score / denom)),
        source: 'fused',
        reasonTags: mergeReasonTags(f.item.reasonTags, ['fused'])
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRnVzaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRnVzaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLFNBQVMsZUFBZSxDQUFDLENBQXVCLEVBQUUsQ0FBdUI7SUFDeEUsSUFBSSxDQUFDLENBQUMsRUFBRSxNQUFNLElBQUksQ0FBQyxDQUFDLEVBQUUsTUFBTTtRQUFFLE9BQU8sU0FBUyxDQUFDO0lBQy9DLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7SUFDOUIsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlCLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM5QixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDeEIsQ0FBQztBQUVEOzs7R0FHRztBQUNILE1BQU0sVUFBVSxPQUFPLENBQUMsT0FBd0IsRUFBRSxJQUFxQztJQUN0RixNQUFNLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN4QixNQUFNLEtBQUssR0FBRyxJQUFJLEVBQUUsS0FBSyxJQUFJLEdBQUcsQ0FBQztJQUVqQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBZ0QsQ0FBQztJQUVwRSxLQUFLLE1BQU0sS0FBSyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzdCLE1BQU0sTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3RSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQixNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDdEUsTUFBTSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM5QixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ2YsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNwRCxDQUFDO2lCQUFNLENBQUM7Z0JBQ1AsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7b0JBQ1osSUFBSSxFQUFFO3dCQUNMLEdBQUcsUUFBUSxDQUFDLElBQUk7d0JBQ2hCLHFFQUFxRTt3QkFDckUsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQzt3QkFDOUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDO3FCQUNwRTtvQkFDRCxLQUFLLEVBQUUsUUFBUSxDQUFDLEtBQUssR0FBRyxHQUFHO2lCQUMzQixDQUFDLENBQUM7WUFDSixDQUFDO1FBQ0YsQ0FBQztJQUNGLENBQUM7SUFFRCxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUNwQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7U0FDakMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFL0MsMkRBQTJEO0lBQzNELElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztJQUNaLEtBQUssTUFBTSxDQUFDLElBQUksS0FBSztRQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssR0FBRyxHQUFHO1lBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7SUFDeEQsTUFBTSxLQUFLLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUV2QixPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDeEIsR0FBRyxDQUFDLENBQUMsSUFBSTtRQUNULEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDO1FBQ2hELE1BQU0sRUFBRSxPQUFPO1FBQ2YsVUFBVSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3pELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29udGV4dEl0ZW0gfSBmcm9tICcuL3R5cGVzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUHJvdmlkZXJCYXRjaCB7XHJcblx0cHJvdmlkZXJJZDogc3RyaW5nO1xyXG5cdGl0ZW1zOiBDb250ZXh0SXRlbVtdO1xyXG59XHJcblxyXG5mdW5jdGlvbiBtZXJnZVJlYXNvblRhZ3MoYTogc3RyaW5nW10gfCB1bmRlZmluZWQsIGI6IHN0cmluZ1tdIHwgdW5kZWZpbmVkKTogc3RyaW5nW10gfCB1bmRlZmluZWQge1xyXG5cdGlmICghYT8ubGVuZ3RoICYmICFiPy5sZW5ndGgpIHJldHVybiB1bmRlZmluZWQ7XHJcblx0Y29uc3Qgc2V0ID0gbmV3IFNldDxzdHJpbmc+KCk7XHJcblx0YT8uZm9yRWFjaCgodCkgPT4gc2V0LmFkZCh0KSk7XHJcblx0Yj8uZm9yRWFjaCgodCkgPT4gc2V0LmFkZCh0KSk7XHJcblx0cmV0dXJuIEFycmF5LmZyb20oc2V0KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFJlY2lwcm9jYWwgUmFuayBGdXNpb24gKFJSRikgYWNyb3NzIHByb3ZpZGVyLXJhbmtlZCBsaXN0cy5cclxuICogUHJvZHVjZXMgYSBzdGFibGUgcmFua2luZyBldmVuIHdoZW4gcHJvdmlkZXJzIGRpc2FncmVlIG9uIHNjb3JlIHNjYWxlcy5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBmdXNlUnJmKGJhdGNoZXM6IFByb3ZpZGVyQmF0Y2hbXSwgb3B0cz86IHsgaz86IG51bWJlcjsgbGltaXQ/OiBudW1iZXIgfSk6IENvbnRleHRJdGVtW10ge1xyXG5cdGNvbnN0IGsgPSBvcHRzPy5rID8/IDYwO1xyXG5cdGNvbnN0IGxpbWl0ID0gb3B0cz8ubGltaXQgPz8gMjAwO1xyXG5cclxuXHRjb25zdCBhY2MgPSBuZXcgTWFwPHN0cmluZywgeyBpdGVtOiBDb250ZXh0SXRlbTsgc2NvcmU6IG51bWJlciB9PigpO1xyXG5cclxuXHRmb3IgKGNvbnN0IGJhdGNoIG9mIGJhdGNoZXMpIHtcclxuXHRcdGNvbnN0IHNvcnRlZCA9IChiYXRjaC5pdGVtcyB8fCBbXSkuc2xpY2UoKS5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSk7XHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHNvcnRlZC5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRjb25zdCBpdCA9IHNvcnRlZFtpXTtcclxuXHRcdFx0Y29uc3Qga2V5ID0gaXQua2V5IHx8IGAke2l0LnBhdGh9JHtpdC5hbmNob3IgPyBgIyR7aXQuYW5jaG9yfWAgOiAnJ31gO1xyXG5cdFx0XHRjb25zdCBhZGQgPSAxIC8gKGsgKyAoaSArIDEpKTtcclxuXHRcdFx0Y29uc3QgZXhpc3RpbmcgPSBhY2MuZ2V0KGtleSk7XHJcblx0XHRcdGlmICghZXhpc3RpbmcpIHtcclxuXHRcdFx0XHRhY2Muc2V0KGtleSwgeyBpdGVtOiB7IC4uLml0LCBrZXkgfSwgc2NvcmU6IGFkZCB9KTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRhY2Muc2V0KGtleSwge1xyXG5cdFx0XHRcdFx0aXRlbToge1xyXG5cdFx0XHRcdFx0XHQuLi5leGlzdGluZy5pdGVtLFxyXG5cdFx0XHRcdFx0XHQvLyBrZWVwIGhpZ2hlc3QgYmFzZSBzY29yZSBhbW9uZyBwcm92aWRlcnMgYnV0IGluY2x1ZGUgdGFncyBmcm9tIGJvdGhcclxuXHRcdFx0XHRcdFx0c2NvcmU6IE1hdGgubWF4KGV4aXN0aW5nLml0ZW0uc2NvcmUsIGl0LnNjb3JlKSxcclxuXHRcdFx0XHRcdFx0cmVhc29uVGFnczogbWVyZ2VSZWFzb25UYWdzKGV4aXN0aW5nLml0ZW0ucmVhc29uVGFncywgaXQucmVhc29uVGFncylcclxuXHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHRzY29yZTogZXhpc3Rpbmcuc2NvcmUgKyBhZGRcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0Y29uc3QgZnVzZWQgPSBBcnJheS5mcm9tKGFjYy52YWx1ZXMoKSlcclxuXHRcdC5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSlcclxuXHRcdC5zbGljZSgwLCBNYXRoLm1heCgxLCBNYXRoLm1pbigxMDAwLCBsaW1pdCkpKTtcclxuXHJcblx0Ly8gTm9ybWFsaXplIGZ1c2VkIHNjb3JlcyB0byAwLi4xIGZvciBkb3duc3RyZWFtIGNvbnN1bWVycy5cclxuXHRsZXQgbWF4ID0gMDtcclxuXHRmb3IgKGNvbnN0IGYgb2YgZnVzZWQpIGlmIChmLnNjb3JlID4gbWF4KSBtYXggPSBmLnNjb3JlO1xyXG5cdGNvbnN0IGRlbm9tID0gbWF4IHx8IDE7XHJcblxyXG5cdHJldHVybiBmdXNlZC5tYXAoKGYpID0+ICh7XHJcblx0XHQuLi5mLml0ZW0sXHJcblx0XHRzY29yZTogTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgZi5zY29yZSAvIGRlbm9tKSksXHJcblx0XHRzb3VyY2U6ICdmdXNlZCcsXHJcblx0XHRyZWFzb25UYWdzOiBtZXJnZVJlYXNvblRhZ3MoZi5pdGVtLnJlYXNvblRhZ3MsIFsnZnVzZWQnXSlcclxuXHR9KSk7XHJcbn1cclxuXHJcblxyXG4iXX0=