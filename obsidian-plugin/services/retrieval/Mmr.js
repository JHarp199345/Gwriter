function dot(a, b) {
    const n = Math.min(a.length, b.length);
    let s = 0;
    for (let i = 0; i < n; i++)
        s += a[i] * b[i];
    return s;
}
function tokenizeLoose(value) {
    const toks = (value || '')
        .toLowerCase()
        .split(/[^\p{L}\p{N}]+/gu)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3);
    return new Set(toks);
}
function jaccard(a, b) {
    if (a.size === 0 && b.size === 0)
        return 0;
    let inter = 0;
    for (const t of a)
        if (b.has(t))
            inter++;
    const union = a.size + b.size - inter;
    return union ? inter / union : 0;
}
/**
 * Maximal Marginal Relevance selection to reduce near-duplicates while keeping relevance.
 */
export function mmrSelect(items, opts) {
    const limit = Math.max(1, Math.min(200, Math.floor(opts.limit)));
    const lambda = Math.max(0, Math.min(1, opts.lambda ?? 0.72));
    const candidates = (items || []).slice(0, 400);
    if (candidates.length <= limit)
        return candidates.slice(0, limit);
    const selected = [];
    const selectedKeys = new Set();
    // Precompute lexical sets for fallback similarity.
    const lex = new Map();
    for (const it of candidates) {
        lex.set(it.key, tokenizeLoose(`${it.path} ${it.title ?? ''} ${it.excerpt}`));
    }
    const sim = (a, b) => {
        const va = opts.getVector?.(a.key) ?? null;
        const vb = opts.getVector?.(b.key) ?? null;
        if (va && vb) {
            // vectors are expected to be L2-normalized
            return Math.max(0, Math.min(1, (dot(va, vb) + 1) / 2));
        }
        return jaccard(lex.get(a.key) ?? new Set(), lex.get(b.key) ?? new Set());
    };
    while (selected.length < limit) {
        let best = null;
        let bestScore = -Infinity;
        for (const cand of candidates) {
            if (selectedKeys.has(cand.key))
                continue;
            const relevance = cand.score;
            let redundancy = 0;
            for (const s of selected) {
                redundancy = Math.max(redundancy, sim(cand, s));
                if (redundancy >= 0.95)
                    break;
            }
            const score = lambda * relevance - (1 - lambda) * redundancy;
            if (score > bestScore) {
                bestScore = score;
                best = cand;
            }
        }
        if (!best)
            break;
        selected.push(best);
        selectedKeys.add(best.key);
    }
    return selected;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW1yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTW1yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLFNBQVMsR0FBRyxDQUFDLENBQVcsRUFBRSxDQUFXO0lBQ3BDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdkMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ1YsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7UUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3QyxPQUFPLENBQUMsQ0FBQztBQUNWLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxLQUFhO0lBQ25DLE1BQU0sSUFBSSxHQUFHLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztTQUN4QixXQUFXLEVBQUU7U0FDYixLQUFLLENBQUMsa0JBQWtCLENBQUM7U0FDekIsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDcEIsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQy9CLE9BQU8sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsT0FBTyxDQUFDLENBQWMsRUFBRSxDQUFjO0lBQzlDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDO1FBQUUsT0FBTyxDQUFDLENBQUM7SUFDM0MsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsS0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQUUsSUFB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LEdBQUcsQ0FBQztnQkFBRSxTQUFTO1lBRXpDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDN0IsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLEtBQUssTUFBTSxDQUFDLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQzFCLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hELElBQUksVUFBVSxJQUFJLElBQUk7b0JBQUUsTUFBTTtZQUMvQixDQUFDO1lBRUQsTUFBTSxLQUFLLEdBQUcsTUFBTSxHQUFHLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsR0FBRyxVQUFVLENBQUM7WUFDN0QsSUFBSSxLQUFLLEdBQUcsU0FBUyxFQUFFLENBQUM7Z0JBQ3ZCLFNBQVMsR0FBRyxLQUFLLENBQUM7Z0JBQ2xCLElBQUksR0FBRyxJQUFJLENBQUM7WUFDYixDQUFDO1FBQ0YsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJO1lBQUUsTUFBTTtRQUNqQixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BCLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFRCxPQUFPLFFBQVEsQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDb250ZXh0SXRlbSB9IGZyb20gJy4vdHlwZXMnO1xuXG5mdW5jdGlvbiBkb3QoYTogbnVtYmVyW10sIGI6IG51bWJlcltdKTogbnVtYmVyIHtcblx0Y29uc3QgbiA9IE1hdGgubWluKGEubGVuZ3RoLCBiLmxlbmd0aCk7XG5cdGxldCBzID0gMDtcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHMgKz0gYVtpXSAqIGJbaV07XG5cdHJldHVybiBzO1xufVxuXG5mdW5jdGlvbiB0b2tlbml6ZUxvb3NlKHZhbHVlOiBzdHJpbmcpOiBTZXQ8c3RyaW5nPiB7XG5cdGNvbnN0IHRva3MgPSAodmFsdWUgfHwgJycpXG5cdFx0LnRvTG93ZXJDYXNlKClcblx0XHQuc3BsaXQoL1teXFxwe0x9XFxwe059XSsvZ3UpXG5cdFx0Lm1hcCgodCkgPT4gdC50cmltKCkpXG5cdFx0LmZpbHRlcigodCkgPT4gdC5sZW5ndGggPj0gMyk7XG5cdHJldHVybiBuZXcgU2V0KHRva3MpO1xufVxuXG5mdW5jdGlvbiBqYWNjYXJkKGE6IFNldDxzdHJpbmc+LCBiOiBTZXQ8c3RyaW5nPik6IG51bWJlciB7XG5cdGlmIChhLnNpemUgPT09IDAgJiYgYi5zaXplID09PSAwKSByZXR1cm4gMDtcblx0bGV0IGludGVyID0gMDtcblx0Zm9yIChjb25zdCB0IG9mIGEpIGlmIChiLmhhcyh0KSkgaW50ZXIrKztcblx0Y29uc3QgdW5pb24gPSBhLnNpemUgKyBiLnNpemUgLSBpbnRlcjtcblx0cmV0dXJuIHVuaW9uID8gaW50ZXIgLyB1bmlvbiA6IDA7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTW1yT3B0aW9ucyB7XG5cdGxpbWl0OiBudW1iZXI7XG5cdGxhbWJkYT86IG51bWJlcjsgLy8gcmVsZXZhbmNlIHdlaWdodFxuXHRnZXRWZWN0b3I/OiAoa2V5OiBzdHJpbmcpID0+IG51bWJlcltdIHwgbnVsbDtcbn1cblxuLyoqXG4gKiBNYXhpbWFsIE1hcmdpbmFsIFJlbGV2YW5jZSBzZWxlY3Rpb24gdG8gcmVkdWNlIG5lYXItZHVwbGljYXRlcyB3aGlsZSBrZWVwaW5nIHJlbGV2YW5jZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1tclNlbGVjdChpdGVtczogQ29udGV4dEl0ZW1bXSwgb3B0czogTW1yT3B0aW9ucyk6IENvbnRleHRJdGVtW10ge1xuXHRjb25zdCBsaW1pdCA9IE1hdGgubWF4KDEsIE1hdGgubWluKDIwMCwgTWF0aC5mbG9vcihvcHRzLmxpbWl0KSkpO1xuXHRjb25zdCBsYW1iZGEgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBvcHRzLmxhbWJkYSA/PyAwLjcyKSk7XG5cblx0Y29uc3QgY2FuZGlkYXRlcyA9IChpdGVtcyB8fCBbXSkuc2xpY2UoMCwgNDAwKTtcblx0aWYgKGNhbmRpZGF0ZXMubGVuZ3RoIDw9IGxpbWl0KSByZXR1cm4gY2FuZGlkYXRlcy5zbGljZSgwLCBsaW1pdCk7XG5cblx0Y29uc3Qgc2VsZWN0ZWQ6IENvbnRleHRJdGVtW10gPSBbXTtcblx0Y29uc3Qgc2VsZWN0ZWRLZXlzID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cblx0Ly8gUHJlY29tcHV0ZSBsZXhpY2FsIHNldHMgZm9yIGZhbGxiYWNrIHNpbWlsYXJpdHkuXG5cdGNvbnN0IGxleCA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKTtcblx0Zm9yIChjb25zdCBpdCBvZiBjYW5kaWRhdGVzKSB7XG5cdFx0bGV4LnNldChpdC5rZXksIHRva2VuaXplTG9vc2UoYCR7aXQucGF0aH0gJHtpdC50aXRsZSA/PyAnJ30gJHtpdC5leGNlcnB0fWApKTtcblx0fVxuXG5cdGNvbnN0IHNpbSA9IChhOiBDb250ZXh0SXRlbSwgYjogQ29udGV4dEl0ZW0pOiBudW1iZXIgPT4ge1xuXHRcdGNvbnN0IHZhID0gb3B0cy5nZXRWZWN0b3I/LihhLmtleSkgPz8gbnVsbDtcblx0XHRjb25zdCB2YiA9IG9wdHMuZ2V0VmVjdG9yPy4oYi5rZXkpID8/IG51bGw7XG5cdFx0aWYgKHZhICYmIHZiKSB7XG5cdFx0XHQvLyB2ZWN0b3JzIGFyZSBleHBlY3RlZCB0byBiZSBMMi1ub3JtYWxpemVkXG5cdFx0XHRyZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKGRvdCh2YSwgdmIpICsgMSkgLyAyKSk7XG5cdFx0fVxuXHRcdHJldHVybiBqYWNjYXJkKGxleC5nZXQoYS5rZXkpID8/IG5ldyBTZXQoKSwgbGV4LmdldChiLmtleSkgPz8gbmV3IFNldCgpKTtcblx0fTtcblxuXHR3aGlsZSAoc2VsZWN0ZWQubGVuZ3RoIDwgbGltaXQpIHtcblx0XHRsZXQgYmVzdDogQ29udGV4dEl0ZW0gfCBudWxsID0gbnVsbDtcblx0XHRsZXQgYmVzdFNjb3JlID0gLUluZmluaXR5O1xuXG5cdFx0Zm9yIChjb25zdCBjYW5kIG9mIGNhbmRpZGF0ZXMpIHtcblx0XHRcdGlmIChzZWxlY3RlZEtleXMuaGFzKGNhbmQua2V5KSkgY29udGludWU7XG5cblx0XHRcdGNvbnN0IHJlbGV2YW5jZSA9IGNhbmQuc2NvcmU7XG5cdFx0XHRsZXQgcmVkdW5kYW5jeSA9IDA7XG5cdFx0XHRmb3IgKGNvbnN0IHMgb2Ygc2VsZWN0ZWQpIHtcblx0XHRcdFx0cmVkdW5kYW5jeSA9IE1hdGgubWF4KHJlZHVuZGFuY3ksIHNpbShjYW5kLCBzKSk7XG5cdFx0XHRcdGlmIChyZWR1bmRhbmN5ID49IDAuOTUpIGJyZWFrO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBzY29yZSA9IGxhbWJkYSAqIHJlbGV2YW5jZSAtICgxIC0gbGFtYmRhKSAqIHJlZHVuZGFuY3k7XG5cdFx0XHRpZiAoc2NvcmUgPiBiZXN0U2NvcmUpIHtcblx0XHRcdFx0YmVzdFNjb3JlID0gc2NvcmU7XG5cdFx0XHRcdGJlc3QgPSBjYW5kO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmICghYmVzdCkgYnJlYWs7XG5cdFx0c2VsZWN0ZWQucHVzaChiZXN0KTtcblx0XHRzZWxlY3RlZEtleXMuYWRkKGJlc3Qua2V5KTtcblx0fVxuXG5cdHJldHVybiBzZWxlY3RlZDtcbn1cblxuXG4iXX0=