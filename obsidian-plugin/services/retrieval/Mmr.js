function dot(a, b) {
    const n = Math.min(a.length, b.length);
    let s = 0;
    for (let i = 0; i < n; i++)
        s += a[i] * b[i];
    return s;
}
function tokenizeLoose(value) {
    const toks = (value || '')
        .toLowerCase()
        .split(/[^\p{L}\p{N}]+/gu)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3);
    return new Set(toks);
}
function jaccard(a, b) {
    if (a.size === 0 && b.size === 0)
        return 0;
    let inter = 0;
    for (const t of a)
        if (b.has(t))
            inter++;
    const union = a.size + b.size - inter;
    return union ? inter / union : 0;
}
/**
 * Maximal Marginal Relevance selection to reduce near-duplicates while keeping relevance.
 */
export function mmrSelect(items, opts) {
    const limit = Math.max(1, Math.min(200, Math.floor(opts.limit)));
    const lambda = Math.max(0, Math.min(1, opts.lambda ?? 0.72));
    const candidates = (items || []).slice(0, 400);
    if (candidates.length <= limit)
        return candidates.slice(0, limit);
    const selected = [];
    const selectedKeys = new Set();
    // Precompute lexical sets for fallback similarity.
    const lex = new Map();
    for (const it of candidates) {
        lex.set(it.key, tokenizeLoose(`${it.path} ${it.title ?? ''} ${it.excerpt}`));
    }
    const sim = (a, b) => {
        const va = opts.getVector?.(a.key) ?? null;
        const vb = opts.getVector?.(b.key) ?? null;
        if (va && vb) {
            // vectors are expected to be L2-normalized
            return Math.max(0, Math.min(1, (dot(va, vb) + 1) / 2));
        }
        return jaccard(lex.get(a.key) ?? new Set(), lex.get(b.key) ?? new Set());
    };
    while (selected.length < limit) {
        let best = null;
        let bestScore = -Infinity;
        for (const cand of candidates) {
            if (selectedKeys.has(cand.key))
                continue;
            const relevance = cand.score;
            let redundancy = 0;
            for (const s of selected) {
                redundancy = Math.max(redundancy, sim(cand, s));
                if (redundancy >= 0.95)
                    break;
            }
            const score = lambda * relevance - (1 - lambda) * redundancy;
            if (score > bestScore) {
                bestScore = score;
                best = cand;
            }
        }
        if (!best)
            break;
        selected.push(best);
        selectedKeys.add(best.key);
    }
    return selected;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW1yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTW1yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLFNBQVMsR0FBRyxDQUFDLENBQVcsRUFBRSxDQUFXO0lBQ3BDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdkMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ1YsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7UUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3QyxPQUFPLENBQUMsQ0FBQztBQUNWLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxLQUFhO0lBQ25DLE1BQU0sSUFBSSxHQUFHLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztTQUN4QixXQUFXLEVBQUU7U0FDYixLQUFLLENBQUMsa0JBQWtCLENBQUM7U0FDekIsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDcEIsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQy9CLE9BQU8sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsT0FBTyxDQUFDLENBQWMsRUFBRSxDQUFjO0lBQzlDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDO1FBQUUsT0FBTyxDQUFDLENBQUM7SUFDM0MsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsS0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQUUsSUFB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LEdBQUcsQ0FBQztnQkFBRSxTQUFTO1lBRXpDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDN0IsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLEtBQUssTUFBTSxDQUFDLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQzFCLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hELElBQUksVUFBVSxJQUFJLElBQUk7b0JBQUUsTUFBTTtZQUMvQixDQUFDO1lBRUQsTUFBTSxLQUFLLEdBQUcsTUFBTSxHQUFHLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsR0FBRyxVQUFVLENBQUM7WUFDN0QsSUFBSSxLQUFLLEdBQUcsU0FBUyxFQUFFLENBQUM7Z0JBQ3ZCLFNBQVMsR0FBRyxLQUFLLENBQUM7Z0JBQ2xCLElBQUksR0FBRyxJQUFJLENBQUM7WUFDYixDQUFDO1FBQ0YsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJO1lBQUUsTUFBTTtRQUNqQixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BCLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFRCxPQUFPLFFBQVEsQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDb250ZXh0SXRlbSB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuZnVuY3Rpb24gZG90KGE6IG51bWJlcltdLCBiOiBudW1iZXJbXSk6IG51bWJlciB7XHJcblx0Y29uc3QgbiA9IE1hdGgubWluKGEubGVuZ3RoLCBiLmxlbmd0aCk7XHJcblx0bGV0IHMgPSAwO1xyXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSBzICs9IGFbaV0gKiBiW2ldO1xyXG5cdHJldHVybiBzO1xyXG59XHJcblxyXG5mdW5jdGlvbiB0b2tlbml6ZUxvb3NlKHZhbHVlOiBzdHJpbmcpOiBTZXQ8c3RyaW5nPiB7XHJcblx0Y29uc3QgdG9rcyA9ICh2YWx1ZSB8fCAnJylcclxuXHRcdC50b0xvd2VyQ2FzZSgpXHJcblx0XHQuc3BsaXQoL1teXFxwe0x9XFxwe059XSsvZ3UpXHJcblx0XHQubWFwKCh0KSA9PiB0LnRyaW0oKSlcclxuXHRcdC5maWx0ZXIoKHQpID0+IHQubGVuZ3RoID49IDMpO1xyXG5cdHJldHVybiBuZXcgU2V0KHRva3MpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBqYWNjYXJkKGE6IFNldDxzdHJpbmc+LCBiOiBTZXQ8c3RyaW5nPik6IG51bWJlciB7XHJcblx0aWYgKGEuc2l6ZSA9PT0gMCAmJiBiLnNpemUgPT09IDApIHJldHVybiAwO1xyXG5cdGxldCBpbnRlciA9IDA7XHJcblx0Zm9yIChjb25zdCB0IG9mIGEpIGlmIChiLmhhcyh0KSkgaW50ZXIrKztcclxuXHRjb25zdCB1bmlvbiA9IGEuc2l6ZSArIGIuc2l6ZSAtIGludGVyO1xyXG5cdHJldHVybiB1bmlvbiA/IGludGVyIC8gdW5pb24gOiAwO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE1tck9wdGlvbnMge1xyXG5cdGxpbWl0OiBudW1iZXI7XHJcblx0bGFtYmRhPzogbnVtYmVyOyAvLyByZWxldmFuY2Ugd2VpZ2h0XHJcblx0Z2V0VmVjdG9yPzogKGtleTogc3RyaW5nKSA9PiBudW1iZXJbXSB8IG51bGw7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBNYXhpbWFsIE1hcmdpbmFsIFJlbGV2YW5jZSBzZWxlY3Rpb24gdG8gcmVkdWNlIG5lYXItZHVwbGljYXRlcyB3aGlsZSBrZWVwaW5nIHJlbGV2YW5jZS5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBtbXJTZWxlY3QoaXRlbXM6IENvbnRleHRJdGVtW10sIG9wdHM6IE1tck9wdGlvbnMpOiBDb250ZXh0SXRlbVtdIHtcclxuXHRjb25zdCBsaW1pdCA9IE1hdGgubWF4KDEsIE1hdGgubWluKDIwMCwgTWF0aC5mbG9vcihvcHRzLmxpbWl0KSkpO1xyXG5cdGNvbnN0IGxhbWJkYSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIG9wdHMubGFtYmRhID8/IDAuNzIpKTtcclxuXHJcblx0Y29uc3QgY2FuZGlkYXRlcyA9IChpdGVtcyB8fCBbXSkuc2xpY2UoMCwgNDAwKTtcclxuXHRpZiAoY2FuZGlkYXRlcy5sZW5ndGggPD0gbGltaXQpIHJldHVybiBjYW5kaWRhdGVzLnNsaWNlKDAsIGxpbWl0KTtcclxuXHJcblx0Y29uc3Qgc2VsZWN0ZWQ6IENvbnRleHRJdGVtW10gPSBbXTtcclxuXHRjb25zdCBzZWxlY3RlZEtleXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcclxuXHJcblx0Ly8gUHJlY29tcHV0ZSBsZXhpY2FsIHNldHMgZm9yIGZhbGxiYWNrIHNpbWlsYXJpdHkuXHJcblx0Y29uc3QgbGV4ID0gbmV3IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PigpO1xyXG5cdGZvciAoY29uc3QgaXQgb2YgY2FuZGlkYXRlcykge1xyXG5cdFx0bGV4LnNldChpdC5rZXksIHRva2VuaXplTG9vc2UoYCR7aXQucGF0aH0gJHtpdC50aXRsZSA/PyAnJ30gJHtpdC5leGNlcnB0fWApKTtcclxuXHR9XHJcblxyXG5cdGNvbnN0IHNpbSA9IChhOiBDb250ZXh0SXRlbSwgYjogQ29udGV4dEl0ZW0pOiBudW1iZXIgPT4ge1xyXG5cdFx0Y29uc3QgdmEgPSBvcHRzLmdldFZlY3Rvcj8uKGEua2V5KSA/PyBudWxsO1xyXG5cdFx0Y29uc3QgdmIgPSBvcHRzLmdldFZlY3Rvcj8uKGIua2V5KSA/PyBudWxsO1xyXG5cdFx0aWYgKHZhICYmIHZiKSB7XHJcblx0XHRcdC8vIHZlY3RvcnMgYXJlIGV4cGVjdGVkIHRvIGJlIEwyLW5vcm1hbGl6ZWRcclxuXHRcdFx0cmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIChkb3QodmEsIHZiKSArIDEpIC8gMikpO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIGphY2NhcmQobGV4LmdldChhLmtleSkgPz8gbmV3IFNldCgpLCBsZXguZ2V0KGIua2V5KSA/PyBuZXcgU2V0KCkpO1xyXG5cdH07XHJcblxyXG5cdHdoaWxlIChzZWxlY3RlZC5sZW5ndGggPCBsaW1pdCkge1xyXG5cdFx0bGV0IGJlc3Q6IENvbnRleHRJdGVtIHwgbnVsbCA9IG51bGw7XHJcblx0XHRsZXQgYmVzdFNjb3JlID0gLUluZmluaXR5O1xyXG5cclxuXHRcdGZvciAoY29uc3QgY2FuZCBvZiBjYW5kaWRhdGVzKSB7XHJcblx0XHRcdGlmIChzZWxlY3RlZEtleXMuaGFzKGNhbmQua2V5KSkgY29udGludWU7XHJcblxyXG5cdFx0XHRjb25zdCByZWxldmFuY2UgPSBjYW5kLnNjb3JlO1xyXG5cdFx0XHRsZXQgcmVkdW5kYW5jeSA9IDA7XHJcblx0XHRcdGZvciAoY29uc3QgcyBvZiBzZWxlY3RlZCkge1xyXG5cdFx0XHRcdHJlZHVuZGFuY3kgPSBNYXRoLm1heChyZWR1bmRhbmN5LCBzaW0oY2FuZCwgcykpO1xyXG5cdFx0XHRcdGlmIChyZWR1bmRhbmN5ID49IDAuOTUpIGJyZWFrO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRjb25zdCBzY29yZSA9IGxhbWJkYSAqIHJlbGV2YW5jZSAtICgxIC0gbGFtYmRhKSAqIHJlZHVuZGFuY3k7XHJcblx0XHRcdGlmIChzY29yZSA+IGJlc3RTY29yZSkge1xyXG5cdFx0XHRcdGJlc3RTY29yZSA9IHNjb3JlO1xyXG5cdFx0XHRcdGJlc3QgPSBjYW5kO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKCFiZXN0KSBicmVhaztcclxuXHRcdHNlbGVjdGVkLnB1c2goYmVzdCk7XHJcblx0XHRzZWxlY3RlZEtleXMuYWRkKGJlc3Qua2V5KTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBzZWxlY3RlZDtcclxufVxyXG5cclxuXHJcbiJdfQ==