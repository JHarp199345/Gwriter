function dot(a, b) {
    const n = Math.min(a.length, b.length);
    let s = 0;
    for (let i = 0; i < n; i++)
        s += a[i] * b[i];
    return s;
}
export class ExternalEmbeddingsProvider {
    constructor(plugin, embeddingsIndex, bm25Index, isEnabled, isAllowedPath) {
        this.id = 'external-embeddings';
        // Cache for embedding vectors (query text -> vector)
        this.embeddingCache = new Map();
        this.cacheTtl = 3600000; // 1 hour
        this.plugin = plugin;
        this.embeddingsIndex = embeddingsIndex;
        this.bm25Index = bm25Index;
        this.isEnabled = isEnabled;
        this.isAllowedPath = isAllowedPath;
    }
    async getQueryEmbedding(query) {
        // Check cache first
        const cached = this.embeddingCache.get(query);
        if (cached && Date.now() - cached.timestamp < this.cacheTtl) {
            return cached.vector;
        }
        const settings = this.plugin.settings;
        const provider = settings.externalEmbeddingProvider;
        const apiKey = settings.externalEmbeddingApiKey;
        const model = settings.externalEmbeddingModel || this.getDefaultModel(provider);
        const apiUrl = settings.externalEmbeddingApiUrl;
        if (!provider || !apiKey) {
            throw new Error('External embedding provider or API key not configured');
        }
        let vector;
        try {
            if (provider === 'openai') {
                vector = await this.callOpenAIEmbedding(apiKey, model, query);
            }
            else if (provider === 'cohere') {
                vector = await this.callCohereEmbedding(apiKey, model, query);
            }
            else if (provider === 'google') {
                vector = await this.callGoogleEmbedding(apiKey, model, query, settings.externalEmbeddingUseBatch || false);
            }
            else if (provider === 'custom' && apiUrl) {
                vector = await this.callCustomEmbedding(apiUrl, query);
            }
            else {
                throw new Error(`Unsupported embedding provider: ${provider}`);
            }
            // Cache the result
            this.embeddingCache.set(query, { vector, timestamp: Date.now() });
            return vector;
        }
        catch (error) {
            console.error(`[ExternalEmbeddingsProvider] Failed to get embedding:`, error);
            throw error;
        }
    }
    getDefaultModel(provider) {
        switch (provider) {
            case 'openai':
                return 'text-embedding-3-small';
            case 'cohere':
                return 'embed-english-v3.0';
            case 'google':
                return 'gemini-embedding-001';
            default:
                return '';
        }
    }
    async callOpenAIEmbedding(apiKey, model, query) {
        const response = await fetch('https://api.openai.com/v1/embeddings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model,
                input: query
            })
        });
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`OpenAI embedding API error: ${response.status} ${error}`);
        }
        const data = await response.json();
        if (data.data && data.data[0] && data.data[0].embedding) {
            return data.data[0].embedding;
        }
        throw new Error('Invalid OpenAI embedding response format');
    }
    async callCohereEmbedding(apiKey, model, query) {
        const response = await fetch('https://api.cohere.ai/v1/embed', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model,
                texts: [query]
            })
        });
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`Cohere embedding API error: ${response.status} ${error}`);
        }
        const data = await response.json();
        if (data.embeddings && data.embeddings[0]) {
            return data.embeddings[0];
        }
        throw new Error('Invalid Cohere embedding response format');
    }
    async callGoogleEmbedding(apiKey, model, query, useBatch) {
        if (useBatch) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:batchEmbedContents?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    requests: [{
                            content: {
                                parts: [{ text: query }]
                            }
                        }]
                })
            });
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Google Gemini batch embedding API error: ${response.status} ${error}`);
            }
            const data = await response.json();
            if (data.embeddings && data.embeddings[0] && data.embeddings[0].values) {
                return data.embeddings[0].values;
            }
            throw new Error('Invalid Google Gemini batch embedding response format');
        }
        else {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:embedContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: {
                        parts: [{ text: query }]
                    }
                })
            });
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Google Gemini embedding API error: ${response.status} ${error}`);
            }
            const data = await response.json();
            if (data.embedding && data.embedding.values) {
                return data.embedding.values;
            }
            throw new Error('Invalid Google Gemini embedding response format');
        }
    }
    async callCustomEmbedding(apiUrl, query) {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: query
            })
        });
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`Custom embedding API error: ${response.status} ${error}`);
        }
        const data = await response.json();
        // Try common response formats
        if (Array.isArray(data)) {
            return data;
        }
        if (data.embedding && Array.isArray(data.embedding)) {
            return data.embedding;
        }
        if (data.vector && Array.isArray(data.vector)) {
            return data.vector;
        }
        if (data.values && Array.isArray(data.values)) {
            return data.values;
        }
        throw new Error('Invalid custom embedding API response format');
    }
    async search(query, opts) {
        if (!this.isEnabled())
            return [];
        const q = (query.text ?? '').trim();
        if (!q)
            return [];
        await this.embeddingsIndex.ensureLoaded();
        // Get query embedding from external API
        let qVec;
        try {
            qVec = await this.getQueryEmbedding(q);
        }
        catch (error) {
            console.error(`[ExternalEmbeddingsProvider] Failed to get query embedding:`, error);
            // Fall back to empty results rather than breaking retrieval
            return [];
        }
        // Get all chunks from local index (these have local hash vectors, but we'll use external query vector)
        // Note: This is a hybrid approach - external query vector with local chunk vectors
        // For true hybrid, we'd need to re-embed chunks with external API, but that's expensive
        // Instead, we use the external query vector with local hash vectors (dimension mismatch handled)
        const chunks = this.embeddingsIndex.getAllChunks().filter((c) => this.isAllowedPath(c.path));
        if (chunks.length === 0)
            return [];
        // Score chunks using external query vector against local hash vectors
        // Note: Dimension mismatch is handled by dot product (uses min length)
        const scored = chunks
            .map((c) => {
            const localVec = c.vector;
            // Normalize both vectors for better comparison across different embedding spaces
            const qNorm = Math.sqrt(qVec.reduce((sum, v) => sum + v * v, 0)) || 1;
            const localNorm = Math.sqrt(localVec.reduce((sum, v) => sum + v * v, 0)) || 1;
            const normalizedQ = qVec.map(v => v / qNorm);
            const normalizedLocal = localVec.map(v => v / localNorm);
            const score = dot(normalizedQ, normalizedLocal);
            return { chunk: c, score };
        })
            .sort((a, b) => b.score - a.score)
            .slice(0, Math.max(1, Math.min(200, opts.limit * 6)));
        const results = [];
        for (const { chunk, score } of scored) {
            results.push({
                key: chunk.key,
                path: chunk.path,
                title: chunk.path.split('/').pop(),
                excerpt: chunk.excerpt,
                score: Math.max(0, Math.min(1, (score + 1) / 2)),
                source: this.id,
                reasonTags: ['external-embeddings']
            });
        }
        return results.slice(0, opts.limit);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXh0ZXJuYWxFbWJlZGRpbmdzUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJFeHRlcm5hbEVtYmVkZGluZ3NQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFLQSxTQUFTLEdBQUcsQ0FBQyxDQUFXLEVBQUUsQ0FBVztJQUNwQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNWLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0MsT0FBTyxDQUFDLENBQUM7QUFDVixDQUFDO0FBU0QsTUFBTSxPQUFPLDBCQUEwQjtJQWF0QyxZQUNDLE1BQThCLEVBQzlCLGVBQWdDLEVBQ2hDLFNBQW9CLEVBQ3BCLFNBQXdCLEVBQ3hCLGFBQXdDO1FBakJoQyxPQUFFLEdBQUcscUJBQXFCLENBQUM7UUFRcEMscURBQXFEO1FBQ3BDLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQW1ELENBQUM7UUFDNUUsYUFBUSxHQUFHLE9BQU8sQ0FBQyxDQUFDLFNBQVM7UUFTN0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFDdkMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7SUFDcEMsQ0FBQztJQUVPLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxLQUFhO1FBQzVDLG9CQUFvQjtRQUNwQixNQUFNLE1B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Q0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7YUFDakMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV2RCxNQUFNLE9BQU8sR0FBa0IsRUFBRSxDQUFDO1FBQ2xDLEtBQUssTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUN2QyxPQUFPLENBQUMsSUFBSSxDQUFDO2dCQUNaLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztnQkFDZCxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7Z0JBQ2hCLEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2xDLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztnQkFDdEIsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNoRCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7Z0JBQ2YsVUFBVSxFQUFFLENBQUMscUJBQXFCLENBQUM7YUFDbkMsQ0FBQyxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29udGV4dEl0ZW0sIFJldHJpZXZhbE9wdGlvbnMsIFJldHJpZXZhbFByb3ZpZGVyLCBSZXRyaWV2YWxRdWVyeSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHR5cGUgeyBFbWJlZGRpbmdzSW5kZXggfSBmcm9tICcuL0VtYmVkZGluZ3NJbmRleCc7XG5pbXBvcnQgdHlwZSB7IEJtMjVJbmRleCB9IGZyb20gJy4vQm0yNUluZGV4JztcbmltcG9ydCBXcml0aW5nRGFzaGJvYXJkUGx1Z2luIGZyb20gJy4uLy4uL21haW4nO1xuXG5mdW5jdGlvbiBkb3QoYTogbnVtYmVyW10sIGI6IG51bWJlcltdKTogbnVtYmVyIHtcblx0Y29uc3QgbiA9IE1hdGgubWluKGEubGVuZ3RoLCBiLmxlbmd0aCk7XG5cdGxldCBzID0gMDtcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHMgKz0gYVtpXSAqIGJbaV07XG5cdHJldHVybiBzO1xufVxuXG5pbnRlcmZhY2UgRW1iZWRkaW5nQXBpUmVzcG9uc2Uge1xuXHRlbWJlZGRpbmc/OiBudW1iZXJbXTtcblx0dmFsdWVzPzogbnVtYmVyW107XG5cdGRhdGE/OiBBcnJheTx7IGVtYmVkZGluZzogbnVtYmVyW10gfT47XG5cdGVtYmVkZGluZ3M/OiBudW1iZXJbXVtdO1xufVxuXG5leHBvcnQgY2xhc3MgRXh0ZXJuYWxFbWJlZGRpbmdzUHJvdmlkZXIgaW1wbGVtZW50cyBSZXRyaWV2YWxQcm92aWRlciB7XG5cdHJlYWRvbmx5IGlkID0gJ2V4dGVybmFsLWVtYmVkZGluZ3MnO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgcGx1Z2luOiBXcml0aW5nRGFzaGJvYXJkUGx1Z2luO1xuXHRwcml2YXRlIHJlYWRvbmx5IGVtYmVkZGluZ3NJbmRleDogRW1iZWRkaW5nc0luZGV4O1xuXHRwcml2YXRlIHJlYWRvbmx5IGJtMjVJbmRleDogQm0yNUluZGV4O1xuXHRwcml2YXRlIHJlYWRvbmx5IGlzRW5hYmxlZDogKCkgPT4gYm9vbGVhbjtcblx0cHJpdmF0ZSByZWFkb25seSBpc0FsbG93ZWRQYXRoOiAocGF0aDogc3RyaW5nKSA9PiBib29sZWFuO1xuXHRcblx0Ly8gQ2FjaGUgZm9yIGVtYmVkZGluZyB2ZWN0b3JzIChxdWVyeSB0ZXh0IC0+IHZlY3Rvcilcblx0cHJpdmF0ZSByZWFkb25seSBlbWJlZGRpbmdDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCB7IHZlY3RvcjogbnVtYmVyW107IHRpbWVzdGFtcDogbnVtYmVyIH0+KCk7XG5cdHByaXZhdGUgcmVhZG9ubHkgY2FjaGVUdGwgPSAzNjAwMDAwOyAvLyAxIGhvdXJcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRwbHVnaW46IFdyaXRpbmdEYXNoYm9hcmRQbHVnaW4sXG5cdFx0ZW1iZWRkaW5nc0luZGV4OiBFbWJlZGRpbmdzSW5kZXgsXG5cdFx0Ym0yNUluZGV4OiBCbTI1SW5kZXgsXG5cdFx0aXNFbmFibGVkOiAoKSA9PiBib29sZWFuLFxuXHRcdGlzQWxsb3dlZFBhdGg6IChwYXRoOiBzdHJpbmcpID0+IGJvb2xlYW5cblx0KSB7XG5cdFx0dGhpcy5wbHVnaW4gPSBwbHVnaW47XG5cdFx0dGhpcy5lbWJlZGRpbmdzSW5kZXggPSBlbWJlZGRpbmdzSW5kZXg7XG5cdFx0dGhpcy5ibTI1SW5kZXggPSBibTI1SW5kZXg7XG5cdFx0dGhpcy5pc0VuYWJsZWQgPSBpc0VuYWJsZWQ7XG5cdFx0dGhpcy5pc0FsbG93ZWRQYXRoID0gaXNBbGxvd2VkUGF0aDtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgZ2V0UXVlcnlFbWJlZGRpbmcocXVlcnk6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyW10+IHtcblx0XHQvLyBDaGVjayBjYWNoZSBmaXJzdFxuXHRcdGNvbnN0IGNhY2hlZCA9IHRoaXMuZW1iZWRkaW5nQ2FjaGUuZ2V0KHF1ZXJ5KTtcblx0XHRpZiAoY2FjaGVkICYmIERhdGUubm93KCkgLSBjYWNoZWQudGltZXN0YW1wIDwgdGhpcy5jYWNoZVR0bCkge1xuXHRcdFx0cmV0dXJuIGNhY2hlZC52ZWN0b3I7XG5cdFx0fVxuXG5cdFx0Y29uc3Qgc2V0dGluZ3MgPSB0aGlzLnBsdWdpbi5zZXR0aW5ncztcblx0XHRjb25zdCBwcm92aWRlciA9IHNldHRpbmdzLmV4dGVybmFsRW1iZWRkaW5nUHJvdmlkZXI7XG5cdFx0Y29uc3QgYXBpS2V5ID0gc2V0dGluZ3MuZXh0ZXJuYWxFbWJlZGRpbmdBcGlLZXk7XG5cdFx0Y29uc3QgbW9kZWwgPSBzZXR0aW5ncy5leHRlcm5hbEVtYmVkZGluZ01vZGVsIHx8IHRoaXMuZ2V0RGVmYXVsdE1vZGVsKHByb3ZpZGVyKTtcblx0XHRjb25zdCBhcGlVcmwgPSBzZXR0aW5ncy5leHRlcm5hbEVtYmVkZGluZ0FwaVVybDtcblxuXHRcdGlmICghcHJvdmlkZXIgfHwgIWFwaUtleSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdFeHRlcm5hbCBlbWJlZGRpbmcgcHJvdmlkZXIgb3IgQVBJIGtleSBub3QgY29uZmlndXJlZCcpO1xuXHRcdH1cblxuXHRcdGxldCB2ZWN0b3I6IG51bWJlcltdO1xuXHRcdHRyeSB7XG5cdFx0XHRpZiAocHJvdmlkZXIgPT09ICdvcGVuYWknKSB7XG5cdFx0XHRcdHZlY3RvciA9IGF3YWl0IHRoaXMuY2FsbE9wZW5BSUVtYmVkZGluZyhhcGlLZXksIG1vZGVsLCBxdWVyeSk7XG5cdFx0XHR9IGVsc2UgaWYgKHByb3ZpZGVyID09PSAnY29oZXJlJykge1xuXHRcdFx0XHR2ZWN0b3IgPSBhd2FpdCB0aGlzLmNhbGxDb2hlcmVFbWJlZGRpbmcoYXBpS2V5LCBtb2RlbCwgcXVlcnkpO1xuXHRcdFx0fSBlbHNlIGlmIChwcm92aWRlciA9PT0gJ2dvb2dsZScpIHtcblx0XHRcdFx0dmVjdG9yID0gYXdhaXQgdGhpcy5jYWxsR29vZ2xlRW1iZWRkaW5nKGFwaUtleSwgbW9kZWwsIHF1ZXJ5LCBzZXR0aW5ncy5leHRlcm5hbEVtYmVkZGluZ1VzZUJhdGNoIHx8IGZhbHNlKTtcblx0XHRcdH0gZWxzZSBpZiAocHJvdmlkZXIgPT09ICdjdXN0b20nICYmIGFwaVVybCkge1xuXHRcdFx0XHR2ZWN0b3IgPSBhd2FpdCB0aGlzLmNhbGxDdXN0b21FbWJlZGRpbmcoYXBpVXJsLCBxdWVyeSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIGVtYmVkZGluZyBwcm92aWRlcjogJHtwcm92aWRlcn1gKTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gQ2FjaGUgdGhlIHJlc3VsdFxuXHRcdFx0dGhpcy5lbWJlZGRpbmdDYWNoZS5zZXQocXVlcnksIHsgdmVjdG9yLCB0aW1lc3RhbXA6IERhdGUubm93KCkgfSk7XG5cdFx0XHRyZXR1cm4gdmVjdG9yO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKGBbRXh0ZXJuYWxFbWJlZGRpbmdzUHJvdmlkZXJdIEZhaWxlZCB0byBnZXQgZW1iZWRkaW5nOmAsIGVycm9yKTtcblx0XHRcdHRocm93IGVycm9yO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgZ2V0RGVmYXVsdE1vZGVsKHByb3ZpZGVyPzogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRzd2l0Y2ggKHByb3ZpZGVyKSB7XG5cdFx0XHRjYXNlICdvcGVuYWknOlxuXHRcdFx0XHRyZXR1cm4gJ3RleHQtZW1iZWRkaW5nLTMtc21hbGwnO1xuXHRcdFx0Y2FzZSAnY29oZXJlJzpcblx0XHRcdFx0cmV0dXJuICdlbWJlZC1lbmdsaXNoLXYzLjAnO1xuXHRcdFx0Y2FzZSAnZ29vZ2xlJzpcblx0XHRcdFx0cmV0dXJuICdnZW1pbmktZW1iZWRkaW5nLTAwMSc7XG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRyZXR1cm4gJyc7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBjYWxsT3BlbkFJRW1iZWRkaW5nKGFwaUtleTogc3RyaW5nLCBtb2RlbDogc3RyaW5nLCBxdWVyeTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXJbXT4ge1xuXHRcdGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goJ2h0dHBzOi8vYXBpLm9wZW5haS5jb20vdjEvZW1iZWRkaW5ncycsIHtcblx0XHRcdG1ldGhvZDogJ1BPU1QnLFxuXHRcdFx0aGVhZGVyczoge1xuXHRcdFx0XHQnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuXHRcdFx0XHQnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthcGlLZXl9YFxuXHRcdFx0fSxcblx0XHRcdGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcblx0XHRcdFx0bW9kZWwsXG5cdFx0XHRcdGlucHV0OiBxdWVyeVxuXHRcdFx0fSlcblx0XHR9KTtcblxuXHRcdGlmICghcmVzcG9uc2Uub2spIHtcblx0XHRcdGNvbnN0IGVycm9yID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBPcGVuQUkgZW1iZWRkaW5nIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9ICR7ZXJyb3J9YCk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgZGF0YTogRW1iZWRkaW5nQXBpUmVzcG9uc2UgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG5cdFx0aWYgKGRhdGEuZGF0YSAmJiBkYXRhLmRhdGFbMF0gJiYgZGF0YS5kYXRhWzBdLmVtYmVkZGluZykge1xuXHRcdFx0cmV0dXJuIGRhdGEuZGF0YVswXS5lbWJlZGRpbmc7XG5cdFx0fVxuXHRcdHRocm93IG5ldyBFcnJvcignSW52YWxpZCBPcGVuQUkgZW1iZWRkaW5nIHJlc3BvbnNlIGZvcm1hdCcpO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBjYWxsQ29oZXJlRW1iZWRkaW5nKGFwaUtleTogc3RyaW5nLCBtb2RlbDogc3RyaW5nLCBxdWVyeTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXJbXT4ge1xuXHRcdGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goJ2h0dHBzOi8vYXBpLmNvaGVyZS5haS92MS9lbWJlZCcsIHtcblx0XHRcdG1ldGhvZDogJ1BPU1QnLFxuXHRcdFx0aGVhZGVyczoge1xuXHRcdFx0XHQnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuXHRcdFx0XHQnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthcGlLZXl9YFxuXHRcdFx0fSxcblx0XHRcdGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcblx0XHRcdFx0bW9kZWwsXG5cdFx0XHRcdHRleHRzOiBbcXVlcnldXG5cdFx0XHR9KVxuXHRcdH0pO1xuXG5cdFx0aWYgKCFyZXNwb25zZS5vaykge1xuXHRcdFx0Y29uc3QgZXJyb3IgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYENvaGVyZSBlbWJlZGRpbmcgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c30gJHtlcnJvcn1gKTtcblx0XHR9XG5cblx0XHRjb25zdCBkYXRhOiBFbWJlZGRpbmdBcGlSZXNwb25zZSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcblx0XHRpZiAoZGF0YS5lbWJlZGRpbmdzICYmIGRhdGEuZW1iZWRkaW5nc1swXSkge1xuXHRcdFx0cmV0dXJuIGRhdGEuZW1iZWRkaW5nc1swXTtcblx0XHR9XG5cdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIENvaGVyZSBlbWJlZGRpbmcgcmVzcG9uc2UgZm9ybWF0Jyk7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGNhbGxHb29nbGVFbWJlZGRpbmcoYXBpS2V5OiBzdHJpbmcsIG1vZGVsOiBzdHJpbmcsIHF1ZXJ5OiBzdHJpbmcsIHVzZUJhdGNoOiBib29sZWFuKTogUHJvbWlzZTxudW1iZXJbXT4ge1xuXHRcdGlmICh1c2VCYXRjaCkge1xuXHRcdFx0Y29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcblx0XHRcdFx0YGh0dHBzOi8vZ2VuZXJhdGl2ZWxhbmd1YWdlLmdvb2dsZWFwaXMuY29tL3YxYmV0YS9tb2RlbHMvJHttb2RlbH06YmF0Y2hFbWJlZENvbnRlbnRzP2tleT0ke2FwaUtleX1gLFxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bWV0aG9kOiAnUE9TVCcsXG5cdFx0XHRcdFx0aGVhZGVyczoge1xuXHRcdFx0XHRcdFx0J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0Ym9keTogSlNPTi5zdHJpbmdpZnkoe1xuXHRcdFx0XHRcdFx0cmVxdWVzdHM6IFt7XG5cdFx0XHRcdFx0XHRcdGNvbnRlbnQ6IHtcblx0XHRcdFx0XHRcdFx0XHRwYXJ0czogW3sgdGV4dDogcXVlcnkgfV1cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fV1cblx0XHRcdFx0XHR9KVxuXHRcdFx0XHR9XG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAoIXJlc3BvbnNlLm9rKSB7XG5cdFx0XHRcdGNvbnN0IGVycm9yID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEdvb2dsZSBHZW1pbmkgYmF0Y2ggZW1iZWRkaW5nIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9ICR7ZXJyb3J9YCk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGRhdGE6IHsgZW1iZWRkaW5ncz86IEFycmF5PHsgdmFsdWVzPzogbnVtYmVyW10gfT4gfSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcblx0XHRcdGlmIChkYXRhLmVtYmVkZGluZ3MgJiYgZGF0YS5lbWJlZGRpbmdzWzBdICYmIGRhdGEuZW1iZWRkaW5nc1swXS52YWx1ZXMpIHtcblx0XHRcdFx0cmV0dXJuIGRhdGEuZW1iZWRkaW5nc1swXS52YWx1ZXM7XG5cdFx0XHR9XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgR29vZ2xlIEdlbWluaSBiYXRjaCBlbWJlZGRpbmcgcmVzcG9uc2UgZm9ybWF0Jyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goXG5cdFx0XHRcdGBodHRwczovL2dlbmVyYXRpdmVsYW5ndWFnZS5nb29nbGVhcGlzLmNvbS92MWJldGEvbW9kZWxzLyR7bW9kZWx9OmVtYmVkQ29udGVudD9rZXk9JHthcGlLZXl9YCxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdG1ldGhvZDogJ1BPU1QnLFxuXHRcdFx0XHRcdGhlYWRlcnM6IHtcblx0XHRcdFx0XHRcdCdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcblx0XHRcdFx0XHRcdGNvbnRlbnQ6IHtcblx0XHRcdFx0XHRcdFx0cGFydHM6IFt7IHRleHQ6IHF1ZXJ5IH1dXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0fVxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKCFyZXNwb25zZS5vaykge1xuXHRcdFx0XHRjb25zdCBlcnJvciA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKGBHb29nbGUgR2VtaW5pIGVtYmVkZGluZyBBUEkgZXJyb3I6ICR7cmVzcG9uc2Uuc3RhdHVzfSAke2Vycm9yfWApO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBkYXRhOiB7IGVtYmVkZGluZz86IHsgdmFsdWVzPzogbnVtYmVyW10gfSB9ID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuXHRcdFx0aWYgKGRhdGEuZW1iZWRkaW5nICYmIGRhdGEuZW1iZWRkaW5nLnZhbHVlcykge1xuXHRcdFx0XHRyZXR1cm4gZGF0YS5lbWJlZGRpbmcudmFsdWVzO1xuXHRcdFx0fVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIEdvb2dsZSBHZW1pbmkgZW1iZWRkaW5nIHJlc3BvbnNlIGZvcm1hdCcpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgY2FsbEN1c3RvbUVtYmVkZGluZyhhcGlVcmw6IHN0cmluZywgcXVlcnk6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyW10+IHtcblx0XHRjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGFwaVVybCwge1xuXHRcdFx0bWV0aG9kOiAnUE9TVCcsXG5cdFx0XHRoZWFkZXJzOiB7XG5cdFx0XHRcdCdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcblx0XHRcdH0sXG5cdFx0XHRib2R5OiBKU09OLnN0cmluZ2lmeSh7XG5cdFx0XHRcdHRleHQ6IHF1ZXJ5XG5cdFx0XHR9KVxuXHRcdH0pO1xuXG5cdFx0aWYgKCFyZXNwb25zZS5vaykge1xuXHRcdFx0Y29uc3QgZXJyb3IgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEN1c3RvbSBlbWJlZGRpbmcgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c30gJHtlcnJvcn1gKTtcblx0XHR9XG5cblx0XHRjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuXHRcdC8vIFRyeSBjb21tb24gcmVzcG9uc2UgZm9ybWF0c1xuXHRcdGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG5cdFx0XHRyZXR1cm4gZGF0YTtcblx0XHR9XG5cdFx0aWYgKGRhdGEuZW1iZWRkaW5nICYmIEFycmF5LmlzQXJyYXkoZGF0YS5lbWJlZGRpbmcpKSB7XG5cdFx0XHRyZXR1cm4gZGF0YS5lbWJlZGRpbmc7XG5cdFx0fVxuXHRcdGlmIChkYXRhLnZlY3RvciAmJiBBcnJheS5pc0FycmF5KGRhdGEudmVjdG9yKSkge1xuXHRcdFx0cmV0dXJuIGRhdGEudmVjdG9yO1xuXHRcdH1cblx0XHRpZiAoZGF0YS52YWx1ZXMgJiYgQXJyYXkuaXNBcnJheShkYXRhLnZhbHVlcykpIHtcblx0XHRcdHJldHVybiBkYXRhLnZhbHVlcztcblx0XHR9XG5cdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGN1c3RvbSBlbWJlZGRpbmcgQVBJIHJlc3BvbnNlIGZvcm1hdCcpO1xuXHR9XG5cblx0YXN5bmMgc2VhcmNoKHF1ZXJ5OiBSZXRyaWV2YWxRdWVyeSwgb3B0czogUmV0cmlldmFsT3B0aW9ucyk6IFByb21pc2U8Q29udGV4dEl0ZW1bXT4ge1xuXHRcdGlmICghdGhpcy5pc0VuYWJsZWQoKSkgcmV0dXJuIFtdO1xuXHRcdGNvbnN0IHEgPSAocXVlcnkudGV4dCA/PyAnJykudHJpbSgpO1xuXHRcdGlmICghcSkgcmV0dXJuIFtdO1xuXG5cdFx0YXdhaXQgdGhpcy5lbWJlZGRpbmdzSW5kZXguZW5zdXJlTG9hZGVkKCk7XG5cblx0XHQvLyBHZXQgcXVlcnkgZW1iZWRkaW5nIGZyb20gZXh0ZXJuYWwgQVBJXG5cdFx0bGV0IHFWZWM6IG51bWJlcltdO1xuXHRcdHRyeSB7XG5cdFx0XHRxVmVjID0gYXdhaXQgdGhpcy5nZXRRdWVyeUVtYmVkZGluZyhxKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0Y29uc29sZS5lcnJvcihgW0V4dGVybmFsRW1iZWRkaW5nc1Byb3ZpZGVyXSBGYWlsZWQgdG8gZ2V0IHF1ZXJ5IGVtYmVkZGluZzpgLCBlcnJvcik7XG5cdFx0XHQvLyBGYWxsIGJhY2sgdG8gZW1wdHkgcmVzdWx0cyByYXRoZXIgdGhhbiBicmVha2luZyByZXRyaWV2YWxcblx0XHRcdHJldHVybiBbXTtcblx0XHR9XG5cblx0XHQvLyBHZXQgYWxsIGNodW5rcyBmcm9tIGxvY2FsIGluZGV4ICh0aGVzZSBoYXZlIGxvY2FsIGhhc2ggdmVjdG9ycywgYnV0IHdlJ2xsIHVzZSBleHRlcm5hbCBxdWVyeSB2ZWN0b3IpXG5cdFx0Ly8gTm90ZTogVGhpcyBpcyBhIGh5YnJpZCBhcHByb2FjaCAtIGV4dGVybmFsIHF1ZXJ5IHZlY3RvciB3aXRoIGxvY2FsIGNodW5rIHZlY3RvcnNcblx0XHQvLyBGb3IgdHJ1ZSBoeWJyaWQsIHdlJ2QgbmVlZCB0byByZS1lbWJlZCBjaHVua3Mgd2l0aCBleHRlcm5hbCBBUEksIGJ1dCB0aGF0J3MgZXhwZW5zaXZlXG5cdFx0Ly8gSW5zdGVhZCwgd2UgdXNlIHRoZSBleHRlcm5hbCBxdWVyeSB2ZWN0b3Igd2l0aCBsb2NhbCBoYXNoIHZlY3RvcnMgKGRpbWVuc2lvbiBtaXNtYXRjaCBoYW5kbGVkKVxuXHRcdGNvbnN0IGNodW5rcyA9IHRoaXMuZW1iZWRkaW5nc0luZGV4LmdldEFsbENodW5rcygpLmZpbHRlcigoYykgPT4gdGhpcy5pc0FsbG93ZWRQYXRoKGMucGF0aCkpO1xuXHRcdGlmIChjaHVua3MubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG5cblx0XHQvLyBTY29yZSBjaHVua3MgdXNpbmcgZXh0ZXJuYWwgcXVlcnkgdmVjdG9yIGFnYWluc3QgbG9jYWwgaGFzaCB2ZWN0b3JzXG5cdFx0Ly8gTm90ZTogRGltZW5zaW9uIG1pc21hdGNoIGlzIGhhbmRsZWQgYnkgZG90IHByb2R1Y3QgKHVzZXMgbWluIGxlbmd0aClcblx0XHRjb25zdCBzY29yZWQgPSBjaHVua3Ncblx0XHRcdC5tYXAoKGMpID0+IHtcblx0XHRcdFx0Y29uc3QgbG9jYWxWZWMgPSBjLnZlY3Rvcjtcblx0XHRcdFx0Ly8gTm9ybWFsaXplIGJvdGggdmVjdG9ycyBmb3IgYmV0dGVyIGNvbXBhcmlzb24gYWNyb3NzIGRpZmZlcmVudCBlbWJlZGRpbmcgc3BhY2VzXG5cdFx0XHRcdGNvbnN0IHFOb3JtID0gTWF0aC5zcXJ0KHFWZWMucmVkdWNlKChzdW0sIHYpID0+IHN1bSArIHYgKiB2LCAwKSkgfHwgMTtcblx0XHRcdFx0Y29uc3QgbG9jYWxOb3JtID0gTWF0aC5zcXJ0KGxvY2FsVmVjLnJlZHVjZSgoc3VtLCB2KSA9PiBzdW0gKyB2ICogdiwgMCkpIHx8IDE7XG5cdFx0XHRcdGNvbnN0IG5vcm1hbGl6ZWRRID0gcVZlYy5tYXAodiA9PiB2IC8gcU5vcm0pO1xuXHRcdFx0XHRjb25zdCBub3JtYWxpemVkTG9jYWwgPSBsb2NhbFZlYy5tYXAodiA9PiB2IC8gbG9jYWxOb3JtKTtcblx0XHRcdFx0Y29uc3Qgc2NvcmUgPSBkb3Qobm9ybWFsaXplZFEsIG5vcm1hbGl6ZWRMb2NhbCk7XG5cdFx0XHRcdHJldHVybiB7IGNodW5rOiBjLCBzY29yZSB9O1xuXHRcdFx0fSlcblx0XHRcdC5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSlcblx0XHRcdC5zbGljZSgwLCBNYXRoLm1heCgxLCBNYXRoLm1pbigyMDAsIG9wdHMubGltaXQgKiA2KSkpO1xuXG5cdFx0Y29uc3QgcmVzdWx0czogQ29udGV4dEl0ZW1bXSA9IFtdO1xuXHRcdGZvciAoY29uc3QgeyBjaHVuaywgc2NvcmUgfSBvZiBzY29yZWQpIHtcblx0XHRcdHJlc3VsdHMucHVzaCh7XG5cdFx0XHRcdGtleTogY2h1bmsua2V5LFxuXHRcdFx0XHRwYXRoOiBjaHVuay5wYXRoLFxuXHRcdFx0XHR0aXRsZTogY2h1bmsucGF0aC5zcGxpdCgnLycpLnBvcCgpLFxuXHRcdFx0XHRleGNlcnB0OiBjaHVuay5leGNlcnB0LFxuXHRcdFx0XHRzY29yZTogTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKHNjb3JlICsgMSkgLyAyKSksXG5cdFx0XHRcdHNvdXJjZTogdGhpcy5pZCxcblx0XHRcdFx0cmVhc29uVGFnczogWydleHRlcm5hbC1lbWJlZGRpbmdzJ11cblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHJldHVybiByZXN1bHRzLnNsaWNlKDAsIG9wdHMubGltaXQpO1xuXHR9XG59XG5cbiJdfQ==