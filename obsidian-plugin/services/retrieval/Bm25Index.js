import { TFile } from 'obsidian';
import { fnv1a32 } from '../ContentHash';
import { buildIndexChunks } from './Chunking';
function clampInt(value, min, max) {
    if (!Number.isFinite(value))
        return min;
    return Math.max(min, Math.min(max, Math.floor(value)));
}
function excerptOf(text, maxChars) {
    const trimmed = text.trim().replace(/\s+/g, ' ');
    if (trimmed.length <= maxChars)
        return trimmed;
    return `${trimmed.slice(0, maxChars)}â€¦`;
}
function chunkingKey(plugin) {
    return {
        headingLevel: plugin.settings.retrievalChunkHeadingLevel ?? 'h1',
        targetWords: clampInt(plugin.settings.retrievalChunkWords ?? 500, 200, 2000),
        overlapWords: clampInt(plugin.settings.retrievalChunkOverlapWords ?? 100, 0, 500)
    };
}
const STOPWORDS = new Set([
    'the',
    'a',
    'an',
    'and',
    'or',
    'but',
    'to',
    'of',
    'in',
    'on',
    'for',
    'with',
    'at',
    'from',
    'by',
    'as',
    'is',
    'are',
    'was',
    'were',
    'be',
    'been',
    'it',
    'that',
    'this',
    'these',
    'those'
]);
function tokenize(value) {
    return (value || '')
        .toLowerCase()
        .split(/[^\p{L}\p{N}]+/gu)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3 && !STOPWORDS.has(t));
}
function tfMap(tokens) {
    const m = new Map();
    for (const t of tokens)
        m.set(t, (m.get(t) ?? 0) + 1);
    return m;
}
export class Bm25Index {
    constructor(vault, plugin) {
        this.loaded = false;
        this.chunksByKey = new Map();
        this.chunkKeysByPath = new Map();
        this.postings = new Map();
        this.fileState = {};
        this.sumLen = 0;
        this.queue = new Set();
        this.workerRunning = false;
        this.persistTimer = null;
        this.vault = vault;
        this.plugin = plugin;
    }
    getIndexFilePath() {
        return `${this.vault.configDir}/plugins/${this.plugin.manifest.id}/rag-index/bm25.json`;
    }
    getStatus() {
        return {
            indexedFiles: this.chunkKeysByPath.size,
            indexedChunks: this.chunksByKey.size,
            queued: this.queue.size
        };
    }
    getIndexedPaths() {
        return Array.from(this.chunkKeysByPath.keys());
    }
    /**
     * Queue all currently indexed paths for re-checking. This is useful when exclusions/profiles change.
     */
    queueRecheckAllIndexed() {
        for (const p of this.getIndexedPaths())
            this.queue.add(p);
        this._kickWorker();
    }
    async ensureLoaded() {
        if (this.loaded)
            return;
        this.loaded = true;
        try {
            const path = this.getIndexFilePath();
            if (!(await this.vault.adapter.exists(path)))
                return;
            const raw = await this.vault.adapter.read(path);
            const parsed = JSON.parse(raw);
            if (parsed?.version !== 1)
                return;
            const expectedChunking = chunkingKey(this.plugin);
            if (parsed.chunking &&
                (parsed.chunking.headingLevel !== expectedChunking.headingLevel ||
                    parsed.chunking.targetWords !== expectedChunking.targetWords ||
                    parsed.chunking.overlapWords !== expectedChunking.overlapWords)) {
                // Chunking config changed; rebuild index.
                this.enqueueFullRescan();
                return;
            }
            this.fileState = parsed.fileState || {};
            this.sumLen = 0;
            this.chunksByKey.clear();
            this.chunkKeysByPath.clear();
            this.postings.clear();
            const chunks = parsed.chunks || {};
            for (const [key, ch] of Object.entries(chunks)) {
                if (!ch?.key || !ch?.path)
                    continue;
                this.chunksByKey.set(key, ch);
                this.sumLen += ch.len || 0;
                const set = this.chunkKeysByPath.get(ch.path) ?? new Set();
                set.add(key);
                this.chunkKeysByPath.set(ch.path, set);
            }
            const postings = parsed.postings || {};
            for (const [term, list] of Object.entries(postings)) {
                if (!Array.isArray(list))
                    continue;
                this.postings.set(term, list.filter((e) => Array.isArray(e) && typeof e[0] === 'string' && typeof e[1] === 'number'));
            }
        }
        catch {
            // Corrupt index should not break the plugin; we rebuild lazily.
            this.chunksByKey.clear();
            this.chunkKeysByPath.clear();
            this.postings.clear();
            this.fileState = {};
            this.sumLen = 0;
        }
    }
    enqueueFullRescan() {
        const files = this.plugin.vaultService.getIncludedMarkdownFiles();
        for (const f of files)
            this.queue.add(f.path);
        this._kickWorker();
    }
    queueUpdateFile(path) {
        if (!path)
            return;
        this.queue.add(path);
        this._kickWorker();
    }
    queueRemoveFile(path) {
        if (!path)
            return;
        this._removePath(path);
        this._schedulePersist();
    }
    _kickWorker() {
        if (this.workerRunning)
            return;
        this.workerRunning = true;
        void this._runWorker().catch(() => {
            this.workerRunning = false;
        });
    }
    async _runWorker() {
        await this.ensureLoaded();
        while (this.queue.size > 0) {
            if (this.plugin.settings.retrievalIndexPaused)
                break;
            const next = this.queue.values().next().value;
            this.queue.delete(next);
            if (this.plugin.vaultService.isExcludedPath(next)) {
                this._removePath(next);
                this._schedulePersist();
                continue;
            }
            const file = this.vault.getAbstractFileByPath(next);
            if (!(file instanceof TFile) || file.extension !== 'md') {
                this._removePath(next);
                this._schedulePersist();
                continue;
            }
            try {
                const content = await this.vault.read(file);
                const fileHash = fnv1a32(content);
                const prev = this.fileState[next];
                if (prev?.hash === fileHash)
                    continue;
                this._reindexFile(next, content);
                this.fileState[next] = {
                    hash: fileHash,
                    chunkCount: this.chunkKeysByPath.get(next)?.size ?? 0,
                    updatedAt: new Date().toISOString()
                };
                this._schedulePersist();
            }
            catch {
                // ignore unreadable files
            }
            // Yield to keep UI responsive.
            await new Promise((r) => setTimeout(r, 10));
        }
        this.workerRunning = false;
    }
    _removePath(path) {
        const keys = this.chunkKeysByPath.get(path);
        if (keys) {
            for (const k of keys) {
                const ch = this.chunksByKey.get(k);
                if (ch)
                    this.sumLen -= ch.len || 0;
                this.chunksByKey.delete(k);
            }
        }
        this.chunkKeysByPath.delete(path);
        delete this.fileState[path];
        // Note: postings are not compacted immediately; stale entries are ignored at query time.
    }
    _reindexFile(path, content) {
        this._removePath(path);
        const cfg = chunkingKey(this.plugin);
        const chunks = buildIndexChunks({
            text: content,
            headingLevel: cfg.headingLevel,
            targetWords: cfg.targetWords,
            overlapWords: cfg.overlapWords
        });
        for (let i = 0; i < chunks.length; i++) {
            const ch = chunks[i];
            const toks = tokenize(ch.text);
            if (toks.length === 0)
                continue;
            const key = `chunk:${path}:${i}`;
            const tf = tfMap(toks);
            this.sumLen += toks.length;
            const meta = {
                key,
                path,
                chunkIndex: i,
                startWord: ch.startWord,
                endWord: ch.endWord,
                excerpt: excerptOf(ch.text, 500),
                len: toks.length
            };
            this.chunksByKey.set(key, meta);
            const set = this.chunkKeysByPath.get(path) ?? new Set();
            set.add(key);
            this.chunkKeysByPath.set(path, set);
            for (const [term, count] of tf.entries()) {
                const list = this.postings.get(term) ?? [];
                list.push([key, count]);
                this.postings.set(term, list);
            }
        }
    }
    _schedulePersist() {
        if (this.persistTimer)
            window.clearTimeout(this.persistTimer);
        this.persistTimer = window.setTimeout(() => {
            this.persistTimer = null;
            void this._persistNow().catch(() => {
                // ignore
            });
        }, 1000);
    }
    async _persistNow() {
        const dir = `${this.vault.configDir}/plugins/${this.plugin.manifest.id}/rag-index`;
        try {
            if (!(await this.vault.adapter.exists(dir))) {
                await this.vault.adapter.mkdir(dir);
            }
        }
        catch {
            // ignore mkdir failures
        }
        const postingsObj = {};
        for (const [term, list] of this.postings.entries())
            postingsObj[term] = list;
        const chunksObj = {};
        for (const [key, ch] of this.chunksByKey.entries())
            chunksObj[key] = ch;
        const avgdl = this.chunksByKey.size ? this.sumLen / this.chunksByKey.size : 0;
        const payload = {
            version: 1,
            avgdl,
            totalChunks: this.chunksByKey.size,
            fileState: this.fileState,
            chunking: chunkingKey(this.plugin),
            chunks: chunksObj,
            postings: postingsObj
        };
        await this.vault.adapter.write(this.getIndexFilePath(), JSON.stringify(payload));
    }
    search(queryText, limit) {
        const qTokens = tokenize(queryText).slice(0, 24);
        const terms = Array.from(new Set(qTokens));
        if (terms.length === 0)
            return [];
        const N = this.chunksByKey.size;
        if (N === 0)
            return [];
        const avgdl = N ? this.sumLen / N : 0;
        const k1 = 1.2;
        const b = 0.75;
        const scores = new Map();
        for (const term of terms) {
            const posting = this.postings.get(term);
            if (!posting || posting.length === 0)
                continue;
            let df = 0;
            for (const [key] of posting) {
                if (this.chunksByKey.has(key))
                    df++;
            }
            if (df === 0)
                continue;
            const idf = Math.log(1 + (N - df + 0.5) / (df + 0.5));
            for (const [key, tf] of posting) {
                const ch = this.chunksByKey.get(key);
                if (!ch)
                    continue;
                const dl = ch.len || 0;
                const denom = tf + k1 * (1 - b + (b * dl) / (avgdl || 1));
                const s = (idf * (tf * (k1 + 1))) / (denom || 1);
                scores.set(key, (scores.get(key) ?? 0) + s);
            }
        }
        const ranked = Array.from(scores.entries())
            .map(([key, rawScore]) => {
            const ch = this.chunksByKey.get(key);
            if (!ch)
                return null;
            return { chunk: ch, rawScore, terms };
        })
            .filter((x) => Boolean(x))
            .sort((a, b) => b.rawScore - a.rawScore)
            .slice(0, Math.max(1, Math.min(400, limit)));
        return ranked;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm0yNUluZGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQm0yNUluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFakMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLFlBQVksQ0FBQztBQXdCOUMsU0FBUyxRQUFRLENBQUMsS0FBYSxFQUFFLEdBQVcsRUFBRSxHQUFXO0lBQ3hELElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUFFLE9BQU8sR0FBRyxDQUFDO0lBQ3hDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLElBQVksRUFBRSxRQUFnQjtJQUNoRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNqRCxJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksUUFBUTtRQUFFLE9BQU8sT0FBTyxDQUFDO0lBQy9DLE9BQU8sR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsR0FBRyxDQUFDO0FBQ3pDLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxNQUE4QjtJQUNsRCxPQUFPO1FBQ04sWUFBWSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsMEJBQTBCLElBQUksSUFBSTtRQUNoRSxXQUFXLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsbUJBQW1CLElBQUksR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUM7UUFDNUUs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USxDQUFDO2FBQ3ZDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTlDLE9BQU8sTUFBTSxDQUFDO0lBQ2YsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBWYXVsdCB9IGZyb20gJ29ic2lkaWFuJztcclxuaW1wb3J0IHsgVEZpbGUgfSBmcm9tICdvYnNpZGlhbic7XHJcbmltcG9ydCB0eXBlIFdyaXRpbmdEYXNoYm9hcmRQbHVnaW4gZnJvbSAnLi4vLi4vbWFpbic7XHJcbmltcG9ydCB7IGZudjFhMzIgfSBmcm9tICcuLi9Db250ZW50SGFzaCc7XHJcbmltcG9ydCB7IGJ1aWxkSW5kZXhDaHVua3MgfSBmcm9tICcuL0NodW5raW5nJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQm0yNUNodW5rIHtcclxuXHRrZXk6IHN0cmluZztcclxuXHRwYXRoOiBzdHJpbmc7XHJcblx0Y2h1bmtJbmRleDogbnVtYmVyO1xyXG5cdHN0YXJ0V29yZDogbnVtYmVyO1xyXG5cdGVuZFdvcmQ6IG51bWJlcjtcclxuXHRleGNlcnB0OiBzdHJpbmc7XHJcblx0bGVuOiBudW1iZXI7XHJcbn1cclxuXHJcbmludGVyZmFjZSBQZXJzaXN0ZWRCbTI1VjEge1xyXG5cdHZlcnNpb246IDE7XHJcblx0YXZnZGw6IG51bWJlcjtcclxuXHR0b3RhbENodW5rczogbnVtYmVyO1xyXG5cdGZpbGVTdGF0ZTogUmVjb3JkPHN0cmluZywgeyBoYXNoOiBzdHJpbmc7IGNodW5rQ291bnQ6IG51bWJlcjsgdXBkYXRlZEF0OiBzdHJpbmcgfT47XHJcblx0Y2h1bmtpbmc/OiB7IGhlYWRpbmdMZXZlbDogJ2gxJyB8ICdoMicgfCAnaDMnIHwgJ25vbmUnOyB0YXJnZXRXb3JkczogbnVtYmVyOyBvdmVybGFwV29yZHM6IG51bWJlciB9O1xyXG5cdC8vIENodW5rIG1ldGFkYXRhIGJ5IGtleVxyXG5cdGNodW5rczogUmVjb3JkPHN0cmluZywgQm0yNUNodW5rPjtcclxuXHQvLyB0ZXJtIC0+IGxpc3Qgb2YgW2NodW5rS2V5LCB0Zl1cclxuXHRwb3N0aW5nczogUmVjb3JkPHN0cmluZywgQXJyYXk8W3N0cmluZywgbnVtYmVyXT4+O1xyXG59XHJcblxyXG5mdW5jdGlvbiBjbGFtcEludCh2YWx1ZTogbnVtYmVyLCBtaW46IG51bWJlciwgbWF4OiBudW1iZXIpOiBudW1iZXIge1xyXG5cdGlmICghTnVtYmVyLmlzRmluaXRlKHZhbHVlKSkgcmV0dXJuIG1pbjtcclxuXHRyZXR1cm4gTWF0aC5tYXgobWluLCBNYXRoLm1pbihtYXgsIE1hdGguZmxvb3IodmFsdWUpKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4Y2VycHRPZih0ZXh0OiBzdHJpbmcsIG1heENoYXJzOiBudW1iZXIpOiBzdHJpbmcge1xyXG5cdGNvbnN0IHRyaW1tZWQgPSB0ZXh0LnRyaW0oKS5yZXBsYWNlKC9cXHMrL2csICcgJyk7XHJcblx0aWYgKHRyaW1tZWQubGVuZ3RoIDw9IG1heENoYXJzKSByZXR1cm4gdHJpbW1lZDtcclxuXHRyZXR1cm4gYCR7dHJpbW1lZC5zbGljZSgwLCBtYXhDaGFycyl94oCmYDtcclxufVxyXG5cclxuZnVuY3Rpb24gY2h1bmtpbmdLZXkocGx1Z2luOiBXcml0aW5nRGFzaGJvYXJkUGx1Z2luKTogeyBoZWFkaW5nTGV2ZWw6ICdoMScgfCAnaDInIHwgJ2gzJyB8ICdub25lJzsgdGFyZ2V0V29yZHM6IG51bWJlcjsgb3ZlcmxhcFdvcmRzOiBudW1iZXIgfSB7XHJcblx0cmV0dXJuIHtcclxuXHRcdGhlYWRpbmdMZXZlbDogcGx1Z2luLnNldHRpbmdzLnJldHJpZXZhbENodW5rSGVhZGluZ0xldmVsID8/ICdoMScsXHJcblx0XHR0YXJnZXRXb3JkczogY2xhbXBJbnQocGx1Z2luLnNldHRpbmdzLnJldHJpZXZhbENodW5rV29yZHMgPz8gNTAwLCAyMDAsIDIwMDApLFxyXG5cdFx0b3ZlcmxhcFdvcmRzOiBjbGFtcEludChwbHVnaW4uc2V0dGluZ3MucmV0cmlldmFsQ2h1bmtPdmVybGFwV29yZHMgPz8gMTAwLCAwLCA1MDApXHJcblx0fTtcclxufVxyXG5cclxuY29uc3QgU1RPUFdPUkRTID0gbmV3IFNldDxzdHJpbmc+KFtcclxuXHQndGhlJyxcclxuXHQnYScsXHJcblx0J2FuJyxcclxuXHQnYW5kJyxcclxuXHQnb3InLFxyXG5cdCdidXQnLFxyXG5cdCd0bycsXHJcblx0J29mJyxcclxuXHQnaW4nLFxyXG5cdCdvbicsXHJcblx0J2ZvcicsXHJcblx0J3dpdGgnLFxyXG5cdCdhdCcsXHJcblx0J2Zyb20nLFxyXG5cdCdieScsXHJcblx0J2FzJyxcclxuXHQnaXMnLFxyXG5cdCdhcmUnLFxyXG5cdCd3YXMnLFxyXG5cdCd3ZXJlJyxcclxuXHQnYmUnLFxyXG5cdCdiZWVuJyxcclxuXHQnaXQnLFxyXG5cdCd0aGF0JyxcclxuXHQndGhpcycsXHJcblx0J3RoZXNlJyxcclxuXHQndGhvc2UnXHJcbl0pO1xyXG5cclxuZnVuY3Rpb24gdG9rZW5pemUodmFsdWU6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuXHRyZXR1cm4gKHZhbHVlIHx8ICcnKVxyXG5cdFx0LnRvTG93ZXJDYXNlKClcclxuXHRcdC5zcGxpdCgvW15cXHB7TH1cXHB7Tn1dKy9ndSlcclxuXHRcdC5tYXAoKHQpID0+IHQudHJpbSgpKVxyXG5cdFx0LmZpbHRlcigodCkgPT4gdC5sZW5ndGggPj0gMyAmJiAhU1RPUFdPUkRTLmhhcyh0KSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRmTWFwKHRva2Vuczogc3RyaW5nW10pOiBNYXA8c3RyaW5nLCBudW1iZXI+IHtcclxuXHRjb25zdCBtID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcclxuXHRmb3IgKGNvbnN0IHQgb2YgdG9rZW5zKSBtLnNldCh0LCAobS5nZXQodCkgPz8gMCkgKyAxKTtcclxuXHRyZXR1cm4gbTtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEJtMjVJbmRleCB7XHJcblx0cHJpdmF0ZSByZWFkb25seSB2YXVsdDogVmF1bHQ7XHJcblx0cHJpdmF0ZSByZWFkb25seSBwbHVnaW46IFdyaXRpbmdEYXNoYm9hcmRQbHVnaW47XHJcblxyXG5cdHByaXZhdGUgbG9hZGVkID0gZmFsc2U7XHJcblx0cHJpdmF0ZSBjaHVua3NCeUtleSA9IG5ldyBNYXA8c3RyaW5nLCBCbTI1Q2h1bms+KCk7XHJcblx0cHJpdmF0ZSBjaHVua0tleXNCeVBhdGggPSBuZXcgTWFwPHN0cmluZywgU2V0PHN0cmluZz4+KCk7XHJcblx0cHJpdmF0ZSBwb3N0aW5ncyA9IG5ldyBNYXA8c3RyaW5nLCBBcnJheTxbc3RyaW5nLCBudW1iZXJdPj4oKTtcclxuXHRwcml2YXRlIGZpbGVTdGF0ZTogUmVjb3JkPHN0cmluZywgeyBoYXNoOiBzdHJpbmc7IGNodW5rQ291bnQ6IG51bWJlcjsgdXBkYXRlZEF0OiBzdHJpbmcgfT4gPSB7fTtcclxuXHRwcml2YXRlIHN1bUxlbiA9IDA7XHJcblxyXG5cdHByaXZhdGUgcmVhZG9ubHkgcXVldWUgPSBuZXcgU2V0PHN0cmluZz4oKTtcclxuXHRwcml2YXRlIHdvcmtlclJ1bm5pbmcgPSBmYWxzZTtcclxuXHRwcml2YXRlIHBlcnNpc3RUaW1lcjogbnVtYmVyIHwgbnVsbCA9IG51bGw7XHJcblxyXG5cdGNvbnN0cnVjdG9yKHZhdWx0OiBWYXVsdCwgcGx1Z2luOiBXcml0aW5nRGFzaGJvYXJkUGx1Z2luKSB7XHJcblx0XHR0aGlzLnZhdWx0ID0gdmF1bHQ7XHJcblx0XHR0aGlzLnBsdWdpbiA9IHBsdWdpbjtcclxuXHR9XHJcblxyXG5cdGdldEluZGV4RmlsZVBhdGgoKTogc3RyaW5nIHtcclxuXHRcdHJldHVybiBgJHt0aGlzLnZhdWx0LmNvbmZpZ0Rpcn0vcGx1Z2lucy8ke3RoaXMucGx1Z2luLm1hbmlmZXN0LmlkfS9yYWctaW5kZXgvYm0yNS5qc29uYDtcclxuXHR9XHJcblxyXG5cdGdldFN0YXR1cygpOiB7IGluZGV4ZWRGaWxlczogbnVtYmVyOyBpbmRleGVkQ2h1bmtzOiBudW1iZXI7IHF1ZXVlZDogbnVtYmVyIH0ge1xyXG5cdFx0cmV0dXJuIHtcclxuXHRcdFx0aW5kZXhlZEZpbGVzOiB0aGlzLmNodW5rS2V5c0J5UGF0aC5zaXplLFxyXG5cdFx0XHRpbmRleGVkQ2h1bmtzOiB0aGlzLmNodW5rc0J5S2V5LnNpemUsXHJcblx0XHRcdHF1ZXVlZDogdGhpcy5xdWV1ZS5zaXplXHJcblx0XHR9O1xyXG5cdH1cclxuXHJcblx0Z2V0SW5kZXhlZFBhdGhzKCk6IHN0cmluZ1tdIHtcclxuXHRcdHJldHVybiBBcnJheS5mcm9tKHRoaXMuY2h1bmtLZXlzQnlQYXRoLmtleXMoKSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBRdWV1ZSBhbGwgY3VycmVudGx5IGluZGV4ZWQgcGF0aHMgZm9yIHJlLWNoZWNraW5nLiBUaGlzIGlzIHVzZWZ1bCB3aGVuIGV4Y2x1c2lvbnMvcHJvZmlsZXMgY2hhbmdlLlxyXG5cdCAqL1xyXG5cdHF1ZXVlUmVjaGVja0FsbEluZGV4ZWQoKTogdm9pZCB7XHJcblx0XHRmb3IgKGNvbnN0IHAgb2YgdGhpcy5nZXRJbmRleGVkUGF0aHMoKSkgdGhpcy5xdWV1ZS5hZGQocCk7XHJcblx0XHR0aGlzLl9raWNrV29ya2VyKCk7XHJcblx0fVxyXG5cclxuXHRhc3luYyBlbnN1cmVMb2FkZWQoKTogUHJvbWlzZTx2b2lkPiB7XHJcblx0XHRpZiAodGhpcy5sb2FkZWQpIHJldHVybjtcclxuXHRcdHRoaXMubG9hZGVkID0gdHJ1ZTtcclxuXHJcblx0XHR0cnkge1xyXG5cdFx0XHRjb25zdCBwYXRoID0gdGhpcy5nZXRJbmRleEZpbGVQYXRoKCk7XHJcblx0XHRcdGlmICghKGF3YWl0IHRoaXMudmF1bHQuYWRhcHRlci5leGlzdHMocGF0aCkpKSByZXR1cm47XHJcblx0XHRcdGNvbnN0IHJhdyA9IGF3YWl0IHRoaXMudmF1bHQuYWRhcHRlci5yZWFkKHBhdGgpO1xyXG5cdFx0XHRjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKHJhdykgYXMgUGVyc2lzdGVkQm0yNVYxO1xyXG5cdFx0XHRpZiAocGFyc2VkPy52ZXJzaW9uICE9PSAxKSByZXR1cm47XHJcblx0XHRcdGNvbnN0IGV4cGVjdGVkQ2h1bmtpbmcgPSBjaHVua2luZ0tleSh0aGlzLnBsdWdpbik7XHJcblx0XHRcdGlmIChcclxuXHRcdFx0XHRwYXJzZWQuY2h1bmtpbmcgJiZcclxuXHRcdFx0XHQocGFyc2VkLmNodW5raW5nLmhlYWRpbmdMZXZlbCAhPT0gZXhwZWN0ZWRDaHVua2luZy5oZWFkaW5nTGV2ZWwgfHxcclxuXHRcdFx0XHRcdHBhcnNlZC5jaHVua2luZy50YXJnZXRXb3JkcyAhPT0gZXhwZWN0ZWRDaHVua2luZy50YXJnZXRXb3JkcyB8fFxyXG5cdFx0XHRcdFx0cGFyc2VkLmNodW5raW5nLm92ZXJsYXBXb3JkcyAhPT0gZXhwZWN0ZWRDaHVua2luZy5vdmVybGFwV29yZHMpXHJcblx0XHRcdCkge1xyXG5cdFx0XHRcdC8vIENodW5raW5nIGNvbmZpZyBjaGFuZ2VkOyByZWJ1aWxkIGluZGV4LlxyXG5cdFx0XHRcdHRoaXMuZW5xdWV1ZUZ1bGxSZXNjYW4oKTtcclxuXHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdHRoaXMuZmlsZVN0YXRlID0gcGFyc2VkLmZpbGVTdGF0ZSB8fCB7fTtcclxuXHRcdFx0dGhpcy5zdW1MZW4gPSAwO1xyXG5cdFx0XHR0aGlzLmNodW5rc0J5S2V5LmNsZWFyKCk7XHJcblx0XHRcdHRoaXMuY2h1bmtLZXlzQnlQYXRoLmNsZWFyKCk7XHJcblx0XHRcdHRoaXMucG9zdGluZ3MuY2xlYXIoKTtcclxuXHJcblx0XHRcdGNvbnN0IGNodW5rcyA9IHBhcnNlZC5jaHVua3MgfHwge307XHJcblx0XHRcdGZvciAoY29uc3QgW2tleSwgY2hdIG9mIE9iamVjdC5lbnRyaWVzKGNodW5rcykpIHtcclxuXHRcdFx0XHRpZiAoIWNoPy5rZXkgfHwgIWNoPy5wYXRoKSBjb250aW51ZTtcclxuXHRcdFx0XHR0aGlzLmNodW5rc0J5S2V5LnNldChrZXksIGNoKTtcclxuXHRcdFx0XHR0aGlzLnN1bUxlbiArPSBjaC5sZW4gfHwgMDtcclxuXHRcdFx0XHRjb25zdCBzZXQgPSB0aGlzLmNodW5rS2V5c0J5UGF0aC5nZXQoY2gucGF0aCkgPz8gbmV3IFNldDxzdHJpbmc+KCk7XHJcblx0XHRcdFx0c2V0LmFkZChrZXkpO1xyXG5cdFx0XHRcdHRoaXMuY2h1bmtLZXlzQnlQYXRoLnNldChjaC5wYXRoLCBzZXQpO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRjb25zdCBwb3N0aW5ncyA9IHBhcnNlZC5wb3N0aW5ncyB8fCB7fTtcclxuXHRcdFx0Zm9yIChjb25zdCBbdGVybSwgbGlzdF0gb2YgT2JqZWN0LmVudHJpZXMocG9zdGluZ3MpKSB7XHJcblx0XHRcdFx0aWYgKCFBcnJheS5pc0FycmF5KGxpc3QpKSBjb250aW51ZTtcclxuXHRcdFx0XHR0aGlzLnBvc3RpbmdzLnNldCh0ZXJtLCBsaXN0LmZpbHRlcigoZSkgPT4gQXJyYXkuaXNBcnJheShlKSAmJiB0eXBlb2YgZVswXSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIGVbMV0gPT09ICdudW1iZXInKSBhcyBBcnJheTxbc3RyaW5nLCBudW1iZXJdPik7XHJcblx0XHRcdH1cclxuXHRcdH0gY2F0Y2gge1xyXG5cdFx0XHQvLyBDb3JydXB0IGluZGV4IHNob3VsZCBub3QgYnJlYWsgdGhlIHBsdWdpbjsgd2UgcmVidWlsZCBsYXppbHkuXHJcblx0XHRcdHRoaXMuY2h1bmtzQnlLZXkuY2xlYXIoKTtcclxuXHRcdFx0dGhpcy5jaHVua0tleXNCeVBhdGguY2xlYXIoKTtcclxuXHRcdFx0dGhpcy5wb3N0aW5ncy5jbGVhcigpO1xyXG5cdFx0XHR0aGlzLmZpbGVTdGF0ZSA9IHt9O1xyXG5cdFx0XHR0aGlzLnN1bUxlbiA9IDA7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRlbnF1ZXVlRnVsbFJlc2NhbigpOiB2b2lkIHtcclxuXHRcdGNvbnN0IGZpbGVzID0gdGhpcy5wbHVnaW4udmF1bHRTZXJ2aWNlLmdldEluY2x1ZGVkTWFya2Rvd25GaWxlcygpO1xyXG5cdFx0Zm9yIChjb25zdCBmIG9mIGZpbGVzKSB0aGlzLnF1ZXVlLmFkZChmLnBhdGgpO1xyXG5cdFx0dGhpcy5fa2lja1dvcmtlcigpO1xyXG5cdH1cclxuXHJcblx0cXVldWVVcGRhdGVGaWxlKHBhdGg6IHN0cmluZyk6IHZvaWQge1xyXG5cdFx0aWYgKCFwYXRoKSByZXR1cm47XHJcblx0XHR0aGlzLnF1ZXVlLmFkZChwYXRoKTtcclxuXHRcdHRoaXMuX2tpY2tXb3JrZXIoKTtcclxuXHR9XHJcblxyXG5cdHF1ZXVlUmVtb3ZlRmlsZShwYXRoOiBzdHJpbmcpOiB2b2lkIHtcclxuXHRcdGlmICghcGF0aCkgcmV0dXJuO1xyXG5cdFx0dGhpcy5fcmVtb3ZlUGF0aChwYXRoKTtcclxuXHRcdHRoaXMuX3NjaGVkdWxlUGVyc2lzdCgpO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBfa2lja1dvcmtlcigpOiB2b2lkIHtcclxuXHRcdGlmICh0aGlzLndvcmtlclJ1bm5pbmcpIHJldHVybjtcclxuXHRcdHRoaXMud29ya2VyUnVubmluZyA9IHRydWU7XHJcblx0XHR2b2lkIHRoaXMuX3J1bldvcmtlcigpLmNhdGNoKCgpID0+IHtcclxuXHRcdFx0dGhpcy53b3JrZXJSdW5uaW5nID0gZmFsc2U7XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgYXN5bmMgX3J1bldvcmtlcigpOiBQcm9taXNlPHZvaWQ+IHtcclxuXHRcdGF3YWl0IHRoaXMuZW5zdXJlTG9hZGVkKCk7XHJcblxyXG5cdFx0d2hpbGUgKHRoaXMucXVldWUuc2l6ZSA+IDApIHtcclxuXHRcdFx0aWYgKHRoaXMucGx1Z2luLnNldHRpbmdzLnJldHJpZXZhbEluZGV4UGF1c2VkKSBicmVhaztcclxuXHRcdFx0Y29uc3QgbmV4dCA9IHRoaXMucXVldWUudmFsdWVzKCkubmV4dCgpLnZhbHVlIGFzIHN0cmluZztcclxuXHRcdFx0dGhpcy5xdWV1ZS5kZWxldGUobmV4dCk7XHJcblxyXG5cdFx0XHRpZiAodGhpcy5wbHVnaW4udmF1bHRTZXJ2aWNlLmlzRXhjbHVkZWRQYXRoKG5leHQpKSB7XHJcblx0XHRcdFx0dGhpcy5fcmVtb3ZlUGF0aChuZXh0KTtcclxuXHRcdFx0XHR0aGlzLl9zY2hlZHVsZVBlcnNpc3QoKTtcclxuXHRcdFx0XHRjb250aW51ZTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Y29uc3QgZmlsZSA9IHRoaXMudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKG5leHQpO1xyXG5cdFx0XHRpZiAoIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpIHx8IGZpbGUuZXh0ZW5zaW9uICE9PSAnbWQnKSB7XHJcblx0XHRcdFx0dGhpcy5fcmVtb3ZlUGF0aChuZXh0KTtcclxuXHRcdFx0XHR0aGlzLl9zY2hlZHVsZVBlcnNpc3QoKTtcclxuXHRcdFx0XHRjb250aW51ZTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0dHJ5IHtcclxuXHRcdFx0XHRjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy52YXVsdC5yZWFkKGZpbGUpO1xyXG5cdFx0XHRcdGNvbnN0IGZpbGVIYXNoID0gZm52MWEzMihjb250ZW50KTtcclxuXHRcdFx0XHRjb25zdCBwcmV2ID0gdGhpcy5maWxlU3RhdGVbbmV4dF07XHJcblx0XHRcdFx0aWYgKHByZXY/Lmhhc2ggPT09IGZpbGVIYXNoKSBjb250aW51ZTtcclxuXHJcblx0XHRcdFx0dGhpcy5fcmVpbmRleEZpbGUobmV4dCwgY29udGVudCk7XHJcblx0XHRcdFx0dGhpcy5maWxlU3RhdGVbbmV4dF0gPSB7XHJcblx0XHRcdFx0XHRoYXNoOiBmaWxlSGFzaCxcclxuXHRcdFx0XHRcdGNodW5rQ291bnQ6IHRoaXMuY2h1bmtLZXlzQnlQYXRoLmdldChuZXh0KT8uc2l6ZSA/PyAwLFxyXG5cdFx0XHRcdFx0dXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuXHRcdFx0XHR9O1xyXG5cdFx0XHRcdHRoaXMuX3NjaGVkdWxlUGVyc2lzdCgpO1xyXG5cdFx0XHR9IGNhdGNoIHtcclxuXHRcdFx0XHQvLyBpZ25vcmUgdW5yZWFkYWJsZSBmaWxlc1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHQvLyBZaWVsZCB0byBrZWVwIFVJIHJlc3BvbnNpdmUuXHJcblx0XHRcdGF3YWl0IG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIDEwKSk7XHJcblx0XHR9XHJcblxyXG5cdFx0dGhpcy53b3JrZXJSdW5uaW5nID0gZmFsc2U7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF9yZW1vdmVQYXRoKHBhdGg6IHN0cmluZyk6IHZvaWQge1xyXG5cdFx0Y29uc3Qga2V5cyA9IHRoaXMuY2h1bmtLZXlzQnlQYXRoLmdldChwYXRoKTtcclxuXHRcdGlmIChrZXlzKSB7XHJcblx0XHRcdGZvciAoY29uc3QgayBvZiBrZXlzKSB7XHJcblx0XHRcdFx0Y29uc3QgY2ggPSB0aGlzLmNodW5rc0J5S2V5LmdldChrKTtcclxuXHRcdFx0XHRpZiAoY2gpIHRoaXMuc3VtTGVuIC09IGNoLmxlbiB8fCAwO1xyXG5cdFx0XHRcdHRoaXMuY2h1bmtzQnlLZXkuZGVsZXRlKGspO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0XHR0aGlzLmNodW5rS2V5c0J5UGF0aC5kZWxldGUocGF0aCk7XHJcblx0XHRkZWxldGUgdGhpcy5maWxlU3RhdGVbcGF0aF07XHJcblx0XHQvLyBOb3RlOiBwb3N0aW5ncyBhcmUgbm90IGNvbXBhY3RlZCBpbW1lZGlhdGVseTsgc3RhbGUgZW50cmllcyBhcmUgaWdub3JlZCBhdCBxdWVyeSB0aW1lLlxyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBfcmVpbmRleEZpbGUocGF0aDogc3RyaW5nLCBjb250ZW50OiBzdHJpbmcpOiB2b2lkIHtcclxuXHRcdHRoaXMuX3JlbW92ZVBhdGgocGF0aCk7XHJcblxyXG5cdFx0Y29uc3QgY2ZnID0gY2h1bmtpbmdLZXkodGhpcy5wbHVnaW4pO1xyXG5cdFx0Y29uc3QgY2h1bmtzID0gYnVpbGRJbmRleENodW5rcyh7XHJcblx0XHRcdHRleHQ6IGNvbnRlbnQsXHJcblx0XHRcdGhlYWRpbmdMZXZlbDogY2ZnLmhlYWRpbmdMZXZlbCxcclxuXHRcdFx0dGFyZ2V0V29yZHM6IGNmZy50YXJnZXRXb3JkcyxcclxuXHRcdFx0b3ZlcmxhcFdvcmRzOiBjZmcub3ZlcmxhcFdvcmRzXHJcblx0XHR9KTtcclxuXHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGNodW5rcy5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRjb25zdCBjaCA9IGNodW5rc1tpXTtcclxuXHRcdFx0Y29uc3QgdG9rcyA9IHRva2VuaXplKGNoLnRleHQpO1xyXG5cdFx0XHRpZiAodG9rcy5sZW5ndGggPT09IDApIGNvbnRpbnVlO1xyXG5cclxuXHRcdFx0Y29uc3Qga2V5ID0gYGNodW5rOiR7cGF0aH06JHtpfWA7XHJcblx0XHRcdGNvbnN0IHRmID0gdGZNYXAodG9rcyk7XHJcblx0XHRcdHRoaXMuc3VtTGVuICs9IHRva3MubGVuZ3RoO1xyXG5cclxuXHRcdFx0Y29uc3QgbWV0YTogQm0yNUNodW5rID0ge1xyXG5cdFx0XHRcdGtleSxcclxuXHRcdFx0XHRwYXRoLFxyXG5cdFx0XHRcdGNodW5rSW5kZXg6IGksXHJcblx0XHRcdFx0c3RhcnRXb3JkOiBjaC5zdGFydFdvcmQsXHJcblx0XHRcdFx0ZW5kV29yZDogY2guZW5kV29yZCxcclxuXHRcdFx0XHRleGNlcnB0OiBleGNlcnB0T2YoY2gudGV4dCwgNTAwKSxcclxuXHRcdFx0XHRsZW46IHRva3MubGVuZ3RoXHJcblx0XHRcdH07XHJcblx0XHRcdHRoaXMuY2h1bmtzQnlLZXkuc2V0KGtleSwgbWV0YSk7XHJcblx0XHRcdGNvbnN0IHNldCA9IHRoaXMuY2h1bmtLZXlzQnlQYXRoLmdldChwYXRoKSA/PyBuZXcgU2V0PHN0cmluZz4oKTtcclxuXHRcdFx0c2V0LmFkZChrZXkpO1xyXG5cdFx0XHR0aGlzLmNodW5rS2V5c0J5UGF0aC5zZXQocGF0aCwgc2V0KTtcclxuXHJcblx0XHRcdGZvciAoY29uc3QgW3Rlcm0sIGNvdW50XSBvZiB0Zi5lbnRyaWVzKCkpIHtcclxuXHRcdFx0XHRjb25zdCBsaXN0ID0gdGhpcy5wb3N0aW5ncy5nZXQodGVybSkgPz8gW107XHJcblx0XHRcdFx0bGlzdC5wdXNoKFtrZXksIGNvdW50XSk7XHJcblx0XHRcdFx0dGhpcy5wb3N0aW5ncy5zZXQodGVybSwgbGlzdCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX3NjaGVkdWxlUGVyc2lzdCgpOiB2b2lkIHtcclxuXHRcdGlmICh0aGlzLnBlcnNpc3RUaW1lcikgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnBlcnNpc3RUaW1lcik7XHJcblx0XHR0aGlzLnBlcnNpc3RUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuXHRcdFx0dGhpcy5wZXJzaXN0VGltZXIgPSBudWxsO1xyXG5cdFx0XHR2b2lkIHRoaXMuX3BlcnNpc3ROb3coKS5jYXRjaCgoKSA9PiB7XHJcblx0XHRcdFx0Ly8gaWdub3JlXHJcblx0XHRcdH0pO1xyXG5cdFx0fSwgMTAwMCk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGFzeW5jIF9wZXJzaXN0Tm93KCk6IFByb21pc2U8dm9pZD4ge1xyXG5cdFx0Y29uc3QgZGlyID0gYCR7dGhpcy52YXVsdC5jb25maWdEaXJ9L3BsdWdpbnMvJHt0aGlzLnBsdWdpbi5tYW5pZmVzdC5pZH0vcmFnLWluZGV4YDtcclxuXHRcdHRyeSB7XHJcblx0XHRcdGlmICghKGF3YWl0IHRoaXMudmF1bHQuYWRhcHRlci5leGlzdHMoZGlyKSkpIHtcclxuXHRcdFx0XHRhd2FpdCB0aGlzLnZhdWx0LmFkYXB0ZXIubWtkaXIoZGlyKTtcclxuXHRcdFx0fVxyXG5cdFx0fSBjYXRjaCB7XHJcblx0XHRcdC8vIGlnbm9yZSBta2RpciBmYWlsdXJlc1xyXG5cdFx0fVxyXG5cclxuXHRcdGNvbnN0IHBvc3RpbmdzT2JqOiBQZXJzaXN0ZWRCbTI1VjFbJ3Bvc3RpbmdzJ10gPSB7fTtcclxuXHRcdGZvciAoY29uc3QgW3Rlcm0sIGxpc3RdIG9mIHRoaXMucG9zdGluZ3MuZW50cmllcygpKSBwb3N0aW5nc09ialt0ZXJtXSA9IGxpc3Q7XHJcblxyXG5cdFx0Y29uc3QgY2h1bmtzT2JqOiBQZXJzaXN0ZWRCbTI1VjFbJ2NodW5rcyddID0ge307XHJcblx0XHRmb3IgKGNvbnN0IFtrZXksIGNoXSBvZiB0aGlzLmNodW5rc0J5S2V5LmVudHJpZXMoKSkgY2h1bmtzT2JqW2tleV0gPSBjaDtcclxuXHJcblx0XHRjb25zdCBhdmdkbCA9IHRoaXMuY2h1bmtzQnlLZXkuc2l6ZSA/IHRoaXMuc3VtTGVuIC8gdGhpcy5jaHVua3NCeUtleS5zaXplIDogMDtcclxuXHRcdGNvbnN0IHBheWxvYWQ6IFBlcnNpc3RlZEJtMjVWMSA9IHtcclxuXHRcdFx0dmVyc2lvbjogMSxcclxuXHRcdFx0YXZnZGwsXHJcblx0XHRcdHRvdGFsQ2h1bmtzOiB0aGlzLmNodW5rc0J5S2V5LnNpemUsXHJcblx0XHRcdGZpbGVTdGF0ZTogdGhpcy5maWxlU3RhdGUsXHJcblx0XHRcdGNodW5raW5nOiBjaHVua2luZ0tleSh0aGlzLnBsdWdpbiksXHJcblx0XHRcdGNodW5rczogY2h1bmtzT2JqLFxyXG5cdFx0XHRwb3N0aW5nczogcG9zdGluZ3NPYmpcclxuXHRcdH07XHJcblx0XHRhd2FpdCB0aGlzLnZhdWx0LmFkYXB0ZXIud3JpdGUodGhpcy5nZXRJbmRleEZpbGVQYXRoKCksIEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKTtcclxuXHR9XHJcblxyXG5cdHNlYXJjaChxdWVyeVRleHQ6IHN0cmluZywgbGltaXQ6IG51bWJlcik6IEFycmF5PHsgY2h1bms6IEJtMjVDaHVuazsgcmF3U2NvcmU6IG51bWJlcjsgdGVybXM6IHN0cmluZ1tdIH0+IHtcclxuXHRcdGNvbnN0IHFUb2tlbnMgPSB0b2tlbml6ZShxdWVyeVRleHQpLnNsaWNlKDAsIDI0KTtcclxuXHRcdGNvbnN0IHRlcm1zID0gQXJyYXkuZnJvbShuZXcgU2V0KHFUb2tlbnMpKTtcclxuXHRcdGlmICh0ZXJtcy5sZW5ndGggPT09IDApIHJldHVybiBbXTtcclxuXHJcblx0XHRjb25zdCBOID0gdGhpcy5jaHVua3NCeUtleS5zaXplO1xyXG5cdFx0aWYgKE4gPT09IDApIHJldHVybiBbXTtcclxuXHJcblx0XHRjb25zdCBhdmdkbCA9IE4gPyB0aGlzLnN1bUxlbiAvIE4gOiAwO1xyXG5cdFx0Y29uc3QgazEgPSAxLjI7XHJcblx0XHRjb25zdCBiID0gMC43NTtcclxuXHJcblx0XHRjb25zdCBzY29yZXMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xyXG5cclxuXHRcdGZvciAoY29uc3QgdGVybSBvZiB0ZXJtcykge1xyXG5cdFx0XHRjb25zdCBwb3N0aW5nID0gdGhpcy5wb3N0aW5ncy5nZXQodGVybSk7XHJcblx0XHRcdGlmICghcG9zdGluZyB8fCBwb3N0aW5nLmxlbmd0aCA9PT0gMCkgY29udGludWU7XHJcblxyXG5cdFx0XHRsZXQgZGYgPSAwO1xyXG5cdFx0XHRmb3IgKGNvbnN0IFtrZXldIG9mIHBvc3RpbmcpIHtcclxuXHRcdFx0XHRpZiAodGhpcy5jaHVua3NCeUtleS5oYXMoa2V5KSkgZGYrKztcclxuXHRcdFx0fVxyXG5cdFx0XHRpZiAoZGYgPT09IDApIGNvbnRpbnVlO1xyXG5cclxuXHRcdFx0Y29uc3QgaWRmID0gTWF0aC5sb2coMSArIChOIC0gZGYgKyAwLjUpIC8gKGRmICsgMC41KSk7XHJcblxyXG5cdFx0XHRmb3IgKGNvbnN0IFtrZXksIHRmXSBvZiBwb3N0aW5nKSB7XHJcblx0XHRcdFx0Y29uc3QgY2ggPSB0aGlzLmNodW5rc0J5S2V5LmdldChrZXkpO1xyXG5cdFx0XHRcdGlmICghY2gpIGNvbnRpbnVlO1xyXG5cdFx0XHRcdGNvbnN0IGRsID0gY2gubGVuIHx8IDA7XHJcblx0XHRcdFx0Y29uc3QgZGVub20gPSB0ZiArIGsxICogKDEgLSBiICsgKGIgKiBkbCkgLyAoYXZnZGwgfHwgMSkpO1xyXG5cdFx0XHRcdGNvbnN0IHMgPSAoaWRmICogKHRmICogKGsxICsgMSkpKSAvIChkZW5vbSB8fCAxKTtcclxuXHRcdFx0XHRzY29yZXMuc2V0KGtleSwgKHNjb3Jlcy5nZXQoa2V5KSA/PyAwKSArIHMpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblxyXG5cdFx0Y29uc3QgcmFua2VkID0gQXJyYXkuZnJvbShzY29yZXMuZW50cmllcygpKVxyXG5cdFx0XHQubWFwKChba2V5LCByYXdTY29yZV0pID0+IHtcclxuXHRcdFx0XHRjb25zdCBjaCA9IHRoaXMuY2h1bmtzQnlLZXkuZ2V0KGtleSk7XHJcblx0XHRcdFx0aWYgKCFjaCkgcmV0dXJuIG51bGw7XHJcblx0XHRcdFx0cmV0dXJuIHsgY2h1bms6IGNoLCByYXdTY29yZSwgdGVybXMgfTtcclxuXHRcdFx0fSlcclxuXHRcdFx0LmZpbHRlcigoeCk6IHggaXMgeyBjaHVuazogQm0yNUNodW5rOyByYXdTY29yZTogbnVtYmVyOyB0ZXJtczogc3RyaW5nW10gfSA9PiBCb29sZWFuKHgpKVxyXG5cdFx0XHQuc29ydCgoYSwgYikgPT4gYi5yYXdTY29yZSAtIGEucmF3U2NvcmUpXHJcblx0XHRcdC5zbGljZSgwLCBNYXRoLm1heCgxLCBNYXRoLm1pbig0MDAsIGxpbWl0KSkpO1xyXG5cclxuXHRcdHJldHVybiByYW5rZWQ7XHJcblx0fVxyXG59XHJcblxyXG5cclxuIl19