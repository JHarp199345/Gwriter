import { TFile } from 'obsidian';
import { fnv1a32 } from '../ContentHash';
function clampInt(value, min, max) {
    if (!Number.isFinite(value))
        return min;
    return Math.max(min, Math.min(max, Math.floor(value)));
}
function excerptOf(text, maxChars) {
    const trimmed = text.trim().replace(/\s+/g, ' ');
    if (trimmed.length <= maxChars)
        return trimmed;
    return `${trimmed.slice(0, maxChars)}â€¦`;
}
function chunkWords(text, chunkWordsCount, overlapWordsCount) {
    const words = text.split(/\s+/g).filter(Boolean);
    const chunks = [];
    const size = clampInt(chunkWordsCount, 200, 2000);
    const overlap = clampInt(overlapWordsCount, 0, Math.max(0, size - 1));
    const step = Math.max(1, size - overlap);
    for (let start = 0; start < words.length; start += step) {
        const end = Math.min(words.length, start + size);
        const slice = words.slice(start, end).join(' ');
        chunks.push({ start, end, text: slice });
        if (end >= words.length)
            break;
    }
    return chunks;
}
const STOPWORDS = new Set([
    'the',
    'a',
    'an',
    'and',
    'or',
    'but',
    'to',
    'of',
    'in',
    'on',
    'for',
    'with',
    'at',
    'from',
    'by',
    'as',
    'is',
    'are',
    'was',
    'were',
    'be',
    'been',
    'it',
    'that',
    'this',
    'these',
    'those'
]);
function tokenize(value) {
    return (value || '')
        .toLowerCase()
        .split(/[^\p{L}\p{N}]+/gu)
        .map((t) => t.trim())
        .filter((t) => t.length >= 3 && !STOPWORDS.has(t));
}
function tfMap(tokens) {
    const m = new Map();
    for (const t of tokens)
        m.set(t, (m.get(t) ?? 0) + 1);
    return m;
}
export class Bm25Index {
    constructor(vault, plugin) {
        this.loaded = false;
        this.chunksByKey = new Map();
        this.chunkKeysByPath = new Map();
        this.postings = new Map();
        this.fileState = {};
        this.sumLen = 0;
        this.queue = new Set();
        this.workerRunning = false;
        this.persistTimer = null;
        this.vault = vault;
        this.plugin = plugin;
    }
    getIndexFilePath() {
        return `${this.vault.configDir}/plugins/${this.plugin.manifest.id}/rag-index/bm25.json`;
    }
    getStatus() {
        return {
            indexedFiles: this.chunkKeysByPath.size,
            indexedChunks: this.chunksByKey.size,
            queued: this.queue.size
        };
    }
    async ensureLoaded() {
        if (this.loaded)
            return;
        this.loaded = true;
        try {
            const path = this.getIndexFilePath();
            if (!(await this.vault.adapter.exists(path)))
                return;
            const raw = await this.vault.adapter.read(path);
            const parsed = JSON.parse(raw);
            if (parsed?.version !== 1)
                return;
            this.fileState = parsed.fileState || {};
            this.sumLen = 0;
            this.chunksByKey.clear();
            this.chunkKeysByPath.clear();
            this.postings.clear();
            const chunks = parsed.chunks || {};
            for (const [key, ch] of Object.entries(chunks)) {
                if (!ch?.key || !ch?.path)
                    continue;
                this.chunksByKey.set(key, ch);
                this.sumLen += ch.len || 0;
                const set = this.chunkKeysByPath.get(ch.path) ?? new Set();
                set.add(key);
                this.chunkKeysByPath.set(ch.path, set);
            }
            const postings = parsed.postings || {};
            for (const [term, list] of Object.entries(postings)) {
                if (!Array.isArray(list))
                    continue;
                this.postings.set(term, list.filter((e) => Array.isArray(e) && typeof e[0] === 'string' && typeof e[1] === 'number'));
            }
        }
        catch {
            // Corrupt index should not break the plugin; we rebuild lazily.
            this.chunksByKey.clear();
            this.chunkKeysByPath.clear();
            this.postings.clear();
            this.fileState = {};
            this.sumLen = 0;
        }
    }
    enqueueFullRescan() {
        const files = this.plugin.vaultService.getIncludedMarkdownFiles();
        for (const f of files)
            this.queue.add(f.path);
        this._kickWorker();
    }
    queueUpdateFile(path) {
        if (!path)
            return;
        this.queue.add(path);
        this._kickWorker();
    }
    queueRemoveFile(path) {
        if (!path)
            return;
        this._removePath(path);
        this._schedulePersist();
    }
    _kickWorker() {
        if (this.workerRunning)
            return;
        this.workerRunning = true;
        void this._runWorker().catch(() => {
            this.workerRunning = false;
        });
    }
    async _runWorker() {
        await this.ensureLoaded();
        while (this.queue.size > 0) {
            if (this.plugin.settings.retrievalIndexPaused)
                break;
            const next = this.queue.values().next().value;
            this.queue.delete(next);
            if (this.plugin.vaultService.isExcludedPath(next)) {
                this._removePath(next);
                this._schedulePersist();
                continue;
            }
            const file = this.vault.getAbstractFileByPath(next);
            if (!(file instanceof TFile) || file.extension !== 'md') {
                this._removePath(next);
                this._schedulePersist();
                continue;
            }
            try {
                const content = await this.vault.read(file);
                const fileHash = fnv1a32(content);
                const prev = this.fileState[next];
                if (prev?.hash === fileHash)
                    continue;
                this._reindexFile(next, content);
                this.fileState[next] = {
                    hash: fileHash,
                    chunkCount: this.chunkKeysByPath.get(next)?.size ?? 0,
                    updatedAt: new Date().toISOString()
                };
                this._schedulePersist();
            }
            catch {
                // ignore unreadable files
            }
            // Yield to keep UI responsive.
            await new Promise((r) => setTimeout(r, 10));
        }
        this.workerRunning = false;
    }
    _removePath(path) {
        const keys = this.chunkKeysByPath.get(path);
        if (keys) {
            for (const k of keys) {
                const ch = this.chunksByKey.get(k);
                if (ch)
                    this.sumLen -= ch.len || 0;
                this.chunksByKey.delete(k);
            }
        }
        this.chunkKeysByPath.delete(path);
        delete this.fileState[path];
        // Note: postings are not compacted immediately; stale entries are ignored at query time.
    }
    _reindexFile(path, content) {
        this._removePath(path);
        const chunkWordsCount = this.plugin.settings.retrievalChunkWords ?? 500;
        const overlap = this.plugin.settings.retrievalChunkOverlapWords ?? 100;
        const chunks = chunkWords(content, chunkWordsCount, overlap);
        for (let i = 0; i < chunks.length; i++) {
            const ch = chunks[i];
            const toks = tokenize(ch.text);
            if (toks.length === 0)
                continue;
            const key = `chunk:${path}:${i}`;
            const tf = tfMap(toks);
            this.sumLen += toks.length;
            const meta = {
                key,
                path,
                chunkIndex: i,
                startWord: ch.start,
                endWord: ch.end,
                excerpt: excerptOf(ch.text, 500),
                len: toks.length
            };
            this.chunksByKey.set(key, meta);
            const set = this.chunkKeysByPath.get(path) ?? new Set();
            set.add(key);
            this.chunkKeysByPath.set(path, set);
            for (const [term, count] of tf.entries()) {
                const list = this.postings.get(term) ?? [];
                list.push([key, count]);
                this.postings.set(term, list);
            }
        }
    }
    _schedulePersist() {
        if (this.persistTimer)
            window.clearTimeout(this.persistTimer);
        this.persistTimer = window.setTimeout(() => {
            this.persistTimer = null;
            void this._persistNow().catch(() => {
                // ignore
            });
        }, 1000);
    }
    async _persistNow() {
        const dir = `${this.vault.configDir}/plugins/${this.plugin.manifest.id}/rag-index`;
        try {
            if (!(await this.vault.adapter.exists(dir))) {
                await this.vault.adapter.mkdir(dir);
            }
        }
        catch {
            // ignore mkdir failures
        }
        const postingsObj = {};
        for (const [term, list] of this.postings.entries())
            postingsObj[term] = list;
        const chunksObj = {};
        for (const [key, ch] of this.chunksByKey.entries())
            chunksObj[key] = ch;
        const avgdl = this.chunksByKey.size ? this.sumLen / this.chunksByKey.size : 0;
        const payload = {
            version: 1,
            avgdl,
            totalChunks: this.chunksByKey.size,
            fileState: this.fileState,
            chunks: chunksObj,
            postings: postingsObj
        };
        await this.vault.adapter.write(this.getIndexFilePath(), JSON.stringify(payload));
    }
    search(queryText, limit) {
        const qTokens = tokenize(queryText).slice(0, 24);
        const terms = Array.from(new Set(qTokens));
        if (terms.length === 0)
            return [];
        const N = this.chunksByKey.size;
        if (N === 0)
            return [];
        const avgdl = N ? this.sumLen / N : 0;
        const k1 = 1.2;
        const b = 0.75;
        const scores = new Map();
        for (const term of terms) {
            const posting = this.postings.get(term);
            if (!posting || posting.length === 0)
                continue;
            let df = 0;
            for (const [key] of posting) {
                if (this.chunksByKey.has(key))
                    df++;
            }
            if (df === 0)
                continue;
            const idf = Math.log(1 + (N - df + 0.5) / (df + 0.5));
            for (const [key, tf] of posting) {
                const ch = this.chunksByKey.get(key);
                if (!ch)
                    continue;
                const dl = ch.len || 0;
                const denom = tf + k1 * (1 - b + (b * dl) / (avgdl || 1));
                const s = (idf * (tf * (k1 + 1))) / (denom || 1);
                scores.set(key, (scores.get(key) ?? 0) + s);
            }
        }
        const ranked = Array.from(scores.entries())
            .map(([key, rawScore]) => {
            const ch = this.chunksByKey.get(key);
            if (!ch)
                return null;
            return { chunk: ch, rawScore, terms };
        })
            .filter((x) => Boolean(x))
            .sort((a, b) => b.rawScore - a.rawScore)
            .slice(0, Math.max(1, Math.min(400, limit)));
        return ranked;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm0yNUluZGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQm0yNUluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFakMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBdUJ6QyxTQUFTLFFBQVEsQ0FBQyxLQUFhLEVBQUUsR0FBVyxFQUFFLEdBQVc7SUFDeEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO1FBQUUsT0FBTyxHQUFHLENBQUM7SUFDeEMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN4RCxDQUFDO0FBRUQsU0FBUyxTQUFTLENBQUMsSUFBWSxFQUFFLFFBQWdCO0lBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2pELElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxRQUFRO1FBQUUsT0FBTyxPQUFPLENBQUM7SUFDL0MsT0FBTyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUM7QUFDekMsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUNsQixJQUFZLEVBQ1osZUFBdUIsRUFDdkIsaUJBQXlCO0lBRXpCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2pELE1BQU0sTUFBTSxHQUF3RCxFQUFFLENBQUM7SUFDdkUsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENB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Q0FBQztRQUU5QyxPQUFPLE1BQU0sQ0FBQztJQUNmLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgVmF1bHQgfSBmcm9tICdvYnNpZGlhbic7XHJcbmltcG9ydCB7IFRGaWxlIH0gZnJvbSAnb2JzaWRpYW4nO1xyXG5pbXBvcnQgdHlwZSBXcml0aW5nRGFzaGJvYXJkUGx1Z2luIGZyb20gJy4uLy4uL21haW4nO1xyXG5pbXBvcnQgeyBmbnYxYTMyIH0gZnJvbSAnLi4vQ29udGVudEhhc2gnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBCbTI1Q2h1bmsge1xyXG5cdGtleTogc3RyaW5nO1xyXG5cdHBhdGg6IHN0cmluZztcclxuXHRjaHVua0luZGV4OiBudW1iZXI7XHJcblx0c3RhcnRXb3JkOiBudW1iZXI7XHJcblx0ZW5kV29yZDogbnVtYmVyO1xyXG5cdGV4Y2VycHQ6IHN0cmluZztcclxuXHRsZW46IG51bWJlcjtcclxufVxyXG5cclxuaW50ZXJmYWNlIFBlcnNpc3RlZEJtMjVWMSB7XHJcblx0dmVyc2lvbjogMTtcclxuXHRhdmdkbDogbnVtYmVyO1xyXG5cdHRvdGFsQ2h1bmtzOiBudW1iZXI7XHJcblx0ZmlsZVN0YXRlOiBSZWNvcmQ8c3RyaW5nLCB7IGhhc2g6IHN0cmluZzsgY2h1bmtDb3VudDogbnVtYmVyOyB1cGRhdGVkQXQ6IHN0cmluZyB9PjtcclxuXHQvLyBDaHVuayBtZXRhZGF0YSBieSBrZXlcclxuXHRjaHVua3M6IFJlY29yZDxzdHJpbmcsIEJtMjVDaHVuaz47XHJcblx0Ly8gdGVybSAtPiBsaXN0IG9mIFtjaHVua0tleSwgdGZdXHJcblx0cG9zdGluZ3M6IFJlY29yZDxzdHJpbmcsIEFycmF5PFtzdHJpbmcsIG51bWJlcl0+PjtcclxufVxyXG5cclxuZnVuY3Rpb24gY2xhbXBJbnQodmFsdWU6IG51bWJlciwgbWluOiBudW1iZXIsIG1heDogbnVtYmVyKTogbnVtYmVyIHtcclxuXHRpZiAoIU51bWJlci5pc0Zpbml0ZSh2YWx1ZSkpIHJldHVybiBtaW47XHJcblx0cmV0dXJuIE1hdGgubWF4KG1pbiwgTWF0aC5taW4obWF4LCBNYXRoLmZsb29yKHZhbHVlKSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBleGNlcnB0T2YodGV4dDogc3RyaW5nLCBtYXhDaGFyczogbnVtYmVyKTogc3RyaW5nIHtcclxuXHRjb25zdCB0cmltbWVkID0gdGV4dC50cmltKCkucmVwbGFjZSgvXFxzKy9nLCAnICcpO1xyXG5cdGlmICh0cmltbWVkLmxlbmd0aCA8PSBtYXhDaGFycykgcmV0dXJuIHRyaW1tZWQ7XHJcblx0cmV0dXJuIGAke3RyaW1tZWQuc2xpY2UoMCwgbWF4Q2hhcnMpfeKApmA7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNodW5rV29yZHMoXHJcblx0dGV4dDogc3RyaW5nLFxyXG5cdGNodW5rV29yZHNDb3VudDogbnVtYmVyLFxyXG5cdG92ZXJsYXBXb3Jkc0NvdW50OiBudW1iZXJcclxuKTogQXJyYXk8eyBzdGFydDogbnVtYmVyOyBlbmQ6IG51bWJlcjsgdGV4dDogc3RyaW5nIH0+IHtcclxuXHRjb25zdCB3b3JkcyA9IHRleHQuc3BsaXQoL1xccysvZykuZmlsdGVyKEJvb2xlYW4pO1xyXG5cdGNvbnN0IGNodW5rczogQXJyYXk8eyBzdGFydDogbnVtYmVyOyBlbmQ6IG51bWJlcjsgdGV4dDogc3RyaW5nIH0+ID0gW107XHJcblx0Y29uc3Qgc2l6ZSA9IGNsYW1wSW50KGNodW5rV29yZHNDb3VudCwgMjAwLCAyMDAwKTtcclxuXHRjb25zdCBvdmVybGFwID0gY2xhbXBJbnQob3ZlcmxhcFdvcmRzQ291bnQsIDAsIE1hdGgubWF4KDAsIHNpemUgLSAxKSk7XHJcblx0Y29uc3Qgc3RlcCA9IE1hdGgubWF4KDEsIHNpemUgLSBvdmVybGFwKTtcclxuXHJcblx0Zm9yIChsZXQgc3RhcnQgPSAwOyBzdGFydCA8IHdvcmRzLmxlbmd0aDsgc3RhcnQgKz0gc3RlcCkge1xyXG5cdFx0Y29uc3QgZW5kID0gTWF0aC5taW4od29yZHMubGVuZ3RoLCBzdGFydCArIHNpemUpO1xyXG5cdFx0Y29uc3Qgc2xpY2UgPSB3b3Jkcy5zbGljZShzdGFydCwgZW5kKS5qb2luKCcgJyk7XHJcblx0XHRjaHVua3MucHVzaCh7IHN0YXJ0LCBlbmQsIHRleHQ6IHNsaWNlIH0pO1xyXG5cdFx0aWYgKGVuZCA+PSB3b3Jkcy5sZW5ndGgpIGJyZWFrO1xyXG5cdH1cclxuXHRyZXR1cm4gY2h1bmtzO1xyXG59XHJcblxyXG5jb25zdCBTVE9QV09SRFMgPSBuZXcgU2V0PHN0cmluZz4oW1xyXG5cdCd0aGUnLFxyXG5cdCdhJyxcclxuXHQnYW4nLFxyXG5cdCdhbmQnLFxyXG5cdCdvcicsXHJcblx0J2J1dCcsXHJcblx0J3RvJyxcclxuXHQnb2YnLFxyXG5cdCdpbicsXHJcblx0J29uJyxcclxuXHQnZm9yJyxcclxuXHQnd2l0aCcsXHJcblx0J2F0JyxcclxuXHQnZnJvbScsXHJcblx0J2J5JyxcclxuXHQnYXMnLFxyXG5cdCdpcycsXHJcblx0J2FyZScsXHJcblx0J3dhcycsXHJcblx0J3dlcmUnLFxyXG5cdCdiZScsXHJcblx0J2JlZW4nLFxyXG5cdCdpdCcsXHJcblx0J3RoYXQnLFxyXG5cdCd0aGlzJyxcclxuXHQndGhlc2UnLFxyXG5cdCd0aG9zZSdcclxuXSk7XHJcblxyXG5mdW5jdGlvbiB0b2tlbml6ZSh2YWx1ZTogc3RyaW5nKTogc3RyaW5nW10ge1xyXG5cdHJldHVybiAodmFsdWUgfHwgJycpXHJcblx0XHQudG9Mb3dlckNhc2UoKVxyXG5cdFx0LnNwbGl0KC9bXlxccHtMfVxccHtOfV0rL2d1KVxyXG5cdFx0Lm1hcCgodCkgPT4gdC50cmltKCkpXHJcblx0XHQuZmlsdGVyKCh0KSA9PiB0Lmxlbmd0aCA+PSAzICYmICFTVE9QV09SRFMuaGFzKHQpKTtcclxufVxyXG5cclxuZnVuY3Rpb24gdGZNYXAodG9rZW5zOiBzdHJpbmdbXSk6IE1hcDxzdHJpbmcsIG51bWJlcj4ge1xyXG5cdGNvbnN0IG0gPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xyXG5cdGZvciAoY29uc3QgdCBvZiB0b2tlbnMpIG0uc2V0KHQsIChtLmdldCh0KSA/PyAwKSArIDEpO1xyXG5cdHJldHVybiBtO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQm0yNUluZGV4IHtcclxuXHRwcml2YXRlIHJlYWRvbmx5IHZhdWx0OiBWYXVsdDtcclxuXHRwcml2YXRlIHJlYWRvbmx5IHBsdWdpbjogV3JpdGluZ0Rhc2hib2FyZFBsdWdpbjtcclxuXHJcblx0cHJpdmF0ZSBsb2FkZWQgPSBmYWxzZTtcclxuXHRwcml2YXRlIGNodW5rc0J5S2V5ID0gbmV3IE1hcDxzdHJpbmcsIEJtMjVDaHVuaz4oKTtcclxuXHRwcml2YXRlIGNodW5rS2V5c0J5UGF0aCA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKTtcclxuXHRwcml2YXRlIHBvc3RpbmdzID0gbmV3IE1hcDxzdHJpbmcsIEFycmF5PFtzdHJpbmcsIG51bWJlcl0+PigpO1xyXG5cdHByaXZhdGUgZmlsZVN0YXRlOiBSZWNvcmQ8c3RyaW5nLCB7IGhhc2g6IHN0cmluZzsgY2h1bmtDb3VudDogbnVtYmVyOyB1cGRhdGVkQXQ6IHN0cmluZyB9PiA9IHt9O1xyXG5cdHByaXZhdGUgc3VtTGVuID0gMDtcclxuXHJcblx0cHJpdmF0ZSByZWFkb25seSBxdWV1ZSA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG5cdHByaXZhdGUgd29ya2VyUnVubmluZyA9IGZhbHNlO1xyXG5cdHByaXZhdGUgcGVyc2lzdFRpbWVyOiBudW1iZXIgfCBudWxsID0gbnVsbDtcclxuXHJcblx0Y29uc3RydWN0b3IodmF1bHQ6IFZhdWx0LCBwbHVnaW46IFdyaXRpbmdEYXNoYm9hcmRQbHVnaW4pIHtcclxuXHRcdHRoaXMudmF1bHQgPSB2YXVsdDtcclxuXHRcdHRoaXMucGx1Z2luID0gcGx1Z2luO1xyXG5cdH1cclxuXHJcblx0Z2V0SW5kZXhGaWxlUGF0aCgpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIGAke3RoaXMudmF1bHQuY29uZmlnRGlyfS9wbHVnaW5zLyR7dGhpcy5wbHVnaW4ubWFuaWZlc3QuaWR9L3JhZy1pbmRleC9ibTI1Lmpzb25gO1xyXG5cdH1cclxuXHJcblx0Z2V0U3RhdHVzKCk6IHsgaW5kZXhlZEZpbGVzOiBudW1iZXI7IGluZGV4ZWRDaHVua3M6IG51bWJlcjsgcXVldWVkOiBudW1iZXIgfSB7XHJcblx0XHRyZXR1cm4ge1xyXG5cdFx0XHRpbmRleGVkRmlsZXM6IHRoaXMuY2h1bmtLZXlzQnlQYXRoLnNpemUsXHJcblx0XHRcdGluZGV4ZWRDaHVua3M6IHRoaXMuY2h1bmtzQnlLZXkuc2l6ZSxcclxuXHRcdFx0cXVldWVkOiB0aGlzLnF1ZXVlLnNpemVcclxuXHRcdH07XHJcblx0fVxyXG5cclxuXHRhc3luYyBlbnN1cmVMb2FkZWQoKTogUHJvbWlzZTx2b2lkPiB7XHJcblx0XHRpZiAodGhpcy5sb2FkZWQpIHJldHVybjtcclxuXHRcdHRoaXMubG9hZGVkID0gdHJ1ZTtcclxuXHJcblx0XHR0cnkge1xyXG5cdFx0XHRjb25zdCBwYXRoID0gdGhpcy5nZXRJbmRleEZpbGVQYXRoKCk7XHJcblx0XHRcdGlmICghKGF3YWl0IHRoaXMudmF1bHQuYWRhcHRlci5leGlzdHMocGF0aCkpKSByZXR1cm47XHJcblx0XHRcdGNvbnN0IHJhdyA9IGF3YWl0IHRoaXMudmF1bHQuYWRhcHRlci5yZWFkKHBhdGgpO1xyXG5cdFx0XHRjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKHJhdykgYXMgUGVyc2lzdGVkQm0yNVYxO1xyXG5cdFx0XHRpZiAocGFyc2VkPy52ZXJzaW9uICE9PSAxKSByZXR1cm47XHJcblxyXG5cdFx0XHR0aGlzLmZpbGVTdGF0ZSA9IHBhcnNlZC5maWxlU3RhdGUgfHwge307XHJcblx0XHRcdHRoaXMuc3VtTGVuID0gMDtcclxuXHRcdFx0dGhpcy5jaHVua3NCeUtleS5jbGVhcigpO1xyXG5cdFx0XHR0aGlzLmNodW5rS2V5c0J5UGF0aC5jbGVhcigpO1xyXG5cdFx0XHR0aGlzLnBvc3RpbmdzLmNsZWFyKCk7XHJcblxyXG5cdFx0XHRjb25zdCBjaHVua3MgPSBwYXJzZWQuY2h1bmtzIHx8IHt9O1xyXG5cdFx0XHRmb3IgKGNvbnN0IFtrZXksIGNoXSBvZiBPYmplY3QuZW50cmllcyhjaHVua3MpKSB7XHJcblx0XHRcdFx0aWYgKCFjaD8ua2V5IHx8ICFjaD8ucGF0aCkgY29udGludWU7XHJcblx0XHRcdFx0dGhpcy5jaHVua3NCeUtleS5zZXQoa2V5LCBjaCk7XHJcblx0XHRcdFx0dGhpcy5zdW1MZW4gKz0gY2gubGVuIHx8IDA7XHJcblx0XHRcdFx0Y29uc3Qgc2V0ID0gdGhpcy5jaHVua0tleXNCeVBhdGguZ2V0KGNoLnBhdGgpID8/IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG5cdFx0XHRcdHNldC5hZGQoa2V5KTtcclxuXHRcdFx0XHR0aGlzLmNodW5rS2V5c0J5UGF0aC5zZXQoY2gucGF0aCwgc2V0KTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Y29uc3QgcG9zdGluZ3MgPSBwYXJzZWQucG9zdGluZ3MgfHwge307XHJcblx0XHRcdGZvciAoY29uc3QgW3Rlcm0sIGxpc3RdIG9mIE9iamVjdC5lbnRyaWVzKHBvc3RpbmdzKSkge1xyXG5cdFx0XHRcdGlmICghQXJyYXkuaXNBcnJheShsaXN0KSkgY29udGludWU7XHJcblx0XHRcdFx0dGhpcy5wb3N0aW5ncy5zZXQodGVybSwgbGlzdC5maWx0ZXIoKGUpID0+IEFycmF5LmlzQXJyYXkoZSkgJiYgdHlwZW9mIGVbMF0gPT09ICdzdHJpbmcnICYmIHR5cGVvZiBlWzFdID09PSAnbnVtYmVyJykgYXMgQXJyYXk8W3N0cmluZywgbnVtYmVyXT4pO1xyXG5cdFx0XHR9XHJcblx0XHR9IGNhdGNoIHtcclxuXHRcdFx0Ly8gQ29ycnVwdCBpbmRleCBzaG91bGQgbm90IGJyZWFrIHRoZSBwbHVnaW47IHdlIHJlYnVpbGQgbGF6aWx5LlxyXG5cdFx0XHR0aGlzLmNodW5rc0J5S2V5LmNsZWFyKCk7XHJcblx0XHRcdHRoaXMuY2h1bmtLZXlzQnlQYXRoLmNsZWFyKCk7XHJcblx0XHRcdHRoaXMucG9zdGluZ3MuY2xlYXIoKTtcclxuXHRcdFx0dGhpcy5maWxlU3RhdGUgPSB7fTtcclxuXHRcdFx0dGhpcy5zdW1MZW4gPSAwO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0ZW5xdWV1ZUZ1bGxSZXNjYW4oKTogdm9pZCB7XHJcblx0XHRjb25zdCBmaWxlcyA9IHRoaXMucGx1Z2luLnZhdWx0U2VydmljZS5nZXRJbmNsdWRlZE1hcmtkb3duRmlsZXMoKTtcclxuXHRcdGZvciAoY29uc3QgZiBvZiBmaWxlcykgdGhpcy5xdWV1ZS5hZGQoZi5wYXRoKTtcclxuXHRcdHRoaXMuX2tpY2tXb3JrZXIoKTtcclxuXHR9XHJcblxyXG5cdHF1ZXVlVXBkYXRlRmlsZShwYXRoOiBzdHJpbmcpOiB2b2lkIHtcclxuXHRcdGlmICghcGF0aCkgcmV0dXJuO1xyXG5cdFx0dGhpcy5xdWV1ZS5hZGQocGF0aCk7XHJcblx0XHR0aGlzLl9raWNrV29ya2VyKCk7XHJcblx0fVxyXG5cclxuXHRxdWV1ZVJlbW92ZUZpbGUocGF0aDogc3RyaW5nKTogdm9pZCB7XHJcblx0XHRpZiAoIXBhdGgpIHJldHVybjtcclxuXHRcdHRoaXMuX3JlbW92ZVBhdGgocGF0aCk7XHJcblx0XHR0aGlzLl9zY2hlZHVsZVBlcnNpc3QoKTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX2tpY2tXb3JrZXIoKTogdm9pZCB7XHJcblx0XHRpZiAodGhpcy53b3JrZXJSdW5uaW5nKSByZXR1cm47XHJcblx0XHR0aGlzLndvcmtlclJ1bm5pbmcgPSB0cnVlO1xyXG5cdFx0dm9pZCB0aGlzLl9ydW5Xb3JrZXIoKS5jYXRjaCgoKSA9PiB7XHJcblx0XHRcdHRoaXMud29ya2VyUnVubmluZyA9IGZhbHNlO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGFzeW5jIF9ydW5Xb3JrZXIoKTogUHJvbWlzZTx2b2lkPiB7XHJcblx0XHRhd2FpdCB0aGlzLmVuc3VyZUxvYWRlZCgpO1xyXG5cclxuXHRcdHdoaWxlICh0aGlzLnF1ZXVlLnNpemUgPiAwKSB7XHJcblx0XHRcdGlmICh0aGlzLnBsdWdpbi5zZXR0aW5ncy5yZXRyaWV2YWxJbmRleFBhdXNlZCkgYnJlYWs7XHJcblx0XHRcdGNvbnN0IG5leHQgPSB0aGlzLnF1ZXVlLnZhbHVlcygpLm5leHQoKS52YWx1ZSBhcyBzdHJpbmc7XHJcblx0XHRcdHRoaXMucXVldWUuZGVsZXRlKG5leHQpO1xyXG5cclxuXHRcdFx0aWYgKHRoaXMucGx1Z2luLnZhdWx0U2VydmljZS5pc0V4Y2x1ZGVkUGF0aChuZXh0KSkge1xyXG5cdFx0XHRcdHRoaXMuX3JlbW92ZVBhdGgobmV4dCk7XHJcblx0XHRcdFx0dGhpcy5fc2NoZWR1bGVQZXJzaXN0KCk7XHJcblx0XHRcdFx0Y29udGludWU7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGNvbnN0IGZpbGUgPSB0aGlzLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChuZXh0KTtcclxuXHRcdFx0aWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB8fCBmaWxlLmV4dGVuc2lvbiAhPT0gJ21kJykge1xyXG5cdFx0XHRcdHRoaXMuX3JlbW92ZVBhdGgobmV4dCk7XHJcblx0XHRcdFx0dGhpcy5fc2NoZWR1bGVQZXJzaXN0KCk7XHJcblx0XHRcdFx0Y29udGludWU7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdHRyeSB7XHJcblx0XHRcdFx0Y29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQucmVhZChmaWxlKTtcclxuXHRcdFx0XHRjb25zdCBmaWxlSGFzaCA9IGZudjFhMzIoY29udGVudCk7XHJcblx0XHRcdFx0Y29uc3QgcHJldiA9IHRoaXMuZmlsZVN0YXRlW25leHRdO1xyXG5cdFx0XHRcdGlmIChwcmV2Py5oYXNoID09PSBmaWxlSGFzaCkgY29udGludWU7XHJcblxyXG5cdFx0XHRcdHRoaXMuX3JlaW5kZXhGaWxlKG5leHQsIGNvbnRlbnQpO1xyXG5cdFx0XHRcdHRoaXMuZmlsZVN0YXRlW25leHRdID0ge1xyXG5cdFx0XHRcdFx0aGFzaDogZmlsZUhhc2gsXHJcblx0XHRcdFx0XHRjaHVua0NvdW50OiB0aGlzLmNodW5rS2V5c0J5UGF0aC5nZXQobmV4dCk/LnNpemUgPz8gMCxcclxuXHRcdFx0XHRcdHVwZGF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcblx0XHRcdFx0fTtcclxuXHRcdFx0XHR0aGlzLl9zY2hlZHVsZVBlcnNpc3QoKTtcclxuXHRcdFx0fSBjYXRjaCB7XHJcblx0XHRcdFx0Ly8gaWdub3JlIHVucmVhZGFibGUgZmlsZXNcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gWWllbGQgdG8ga2VlcCBVSSByZXNwb25zaXZlLlxyXG5cdFx0XHRhd2FpdCBuZXcgUHJvbWlzZSgocikgPT4gc2V0VGltZW91dChyLCAxMCkpO1xyXG5cdFx0fVxyXG5cclxuXHRcdHRoaXMud29ya2VyUnVubmluZyA9IGZhbHNlO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBfcmVtb3ZlUGF0aChwYXRoOiBzdHJpbmcpOiB2b2lkIHtcclxuXHRcdGNvbnN0IGtleXMgPSB0aGlzLmNodW5rS2V5c0J5UGF0aC5nZXQocGF0aCk7XHJcblx0XHRpZiAoa2V5cykge1xyXG5cdFx0XHRmb3IgKGNvbnN0IGsgb2Yga2V5cykge1xyXG5cdFx0XHRcdGNvbnN0IGNoID0gdGhpcy5jaHVua3NCeUtleS5nZXQoayk7XHJcblx0XHRcdFx0aWYgKGNoKSB0aGlzLnN1bUxlbiAtPSBjaC5sZW4gfHwgMDtcclxuXHRcdFx0XHR0aGlzLmNodW5rc0J5S2V5LmRlbGV0ZShrKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdFx0dGhpcy5jaHVua0tleXNCeVBhdGguZGVsZXRlKHBhdGgpO1xyXG5cdFx0ZGVsZXRlIHRoaXMuZmlsZVN0YXRlW3BhdGhdO1xyXG5cdFx0Ly8gTm90ZTogcG9zdGluZ3MgYXJlIG5vdCBjb21wYWN0ZWQgaW1tZWRpYXRlbHk7IHN0YWxlIGVudHJpZXMgYXJlIGlnbm9yZWQgYXQgcXVlcnkgdGltZS5cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX3JlaW5kZXhGaWxlKHBhdGg6IHN0cmluZywgY29udGVudDogc3RyaW5nKTogdm9pZCB7XHJcblx0XHR0aGlzLl9yZW1vdmVQYXRoKHBhdGgpO1xyXG5cclxuXHRcdGNvbnN0IGNodW5rV29yZHNDb3VudCA9IHRoaXMucGx1Z2luLnNldHRpbmdzLnJldHJpZXZhbENodW5rV29yZHMgPz8gNTAwO1xyXG5cdFx0Y29uc3Qgb3ZlcmxhcCA9IHRoaXMucGx1Z2luLnNldHRpbmdzLnJldHJpZXZhbENodW5rT3ZlcmxhcFdvcmRzID8/IDEwMDtcclxuXHRcdGNvbnN0IGNodW5rcyA9IGNodW5rV29yZHMoY29udGVudCwgY2h1bmtXb3Jkc0NvdW50LCBvdmVybGFwKTtcclxuXHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGNodW5rcy5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRjb25zdCBjaCA9IGNodW5rc1tpXTtcclxuXHRcdFx0Y29uc3QgdG9rcyA9IHRva2VuaXplKGNoLnRleHQpO1xyXG5cdFx0XHRpZiAodG9rcy5sZW5ndGggPT09IDApIGNvbnRpbnVlO1xyXG5cclxuXHRcdFx0Y29uc3Qga2V5ID0gYGNodW5rOiR7cGF0aH06JHtpfWA7XHJcblx0XHRcdGNvbnN0IHRmID0gdGZNYXAodG9rcyk7XHJcblx0XHRcdHRoaXMuc3VtTGVuICs9IHRva3MubGVuZ3RoO1xyXG5cclxuXHRcdFx0Y29uc3QgbWV0YTogQm0yNUNodW5rID0ge1xyXG5cdFx0XHRcdGtleSxcclxuXHRcdFx0XHRwYXRoLFxyXG5cdFx0XHRcdGNodW5rSW5kZXg6IGksXHJcblx0XHRcdFx0c3RhcnRXb3JkOiBjaC5zdGFydCxcclxuXHRcdFx0XHRlbmRXb3JkOiBjaC5lbmQsXHJcblx0XHRcdFx0ZXhjZXJwdDogZXhjZXJwdE9mKGNoLnRleHQsIDUwMCksXHJcblx0XHRcdFx0bGVuOiB0b2tzLmxlbmd0aFxyXG5cdFx0XHR9O1xyXG5cdFx0XHR0aGlzLmNodW5rc0J5S2V5LnNldChrZXksIG1ldGEpO1xyXG5cdFx0XHRjb25zdCBzZXQgPSB0aGlzLmNodW5rS2V5c0J5UGF0aC5nZXQocGF0aCkgPz8gbmV3IFNldDxzdHJpbmc+KCk7XHJcblx0XHRcdHNldC5hZGQoa2V5KTtcclxuXHRcdFx0dGhpcy5jaHVua0tleXNCeVBhdGguc2V0KHBhdGgsIHNldCk7XHJcblxyXG5cdFx0XHRmb3IgKGNvbnN0IFt0ZXJtLCBjb3VudF0gb2YgdGYuZW50cmllcygpKSB7XHJcblx0XHRcdFx0Y29uc3QgbGlzdCA9IHRoaXMucG9zdGluZ3MuZ2V0KHRlcm0pID8/IFtdO1xyXG5cdFx0XHRcdGxpc3QucHVzaChba2V5LCBjb3VudF0pO1xyXG5cdFx0XHRcdHRoaXMucG9zdGluZ3Muc2V0KHRlcm0sIGxpc3QpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF9zY2hlZHVsZVBlcnNpc3QoKTogdm9pZCB7XHJcblx0XHRpZiAodGhpcy5wZXJzaXN0VGltZXIpIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5wZXJzaXN0VGltZXIpO1xyXG5cdFx0dGhpcy5wZXJzaXN0VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcblx0XHRcdHRoaXMucGVyc2lzdFRpbWVyID0gbnVsbDtcclxuXHRcdFx0dm9pZCB0aGlzLl9wZXJzaXN0Tm93KCkuY2F0Y2goKCkgPT4ge1xyXG5cdFx0XHRcdC8vIGlnbm9yZVxyXG5cdFx0XHR9KTtcclxuXHRcdH0sIDEwMDApO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBhc3luYyBfcGVyc2lzdE5vdygpOiBQcm9taXNlPHZvaWQ+IHtcclxuXHRcdGNvbnN0IGRpciA9IGAke3RoaXMudmF1bHQuY29uZmlnRGlyfS9wbHVnaW5zLyR7dGhpcy5wbHVnaW4ubWFuaWZlc3QuaWR9L3JhZy1pbmRleGA7XHJcblx0XHR0cnkge1xyXG5cdFx0XHRpZiAoIShhd2FpdCB0aGlzLnZhdWx0LmFkYXB0ZXIuZXhpc3RzKGRpcikpKSB7XHJcblx0XHRcdFx0YXdhaXQgdGhpcy52YXVsdC5hZGFwdGVyLm1rZGlyKGRpcik7XHJcblx0XHRcdH1cclxuXHRcdH0gY2F0Y2gge1xyXG5cdFx0XHQvLyBpZ25vcmUgbWtkaXIgZmFpbHVyZXNcclxuXHRcdH1cclxuXHJcblx0XHRjb25zdCBwb3N0aW5nc09iajogUGVyc2lzdGVkQm0yNVYxWydwb3N0aW5ncyddID0ge307XHJcblx0XHRmb3IgKGNvbnN0IFt0ZXJtLCBsaXN0XSBvZiB0aGlzLnBvc3RpbmdzLmVudHJpZXMoKSkgcG9zdGluZ3NPYmpbdGVybV0gPSBsaXN0O1xyXG5cclxuXHRcdGNvbnN0IGNodW5rc09iajogUGVyc2lzdGVkQm0yNVYxWydjaHVua3MnXSA9IHt9O1xyXG5cdFx0Zm9yIChjb25zdCBba2V5LCBjaF0gb2YgdGhpcy5jaHVua3NCeUtleS5lbnRyaWVzKCkpIGNodW5rc09ialtrZXldID0gY2g7XHJcblxyXG5cdFx0Y29uc3QgYXZnZGwgPSB0aGlzLmNodW5rc0J5S2V5LnNpemUgPyB0aGlzLnN1bUxlbiAvIHRoaXMuY2h1bmtzQnlLZXkuc2l6ZSA6IDA7XHJcblx0XHRjb25zdCBwYXlsb2FkOiBQZXJzaXN0ZWRCbTI1VjEgPSB7XHJcblx0XHRcdHZlcnNpb246IDEsXHJcblx0XHRcdGF2Z2RsLFxyXG5cdFx0XHR0b3RhbENodW5rczogdGhpcy5jaHVua3NCeUtleS5zaXplLFxyXG5cdFx0XHRmaWxlU3RhdGU6IHRoaXMuZmlsZVN0YXRlLFxyXG5cdFx0XHRjaHVua3M6IGNodW5rc09iaixcclxuXHRcdFx0cG9zdGluZ3M6IHBvc3RpbmdzT2JqXHJcblx0XHR9O1xyXG5cdFx0YXdhaXQgdGhpcy52YXVsdC5hZGFwdGVyLndyaXRlKHRoaXMuZ2V0SW5kZXhGaWxlUGF0aCgpLCBKU09OLnN0cmluZ2lmeShwYXlsb2FkKSk7XHJcblx0fVxyXG5cclxuXHRzZWFyY2gocXVlcnlUZXh0OiBzdHJpbmcsIGxpbWl0OiBudW1iZXIpOiBBcnJheTx7IGNodW5rOiBCbTI1Q2h1bms7IHJhd1Njb3JlOiBudW1iZXI7IHRlcm1zOiBzdHJpbmdbXSB9PiB7XHJcblx0XHRjb25zdCBxVG9rZW5zID0gdG9rZW5pemUocXVlcnlUZXh0KS5zbGljZSgwLCAyNCk7XHJcblx0XHRjb25zdCB0ZXJtcyA9IEFycmF5LmZyb20obmV3IFNldChxVG9rZW5zKSk7XHJcblx0XHRpZiAodGVybXMubGVuZ3RoID09PSAwKSByZXR1cm4gW107XHJcblxyXG5cdFx0Y29uc3QgTiA9IHRoaXMuY2h1bmtzQnlLZXkuc2l6ZTtcclxuXHRcdGlmIChOID09PSAwKSByZXR1cm4gW107XHJcblxyXG5cdFx0Y29uc3QgYXZnZGwgPSBOID8gdGhpcy5zdW1MZW4gLyBOIDogMDtcclxuXHRcdGNvbnN0IGsxID0gMS4yO1xyXG5cdFx0Y29uc3QgYiA9IDAuNzU7XHJcblxyXG5cdFx0Y29uc3Qgc2NvcmVzID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcclxuXHJcblx0XHRmb3IgKGNvbnN0IHRlcm0gb2YgdGVybXMpIHtcclxuXHRcdFx0Y29uc3QgcG9zdGluZyA9IHRoaXMucG9zdGluZ3MuZ2V0KHRlcm0pO1xyXG5cdFx0XHRpZiAoIXBvc3RpbmcgfHwgcG9zdGluZy5sZW5ndGggPT09IDApIGNvbnRpbnVlO1xyXG5cclxuXHRcdFx0bGV0IGRmID0gMDtcclxuXHRcdFx0Zm9yIChjb25zdCBba2V5XSBvZiBwb3N0aW5nKSB7XHJcblx0XHRcdFx0aWYgKHRoaXMuY2h1bmtzQnlLZXkuaGFzKGtleSkpIGRmKys7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKGRmID09PSAwKSBjb250aW51ZTtcclxuXHJcblx0XHRcdGNvbnN0IGlkZiA9IE1hdGgubG9nKDEgKyAoTiAtIGRmICsgMC41KSAvIChkZiArIDAuNSkpO1xyXG5cclxuXHRcdFx0Zm9yIChjb25zdCBba2V5LCB0Zl0gb2YgcG9zdGluZykge1xyXG5cdFx0XHRcdGNvbnN0IGNoID0gdGhpcy5jaHVua3NCeUtleS5nZXQoa2V5KTtcclxuXHRcdFx0XHRpZiAoIWNoKSBjb250aW51ZTtcclxuXHRcdFx0XHRjb25zdCBkbCA9IGNoLmxlbiB8fCAwO1xyXG5cdFx0XHRcdGNvbnN0IGRlbm9tID0gdGYgKyBrMSAqICgxIC0gYiArIChiICogZGwpIC8gKGF2Z2RsIHx8IDEpKTtcclxuXHRcdFx0XHRjb25zdCBzID0gKGlkZiAqICh0ZiAqIChrMSArIDEpKSkgLyAoZGVub20gfHwgMSk7XHJcblx0XHRcdFx0c2NvcmVzLnNldChrZXksIChzY29yZXMuZ2V0KGtleSkgPz8gMCkgKyBzKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cclxuXHRcdGNvbnN0IHJhbmtlZCA9IEFycmF5LmZyb20oc2NvcmVzLmVudHJpZXMoKSlcclxuXHRcdFx0Lm1hcCgoW2tleSwgcmF3U2NvcmVdKSA9PiB7XHJcblx0XHRcdFx0Y29uc3QgY2ggPSB0aGlzLmNodW5rc0J5S2V5LmdldChrZXkpO1xyXG5cdFx0XHRcdGlmICghY2gpIHJldHVybiBudWxsO1xyXG5cdFx0XHRcdHJldHVybiB7IGNodW5rOiBjaCwgcmF3U2NvcmUsIHRlcm1zIH07XHJcblx0XHRcdH0pXHJcblx0XHRcdC5maWx0ZXIoKHgpOiB4IGlzIHsgY2h1bms6IEJtMjVDaHVuazsgcmF3U2NvcmU6IG51bWJlcjsgdGVybXM6IHN0cmluZ1tdIH0gPT4gQm9vbGVhbih4KSlcclxuXHRcdFx0LnNvcnQoKGEsIGIpID0+IGIucmF3U2NvcmUgLSBhLnJhd1Njb3JlKVxyXG5cdFx0XHQuc2xpY2UoMCwgTWF0aC5tYXgoMSwgTWF0aC5taW4oNDAwLCBsaW1pdCkpKTtcclxuXHJcblx0XHRyZXR1cm4gcmFua2VkO1xyXG5cdH1cclxufVxyXG5cclxuXHJcbiJdfQ==