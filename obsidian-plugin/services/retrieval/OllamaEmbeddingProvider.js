import { requestUrl } from 'obsidian';
export class OllamaEmbeddingProvider {
    constructor(app, baseUrl = 'http://127.0.0.1:11434', model = 'nomic-embed-text') {
        this.app = app;
        this.baseUrl = baseUrl;
        this.model = model;
    }
    async isAvailable() {
        try {
            const res = await requestUrl({ url: `${this.baseUrl}/api/tags`, method: 'GET' });
            return res.status === 200;
        }
        catch (e) {
            console.warn("[Ollama] Not detected. Ensure 'ollama serve' is running.");
            return false;
        }
    }
    /**
     * Check if a specific model is present in the local Ollama registry.
     */
    async hasModel(modelName = this.model) {
        const normalize = (val) => (val || '').split(':')[0];
        try {
            const res = await requestUrl({ url: `${this.baseUrl}/api/tags`, method: 'GET' });
            if (res.status !== 200)
                return false;
            const tags = res.json?.models || res.json?.modelsList || res.json?.data;
            if (!Array.isArray(tags))
                return false;
            return tags.some((m) => {
                const candidates = [
                    typeof m === 'string' ? m : undefined,
                    m?.name,
                    m?.model
                ].filter(Boolean);
                return candidates.some((c) => {
                    if (!c)
                        return false;
                    // Accept exact match, tagged variants (e.g., ":latest"), and normalized prefix match
                    return (c === modelName ||
                        c === `${modelName}:latest` ||
                        c.startsWith(`${modelName}:`) ||
                        normalize(c) === modelName);
                });
            });
        }
        catch {
            return false;
        }
    }
    async getEmbedding(text) {
        const res = await requestUrl({
            url: `${this.baseUrl}/api/embed`,
            method: 'POST',
            body: JSON.stringify({
                model: this.model,
                input: text
            })
        });
        const vec = res.json?.embeddings?.[0];
        if (!Array.isArray(vec) || vec.length === 0) {
            throw new Error('[Ollama] Invalid embedding response');
        }
        return vec;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2xsYW1hRW1iZWRkaW5nUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJPbGxhbWFFbWJlZGRpbmdQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQU8sVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRTNDLE1BQU0sT0FBTyx1QkFBdUI7SUFLbkMsWUFBWSxHQUFRLEVBQUUsT0FBTyxHQUFHLHdCQUF3QixFQUFFLEtBQUssR0FBRyxrQkFBa0I7UUFDbkYsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVc7UUFDaEIsSUFBSSxDQUFDO1lBQ0osTUFBTSxHQUFHLEdBQUcsTUFBTSxVQUFVLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxXQUFXLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDakYsT0FBTyxHQUFHLENBQUMsTUFBTSxLQUFLLEdBQUcsQ0FBQztRQUMzQixDQUFDO1FBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNaLE9BQU8sQ0FBQyxJQUFJLENBQUMsMERBQTBELENBQUMsQ0FBQztZQUN6RSxPQUFPLEtBQUssQ0FBQztRQUNkLENBQUM7SUFDRixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUSxDQUFDLFlBQW9CLElBQUksQ0FBQyxLQUFLO1FBQzVDLE1BQU0sU0FBUyxHQUFHLENBQUMsR0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDO1lBQ0osTUFBTSxHQUFHLEdBQUcsTUFBTSxVQUFVLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxXQUFXLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDakYsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLEdBQUc7Z0JBQUUsT0FBTyxLQUFLLENBQUM7WUFDckMsTUFBTSxJQUFJLEdBQUksR0FBRyxDQUFDLElBQVksRUFBRSxNQUFNLElBQUssR0FBRyxDQUFDLElBQVksRUFBRSxVQUFVLElBQUssR0FBRyxDQUFDLElBQVksRUFBRSxJQUFJLENBQUM7WUFDbkcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO2dCQUFFLE9BQU8sS0FBSyxDQUFDO1lBRXZDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQU0sRUFBRSxFQUFFO2dCQUMzQixNQUFNLFVBQVUsR0FBRztvQkFDbEIsT0FBTyxDQUFDLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVM7b0JBQ3JDLENBQUMsRUFBRSxJQUFJO29CQUNQLENBQUMsRUFBRSxLQUFLO2lCQUNSLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBYSxDQUFDO2dCQUU5QixPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtvQkFDNUIsSUFBSSxDQUFDLENBQUM7d0JBQUUsT0FBTyxLQUFLLENBQUM7b0JBQ3JCLHFGQUFxRjtvQkFDckYsT0FBTyxDQUNOLENBQUMsS0FBSyxTQUFTO3dCQUNmLENBQUMsS0FBSyxHQUFHLFNBQVMsU0FBUzt3QkFDM0IsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLFNBQVMsR0FBRyxDQUFDO3dCQUM3QixTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssU0FBUyxDQUMxQixDQUFDO2dCQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0osQ0FBQyxDQUFDLENBQUM7UUFDSixDQUFDO1FBQUMsTUFBTSxDQUFDO1lBQ1IsT0FBTyxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0YsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUMsSUFBWTtRQUM5QixNQUFNLEdBQUcsR0FBRyxNQUFNLFVBQVUsQ0FBQztZQUM1QixHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxZQUFZO1lBQ2hDLE1BQU0sRUFBRSxNQUFNO1lBQ2QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ3BCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztnQkFDakIsS0FBSyxFQUFFLElBQUk7YUFDWCxDQUFDO1NBQ0YsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxHQUFHLEdBQUksR0FBRyxDQUFDLElBQVksRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzdDLE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztRQUN4RCxDQUFDO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIHJlcXVlc3RVcmwgfSBmcm9tICdvYnNpZGlhbic7XHJcblxyXG5leHBvcnQgY2xhc3MgT2xsYW1hRW1iZWRkaW5nUHJvdmlkZXIge1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgYXBwOiBBcHA7XHJcblx0cHJpdmF0ZSByZWFkb25seSBiYXNlVXJsOiBzdHJpbmc7XHJcblx0cHJpdmF0ZSByZWFkb25seSBtb2RlbDogc3RyaW5nO1xyXG5cclxuXHRjb25zdHJ1Y3RvcihhcHA6IEFwcCwgYmFzZVVybCA9ICdodHRwOi8vMTI3LjAuMC4xOjExNDM0JywgbW9kZWwgPSAnbm9taWMtZW1iZWQtdGV4dCcpIHtcclxuXHRcdHRoaXMuYXBwID0gYXBwO1xyXG5cdFx0dGhpcy5iYXNlVXJsID0gYmFzZVVybDtcclxuXHRcdHRoaXMubW9kZWwgPSBtb2RlbDtcclxuXHR9XHJcblxyXG5cdGFzeW5jIGlzQXZhaWxhYmxlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG5cdFx0dHJ5IHtcclxuXHRcdFx0Y29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdFVybCh7IHVybDogYCR7dGhpcy5iYXNlVXJsfS9hcGkvdGFnc2AsIG1ldGhvZDogJ0dFVCcgfSk7XHJcblx0XHRcdHJldHVybiByZXMuc3RhdHVzID09PSAyMDA7XHJcblx0XHR9IGNhdGNoIChlKSB7XHJcblx0XHRcdGNvbnNvbGUud2FybihcIltPbGxhbWFdIE5vdCBkZXRlY3RlZC4gRW5zdXJlICdvbGxhbWEgc2VydmUnIGlzIHJ1bm5pbmcuXCIpO1xyXG5cdFx0XHRyZXR1cm4gZmFsc2U7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBDaGVjayBpZiBhIHNwZWNpZmljIG1vZGVsIGlzIHByZXNlbnQgaW4gdGhlIGxvY2FsIE9sbGFtYSByZWdpc3RyeS5cclxuXHQgKi9cclxuXHRhc3luYyBoYXNNb2RlbChtb2RlbE5hbWU6IHN0cmluZyA9IHRoaXMubW9kZWwpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuXHRcdGNvbnN0IG5vcm1hbGl6ZSA9ICh2YWw6IHN0cmluZykgPT4gKHZhbCB8fCAnJykuc3BsaXQoJzonKVswXTtcclxuXHRcdHRyeSB7XHJcblx0XHRcdGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3RVcmwoeyB1cmw6IGAke3RoaXMuYmFzZVVybH0vYXBpL3RhZ3NgLCBtZXRob2Q6ICdHRVQnIH0pO1xyXG5cdFx0XHRpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSByZXR1cm4gZmFsc2U7XHJcblx0XHRcdGNvbnN0IHRhZ3MgPSAocmVzLmpzb24gYXMgYW55KT8ubW9kZWxzIHx8IChyZXMuanNvbiBhcyBhbnkpPy5tb2RlbHNMaXN0IHx8IChyZXMuanNvbiBhcyBhbnkpPy5kYXRhO1xyXG5cdFx0XHRpZiAoIUFycmF5LmlzQXJyYXkodGFncykpIHJldHVybiBmYWxzZTtcclxuXHJcblx0XHRcdHJldHVybiB0YWdzLnNvbWUoKG06IGFueSkgPT4ge1xyXG5cdFx0XHRcdGNvbnN0IGNhbmRpZGF0ZXMgPSBbXHJcblx0XHRcdFx0XHR0eXBlb2YgbSA9PT0gJ3N0cmluZycgPyBtIDogdW5kZWZpbmVkLFxyXG5cdFx0XHRcdFx0bT8ubmFtZSxcclxuXHRcdFx0XHRcdG0/Lm1vZGVsXHJcblx0XHRcdFx0XS5maWx0ZXIoQm9vbGVhbikgYXMgc3RyaW5nW107XHJcblxyXG5cdFx0XHRcdHJldHVybiBjYW5kaWRhdGVzLnNvbWUoKGMpID0+IHtcclxuXHRcdFx0XHRcdGlmICghYykgcmV0dXJuIGZhbHNlO1xyXG5cdFx0XHRcdFx0Ly8gQWNjZXB0IGV4YWN0IG1hdGNoLCB0YWdnZWQgdmFyaWFudHMgKGUuZy4sIFwiOmxhdGVzdFwiKSwgYW5kIG5vcm1hbGl6ZWQgcHJlZml4IG1hdGNoXHJcblx0XHRcdFx0XHRyZXR1cm4gKFxyXG5cdFx0XHRcdFx0XHRjID09PSBtb2RlbE5hbWUgfHxcclxuXHRcdFx0XHRcdFx0YyA9PT0gYCR7bW9kZWxOYW1lfTpsYXRlc3RgIHx8XHJcblx0XHRcdFx0XHRcdGMuc3RhcnRzV2l0aChgJHttb2RlbE5hbWV9OmApIHx8XHJcblx0XHRcdFx0XHRcdG5vcm1hbGl6ZShjKSA9PT0gbW9kZWxOYW1lXHJcblx0XHRcdFx0XHQpO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9KTtcclxuXHRcdH0gY2F0Y2gge1xyXG5cdFx0XHRyZXR1cm4gZmFsc2U7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRhc3luYyBnZXRFbWJlZGRpbmcodGV4dDogc3RyaW5nKTogUHJvbWlzZTxudW1iZXJbXT4ge1xyXG5cdFx0Y29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdFVybCh7XHJcblx0XHRcdHVybDogYCR7dGhpcy5iYXNlVXJsfS9hcGkvZW1iZWRgLFxyXG5cdFx0XHRtZXRob2Q6ICdQT1NUJyxcclxuXHRcdFx0Ym9keTogSlNPTi5zdHJpbmdpZnkoe1xyXG5cdFx0XHRcdG1vZGVsOiB0aGlzLm1vZGVsLFxyXG5cdFx0XHRcdGlucHV0OiB0ZXh0XHJcblx0XHRcdH0pXHJcblx0XHR9KTtcclxuXHRcdGNvbnN0IHZlYyA9IChyZXMuanNvbiBhcyBhbnkpPy5lbWJlZGRpbmdzPy5bMF07XHJcblx0XHRpZiAoIUFycmF5LmlzQXJyYXkodmVjKSB8fCB2ZWMubGVuZ3RoID09PSAwKSB7XHJcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09sbGFtYV0gSW52YWxpZCBlbWJlZGRpbmcgcmVzcG9uc2UnKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB2ZWM7XHJcblx0fVxyXG59XHJcblxyXG4iXX0=