import { __awaiter } from "tslib";
import { TFile } from 'obsidian';
function trimBom(s) {
    return s.charCodeAt(0) === 0xfeff ? s.slice(1) : s;
}
function parseH1Chapters(markdown, sourcePath) {
    const text = trimBom(markdown);
    const lines = text.split(/\r?\n/);
    const chapters = [];
    let currentTitle = '';
    let currentBody = [];
    const flush = () => {
        const body = currentBody.join('\n').trim();
        if (!currentTitle && !body)
            return;
        const title = currentTitle || 'Chapter';
        chapters.push({ title, sourcePath, markdown: body });
    };
    for (const line of lines) {
        const m = /^#\s+(.+?)\s*$/.exec(line);
        if (m) {
            // New chapter
            if (currentTitle || currentBody.length)
                flush();
            currentTitle = m[1].trim();
            currentBody = [];
            continue;
        }
        currentBody.push(line);
    }
    flush();
    if (chapters.length === 0) {
        return [{ title: 'Book', sourcePath, markdown: text.trim() }];
    }
    return chapters;
}
function extractTocBlock(markdown) {
    // Prefer a section headed by "# TOC" (case-insensitive).
    const lines = trimBom(markdown).split(/\r?\n/);
    const startIdx = lines.findIndex((l) => /^#\s+toc\s*$/i.test(l.trim()));
    if (startIdx < 0)
        return null;
    const block = [];
    for (let i = startIdx + 1; i < lines.length; i++) {
        const line = lines[i];
        if (/^#\s+/.test(line.trim()))
            break; // stop at next H1
        block.push(line);
    }
    return block;
}
function extractListLinks(lines) {
    const links = [];
    for (const line of lines) {
        if (!/^\s*(?:[-*+]\s+|\d+\.\s+)/.test(line))
            continue;
        // Wikilinks: [[Chapter 01]] or [[Folder/Chapter 01|Title]]
        const wikiMatches = Array.from(line.matchAll(/\[\[([^\]|#]+)(?:#[^\]]+)?(?:\|[^\]]+)?\]\]/g));
        for (const m of wikiMatches)
            links.push(m[1].trim());
        // Markdown links: [Title](path/to/chapter.md)
        const mdMatches = Array.from(line.matchAll(/\[[^\]]*\]\(([^)]+)\)/g));
        for (const m of mdMatches)
            links.push(m[1].trim());
    }
    return links.filter(Boolean);
}
function uniquePreserveOrder(items) {
    const out = [];
    const seen = new Set();
    for (const it of items) {
        const key = it;
        if (seen.has(key))
            continue;
        seen.add(key);
        out.push(it);
    }
    return out;
}
function normalizeLinkTarget(raw) {
    // Remove any fragment for our purposes.
    const noFrag = raw.split('#')[0].trim();
    if (!noFrag)
        return '';
    // Remove angle brackets used in markdown autolinks.
    return noFrag.replace(/^<|>$/g, '').trim();
}
function resolveLinkToFile(app, linkTarget, fromPath) {
    const t = normalizeLinkTarget(linkTarget);
    if (!t)
        return null;
    // If it's a full path and exists, use it.
    const direct = app.vault.getAbstractFileByPath(t);
    if (direct instanceof TFile)
        return direct;
    // Try adding .md for wikilink-like targets.
    const directMd = app.vault.getAbstractFileByPath(`${t}.md`);
    if (directMd instanceof TFile)
        return directMd;
    // Use metadata cache link resolution.
    const dest = app.metadataCache.getFirstLinkpathDest(t, fromPath);
    if (dest instanceof TFile)
        return dest;
    return null;
}
export class MarkdownCompile {
    constructor(app) {
        this.app = app;
    }
    compileFromBookMain(sourcePath) {
        return __awaiter(this, void 0, void 0, function* () {
            const file = this.app.vault.getAbstractFileByPath(sourcePath);
            if (!(file instanceof TFile)) {
                throw new Error(`Book main file not found: ${sourcePath}`);
            }
            const text = yield this.app.vault.read(file);
            const chapters = parseH1Chapters(text, file.path);
            return { titleGuess: file.basename, chapters };
        });
    }
    compileFromTocNote(tocPath) {
        return __awaiter(this, void 0, void 0, function* () {
            const file = this.app.vault.getAbstractFileByPath(tocPath);
            if (!(file instanceof TFile))
                throw new Error(`TOC note not found: ${tocPath}`);
            const text = yield this.app.vault.read(file);
            const lines = trimBom(text).split(/\r?\n/);
            const tocBlock = extractTocBlock(text);
            const linkTargets = tocBlock ? extractListLinks(tocBlock) : extractListLinks(lines);
            const ordered = uniquePreserveOrder(linkTargets);
            if (ordered.length === 0) {
                throw new Error('No chapter links found in the TOC note.');
            }
            const chapters = [];
            for (const target of ordered) {
                const dest = resolveLinkToFile(this.app, target, file.path);
                if (!dest)
                    continue;
                const md = yield this.app.vault.read(dest);
                const title = (() => {
                    const m = /^#\s+(.+?)\s*$/m.exec(md);
                    return m ? m[1].trim() : dest.basename;
                })();
                chapters.push({ title, sourcePath: dest.path, markdown: md });
            }
            if (chapters.length === 0) {
                throw new Error('No linked chapter files could be resolved.');
            }
            return { titleGuess: file.basename, chapters };
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFya2Rvd25Db21waWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWFya2Rvd25Db21waWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBYWpDLFNBQVMsT0FBTyxDQUFDLENBQVM7SUFDekIsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3BELENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxRQUFnQixFQUFFLFVBQWtCO0lBQzVELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2xDLE1BQU0sUUFBUSxHQUFzQixFQUFFLENBQUM7SUFFdkMsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO0lBQ3RCLElBQUksV0FBVyxHQUFhLEVBQUUsQ0FBQztJQUUvQixNQUFNLEtBQUssR0FBRyxHQUFHLEVBQUU7UUFDbEIsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsSUFBSTtZQUFFLE9BQU87UUFDbkMsTUFBTSxLQUFLLEdBQUcsWUFBWSxJQUFJLFNBQVMsQ0FBQztRQUN4QyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUN0RCxDQUFDLENBQUM7SUFFRixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxHQUFHLGdCQUFnQixD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Q0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO2dCQUN4QyxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUNMLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDL0QsQ0FBQztZQUVELElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDM0IsTUFBTSxJQUFJLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1lBQy9ELENBQUM7WUFFRCxPQUFPLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLENBQUM7UUFDaEQsQ0FBQztLQUFBO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEFwcCB9IGZyb20gJ29ic2lkaWFuJztcclxuaW1wb3J0IHsgVEZpbGUgfSBmcm9tICdvYnNpZGlhbic7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIENvbXBpbGVkQ2hhcHRlciB7XHJcblx0dGl0bGU6IHN0cmluZztcclxuXHRzb3VyY2VQYXRoOiBzdHJpbmc7XHJcblx0bWFya2Rvd246IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDb21waWxlUmVzdWx0IHtcclxuXHR0aXRsZUd1ZXNzPzogc3RyaW5nO1xyXG5cdGNoYXB0ZXJzOiBDb21waWxlZENoYXB0ZXJbXTtcclxufVxyXG5cclxuZnVuY3Rpb24gdHJpbUJvbShzOiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cdHJldHVybiBzLmNoYXJDb2RlQXQoMCkgPT09IDB4ZmVmZiA/IHMuc2xpY2UoMSkgOiBzO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUgxQ2hhcHRlcnMobWFya2Rvd246IHN0cmluZywgc291cmNlUGF0aDogc3RyaW5nKTogQ29tcGlsZWRDaGFwdGVyW10ge1xyXG5cdGNvbnN0IHRleHQgPSB0cmltQm9tKG1hcmtkb3duKTtcclxuXHRjb25zdCBsaW5lcyA9IHRleHQuc3BsaXQoL1xccj9cXG4vKTtcclxuXHRjb25zdCBjaGFwdGVyczogQ29tcGlsZWRDaGFwdGVyW10gPSBbXTtcclxuXHJcblx0bGV0IGN1cnJlbnRUaXRsZSA9ICcnO1xyXG5cdGxldCBjdXJyZW50Qm9keTogc3RyaW5nW10gPSBbXTtcclxuXHJcblx0Y29uc3QgZmx1c2ggPSAoKSA9PiB7XHJcblx0XHRjb25zdCBib2R5ID0gY3VycmVudEJvZHkuam9pbignXFxuJykudHJpbSgpO1xyXG5cdFx0aWYgKCFjdXJyZW50VGl0bGUgJiYgIWJvZHkpIHJldHVybjtcclxuXHRcdGNvbnN0IHRpdGxlID0gY3VycmVudFRpdGxlIHx8ICdDaGFwdGVyJztcclxuXHRcdGNoYXB0ZXJzLnB1c2goeyB0aXRsZSwgc291cmNlUGF0aCwgbWFya2Rvd246IGJvZHkgfSk7XHJcblx0fTtcclxuXHJcblx0Zm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XHJcblx0XHRjb25zdCBtID0gL14jXFxzKyguKz8pXFxzKiQvLmV4ZWMobGluZSk7XHJcblx0XHRpZiAobSkge1xyXG5cdFx0XHQvLyBOZXcgY2hhcHRlclxyXG5cdFx0XHRpZiAoY3VycmVudFRpdGxlIHx8IGN1cnJlbnRCb2R5Lmxlbmd0aCkgZmx1c2goKTtcclxuXHRcdFx0Y3VycmVudFRpdGxlID0gbVsxXS50cmltKCk7XHJcblx0XHRcdGN1cnJlbnRCb2R5ID0gW107XHJcblx0XHRcdGNvbnRpbnVlO1xyXG5cdFx0fVxyXG5cdFx0Y3VycmVudEJvZHkucHVzaChsaW5lKTtcclxuXHR9XHJcblx0Zmx1c2goKTtcclxuXHJcblx0aWYgKGNoYXB0ZXJzLmxlbmd0aCA9PT0gMCkge1xyXG5cdFx0cmV0dXJuIFt7IHRpdGxlOiAnQm9vaycsIHNvdXJjZVBhdGgsIG1hcmtkb3duOiB0ZXh0LnRyaW0oKSB9XTtcclxuXHR9XHJcblx0cmV0dXJuIGNoYXB0ZXJzO1xyXG59XHJcblxyXG5mdW5jdGlvbiBleHRyYWN0VG9jQmxvY2sobWFya2Rvd246IHN0cmluZyk6IHN0cmluZ1tdIHwgbnVsbCB7XHJcblx0Ly8gUHJlZmVyIGEgc2VjdGlvbiBoZWFkZWQgYnkgXCIjIFRPQ1wiIChjYXNlLWluc2Vuc2l0aXZlKS5cclxuXHRjb25zdCBsaW5lcyA9IHRyaW1Cb20obWFya2Rvd24pLnNwbGl0KC9cXHI/XFxuLyk7XHJcblx0Y29uc3Qgc3RhcnRJZHggPSBsaW5lcy5maW5kSW5kZXgoKGwpID0+IC9eI1xccyt0b2NcXHMqJC9pLnRlc3QobC50cmltKCkpKTtcclxuXHRpZiAoc3RhcnRJZHggPCAwKSByZXR1cm4gbnVsbDtcclxuXHJcblx0Y29uc3QgYmxvY2s6IHN0cmluZ1tdID0gW107XHJcblx0Zm9yIChsZXQgaSA9IHN0YXJ0SWR4ICsgMTsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRjb25zdCBsaW5lID0gbGluZXNbaV07XHJcblx0XHRpZiAoL14jXFxzKy8udGVzdChsaW5lLnRyaW0oKSkpIGJyZWFrOyAvLyBzdG9wIGF0IG5leHQgSDFcclxuXHRcdGJsb2NrLnB1c2gobGluZSk7XHJcblx0fVxyXG5cdHJldHVybiBibG9jaztcclxufVxyXG5cclxuZnVuY3Rpb24gZXh0cmFjdExpc3RMaW5rcyhsaW5lczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcblx0Y29uc3QgbGlua3M6IHN0cmluZ1tdID0gW107XHJcblx0Zm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XHJcblx0XHRpZiAoIS9eXFxzKig/OlstKitdXFxzK3xcXGQrXFwuXFxzKykvLnRlc3QobGluZSkpIGNvbnRpbnVlO1xyXG5cclxuXHRcdC8vIFdpa2lsaW5rczogW1tDaGFwdGVyIDAxXV0gb3IgW1tGb2xkZXIvQ2hhcHRlciAwMXxUaXRsZV1dXHJcblx0XHRjb25zdCB3aWtpTWF0Y2hlcyA9IEFycmF5LmZyb20obGluZS5tYXRjaEFsbCgvXFxbXFxbKFteXFxdfCNdKykoPzojW15cXF1dKyk/KD86XFx8W15cXF1dKyk/XFxdXFxdL2cpKTtcclxuXHRcdGZvciAoY29uc3QgbSBvZiB3aWtpTWF0Y2hlcykgbGlua3MucHVzaChtWzFdLnRyaW0oKSk7XHJcblxyXG5cdFx0Ly8gTWFya2Rvd24gbGlua3M6IFtUaXRsZV0ocGF0aC90by9jaGFwdGVyLm1kKVxyXG5cdFx0Y29uc3QgbWRNYXRjaGVzID0gQXJyYXkuZnJvbShsaW5lLm1hdGNoQWxsKC9cXFtbXlxcXV0qXFxdXFwoKFteKV0rKVxcKS9nKSk7XHJcblx0XHRmb3IgKGNvbnN0IG0gb2YgbWRNYXRjaGVzKSBsaW5rcy5wdXNoKG1bMV0udHJpbSgpKTtcclxuXHR9XHJcblx0cmV0dXJuIGxpbmtzLmZpbHRlcihCb29sZWFuKTtcclxufVxyXG5cclxuZnVuY3Rpb24gdW5pcXVlUHJlc2VydmVPcmRlcihpdGVtczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcblx0Y29uc3Qgb3V0OiBzdHJpbmdbXSA9IFtdO1xyXG5cdGNvbnN0IHNlZW4gPSBuZXcgU2V0PHN0cmluZz4oKTtcclxuXHRmb3IgKGNvbnN0IGl0IG9mIGl0ZW1zKSB7XHJcblx0XHRjb25zdCBrZXkgPSBpdDtcclxuXHRcdGlmIChzZWVuLmhhcyhrZXkpKSBjb250aW51ZTtcclxuXHRcdHNlZW4uYWRkKGtleSk7XHJcblx0XHRvdXQucHVzaChpdCk7XHJcblx0fVxyXG5cdHJldHVybiBvdXQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG5vcm1hbGl6ZUxpbmtUYXJnZXQocmF3OiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cdC8vIFJlbW92ZSBhbnkgZnJhZ21lbnQgZm9yIG91ciBwdXJwb3Nlcy5cclxuXHRjb25zdCBub0ZyYWcgPSByYXcuc3BsaXQoJyMnKVswXS50cmltKCk7XHJcblx0aWYgKCFub0ZyYWcpIHJldHVybiAnJztcclxuXHQvLyBSZW1vdmUgYW5nbGUgYnJhY2tldHMgdXNlZCBpbiBtYXJrZG93biBhdXRvbGlua3MuXHJcblx0cmV0dXJuIG5vRnJhZy5yZXBsYWNlKC9ePHw+JC9nLCAnJykudHJpbSgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZXNvbHZlTGlua1RvRmlsZShhcHA6IEFwcCwgbGlua1RhcmdldDogc3RyaW5nLCBmcm9tUGF0aDogc3RyaW5nKTogVEZpbGUgfCBudWxsIHtcclxuXHRjb25zdCB0ID0gbm9ybWFsaXplTGlua1RhcmdldChsaW5rVGFyZ2V0KTtcclxuXHRpZiAoIXQpIHJldHVybiBudWxsO1xyXG5cclxuXHQvLyBJZiBpdCdzIGEgZnVsbCBwYXRoIGFuZCBleGlzdHMsIHVzZSBpdC5cclxuXHRjb25zdCBkaXJlY3QgPSBhcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHQpO1xyXG5cdGlmIChkaXJlY3QgaW5zdGFuY2VvZiBURmlsZSkgcmV0dXJuIGRpcmVjdDtcclxuXHJcblx0Ly8gVHJ5IGFkZGluZyAubWQgZm9yIHdpa2lsaW5rLWxpa2UgdGFyZ2V0cy5cclxuXHRjb25zdCBkaXJlY3RNZCA9IGFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoYCR7dH0ubWRgKTtcclxuXHRpZiAoZGlyZWN0TWQgaW5zdGFuY2VvZiBURmlsZSkgcmV0dXJuIGRpcmVjdE1kO1xyXG5cclxuXHQvLyBVc2UgbWV0YWRhdGEgY2FjaGUgbGluayByZXNvbHV0aW9uLlxyXG5cdGNvbnN0IGRlc3QgPSBhcHAubWV0YWRhdGFDYWNoZS5nZXRGaXJzdExpbmtwYXRoRGVzdCh0LCBmcm9tUGF0aCk7XHJcblx0aWYgKGRlc3QgaW5zdGFuY2VvZiBURmlsZSkgcmV0dXJuIGRlc3Q7XHJcblxyXG5cdHJldHVybiBudWxsO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgTWFya2Rvd25Db21waWxlIHtcclxuXHRwcml2YXRlIHJlYWRvbmx5IGFwcDogQXBwO1xyXG5cclxuXHRjb25zdHJ1Y3RvcihhcHA6IEFwcCkge1xyXG5cdFx0dGhpcy5hcHAgPSBhcHA7XHJcblx0fVxyXG5cclxuXHRhc3luYyBjb21waWxlRnJvbUJvb2tNYWluKHNvdXJjZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Q29tcGlsZVJlc3VsdD4ge1xyXG5cdFx0Y29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChzb3VyY2VQYXRoKTtcclxuXHRcdGlmICghKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHtcclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBCb29rIG1haW4gZmlsZSBub3QgZm91bmQ6ICR7c291cmNlUGF0aH1gKTtcclxuXHRcdH1cclxuXHRcdGNvbnN0IHRleHQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKGZpbGUpO1xyXG5cdFx0Y29uc3QgY2hhcHRlcnMgPSBwYXJzZUgxQ2hhcHRlcnModGV4dCwgZmlsZS5wYXRoKTtcclxuXHRcdHJldHVybiB7IHRpdGxlR3Vlc3M6IGZpbGUuYmFzZW5hbWUsIGNoYXB0ZXJzIH07XHJcblx0fVxyXG5cclxuXHRhc3luYyBjb21waWxlRnJvbVRvY05vdGUodG9jUGF0aDogc3RyaW5nKTogUHJvbWlzZTxDb21waWxlUmVzdWx0PiB7XHJcblx0XHRjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHRvY1BhdGgpO1xyXG5cdFx0aWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkgdGhyb3cgbmV3IEVycm9yKGBUT0Mgbm90ZSBub3QgZm91bmQ6ICR7dG9jUGF0aH1gKTtcclxuXHJcblx0XHRjb25zdCB0ZXh0ID0gYXdhaXQgdGhpcy5hcHAudmF1bHQucmVhZChmaWxlKTtcclxuXHRcdGNvbnN0IGxpbmVzID0gdHJpbUJvbSh0ZXh0KS5zcGxpdCgvXFxyP1xcbi8pO1xyXG5cdFx0Y29uc3QgdG9jQmxvY2sgPSBleHRyYWN0VG9jQmxvY2sodGV4dCk7XHJcblx0XHRjb25zdCBsaW5rVGFyZ2V0cyA9IHRvY0Jsb2NrID8gZXh0cmFjdExpc3RMaW5rcyh0b2NCbG9jaykgOiBleHRyYWN0TGlzdExpbmtzKGxpbmVzKTtcclxuXHRcdGNvbnN0IG9yZGVyZWQgPSB1bmlxdWVQcmVzZXJ2ZU9yZGVyKGxpbmtUYXJnZXRzKTtcclxuXHRcdGlmIChvcmRlcmVkLmxlbmd0aCA9PT0gMCkge1xyXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ05vIGNoYXB0ZXIgbGlua3MgZm91bmQgaW4gdGhlIFRPQyBub3RlLicpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGNvbnN0IGNoYXB0ZXJzOiBDb21waWxlZENoYXB0ZXJbXSA9IFtdO1xyXG5cdFx0Zm9yIChjb25zdCB0YXJnZXQgb2Ygb3JkZXJlZCkge1xyXG5cdFx0XHRjb25zdCBkZXN0ID0gcmVzb2x2ZUxpbmtUb0ZpbGUodGhpcy5hcHAsIHRhcmdldCwgZmlsZS5wYXRoKTtcclxuXHRcdFx0aWYgKCFkZXN0KSBjb250aW51ZTtcclxuXHRcdFx0Y29uc3QgbWQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKGRlc3QpO1xyXG5cdFx0XHRjb25zdCB0aXRsZSA9ICgoKSA9PiB7XHJcblx0XHRcdFx0Y29uc3QgbSA9IC9eI1xccysoLis/KVxccyokL20uZXhlYyhtZCk7XHJcblx0XHRcdFx0cmV0dXJuIG0gPyBtWzFdLnRyaW0oKSA6IGRlc3QuYmFzZW5hbWU7XHJcblx0XHRcdH0pKCk7XHJcblx0XHRcdGNoYXB0ZXJzLnB1c2goeyB0aXRsZSwgc291cmNlUGF0aDogZGVzdC5wYXRoLCBtYXJrZG93bjogbWQgfSk7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKGNoYXB0ZXJzLmxlbmd0aCA9PT0gMCkge1xyXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ05vIGxpbmtlZCBjaGFwdGVyIGZpbGVzIGNvdWxkIGJlIHJlc29sdmVkLicpO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiB7IHRpdGxlR3Vlc3M6IGZpbGUuYmFzZW5hbWUsIGNoYXB0ZXJzIH07XHJcblx0fVxyXG59XHJcblxyXG5cclxuIl19