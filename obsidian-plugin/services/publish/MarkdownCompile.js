import { TFile } from 'obsidian';
function trimBom(s) {
    return s.charCodeAt(0) === 0xfeff ? s.slice(1) : s;
}
function parseH1Chapters(markdown, sourcePath) {
    const text = trimBom(markdown);
    const lines = text.split(/\r?\n/);
    const chapters = [];
    let currentTitle = '';
    let currentBody = [];
    const flush = () => {
        const body = currentBody.join('\n').trim();
        if (!currentTitle && !body)
            return;
        const title = currentTitle || 'Chapter';
        chapters.push({ title, sourcePath, markdown: body });
    };
    for (const line of lines) {
        const m = /^#\s+(.+?)\s*$/.exec(line);
        if (m) {
            // New chapter
            if (currentTitle || currentBody.length)
                flush();
            currentTitle = m[1].trim();
            currentBody = [];
            continue;
        }
        currentBody.push(line);
    }
    flush();
    if (chapters.length === 0) {
        return [{ title: 'Book', sourcePath, markdown: text.trim() }];
    }
    return chapters;
}
function extractTocBlock(markdown) {
    // Prefer a section headed by "# TOC" (case-insensitive).
    const lines = trimBom(markdown).split(/\r?\n/);
    const startIdx = lines.findIndex((l) => /^#\s+toc\s*$/i.test(l.trim()));
    if (startIdx < 0)
        return null;
    const block = [];
    for (let i = startIdx + 1; i < lines.length; i++) {
        const line = lines[i];
        if (/^#\s+/.test(line.trim()))
            break; // stop at next H1
        block.push(line);
    }
    return block;
}
function extractListLinks(lines) {
    const links = [];
    for (const line of lines) {
        if (!/^\s*(?:[-*+]\s+|\d+\.\s+)/.test(line))
            continue;
        // Wikilinks: [[Chapter 01]] or [[Folder/Chapter 01|Title]]
        const wikiMatches = Array.from(line.matchAll(/\[\[([^\]|#]+)(?:#[^\]]+)?(?:\|[^\]]+)?\]\]/g));
        for (const m of wikiMatches)
            links.push(m[1].trim());
        // Markdown links: [Title](path/to/chapter.md)
        const mdMatches = Array.from(line.matchAll(/\[[^\]]*\]\(([^)]+)\)/g));
        for (const m of mdMatches)
            links.push(m[1].trim());
    }
    return links.filter(Boolean);
}
function uniquePreserveOrder(items) {
    const out = [];
    const seen = new Set();
    for (const it of items) {
        const key = it;
        if (seen.has(key))
            continue;
        seen.add(key);
        out.push(it);
    }
    return out;
}
function normalizeLinkTarget(raw) {
    // Remove any fragment for our purposes.
    const noFrag = raw.split('#')[0].trim();
    if (!noFrag)
        return '';
    // Remove angle brackets used in markdown autolinks.
    return noFrag.replace(/^<|>$/g, '').trim();
}
function resolveLinkToFilePath(app, linkTarget, fromPath) {
    const t = normalizeLinkTarget(linkTarget);
    if (!t)
        return null;
    // If it's a full path and exists, use it.
    const direct = app.vault.getAbstractFileByPath(t);
    if (direct instanceof TFile)
        return direct.path;
    // Try adding .md for wikilink-like targets.
    const directMd = app.vault.getAbstractFileByPath(`${t}.md`);
    if (directMd instanceof TFile)
        return directMd.path;
    // Use metadata cache link resolution.
    const dest = app.metadataCache.getFirstLinkpathDest(t, fromPath);
    if (dest instanceof TFile)
        return dest.path;
    return null;
}
export class MarkdownCompile {
    constructor(app) {
        this.app = app;
    }
    async compileFromBookMain(sourcePath) {
        const file = this.app.vault.getAbstractFileByPath(sourcePath);
        if (!(file instanceof TFile)) {
            throw new Error(`Book main file not found: ${sourcePath}`);
        }
        const text = await this.app.vault.read(file);
        const chapters = parseH1Chapters(text, file.path);
        return { titleGuess: file.basename, chapters };
    }
    async compileFromTocNote(tocPath) {
        const file = this.app.vault.getAbstractFileByPath(tocPath);
        if (!(file instanceof TFile))
            throw new Error(`TOC note not found: ${tocPath}`);
        const text = await this.app.vault.read(file);
        const lines = trimBom(text).split(/\r?\n/);
        const tocBlock = extractTocBlock(text);
        const linkTargets = tocBlock ? extractListLinks(tocBlock) : extractListLinks(lines);
        const ordered = uniquePreserveOrder(linkTargets);
        if (ordered.length === 0) {
            throw new Error('No chapter links found in the TOC note.');
        }
        const chapters = [];
        for (const target of ordered) {
            const destPath = resolveLinkToFilePath(this.app, target, file.path);
            if (!destPath)
                continue;
            const dest = this.app.vault.getAbstractFileByPath(destPath);
            if (!(dest instanceof TFile))
                continue;
            const md = await this.app.vault.read(dest);
            const title = (() => {
                const m = /^#\s+(.+?)\s*$/m.exec(md);
                return m ? m[1].trim() : dest.basename;
            })();
            chapters.push({ title, sourcePath: dest.path, markdown: md });
        }
        if (chapters.length === 0) {
            throw new Error('No linked chapter files could be resolved.');
        }
        return { titleGuess: file.basename, chapters };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFya2Rvd25Db21waWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWFya2Rvd25Db21waWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFhakMsU0FBUyxPQUFPLENBQUMsQ0FBUztJQUN6QixPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEQsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLFFBQWdCLEVBQUUsVUFBa0I7SUFDNUQsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9CLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbEMsTUFBTSxRQUFRLEdBQXNCLEVBQUUsQ0FBQztJQUV2QyxJQUFJLFlBQVksR0FBRyxFQUFFLENBQUM7SUFDdEIsSUFBSSxXQUFXLEdBQWEsRUFBRSxDQUFDO0lBRS9CLE1BQU0sS0FBSyxHQUFHLEdBQUcsRUFBRTtRQUNsQixNQUFNLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzNDLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxJQUFJO1lBQUUsT0FBTztRQUNuQyxNQUFNLEtBQUssR0FBRyxZQUFZLElBQUksU0FBUyxDQUFDO1FBQ3hDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELENBQUMsQ0FBQztJQUVGLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7UUFDMUIsTUFBTSxDQUFDLEdBQUcsZ0JBQWdCLENB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QUFNLEtBQUssR0FBRyxDQUFDLEdBQUcsRUFBRTtnQkFDbkIsTUFBTSxDQUFDLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNyQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQ3hDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDTCxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDM0IsTUFBTSxJQUFJLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCxPQUFPLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLENBQUM7SUFDaEQsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBBcHAgfSBmcm9tICdvYnNpZGlhbic7XG5pbXBvcnQgeyBURmlsZSB9IGZyb20gJ29ic2lkaWFuJztcblxuZXhwb3J0IGludGVyZmFjZSBDb21waWxlZENoYXB0ZXIge1xuXHR0aXRsZTogc3RyaW5nO1xuXHRzb3VyY2VQYXRoOiBzdHJpbmc7XG5cdG1hcmtkb3duOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tcGlsZVJlc3VsdCB7XG5cdHRpdGxlR3Vlc3M/OiBzdHJpbmc7XG5cdGNoYXB0ZXJzOiBDb21waWxlZENoYXB0ZXJbXTtcbn1cblxuZnVuY3Rpb24gdHJpbUJvbShzOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRyZXR1cm4gcy5jaGFyQ29kZUF0KDApID09PSAweGZlZmYgPyBzLnNsaWNlKDEpIDogcztcbn1cblxuZnVuY3Rpb24gcGFyc2VIMUNoYXB0ZXJzKG1hcmtkb3duOiBzdHJpbmcsIHNvdXJjZVBhdGg6IHN0cmluZyk6IENvbXBpbGVkQ2hhcHRlcltdIHtcblx0Y29uc3QgdGV4dCA9IHRyaW1Cb20obWFya2Rvd24pO1xuXHRjb25zdCBsaW5lcyA9IHRleHQuc3BsaXQoL1xccj9cXG4vKTtcblx0Y29uc3QgY2hhcHRlcnM6IENvbXBpbGVkQ2hhcHRlcltdID0gW107XG5cblx0bGV0IGN1cnJlbnRUaXRsZSA9ICcnO1xuXHRsZXQgY3VycmVudEJvZHk6IHN0cmluZ1tdID0gW107XG5cblx0Y29uc3QgZmx1c2ggPSAoKSA9PiB7XG5cdFx0Y29uc3QgYm9keSA9IGN1cnJlbnRCb2R5LmpvaW4oJ1xcbicpLnRyaW0oKTtcblx0XHRpZiAoIWN1cnJlbnRUaXRsZSAmJiAhYm9keSkgcmV0dXJuO1xuXHRcdGNvbnN0IHRpdGxlID0gY3VycmVudFRpdGxlIHx8ICdDaGFwdGVyJztcblx0XHRjaGFwdGVycy5wdXNoKHsgdGl0bGUsIHNvdXJjZVBhdGgsIG1hcmtkb3duOiBib2R5IH0pO1xuXHR9O1xuXG5cdGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuXHRcdGNvbnN0IG0gPSAvXiNcXHMrKC4rPylcXHMqJC8uZXhlYyhsaW5lKTtcblx0XHRpZiAobSkge1xuXHRcdFx0Ly8gTmV3IGNoYXB0ZXJcblx0XHRcdGlmIChjdXJyZW50VGl0bGUgfHwgY3VycmVudEJvZHkubGVuZ3RoKSBmbHVzaCgpO1xuXHRcdFx0Y3VycmVudFRpdGxlID0gbVsxXS50cmltKCk7XG5cdFx0XHRjdXJyZW50Qm9keSA9IFtdO1xuXHRcdFx0Y29udGludWU7XG5cdFx0fVxuXHRcdGN1cnJlbnRCb2R5LnB1c2gobGluZSk7XG5cdH1cblx0Zmx1c2goKTtcblxuXHRpZiAoY2hhcHRlcnMubGVuZ3RoID09PSAwKSB7XG5cdFx0cmV0dXJuIFt7IHRpdGxlOiAnQm9vaycsIHNvdXJjZVBhdGgsIG1hcmtkb3duOiB0ZXh0LnRyaW0oKSB9XTtcblx0fVxuXHRyZXR1cm4gY2hhcHRlcnM7XG59XG5cbmZ1bmN0aW9uIGV4dHJhY3RUb2NCbG9jayhtYXJrZG93bjogc3RyaW5nKTogc3RyaW5nW10gfCBudWxsIHtcblx0Ly8gUHJlZmVyIGEgc2VjdGlvbiBoZWFkZWQgYnkgXCIjIFRPQ1wiIChjYXNlLWluc2Vuc2l0aXZlKS5cblx0Y29uc3QgbGluZXMgPSB0cmltQm9tKG1hcmtkb3duKS5zcGxpdCgvXFxyP1xcbi8pO1xuXHRjb25zdCBzdGFydElkeCA9IGxpbmVzLmZpbmRJbmRleCgobCkgPT4gL14jXFxzK3RvY1xccyokL2kudGVzdChsLnRyaW0oKSkpO1xuXHRpZiAoc3RhcnRJZHggPCAwKSByZXR1cm4gbnVsbDtcblxuXHRjb25zdCBibG9jazogc3RyaW5nW10gPSBbXTtcblx0Zm9yIChsZXQgaSA9IHN0YXJ0SWR4ICsgMTsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7XG5cdFx0Y29uc3QgbGluZSA9IGxpbmVzW2ldO1xuXHRcdGlmICgvXiNcXHMrLy50ZXN0KGxpbmUudHJpbSgpKSkgYnJlYWs7IC8vIHN0b3AgYXQgbmV4dCBIMVxuXHRcdGJsb2NrLnB1c2gobGluZSk7XG5cdH1cblx0cmV0dXJuIGJsb2NrO1xufVxuXG5mdW5jdGlvbiBleHRyYWN0TGlzdExpbmtzKGxpbmVzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcblx0Y29uc3QgbGlua3M6IHN0cmluZ1tdID0gW107XG5cdGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuXHRcdGlmICghL15cXHMqKD86Wy0qK11cXHMrfFxcZCtcXC5cXHMrKS8udGVzdChsaW5lKSkgY29udGludWU7XG5cblx0XHQvLyBXaWtpbGlua3M6IFtbQ2hhcHRlciAwMV1dIG9yIFtbRm9sZGVyL0NoYXB0ZXIgMDF8VGl0bGVdXVxuXHRcdGNvbnN0IHdpa2lNYXRjaGVzID0gQXJyYXkuZnJvbShsaW5lLm1hdGNoQWxsKC9cXFtcXFsoW15cXF18I10rKSg/OiNbXlxcXV0rKT8oPzpcXHxbXlxcXV0rKT9cXF1cXF0vZykpO1xuXHRcdGZvciAoY29uc3QgbSBvZiB3aWtpTWF0Y2hlcykgbGlua3MucHVzaChtWzFdLnRyaW0oKSk7XG5cblx0XHQvLyBNYXJrZG93biBsaW5rczogW1RpdGxlXShwYXRoL3RvL2NoYXB0ZXIubWQpXG5cdFx0Y29uc3QgbWRNYXRjaGVzID0gQXJyYXkuZnJvbShsaW5lLm1hdGNoQWxsKC9cXFtbXlxcXV0qXFxdXFwoKFteKV0rKVxcKS9nKSk7XG5cdFx0Zm9yIChjb25zdCBtIG9mIG1kTWF0Y2hlcykgbGlua3MucHVzaChtWzFdLnRyaW0oKSk7XG5cdH1cblx0cmV0dXJuIGxpbmtzLmZpbHRlcihCb29sZWFuKTtcbn1cblxuZnVuY3Rpb24gdW5pcXVlUHJlc2VydmVPcmRlcihpdGVtczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG5cdGNvbnN0IG91dDogc3RyaW5nW10gPSBbXTtcblx0Y29uc3Qgc2VlbiA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXHRmb3IgKGNvbnN0IGl0IG9mIGl0ZW1zKSB7XG5cdFx0Y29uc3Qga2V5ID0gaXQ7XG5cdFx0aWYgKHNlZW4uaGFzKGtleSkpIGNvbnRpbnVlO1xuXHRcdHNlZW4uYWRkKGtleSk7XG5cdFx0b3V0LnB1c2goaXQpO1xuXHR9XG5cdHJldHVybiBvdXQ7XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZUxpbmtUYXJnZXQocmF3OiBzdHJpbmcpOiBzdHJpbmcge1xuXHQvLyBSZW1vdmUgYW55IGZyYWdtZW50IGZvciBvdXIgcHVycG9zZXMuXG5cdGNvbnN0IG5vRnJhZyA9IHJhdy5zcGxpdCgnIycpWzBdLnRyaW0oKTtcblx0aWYgKCFub0ZyYWcpIHJldHVybiAnJztcblx0Ly8gUmVtb3ZlIGFuZ2xlIGJyYWNrZXRzIHVzZWQgaW4gbWFya2Rvd24gYXV0b2xpbmtzLlxuXHRyZXR1cm4gbm9GcmFnLnJlcGxhY2UoL148fD4kL2csICcnKS50cmltKCk7XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVMaW5rVG9GaWxlUGF0aChhcHA6IEFwcCwgbGlua1RhcmdldDogc3RyaW5nLCBmcm9tUGF0aDogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG5cdGNvbnN0IHQgPSBub3JtYWxpemVMaW5rVGFyZ2V0KGxpbmtUYXJnZXQpO1xuXHRpZiAoIXQpIHJldHVybiBudWxsO1xuXG5cdC8vIElmIGl0J3MgYSBmdWxsIHBhdGggYW5kIGV4aXN0cywgdXNlIGl0LlxuXHRjb25zdCBkaXJlY3QgPSBhcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHQpO1xuXHRpZiAoZGlyZWN0IGluc3RhbmNlb2YgVEZpbGUpIHJldHVybiBkaXJlY3QucGF0aDtcblxuXHQvLyBUcnkgYWRkaW5nIC5tZCBmb3Igd2lraWxpbmstbGlrZSB0YXJnZXRzLlxuXHRjb25zdCBkaXJlY3RNZCA9IGFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoYCR7dH0ubWRgKTtcblx0aWYgKGRpcmVjdE1kIGluc3RhbmNlb2YgVEZpbGUpIHJldHVybiBkaXJlY3RNZC5wYXRoO1xuXG5cdC8vIFVzZSBtZXRhZGF0YSBjYWNoZSBsaW5rIHJlc29sdXRpb24uXG5cdGNvbnN0IGRlc3QgPSBhcHAubWV0YWRhdGFDYWNoZS5nZXRGaXJzdExpbmtwYXRoRGVzdCh0LCBmcm9tUGF0aCk7XG5cdGlmIChkZXN0IGluc3RhbmNlb2YgVEZpbGUpIHJldHVybiBkZXN0LnBhdGg7XG5cblx0cmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBjbGFzcyBNYXJrZG93bkNvbXBpbGUge1xuXHRwcml2YXRlIHJlYWRvbmx5IGFwcDogQXBwO1xuXG5cdGNvbnN0cnVjdG9yKGFwcDogQXBwKSB7XG5cdFx0dGhpcy5hcHAgPSBhcHA7XG5cdH1cblxuXHRhc3luYyBjb21waWxlRnJvbUJvb2tNYWluKHNvdXJjZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Q29tcGlsZVJlc3VsdD4ge1xuXHRcdGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoc291cmNlUGF0aCk7XG5cdFx0aWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBCb29rIG1haW4gZmlsZSBub3QgZm91bmQ6ICR7c291cmNlUGF0aH1gKTtcblx0XHR9XG5cdFx0Y29uc3QgdGV4dCA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LnJlYWQoZmlsZSk7XG5cdFx0Y29uc3QgY2hhcHRlcnMgPSBwYXJzZUgxQ2hhcHRlcnModGV4dCwgZmlsZS5wYXRoKTtcblx0XHRyZXR1cm4geyB0aXRsZUd1ZXNzOiBmaWxlLmJhc2VuYW1lLCBjaGFwdGVycyB9O1xuXHR9XG5cblx0YXN5bmMgY29tcGlsZUZyb21Ub2NOb3RlKHRvY1BhdGg6IHN0cmluZyk6IFByb21pc2U8Q29tcGlsZVJlc3VsdD4ge1xuXHRcdGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgodG9jUGF0aCk7XG5cdFx0aWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkgdGhyb3cgbmV3IEVycm9yKGBUT0Mgbm90ZSBub3QgZm91bmQ6ICR7dG9jUGF0aH1gKTtcblxuXHRcdGNvbnN0IHRleHQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKGZpbGUpO1xuXHRcdGNvbnN0IGxpbmVzID0gdHJpbUJvbSh0ZXh0KS5zcGxpdCgvXFxyP1xcbi8pO1xuXHRcdGNvbnN0IHRvY0Jsb2NrID0gZXh0cmFjdFRvY0Jsb2NrKHRleHQpO1xuXHRcdGNvbnN0IGxpbmtUYXJnZXRzID0gdG9jQmxvY2sgPyBleHRyYWN0TGlzdExpbmtzKHRvY0Jsb2NrKSA6IGV4dHJhY3RMaXN0TGlua3MobGluZXMpO1xuXHRcdGNvbnN0IG9yZGVyZWQgPSB1bmlxdWVQcmVzZXJ2ZU9yZGVyKGxpbmtUYXJnZXRzKTtcblx0XHRpZiAob3JkZXJlZC5sZW5ndGggPT09IDApIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignTm8gY2hhcHRlciBsaW5rcyBmb3VuZCBpbiB0aGUgVE9DIG5vdGUuJyk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgY2hhcHRlcnM6IENvbXBpbGVkQ2hhcHRlcltdID0gW107XG5cdFx0Zm9yIChjb25zdCB0YXJnZXQgb2Ygb3JkZXJlZCkge1xuXHRcdFx0Y29uc3QgZGVzdFBhdGggPSByZXNvbHZlTGlua1RvRmlsZVBhdGgodGhpcy5hcHAsIHRhcmdldCwgZmlsZS5wYXRoKTtcblx0XHRcdGlmICghZGVzdFBhdGgpIGNvbnRpbnVlO1xuXHRcdFx0Y29uc3QgZGVzdCA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChkZXN0UGF0aCk7XG5cdFx0XHRpZiAoIShkZXN0IGluc3RhbmNlb2YgVEZpbGUpKSBjb250aW51ZTtcblx0XHRcdGNvbnN0IG1kID0gYXdhaXQgdGhpcy5hcHAudmF1bHQucmVhZChkZXN0KTtcblx0XHRcdGNvbnN0IHRpdGxlID0gKCgpID0+IHtcblx0XHRcdFx0Y29uc3QgbSA9IC9eI1xccysoLis/KVxccyokL20uZXhlYyhtZCk7XG5cdFx0XHRcdHJldHVybiBtID8gbVsxXS50cmltKCkgOiBkZXN0LmJhc2VuYW1lO1xuXHRcdFx0fSkoKTtcblx0XHRcdGNoYXB0ZXJzLnB1c2goeyB0aXRsZSwgc291cmNlUGF0aDogZGVzdC5wYXRoLCBtYXJrZG93bjogbWQgfSk7XG5cdFx0fVxuXG5cdFx0aWYgKGNoYXB0ZXJzLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdObyBsaW5rZWQgY2hhcHRlciBmaWxlcyBjb3VsZCBiZSByZXNvbHZlZC4nKTtcblx0XHR9XG5cblx0XHRyZXR1cm4geyB0aXRsZUd1ZXNzOiBmaWxlLmJhc2VuYW1lLCBjaGFwdGVycyB9O1xuXHR9XG59XG5cblxuIl19