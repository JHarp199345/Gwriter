import { TFile } from 'obsidian';
function trimBom(s) {
    return s.charCodeAt(0) === 0xfeff ? s.slice(1) : s;
}
function parseH1Chapters(markdown, sourcePath) {
    const text = trimBom(markdown);
    const lines = text.split(/\r?\n/);
    const chapters = [];
    let currentTitle = '';
    let currentBody = [];
    const flush = () => {
        const body = currentBody.join('\n').trim();
        if (!currentTitle && !body)
            return;
        const title = currentTitle || 'Chapter';
        chapters.push({ title, sourcePath, markdown: body });
    };
    for (const line of lines) {
        const m = /^#\s+(.+?)\s*$/.exec(line);
        if (m) {
            // New chapter
            if (currentTitle || currentBody.length)
                flush();
            currentTitle = m[1].trim();
            currentBody = [];
            continue;
        }
        currentBody.push(line);
    }
    flush();
    if (chapters.length === 0) {
        return [{ title: 'Book', sourcePath, markdown: text.trim() }];
    }
    return chapters;
}
function extractTocBlock(markdown) {
    // Prefer a section headed by "# TOC" (case-insensitive).
    const lines = trimBom(markdown).split(/\r?\n/);
    const startIdx = lines.findIndex((l) => /^#\s+toc\s*$/i.test(l.trim()));
    if (startIdx < 0)
        return null;
    const block = [];
    for (let i = startIdx + 1; i < lines.length; i++) {
        const line = lines[i];
        if (/^#\s+/.test(line.trim()))
            break; // stop at next H1
        block.push(line);
    }
    return block;
}
function extractListLinks(lines) {
    const links = [];
    for (const line of lines) {
        if (!/^\s*(?:[-*+]\s+|\d+\.\s+)/.test(line))
            continue;
        // Wikilinks: [[Chapter 01]] or [[Folder/Chapter 01|Title]]
        const wikiMatches = Array.from(line.matchAll(/\[\[([^\]|#]+)(?:#[^\]]+)?(?:\|[^\]]+)?\]\]/g));
        for (const m of wikiMatches)
            links.push(m[1].trim());
        // Markdown links: [Title](path/to/chapter.md)
        const mdMatches = Array.from(line.matchAll(/\[[^\]]*\]\(([^)]+)\)/g));
        for (const m of mdMatches)
            links.push(m[1].trim());
    }
    return links.filter(Boolean);
}
function uniquePreserveOrder(items) {
    const out = [];
    const seen = new Set();
    for (const it of items) {
        const key = it;
        if (seen.has(key))
            continue;
        seen.add(key);
        out.push(it);
    }
    return out;
}
function normalizeLinkTarget(raw) {
    // Remove any fragment for our purposes.
    const noFrag = raw.split('#')[0].trim();
    if (!noFrag)
        return '';
    // Remove angle brackets used in markdown autolinks.
    return noFrag.replace(/^<|>$/g, '').trim();
}
function resolveLinkToFilePath(app, linkTarget, fromPath) {
    const t = normalizeLinkTarget(linkTarget);
    if (!t)
        return null;
    // If it's a full path and exists, use it.
    const direct = app.vault.getAbstractFileByPath(t);
    if (direct instanceof TFile)
        return direct.path;
    // Try adding .md for wikilink-like targets.
    const directMd = app.vault.getAbstractFileByPath(`${t}.md`);
    if (directMd instanceof TFile)
        return directMd.path;
    // Use metadata cache link resolution.
    const dest = app.metadataCache.getFirstLinkpathDest(t, fromPath);
    if (dest instanceof TFile)
        return dest.path;
    return null;
}
export class MarkdownCompile {
    constructor(app) {
        this.app = app;
    }
    async compileFromBookMain(sourcePath) {
        const file = this.app.vault.getAbstractFileByPath(sourcePath);
        if (!(file instanceof TFile)) {
            throw new Error(`Book main file not found: ${sourcePath}`);
        }
        const text = await this.app.vault.read(file);
        const chapters = parseH1Chapters(text, file.path);
        return { titleGuess: file.basename, chapters };
    }
    async compileFromTocNote(tocPath) {
        const file = this.app.vault.getAbstractFileByPath(tocPath);
        if (!(file instanceof TFile))
            throw new Error(`TOC note not found: ${tocPath}`);
        const text = await this.app.vault.read(file);
        const lines = trimBom(text).split(/\r?\n/);
        const tocBlock = extractTocBlock(text);
        const linkTargets = tocBlock ? extractListLinks(tocBlock) : extractListLinks(lines);
        const ordered = uniquePreserveOrder(linkTargets);
        if (ordered.length === 0) {
            throw new Error('No chapter links found in the TOC note.');
        }
        const chapters = [];
        for (const target of ordered) {
            const destPath = resolveLinkToFilePath(this.app, target, file.path);
            if (!destPath)
                continue;
            const dest = this.app.vault.getAbstractFileByPath(destPath);
            if (!(dest instanceof TFile))
                continue;
            const md = await this.app.vault.read(dest);
            const title = (() => {
                const m = /^#\s+(.+?)\s*$/m.exec(md);
                return m ? m[1].trim() : dest.basename;
            })();
            chapters.push({ title, sourcePath: dest.path, markdown: md });
        }
        if (chapters.length === 0) {
            throw new Error('No linked chapter files could be resolved.');
        }
        return { titleGuess: file.basename, chapters };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFya2Rvd25Db21waWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWFya2Rvd25Db21waWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFhakMsU0FBUyxPQUFPLENBQUMsQ0FBUztJQUN6QixPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEQsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLFFBQWdCLEVBQUUsVUFBa0I7SUFDNUQsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9CLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbEMsTUFBTSxRQUFRLEdBQXNCLEVBQUUsQ0FBQztJQUV2QyxJQUFJLFlBQVksR0FBRyxFQUFFLENBQUM7SUFDdEIsSUFBSSxXQUFXLEdBQWEsRUFBRSxDQUFDO0lBRS9CLE1BQU0sS0FBSyxHQUFHLEdBQUcsRUFBRTtRQUNsQixNQUFNLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzNDLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxJQUFJO1lBQUUsT0FBTztRQUNuQyxNQUFNLEtBQUssR0FBRyxZQUFZLElBQUksU0FBUyxDQUFDO1FBQ3hDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELENBQUMsQ0FBQztJQUVGLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7UUFDMUIsTUFBTSxDQUFDLEdBQUcsZ0JBQWdCLENB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QUFNLEtBQUssR0FBRyxDQUFDLEdBQUcsRUFBRTtnQkFDbkIsTUFBTSxDQUFDLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNyQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQ3hDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDTCxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDM0IsTUFBTSxJQUFJLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCxPQUFPLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLENBQUM7SUFDaEQsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBBcHAgfSBmcm9tICdvYnNpZGlhbic7XHJcbmltcG9ydCB7IFRGaWxlIH0gZnJvbSAnb2JzaWRpYW4nO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDb21waWxlZENoYXB0ZXIge1xyXG5cdHRpdGxlOiBzdHJpbmc7XHJcblx0c291cmNlUGF0aDogc3RyaW5nO1xyXG5cdG1hcmtkb3duOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ29tcGlsZVJlc3VsdCB7XHJcblx0dGl0bGVHdWVzcz86IHN0cmluZztcclxuXHRjaGFwdGVyczogQ29tcGlsZWRDaGFwdGVyW107XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyaW1Cb20oczogc3RyaW5nKTogc3RyaW5nIHtcclxuXHRyZXR1cm4gcy5jaGFyQ29kZUF0KDApID09PSAweGZlZmYgPyBzLnNsaWNlKDEpIDogcztcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VIMUNoYXB0ZXJzKG1hcmtkb3duOiBzdHJpbmcsIHNvdXJjZVBhdGg6IHN0cmluZyk6IENvbXBpbGVkQ2hhcHRlcltdIHtcclxuXHRjb25zdCB0ZXh0ID0gdHJpbUJvbShtYXJrZG93bik7XHJcblx0Y29uc3QgbGluZXMgPSB0ZXh0LnNwbGl0KC9cXHI/XFxuLyk7XHJcblx0Y29uc3QgY2hhcHRlcnM6IENvbXBpbGVkQ2hhcHRlcltdID0gW107XHJcblxyXG5cdGxldCBjdXJyZW50VGl0bGUgPSAnJztcclxuXHRsZXQgY3VycmVudEJvZHk6IHN0cmluZ1tdID0gW107XHJcblxyXG5cdGNvbnN0IGZsdXNoID0gKCkgPT4ge1xyXG5cdFx0Y29uc3QgYm9keSA9IGN1cnJlbnRCb2R5LmpvaW4oJ1xcbicpLnRyaW0oKTtcclxuXHRcdGlmICghY3VycmVudFRpdGxlICYmICFib2R5KSByZXR1cm47XHJcblx0XHRjb25zdCB0aXRsZSA9IGN1cnJlbnRUaXRsZSB8fCAnQ2hhcHRlcic7XHJcblx0XHRjaGFwdGVycy5wdXNoKHsgdGl0bGUsIHNvdXJjZVBhdGgsIG1hcmtkb3duOiBib2R5IH0pO1xyXG5cdH07XHJcblxyXG5cdGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xyXG5cdFx0Y29uc3QgbSA9IC9eI1xccysoLis/KVxccyokLy5leGVjKGxpbmUpO1xyXG5cdFx0aWYgKG0pIHtcclxuXHRcdFx0Ly8gTmV3IGNoYXB0ZXJcclxuXHRcdFx0aWYgKGN1cnJlbnRUaXRsZSB8fCBjdXJyZW50Qm9keS5sZW5ndGgpIGZsdXNoKCk7XHJcblx0XHRcdGN1cnJlbnRUaXRsZSA9IG1bMV0udHJpbSgpO1xyXG5cdFx0XHRjdXJyZW50Qm9keSA9IFtdO1xyXG5cdFx0XHRjb250aW51ZTtcclxuXHRcdH1cclxuXHRcdGN1cnJlbnRCb2R5LnB1c2gobGluZSk7XHJcblx0fVxyXG5cdGZsdXNoKCk7XHJcblxyXG5cdGlmIChjaGFwdGVycy5sZW5ndGggPT09IDApIHtcclxuXHRcdHJldHVybiBbeyB0aXRsZTogJ0Jvb2snLCBzb3VyY2VQYXRoLCBtYXJrZG93bjogdGV4dC50cmltKCkgfV07XHJcblx0fVxyXG5cdHJldHVybiBjaGFwdGVycztcclxufVxyXG5cclxuZnVuY3Rpb24gZXh0cmFjdFRvY0Jsb2NrKG1hcmtkb3duOiBzdHJpbmcpOiBzdHJpbmdbXSB8IG51bGwge1xyXG5cdC8vIFByZWZlciBhIHNlY3Rpb24gaGVhZGVkIGJ5IFwiIyBUT0NcIiAoY2FzZS1pbnNlbnNpdGl2ZSkuXHJcblx0Y29uc3QgbGluZXMgPSB0cmltQm9tKG1hcmtkb3duKS5zcGxpdCgvXFxyP1xcbi8pO1xyXG5cdGNvbnN0IHN0YXJ0SWR4ID0gbGluZXMuZmluZEluZGV4KChsKSA9PiAvXiNcXHMrdG9jXFxzKiQvaS50ZXN0KGwudHJpbSgpKSk7XHJcblx0aWYgKHN0YXJ0SWR4IDwgMCkgcmV0dXJuIG51bGw7XHJcblxyXG5cdGNvbnN0IGJsb2NrOiBzdHJpbmdbXSA9IFtdO1xyXG5cdGZvciAobGV0IGkgPSBzdGFydElkeCArIDE7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykge1xyXG5cdFx0Y29uc3QgbGluZSA9IGxpbmVzW2ldO1xyXG5cdFx0aWYgKC9eI1xccysvLnRlc3QobGluZS50cmltKCkpKSBicmVhazsgLy8gc3RvcCBhdCBuZXh0IEgxXHJcblx0XHRibG9jay5wdXNoKGxpbmUpO1xyXG5cdH1cclxuXHRyZXR1cm4gYmxvY2s7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4dHJhY3RMaXN0TGlua3MobGluZXM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG5cdGNvbnN0IGxpbmtzOiBzdHJpbmdbXSA9IFtdO1xyXG5cdGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xyXG5cdFx0aWYgKCEvXlxccyooPzpbLSorXVxccyt8XFxkK1xcLlxccyspLy50ZXN0KGxpbmUpKSBjb250aW51ZTtcclxuXHJcblx0XHQvLyBXaWtpbGlua3M6IFtbQ2hhcHRlciAwMV1dIG9yIFtbRm9sZGVyL0NoYXB0ZXIgMDF8VGl0bGVdXVxyXG5cdFx0Y29uc3Qgd2lraU1hdGNoZXMgPSBBcnJheS5mcm9tKGxpbmUubWF0Y2hBbGwoL1xcW1xcWyhbXlxcXXwjXSspKD86I1teXFxdXSspPyg/OlxcfFteXFxdXSspP1xcXVxcXS9nKSk7XHJcblx0XHRmb3IgKGNvbnN0IG0gb2Ygd2lraU1hdGNoZXMpIGxpbmtzLnB1c2gobVsxXS50cmltKCkpO1xyXG5cclxuXHRcdC8vIE1hcmtkb3duIGxpbmtzOiBbVGl0bGVdKHBhdGgvdG8vY2hhcHRlci5tZClcclxuXHRcdGNvbnN0IG1kTWF0Y2hlcyA9IEFycmF5LmZyb20obGluZS5tYXRjaEFsbCgvXFxbW15cXF1dKlxcXVxcKChbXildKylcXCkvZykpO1xyXG5cdFx0Zm9yIChjb25zdCBtIG9mIG1kTWF0Y2hlcykgbGlua3MucHVzaChtWzFdLnRyaW0oKSk7XHJcblx0fVxyXG5cdHJldHVybiBsaW5rcy5maWx0ZXIoQm9vbGVhbik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVuaXF1ZVByZXNlcnZlT3JkZXIoaXRlbXM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG5cdGNvbnN0IG91dDogc3RyaW5nW10gPSBbXTtcclxuXHRjb25zdCBzZWVuID0gbmV3IFNldDxzdHJpbmc+KCk7XHJcblx0Zm9yIChjb25zdCBpdCBvZiBpdGVtcykge1xyXG5cdFx0Y29uc3Qga2V5ID0gaXQ7XHJcblx0XHRpZiAoc2Vlbi5oYXMoa2V5KSkgY29udGludWU7XHJcblx0XHRzZWVuLmFkZChrZXkpO1xyXG5cdFx0b3V0LnB1c2goaXQpO1xyXG5cdH1cclxuXHRyZXR1cm4gb3V0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBub3JtYWxpemVMaW5rVGFyZ2V0KHJhdzogc3RyaW5nKTogc3RyaW5nIHtcclxuXHQvLyBSZW1vdmUgYW55IGZyYWdtZW50IGZvciBvdXIgcHVycG9zZXMuXHJcblx0Y29uc3Qgbm9GcmFnID0gcmF3LnNwbGl0KCcjJylbMF0udHJpbSgpO1xyXG5cdGlmICghbm9GcmFnKSByZXR1cm4gJyc7XHJcblx0Ly8gUmVtb3ZlIGFuZ2xlIGJyYWNrZXRzIHVzZWQgaW4gbWFya2Rvd24gYXV0b2xpbmtzLlxyXG5cdHJldHVybiBub0ZyYWcucmVwbGFjZSgvXjx8PiQvZywgJycpLnRyaW0oKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcmVzb2x2ZUxpbmtUb0ZpbGVQYXRoKGFwcDogQXBwLCBsaW5rVGFyZ2V0OiBzdHJpbmcsIGZyb21QYXRoOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcclxuXHRjb25zdCB0ID0gbm9ybWFsaXplTGlua1RhcmdldChsaW5rVGFyZ2V0KTtcclxuXHRpZiAoIXQpIHJldHVybiBudWxsO1xyXG5cclxuXHQvLyBJZiBpdCdzIGEgZnVsbCBwYXRoIGFuZCBleGlzdHMsIHVzZSBpdC5cclxuXHRjb25zdCBkaXJlY3QgPSBhcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHQpO1xyXG5cdGlmIChkaXJlY3QgaW5zdGFuY2VvZiBURmlsZSkgcmV0dXJuIGRpcmVjdC5wYXRoO1xyXG5cclxuXHQvLyBUcnkgYWRkaW5nIC5tZCBmb3Igd2lraWxpbmstbGlrZSB0YXJnZXRzLlxyXG5cdGNvbnN0IGRpcmVjdE1kID0gYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChgJHt0fS5tZGApO1xyXG5cdGlmIChkaXJlY3RNZCBpbnN0YW5jZW9mIFRGaWxlKSByZXR1cm4gZGlyZWN0TWQucGF0aDtcclxuXHJcblx0Ly8gVXNlIG1ldGFkYXRhIGNhY2hlIGxpbmsgcmVzb2x1dGlvbi5cclxuXHRjb25zdCBkZXN0ID0gYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0Rmlyc3RMaW5rcGF0aERlc3QodCwgZnJvbVBhdGgpO1xyXG5cdGlmIChkZXN0IGluc3RhbmNlb2YgVEZpbGUpIHJldHVybiBkZXN0LnBhdGg7XHJcblxyXG5cdHJldHVybiBudWxsO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgTWFya2Rvd25Db21waWxlIHtcclxuXHRwcml2YXRlIHJlYWRvbmx5IGFwcDogQXBwO1xyXG5cclxuXHRjb25zdHJ1Y3RvcihhcHA6IEFwcCkge1xyXG5cdFx0dGhpcy5hcHAgPSBhcHA7XHJcblx0fVxyXG5cclxuXHRhc3luYyBjb21waWxlRnJvbUJvb2tNYWluKHNvdXJjZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Q29tcGlsZVJlc3VsdD4ge1xyXG5cdFx0Y29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChzb3VyY2VQYXRoKTtcclxuXHRcdGlmICghKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHtcclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBCb29rIG1haW4gZmlsZSBub3QgZm91bmQ6ICR7c291cmNlUGF0aH1gKTtcclxuXHRcdH1cclxuXHRcdGNvbnN0IHRleHQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKGZpbGUpO1xyXG5cdFx0Y29uc3QgY2hhcHRlcnMgPSBwYXJzZUgxQ2hhcHRlcnModGV4dCwgZmlsZS5wYXRoKTtcclxuXHRcdHJldHVybiB7IHRpdGxlR3Vlc3M6IGZpbGUuYmFzZW5hbWUsIGNoYXB0ZXJzIH07XHJcblx0fVxyXG5cclxuXHRhc3luYyBjb21waWxlRnJvbVRvY05vdGUodG9jUGF0aDogc3RyaW5nKTogUHJvbWlzZTxDb21waWxlUmVzdWx0PiB7XHJcblx0XHRjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHRvY1BhdGgpO1xyXG5cdFx0aWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkgdGhyb3cgbmV3IEVycm9yKGBUT0Mgbm90ZSBub3QgZm91bmQ6ICR7dG9jUGF0aH1gKTtcclxuXHJcblx0XHRjb25zdCB0ZXh0ID0gYXdhaXQgdGhpcy5hcHAudmF1bHQucmVhZChmaWxlKTtcclxuXHRcdGNvbnN0IGxpbmVzID0gdHJpbUJvbSh0ZXh0KS5zcGxpdCgvXFxyP1xcbi8pO1xyXG5cdFx0Y29uc3QgdG9jQmxvY2sgPSBleHRyYWN0VG9jQmxvY2sodGV4dCk7XHJcblx0XHRjb25zdCBsaW5rVGFyZ2V0cyA9IHRvY0Jsb2NrID8gZXh0cmFjdExpc3RMaW5rcyh0b2NCbG9jaykgOiBleHRyYWN0TGlzdExpbmtzKGxpbmVzKTtcclxuXHRcdGNvbnN0IG9yZGVyZWQgPSB1bmlxdWVQcmVzZXJ2ZU9yZGVyKGxpbmtUYXJnZXRzKTtcclxuXHRcdGlmIChvcmRlcmVkLmxlbmd0aCA9PT0gMCkge1xyXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ05vIGNoYXB0ZXIgbGlua3MgZm91bmQgaW4gdGhlIFRPQyBub3RlLicpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGNvbnN0IGNoYXB0ZXJzOiBDb21waWxlZENoYXB0ZXJbXSA9IFtdO1xyXG5cdFx0Zm9yIChjb25zdCB0YXJnZXQgb2Ygb3JkZXJlZCkge1xyXG5cdFx0XHRjb25zdCBkZXN0UGF0aCA9IHJlc29sdmVMaW5rVG9GaWxlUGF0aCh0aGlzLmFwcCwgdGFyZ2V0LCBmaWxlLnBhdGgpO1xyXG5cdFx0XHRpZiAoIWRlc3RQYXRoKSBjb250aW51ZTtcclxuXHRcdFx0Y29uc3QgZGVzdCA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChkZXN0UGF0aCk7XHJcblx0XHRcdGlmICghKGRlc3QgaW5zdGFuY2VvZiBURmlsZSkpIGNvbnRpbnVlO1xyXG5cdFx0XHRjb25zdCBtZCA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LnJlYWQoZGVzdCk7XHJcblx0XHRcdGNvbnN0IHRpdGxlID0gKCgpID0+IHtcclxuXHRcdFx0XHRjb25zdCBtID0gL14jXFxzKyguKz8pXFxzKiQvbS5leGVjKG1kKTtcclxuXHRcdFx0XHRyZXR1cm4gbSA/IG1bMV0udHJpbSgpIDogZGVzdC5iYXNlbmFtZTtcclxuXHRcdFx0fSkoKTtcclxuXHRcdFx0Y2hhcHRlcnMucHVzaCh7IHRpdGxlLCBzb3VyY2VQYXRoOiBkZXN0LnBhdGgsIG1hcmtkb3duOiBtZCB9KTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoY2hhcHRlcnMubGVuZ3RoID09PSAwKSB7XHJcblx0XHRcdHRocm93IG5ldyBFcnJvcignTm8gbGlua2VkIGNoYXB0ZXIgZmlsZXMgY291bGQgYmUgcmVzb2x2ZWQuJyk7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHsgdGl0bGVHdWVzczogZmlsZS5iYXNlbmFtZSwgY2hhcHRlcnMgfTtcclxuXHR9XHJcbn1cclxuXHJcblxyXG4iXX0=